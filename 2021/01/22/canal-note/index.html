<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>canal 学习笔记 | Tim Ho&#39;s Technology Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本篇将说说阿里巴巴开源的mysql数据库同步工具canal的使用，详细说明可以参考wiki。主要用途是基于mysql数据库增量日志解析，提供增量数据订阅和消费。 基于日志增量订阅和消费的业务包括  数据库镜像 数据库实时备份 索引构建和实时维护（拆分异构索引、倒排索引等） 业务 cache 刷新 带业务逻辑的增量数据处理  当前的 canal 支持源端 mysql 版本包括 5.1.x , 5.5">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="canal 学习笔记">
<meta property="og:url" content="https://github.com/hewentian/2021/01/22/canal-note/index.html">
<meta property="og:site_name" content="Tim Ho&#39;s Technology Blog">
<meta property="og:description" content="本篇将说说阿里巴巴开源的mysql数据库同步工具canal的使用，详细说明可以参考wiki。主要用途是基于mysql数据库增量日志解析，提供增量数据订阅和消费。 基于日志增量订阅和消费的业务包括  数据库镜像 数据库实时备份 索引构建和实时维护（拆分异构索引、倒排索引等） 业务 cache 刷新 带业务逻辑的增量数据处理  当前的 canal 支持源端 mysql 版本包括 5.1.x , 5.5">
<meta property="og:locale" content="en-US">
<meta property="og:image" content="https://github.com/img/mysql-1.png">
<meta property="og:image" content="https://github.com/img/canal-1.png">
<meta property="og:updated_time" content="2021-01-23T11:03:49.624Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="canal 学习笔记">
<meta name="twitter:description" content="本篇将说说阿里巴巴开源的mysql数据库同步工具canal的使用，详细说明可以参考wiki。主要用途是基于mysql数据库增量日志解析，提供增量数据订阅和消费。 基于日志增量订阅和消费的业务包括  数据库镜像 数据库实时备份 索引构建和实时维护（拆分异构索引、倒排索引等） 业务 cache 刷新 带业务逻辑的增量数据处理  当前的 canal 支持源端 mysql 版本包括 5.1.x , 5.5">
<meta name="twitter:image" content="https://github.com/img/mysql-1.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tim Ho&#39;s Technology Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心如止水</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/categories/">Categories</a>
        
          <a class="main-nav-link" href="/tags/">Tags</a>
        
          <a class="main-nav-link" href="/about/">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/hewentian"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-canal-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/22/canal-note/" class="article-date">
  <time datetime="2021-01-22T02:16:21.000Z" itemprop="datePublished">2021-01-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      canal 学习笔记
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本篇将说说阿里巴巴开源的mysql数据库同步工具<a href="https://github.com/alibaba/canal">canal</a>的使用，详细说明可以参考<a href="https://github.com/alibaba/canal/wiki">wiki</a>。主要用途是基于mysql数据库增量日志解析，提供增量数据订阅和消费。</p>
<p>基于日志增量订阅和消费的业务包括</p>
<ul>
<li>数据库镜像</li>
<li>数据库实时备份</li>
<li>索引构建和实时维护（拆分异构索引、倒排索引等）</li>
<li>业务 cache 刷新</li>
<li>带业务逻辑的增量数据处理</li>
</ul>
<p>当前的 canal 支持源端 mysql 版本包括 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.x</p>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>mysql主备复制原理</p>
<p><img src="/img/mysql-1.png" alt="" title="mysql主备复制原理"></p>
<ul>
<li>mysql master 将数据变更写入二进制日志（binary log，其中记录叫做二进制日志事件binary log events，可以通过 show binlog events 进行查看）</li>
<li>mysql slave 将 master 的 binary log events 复制到它的中继日志(relay log)</li>
<li>mysql slave 重放 relay log 中事件，将数据变更反映它自己的数据</li>
</ul>
<p>canal工作原理</p>
<p><img src="/img/canal-1.png" alt="" title="canal工作原理"></p>
<ul>
<li>canal 模拟 mysql slave 的交互协议，伪装自己为 mysql slave，向 mysql master 发送 dump 请求</li>
<li>mysql master 收到 dump 请求，开始推送 binary log 给 slave （即 canal）</li>
<li>canal 解析 binary log 对象（原始为 byte 流）</li>
</ul>
<h3 id="配置mysql服务器"><a href="#配置mysql服务器" class="headerlink" title="配置mysql服务器"></a>配置mysql服务器</h3><p>在文件<code>/etc/mysql/conf.d/mysql.cnf</code>中增加如下配置信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log_bin=mysql-bin    # 开启 binlog，其中 mysql-bin 是日志名称前缀</span><br><span class="line">binlog_format=ROW    # 选择 ROW 模式</span><br><span class="line">server_id=1          # 默认值是0，如果使用默认值则不能和从节点通信，这个值的区间是：1到(2^32)-1。注意不要和 canal 的 slaveId 重复</span><br></pre></td></tr></table></figure></p>
<p>配置后，重启mysql服务器，验证是否配置成功：</p>
<pre><code>SHOW VARIABLES LIKE &apos;server_id&apos;;
SHOW VARIABLES LIKE &apos;log_%&apos;;
SHOW VARIABLES LIKE &apos;binlog_format&apos;;
</code></pre><p>创建 canal 链接 mysql 的账号，并分配作为 mysql slave 的权限，如果已有账户则可直接 grant</p>
<pre><code>CREATE USER canal IDENTIFIED BY &apos;canal&apos;;
GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &apos;canal&apos;@&apos;%&apos;;
-- GRANT ALL PRIVILEGES ON *.* TO &apos;canal&apos;@&apos;%&apos;;
FLUSH PRIVILEGES;
</code></pre><h3 id="安装canal"><a href="#安装canal" class="headerlink" title="安装canal"></a>安装canal</h3><p>下载，可以在<a href="https://github.com/alibaba/canal/releases">releases</a>页面进行下载<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/alibaba/canal/releases/download/canal-1.1.4/canal.deployer-1.1.4.tar.gz</span><br><span class="line"></span><br><span class="line">$ mkdir ~/canal</span><br><span class="line">$ tar xf canal.deployer-1.1.4.tar.gz -C ~/canal</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ~/canal</span><br><span class="line">$ ls</span><br><span class="line">bin  conf  lib  logs</span><br></pre></td></tr></table></figure></p>
<p>配置canal server<br>配置端口、用户名和访问密码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vi ~/canal/conf/canal.properties</span><br><span class="line"></span><br><span class="line">canal.port = 11111</span><br><span class="line">canal.user = canal</span><br><span class="line">canal.passwd = E3619321C1A937C46A0D8BD1DAC39F93B27D4458    <span class="comment"># 这个是加密后的密码，未加密前是canal</span></span><br><span class="line">canal.destinations = example                               <span class="comment"># 当前默认开启了一个名为example的instance，多个之间用逗号(,)分隔</span></span><br></pre></td></tr></table></figure></p>
<p>配置canal instance<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vi ~/canal/conf/example/instance.properties</span><br><span class="line"></span><br><span class="line">canal.instance.mysql.slaveId=1234    <span class="comment"># mysql serverId , v1.0.26+ will autoGen</span></span><br><span class="line">canal.instance.master.address=127.0.0.1:3306</span><br><span class="line">canal.instance.dbUsername=canal</span><br><span class="line">canal.instance.dbPassword=canal</span><br><span class="line">canal.instance.connectionCharset = UTF-8</span><br><span class="line">canal.instance.filter.regex=.*\\..*</span><br></pre></td></tr></table></figure></p>
<p>启动canal<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/canal</span><br><span class="line">$ sh bin/startup.sh</span><br></pre></td></tr></table></figure></p>
<p>查看 server 日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ more logs/canal/canal.log</span><br><span class="line"></span><br><span class="line">2021-01-22 20:12:11.735 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class="comment">## set default uncaught exception handler</span></span><br><span class="line">2021-01-22 20:12:11.797 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class="comment">## load canal configurations</span></span><br><span class="line">2021-01-22 20:12:11.813 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class="comment">## start the canal server.</span></span><br><span class="line">2021-01-22 20:12:11.869 [main] INFO  com.alibaba.otter.canal.deployer.CanalController - <span class="comment">## start the canal server[172.18.0.1(172.18.0.1):11111]</span></span><br><span class="line">2021-01-22 20:12:13.779 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class="comment">## the canal server is running now ......</span></span><br></pre></td></tr></table></figure></p>
<p>查看 instance 的日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ more logs/example/example.log</span><br><span class="line"></span><br><span class="line">2021-01-22 20:12:12.428 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]</span><br><span class="line">2021-01-22 20:12:12.436 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [example/instance.properties]</span><br><span class="line">2021-01-22 20:12:12.722 [main] WARN  o.s.beans.GenericTypeAwarePropertyDescriptor - Invalid JavaBean property <span class="string">'connectionCharset'</span> being accessed! Ambiguous write methods found next to actually used [public void com.alibaba.otter.canal.parse.inbound.mysql.AbstractMysqlEventParser.setConnectionCharset(java.nio.charset.Charset)]: [public void com.alibaba.otter.canal.parse.inbound.mysql.AbstractMysqlEventParser.setConnectionCharset(java.lang.String)]</span><br><span class="line">2021-01-22 20:12:12.803 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]</span><br><span class="line">2021-01-22 20:12:12.803 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [example/instance.properties]</span><br><span class="line">2021-01-22 20:12:13.524 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance <span class="keyword">for</span> 1-example</span><br><span class="line">2021-01-22 20:12:13.536 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --&gt; init table filter : ^.*\..*$</span><br><span class="line">2021-01-22 20:12:13.536 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --&gt; init table black filter :</span><br><span class="line">2021-01-22 20:12:13.570 [main] INFO  c.a.otter.canal.instance.core.AbstractCanalInstance - start successful....</span><br><span class="line">2021-01-22 20:12:13.801 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - ---&gt; begin to find start position, it will be long time <span class="keyword">for</span> reset or first position</span><br><span class="line">2021-01-22 20:12:13.801 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - prepare to find start position just show master status</span><br><span class="line">2021-01-22 20:12:15.240 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - ---&gt; find start position successfully, EntryPosition[included=<span class="literal">false</span>,journalName=mysql-bin.000003,position=4,serverId=1,gtid=&lt;null&gt;,timestamp=1591628633000] cost : 1408ms , the next step is binlog dump</span><br></pre></td></tr></table></figure></p>
<p>关闭<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/canal</span><br><span class="line">$ sh bin/stop.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="JAVA使用示例"><a href="#JAVA使用示例" class="headerlink" title="JAVA使用示例"></a>JAVA使用示例</h3><p>在JAVA项目中的pom.xml加入依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.otter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal.client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>JAVA代码如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hewentian.canal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.Column;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.Entry;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.EntryType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.EventType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.RowChange;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.RowData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleCanalClientExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建链接</span></span><br><span class="line">        CanalConnector connector = CanalConnectors.newSingleConnector(</span><br><span class="line">                <span class="keyword">new</span> InetSocketAddress(<span class="string">"192.168.56.113"</span>, <span class="number">11111</span>),</span><br><span class="line">                <span class="string">"example"</span>, <span class="string">"canal"</span>, <span class="string">"canal"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> batchSize = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">int</span> emptyCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connector.connect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//订阅 监控的 数据库.表</span></span><br><span class="line"><span class="comment">//            connector.subscribe("test.t_user");</span></span><br><span class="line">            connector.subscribe(<span class="string">".*\\..*"</span>);</span><br><span class="line">            connector.rollback();</span><br><span class="line">            <span class="keyword">int</span> totalEmptyCount = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (emptyCount &lt; totalEmptyCount) &#123;</span><br><span class="line">                Message message = connector.getWithoutAck(batchSize); <span class="comment">// 获取指定数量的数据</span></span><br><span class="line">                <span class="keyword">long</span> batchId = message.getId();</span><br><span class="line">                <span class="keyword">int</span> size = message.getEntries().size();</span><br><span class="line">                System.out.println(<span class="string">"batchId: "</span> + batchId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (batchId == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">                    emptyCount++;</span><br><span class="line">                    System.out.println(<span class="string">"empty count: "</span> + emptyCount);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    emptyCount = <span class="number">0</span>;</span><br><span class="line">                    <span class="comment">// System.out.printf("message[batchId=%s,size=%s] \n", batchId, size);</span></span><br><span class="line">                    printEntry(message.getEntries());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                connector.ack(batchId); <span class="comment">// 提交确认</span></span><br><span class="line">                <span class="comment">// connector.rollback(batchId); // 处理失败, 回滚数据</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"empty too many times, exit"</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printEntry</span><span class="params">(List&lt;Entry&gt; entrys)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry entry : entrys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            RowChange rowChage;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rowChage = RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ERROR ## parser of eromanga-event has an error, data:"</span> + entry.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            EventType eventType = rowChage.getEventType();</span><br><span class="line">            <span class="keyword">long</span> delayTime = <span class="keyword">new</span> Date().getTime() - entry.getHeader().getExecuteTime();</span><br><span class="line">            System.out.println(String.format(<span class="string">"================ binlog[%s:%s], name[%s,%s], eventType: %s, delayTime: %s"</span>,</span><br><span class="line">                    entry.getHeader().getLogfileName(), entry.getHeader().getLogfileOffset(),</span><br><span class="line">                    entry.getHeader().getSchemaName(), entry.getHeader().getTableName(),</span><br><span class="line">                    eventType, delayTime));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DDL数据，打印SQL</span></span><br><span class="line">            <span class="keyword">if</span> (eventType == EventType.QUERY || rowChage.getIsDdl()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"sql -----&gt; "</span> + rowChage.getSql());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DML数据，打印字段信息</span></span><br><span class="line">            <span class="keyword">for</span> (RowData rowData : rowChage.getRowDatasList()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (eventType == EventType.DELETE) &#123;</span><br><span class="line">                    printColumn(rowData.getBeforeColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventType == EventType.INSERT) &#123;</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"---------- before"</span>);</span><br><span class="line">                    printColumn(rowData.getBeforeColumnsList());</span><br><span class="line">                    System.out.println(<span class="string">"---------- after"</span>);</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printColumn</span><span class="params">(List&lt;Column&gt; columns)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Column column : columns) &#123;</span><br><span class="line">            System.out.println(column.getName() + <span class="string">" : "</span> + column.getValue() + <span class="string">", update = "</span> + column.getUpdated());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行上面的JAVA代码后，可以从控制台看到类似消息：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br></pre></td></tr></table></figure></p>
<p>此时代表当前数据库无变更数据</p>
<p>触发数据库变更<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'ID'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户名'</span>,</span><br><span class="line"> PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC <span class="keyword">COMMENT</span>=<span class="string">'用户表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">VALUE</span>(<span class="number">1</span>,<span class="string">'Scott'</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> t_user <span class="keyword">SET</span> <span class="keyword">name</span> = <span class="string">'Tiger'</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>可以从控制台中看到：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br><span class="line">empty count: <span class="number">5</span></span><br><span class="line">empty count: <span class="number">6</span></span><br><span class="line">================ binlog[mysql-bin.000003:<span class="number">2626</span>], name[test,t_user], eventType: INSERT</span><br><span class="line">id : <span class="number">1</span>, update = <span class="keyword">true</span></span><br><span class="line">name : Scott, update = <span class="keyword">true</span></span><br><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br><span class="line">empty count: <span class="number">5</span></span><br><span class="line">empty count: <span class="number">6</span></span><br><span class="line">empty count: <span class="number">7</span></span><br><span class="line">empty count: <span class="number">8</span></span><br><span class="line">================ binlog[mysql-bin.000003:<span class="number">2892</span>], name[test,t_user], eventType: UPDATE</span><br><span class="line">---------- before</span><br><span class="line">id : <span class="number">1</span>, update = <span class="keyword">false</span></span><br><span class="line">name : Scott, update = <span class="keyword">false</span></span><br><span class="line">---------- after</span><br><span class="line">id : <span class="number">1</span>, update = <span class="keyword">false</span></span><br><span class="line">name : Tiger, update = <span class="keyword">true</span></span><br><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br><span class="line">empty count: <span class="number">5</span></span><br><span class="line">empty count: <span class="number">6</span></span><br><span class="line">================ binlog[mysql-bin.000003:<span class="number">3170</span>], name[test,t_user], eventType: DELETE</span><br><span class="line">id : <span class="number">1</span>, update = <span class="keyword">false</span></span><br><span class="line">name : Tiger, update = <span class="keyword">false</span></span><br><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br><span class="line">empty count: <span class="number">5</span></span><br><span class="line">empty count: <span class="number">6</span></span><br><span class="line">empty count: <span class="number">7</span></span><br><span class="line">empty count: <span class="number">8</span></span><br></pre></td></tr></table></figure></p>
<p>完整代码在<a href="https://github.com/hewentian/study-lib/tree/main/codes/canal">这里</a>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2021/01/22/canal-note/" data-id="ckpo1mywp0007uu3kub88knfe" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/04/01/mybatis-note/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          mybatis 学习笔记
        
      </div>
    </a>
  
  
    <a href="/2020/06/08/springboot-note/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">springboot 学习笔记</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">bigdata</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/container/">container</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-server/">web server</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/01/mybatis-note/">mybatis 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/01/22/canal-note/">canal 学习笔记</a>
          </li>
        
          <li>
            <a href="/2020/06/08/springboot-note/">springboot 学习笔记</a>
          </li>
        
          <li>
            <a href="/2020/01/14/spark-note/">spark 学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/12/30/scala-note/">scala 学习笔记</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">link</h3>
    <div class="widget">
      <li><a href="https://github.com/hewentian" title="Tim Ho's Blog">我的github</a></li>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Tim Ho<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/categories/" class="mobile-nav-link">Categories</a>
  
    <a href="/tags/" class="mobile-nav-link">Tags</a>
  
    <a href="/about/" class="mobile-nav-link">About</a>
  
</nav>
    

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<!-- <script src="//code.jquery.com/jquery-2.2.4.min.js"></script> -->
<script src="/js/jquery-3.5.1.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>