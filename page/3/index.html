<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tim Ho&#39;s Technology Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="my personal blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Tim Ho&#39;s Technology Blog">
<meta property="og:url" content="https://github.com/hewentian/page/3/index.html">
<meta property="og:site_name" content="Tim Ho&#39;s Technology Blog">
<meta property="og:description" content="my personal blog">
<meta property="og:locale" content="en-US">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tim Ho&#39;s Technology Blog">
<meta name="twitter:description" content="my personal blog">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tim Ho&#39;s Technology Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心如止水</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/categories/">Categories</a>
        
          <a class="main-nav-link" href="/tags/">Tags</a>
        
          <a class="main-nav-link" href="/about/">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/hewentian"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-elasticsearch-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/18/elasticsearch-note/" class="article-date">
  <time datetime="2018-09-18T02:21:01.000Z" itemprop="datePublished">2018-09-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/18/elasticsearch-note/">elasticsearch 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>参考资料：<br><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html" title="Elasticsearch 权威指南" target="_blank" rel="noopener">Elasticsearch 权威指南</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" title="Elasticsearch Reference" target="_blank" rel="noopener">Elasticsearch Reference</a><br><a href="http://es.xiaoleilu.com/080_Structured_Search/20_contains.html" target="_blank" rel="noopener">http://es.xiaoleilu.com/080_Structured_Search/20_contains.html</a></p>
<p>首先，你必须至少有一台<code>elasticsearch</code>服务器可以使用，如果还没安装，可以参考我的上一篇 <a href="../../../../2018/09/16/elasticsearch-install" title="elasticsearch 的安装">elasticsearch 的安装</a></p>
<p>使用JAVA API来操作<code>elasticsearch</code>的例子可以在这里找到：<a href="https://github.com/hewentian/study-lib/blob/main/codes/bigdata/elasticsearch/src/main/java/com/hewentian/elasticsearch/util/ElasticsearchUtil.java">ElasticsearchUtil.java</a>、<a href="https://github.com/hewentian/study-lib/blob/main/codes/bigdata/elasticsearch/src/main/java/com/hewentian/elasticsearch/ElasticsearchDemo.java">ElasticsearchDemo.java</a></p>
<h3 id="elasticsearch使用示例"><a href="#elasticsearch使用示例" class="headerlink" title="elasticsearch使用示例"></a>elasticsearch使用示例</h3><p><code>elasticsearch</code>的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.4/elasticsearch-intro.html" target="_blank" rel="noopener">官方文档</a>写得非常详细。下面是一些快速连接：<br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.4/rest-apis.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/8.4/rest-apis.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.4/indices.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/8.4/indices.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.4/query-dsl.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/8.4/query-dsl.html</a></p>
<p>下面的示例摘自官方文档：</p>
<p><strong>下面代码的缩进尽量不要使用tab，要使用空格</strong></p>
<p>如果使用curl命令，一律要加上ca证书，下面为简洁起见，省略了：<br>        curl –cacert /home/hewentian/ProjectD/elasticsearch-8.4.0/config/certs/http_ca.crt -u elastic</p>
<h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT &quot;https://localhost:9200/my-index-000001?pretty&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000001</span><br></pre></td></tr></table></figure>
<p>创建索引的时候设置副本、分片<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;https://localhost:9200/my-index-000001&apos; -H &apos;Content-Type: application/json&apos; -d &apos;&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 3,</span><br><span class="line">    &quot;number_of_replicas&quot;: 2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000001</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 3,</span><br><span class="line">    &quot;number_of_replicas&quot;: 2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Default for number_of_shards is 1<br>Default for number_of_replicas is 1 (ie one replica for each primary shard)</p>
<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /my-index-000001</span><br></pre></td></tr></table></figure>
<h4 id="获取索引的settings"><a href="#获取索引的settings" class="headerlink" title="获取索引的settings"></a>获取索引的settings</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000001/_settings</span><br></pre></td></tr></table></figure>
<h4 id="修改索引的settings"><a href="#修改索引的settings" class="headerlink" title="修改索引的settings"></a>修改索引的settings</h4><p>elasticsearch在索引数据的时候，如果存在副本，那么主分片会将数据同时同步到副本。所以，如果当前插入大量数据，那么会对es集群造成一定的压力，所以我们最好把副本数设置为0；等数据建立完索引之后，再手动的将副本数更改到2，这样可以提高数据的索引效率。副本数最好是1-2个。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000001/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index&quot;: &#123;</span><br><span class="line">    &quot;number_of_replicas&quot; : 2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="索引创建mapping"><a href="#索引创建mapping" class="headerlink" title="索引创建mapping"></a>索引创建mapping</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000001/_mapping</span><br><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;false&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;age&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;tags&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">       &#125;,</span><br><span class="line">       &quot;birthday&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;strict_date_optional_time || epoch_millis || yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取索引的mapping"><a href="#获取索引的mapping" class="headerlink" title="获取索引的mapping"></a>获取索引的mapping</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000001/_mapping</span><br></pre></td></tr></table></figure>
<h4 id="Index-API-索引数据"><a href="#Index-API-索引数据" class="headerlink" title="Index API 索引数据"></a>Index API 索引数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /&lt;target&gt;/_doc/&lt;_id&gt;</span><br><span class="line">POST /&lt;target&gt;/_doc/</span><br><span class="line">PUT /&lt;target&gt;/_create/&lt;_id&gt;</span><br><span class="line">POST /&lt;target&gt;/_create/&lt;_id&gt;</span><br></pre></td></tr></table></figure>
<p>You cannot add new documents to a data stream using the PUT /<target>/_doc/<_id> request format. To specify a document ID, use the PUT /<target>/_create/<_id> format instead.</_id></target></_id></target></p>
<p>If the Elasticsearch security features are enabled, you must have the following index privileges for the target data stream, index, or index alias:</p>
<ol>
<li>To add or overwrite a document using the PUT /<target>/_doc/<_id> request format, you must have the create, index, or write index privilege.</_id></target></li>
<li>To add a document using the POST /<target>/_doc/, PUT /<target>/_create/<_id>, or POST /<target>/_create/<_id> request formats, you must have the create_doc, create, index, or write index privilege.</_id></target></_id></target></target></li>
<li>To automatically create a data stream or index with an index API request, you must have the auto_configure, create_index, or manage index privilege.</li>
</ol>
<p>Automatic data stream creation requires a matching index template with data stream enabled.</p>
<p>Let’s try and index some twitter like information. First, let’s index some tweets (the @twitter@ index will be created automatically):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT /twitter/_create/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;user&quot;: &quot;kimchy&quot;,</span><br><span class="line">  &quot;post_date&quot;: &quot;2009-11-15T13:12:00&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;Trying out Elasticsearch, so far so good?&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /twitter/_create/2?pretty</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot;: &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot;: &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;Another tweet, will it be indexed?&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /twitter/_create/3?pretty</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot;: &quot;elastic&quot;,</span><br><span class="line">    &quot;post_date&quot;: &quot;2010-01-15T01:46:38&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;Building the site, should be kewl&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Get-API-获取数据"><a href="#Get-API-获取数据" class="headerlink" title="Get API 获取数据"></a>Get API 获取数据</h3><p>Retrieves the specified JSON document from an index.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET &lt;index&gt;/_doc/&lt;_id&gt;</span><br><span class="line">HEAD &lt;index&gt;/_doc/&lt;_id&gt;</span><br><span class="line">GET &lt;index&gt;/_source/&lt;_id&gt;</span><br><span class="line">HEAD &lt;index&gt;/_source/&lt;_id&gt;</span><br></pre></td></tr></table></figure>
<p>Now, let’s see if the information was added by GETting it:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/_doc/1?pretty=true</span><br><span class="line">GET /twitter/_doc/2?pretty=true</span><br><span class="line">GET /twitter/_doc/3?pretty=true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">The results show below:</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;twitter&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 1,</span><br><span class="line">  &quot;_seq_no&quot;: 0,</span><br><span class="line">  &quot;_primary_term&quot;: 1,</span><br><span class="line">  &quot;found&quot;: true,</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;user&quot;: &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot;: &quot;2009-11-15T13:12:00&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;Trying out Elasticsearch, so far so good?&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;twitter&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot;: 1,</span><br><span class="line">  &quot;_seq_no&quot;: 1,</span><br><span class="line">  &quot;_primary_term&quot;: 1,</span><br><span class="line">  &quot;found&quot;: true,</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;user&quot;: &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot;: &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;Another tweet, will it be indexed?&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;twitter&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;3&quot;,</span><br><span class="line">  &quot;_version&quot;: 1,</span><br><span class="line">  &quot;_seq_no&quot;: 2,</span><br><span class="line">  &quot;_primary_term&quot;: 1,</span><br><span class="line">  &quot;found&quot;: true,</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;user&quot;: &quot;elastic&quot;,</span><br><span class="line">    &quot;post_date&quot;: &quot;2010-01-15T01:46:38&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;Building the site, should be kewl&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Update-API"><a href="#Update-API" class="headerlink" title="Update API"></a>Update API</h4><p>Updates a document using the specified script.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /&lt;index&gt;/_update/&lt;_id&gt;</span><br></pre></td></tr></table></figure></p>
<p>If both doc and script are specified, then doc is ignored. If you specify a scripted update, include the fields you want to update in the script.</p>
<p>文档是不可变的：他们不能被修改，只能被替换。 update API 必须遵循同样的规则。 从外部来看，我们在一个文档的某个位置进行部分更新。然而在内部， update API 简单使用与之前描述相同的 检索-修改-重建索引 的处理过程。区别在于这个过程发生在分片内部，这样就避免了多次请求的网络开销。通过减少检索和重建索引步骤之间的时间，我们也减少了其他进程的变更带来冲突的可能性。</p>
<p>方法一：update 请求最简单的一种形式是接收文档的一部分作为 doc 的参数， 它只是与现有的文档进行合并。对象被合并到一起，覆盖现有的字段，增加新的字段。 例如，我们增加字段 tags 和 views 到我们的博客文章，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST twitter/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">    &quot;message&quot;: &quot;Trying out Elasticsearch, so far so good? yes&quot;,</span><br><span class="line">    &quot;tags&quot;: [&quot;java&quot;],</span><br><span class="line">    &quot;views&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法二：使用脚本部分更新文档编辑<br>脚本可以在 update API中用来改变 _source 的字段内容，它在更新脚本中称为 ctx._source 。例如，我们可以使用脚本来增加博客文章中 views 的数量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">POST twitter/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot; : &#123;</span><br><span class="line">    &quot;source&quot;: &quot;ctx._source.views += params.views&quot;,</span><br><span class="line">    &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">    &quot;params&quot; : &#123;</span><br><span class="line">      &quot;views&quot; : 4</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST twitter/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">    &quot;source&quot;: &quot;ctx._source.tags.add(params.tag)&quot;,</span><br><span class="line">    &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">    &quot;params&quot;: &#123;</span><br><span class="line">      &quot;tag&quot;: &quot;lucene&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST twitter/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">    &quot;source&quot;: &quot;ctx._source.message=\&quot;yes, you are right.\&quot;&quot;,</span><br><span class="line">    &quot;lang&quot;: &quot;painless&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST twitter/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot; : &quot;ctx._source.new_field = &apos;value_of_new_field&apos;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST twitter/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot; : &quot;ctx._source.remove(&apos;new_field&apos;)&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Delete-API"><a href="#Delete-API" class="headerlink" title="Delete API"></a>Delete API</h3><p>Removes a JSON document from the specified index.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /&lt;index&gt;/_doc/&lt;_id&gt;</span><br></pre></td></tr></table></figure></p>
<p>根据查询结果删除，注意这里发的是<code>POST</code>请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000001/_delete_by_query?refresh&amp;slices=3&amp;pretty=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;user.id&quot;: &quot;elkbee&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在ES里面删除数据的时候要非常小心，如果全部都清空了，可能整个库的mapping都会有问题。这时，一些原先可以执行的语句可能会无法执行。</p>
<h3 id="Search-API-搜索"><a href="#Search-API-搜索" class="headerlink" title="Search API 搜索"></a>Search API 搜索</h3><p>Just for kicks, let’s get all the documents stored (we should see the tweet from @elastic@ as well):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/_search?pretty=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Let’s find all the tweets that @kimchy@ posted:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/_search?pretty=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;user&quot;: &quot;kimchy&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We can also do range search (the @post_date@ was automatically identified as date)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/_search?pretty=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;post_date&quot;: &#123;</span><br><span class="line">        &quot;from&quot;: &quot;2009-11-15T13:00:00&quot;,</span><br><span class="line">        &quot;to&quot;: &quot;2009-11-15T14:15:00&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在指定索引（所有索引、指定单个或多个索引）上查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000001/_create/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;user&quot;: &quot;kimchy&quot;,</span><br><span class="line">  &quot;post_date&quot;: &quot;2009-11-15T13:12:00&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;Trying out Elasticsearch, so far so good?&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_search?pretty=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /twitter,my-index-000001/_search?pretty=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">简单联合查询</span><br><span class="line">GET /user/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;name&quot;: &quot;scott&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;age&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: 10,</span><br><span class="line">              &quot;lte&quot;: 20</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">term查询</span><br><span class="line">GET /user/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;scott&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 20</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">GET /user/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;scott&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age-histogram&quot;: &#123;</span><br><span class="line">      &quot;histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;interval&quot;: 22</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /user/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;name-term&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;name.keyword&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;age-term&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查询返回某些指定的字段"><a href="#查询返回某些指定的字段" class="headerlink" title="查询返回某些指定的字段"></a>查询返回某些指定的字段</h3><p>如果查询的结果字段很多，而我们仅需要其中的某些字段的时候，我们可能通过<code>_source</code>来指定，比如我们只要user, message：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;user&quot;: &quot;elastic&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_source&quot;: [</span><br><span class="line">    &quot;user&quot;,</span><br><span class="line">    &quot;message&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;size&quot;: 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="展示所有索引"><a href="#展示所有索引" class="headerlink" title="展示所有索引"></a>展示所有索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br></pre></td></tr></table></figure>
<p>health status index           uuid                   pri rep docs.count docs.deleted store.size pri.store.size<br>yellow open   twitter         yyRB0a9LRP63voi75TEGrw   1   1          2            0      5.3kb          5.3kb<br>yellow open   my-index-000001 Rc4yqBZWRCGqXeujM7Gq2Q   1   2          0            0       225b           225b</p>
<h3 id="统计指定索引下的文档数："><a href="#统计指定索引下的文档数：" class="headerlink" title="统计指定索引下的文档数："></a>统计指定索引下的文档数：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/count/my-index-000002?v</span><br><span class="line"></span><br><span class="line">epoch      timestamp count</span><br><span class="line">1661084399 12:19:59  3</span><br></pre></td></tr></table></figure>
<h4 id="ES别名"><a href="#ES别名" class="headerlink" title="ES别名"></a>ES别名</h4><p>别名的好处，就是更换索引的时候，系统业务代码无需修改。</p>
<p>查询所有别名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _alias</span><br></pre></td></tr></table></figure></p>
<p>查询某个索引的别名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET my-index-000001/_alias</span><br></pre></td></tr></table></figure></p>
<p>查询某个别名对应的索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _alias/your_index_alia_name</span><br></pre></td></tr></table></figure></p>
<p>添加别名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;my-index-000001&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;my-idx-1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>删除别名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;remove&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;my-index-000001&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;my-idx-1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改别名，ES没有修改别名的操作，只能先删除后添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;remove&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;my-index-000001&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;my-idx-1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;my-index-000001&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;my-idx-001&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="ES中的一些概念"><a href="#ES中的一些概念" class="headerlink" title="ES中的一些概念"></a>ES中的一些概念</h4><p><strong>cluster</strong><br>代表一个集群，集群中有多个节点，其中有一个为主节点，这个主节点是可以通过选举产生的，主从节点是对于集群内部来说的。es的一个概念就是去中心化，字面上理解就是无中心节点，这是对于集群外部来说的，因为从外部来看es集群，在逻辑上是个整体，你与任何一个节点的通信和与整个es集群通信是等价的。</p>
<p><strong>shards</strong><br>代表索引分片，es可以把一个完整的索引分成多个分片，这样的好处是可以把一个大的索引拆分成多个，分布到不同的节点上。构成分布式搜索。分片的数量只能在索引创建前指定，并且索引创建后不能更改。</p>
<p><strong>replicas</strong><br>代表索引副本，es可以设置多个索引的副本，副本的作用一是提高系统的容错性，当某个节点某个分片损坏或丢失时可以从副本中恢复。二是提高es的查询效率，es会自动对搜索请求进行负载均衡。</p>
<p><strong>recovery</strong><br>代表数据恢复或叫数据重新分布，es在有节点加入或退出时会根据机器的负载对索引分片进行重新分配，挂掉的节点重新启动时也会进行数据恢复。</p>
<p><strong>river</strong><br>代表es的一个数据源，也是其它存储方式（如：数据库）同步数据到es的一个方法。它是以插件方式存在的一个es服务，通过读取river中的数据并把它索引到es中，官方的river有couchDB的，RabbitMQ的，Twitter的，Wikipedia的。</p>
<p><strong>gateway</strong><br>代表es索引快照的存储方式，es默认是先把索引存放到内存中，当内存满了时再持久化到本地硬盘。gateway对索引快照进行存储，当这个es集群关闭再重新启动时就会从gateway中读取索引备份数据。es支持多种类型的gateway，有本地文件系统（默认），分布式文件系统，Hadoop的HDFS和amazon的s3云存储服务。</p>
<p><strong>discovery.zen</strong><br>代表es的自动发现节点机制，es是一个基于p2p的系统，它先通过广播寻找存在的节点，再通过多播协议来进行节点之间的通信，同时也支持点对点的交互。</p>
<p><strong>Transport</strong><br>代表es内部节点或集群与客户端的交互方式，默认内部是使用tcp协议进行交互，同时它支持http协议（json格式）、thrift、servlet、memcached、zeroMQ等的传输协议（通过插件方式集成）。</p>
<p><strong>cluster.name</strong><br>配置es的集群名称，默认是elasticsearch，不同的集群用名字来区分，es会自动发现在同一网段下的es，配置成相同集群名字的各个节点形成一个集群。如果在同一网段下有多个集群，就可以用这个属性来区分不同的集群。</p>
<p><strong>http.port</strong><br>设置对外服务的http端口，默认为9200。不能相同，否则会冲突。</p>
<h3 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h3><p>Date formats can be customised, but if no format is specified then it uses the default:</p>
<pre><code>&quot;strict_date_optional_time||epoch_millis&quot;
</code></pre><p>if you set it like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000002</span><br><span class="line"></span><br><span class="line">PUT /my-index-000002/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;date&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">      &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>you can use the below method to set date:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000002/_create/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;date&quot;: &quot;2015-01-01 12:10:30&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my-index-000002/_create/2?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;date&quot;: &quot;2015-01-02&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my-index-000002/_create/3?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;date&quot;: 1420070400001</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h3><p>ES一次查询，最多返回10条，但hits会显示total一共有多少条，要使用from, size指定。</p>
<h3 id="深度翻页问题"><a href="#深度翻页问题" class="headerlink" title="深度翻页问题"></a>深度翻页问题</h3><h4 id="scroll-search"><a href="#scroll-search" class="headerlink" title="scroll search"></a>scroll search</h4><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html#scroll-search-results" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html#scroll-search-results</a></p>
<p>We no longer recommend using the scroll API for deep pagination. If you need to preserve the index state while paging through more than 10,000 hits, use the search_after parameter with a point in time (PIT).</p>
<p>Scrolling is not intended for real time user requests, but rather for processing large amounts of data, e.g. in order to reindex the contents of one data stream or index into a new data stream or index with a different configuration.</p>
<p>The results that are returned from a scroll request reflect the state of the data stream or index at the time that the initial search request was made, like a snapshot in time. Subsequent changes to documents (index, update or delete) will only affect later search requests.</p>
<p>In order to use scrolling, the initial search request should specify the scroll parameter in the query string, which tells Elasticsearch how long it should keep the “search context” alive (see Keeping the search context alive), eg ?scroll=1m.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000001/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 3,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;scott&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The result from the above request includes a _scroll_id, which should be passed to the scroll API in order to retrieve the next batch of results.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">  &quot;scroll&quot; : &quot;1m&quot;,</span><br><span class="line">  &quot;scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ==&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>GET or POST can be used and the URL should not include the index name — this is specified in the original search request instead.</li>
<li>The scroll parameter tells Elasticsearch to keep the search context open for another 1m.</li>
<li>The scroll_id parameter</li>
</ul>
<p>clear scroll<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DELETE /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">  &quot;scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ==&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ES默认的分页机制一个不足的地方是，比如有5010条数据，当你仅想取第5000到5010条数据的时候，ES也会将前5000条数据加载到内存当中。从价值观上来看，使用大量的CPU，内存和带宽，分类过程确实会变得非常重要。 为此，我们强烈建议不要进行深度分页。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [],</span><br><span class="line">      &quot;must_not&quot;: [],</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;wildcard&quot;: &#123;</span><br><span class="line">            &quot;orgName&quot;: &quot;*有限公司&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;wildcard&quot;: &#123;</span><br><span class="line">            &quot;orgName&quot;: &quot;*株式会社&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;from&quot;: 1000000,</span><br><span class="line">  &quot;size&quot;: 100,</span><br><span class="line">  &quot;sort&quot;: [],</span><br><span class="line">  &quot;aggs&quot;: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<pre><code>Result window is too large, from + size must be less than or equal to: [1000000] but was [1000100]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.
</code></pre><p>要解决这个问题，可以使用下面的方式来改变ES默认深度分页的<code>index.max_result_window</code>最大窗口值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index&quot;: &#123;</span><br><span class="line">    &quot;max_result_window&quot;: 500000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中my_index为要修改的index名，500000为要调整的新的窗口数</p>
<p>或者分页使用ES的scroll api实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scrollSearch</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String searchText = <span class="string">"scott"</span>;</span><br><span class="line"></span><br><span class="line">    Time time = Time.of(t -&gt; t.time(<span class="string">"1m"</span>));</span><br><span class="line"></span><br><span class="line">    ResponseBody&lt;User&gt; response = elasticsearchClient.search(s -&gt; s</span><br><span class="line">                    .index(indexName)</span><br><span class="line">                    .query(q -&gt; q</span><br><span class="line">                            .match(t -&gt; t</span><br><span class="line">                                    .field(<span class="string">"name"</span>)</span><br><span class="line">                                    .query(searchText)</span><br><span class="line">                            )</span><br><span class="line">                    )</span><br><span class="line">                    .scroll(time)</span><br><span class="line">                    .sort(SortOptions.of(so -&gt; so.field(FieldSort.of(f -&gt; f.field(<span class="string">"age"</span>).order(SortOrder.Asc)))))</span><br><span class="line">                    .size(<span class="number">3</span>)</span><br><span class="line">            , User.class</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    TotalHits total = response.hits().total();</span><br><span class="line">    <span class="keyword">boolean</span> isExactResult = total.relation() == TotalHitsRelation.Eq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isExactResult) &#123;</span><br><span class="line">        System.out.println(<span class="string">"There are "</span> + total.value() + <span class="string">" results"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"There are more than "</span> + total.value() + <span class="string">" results"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"-----------------------------------"</span>);</span><br><span class="line">        List&lt;Hit&lt;User&gt;&gt; hits = response.hits().hits();</span><br><span class="line">        <span class="keyword">for</span> (Hit&lt;User&gt; hit : hits) &#123;</span><br><span class="line">            User user = hit.source();</span><br><span class="line">            System.out.println(<span class="string">"Found user: "</span> + user + <span class="string">", score "</span> + hit.score());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String scrollId = response.scrollId();</span><br><span class="line">        System.out.println(<span class="string">"scrollId: "</span> + scrollId);</span><br><span class="line"></span><br><span class="line">        response = elasticsearchClient.scroll(s -&gt; s.scrollId(scrollId).scroll(time), User.class);</span><br><span class="line">    &#125; <span class="keyword">while</span> (response.hits().hits().size() != <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="search-after-pit-search"><a href="#search-after-pit-search" class="headerlink" title="search_after(pit search)"></a>search_after(pit search)</h4><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html#search-after" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html#search-after</a></p>
<p>Avoid using from and size to page too deeply or request too many results at once. Search requests usually span multiple shards. Each shard must load its requested hits and the hits for any previous pages into memory. For deep pages or large sets of results, these operations can significantly increase memory and CPU usage, resulting in degraded performance or node failures.</p>
<p>By default, you cannot use from and size to page through more than 10,000 hits. This limit is a safeguard set by the index.max_result_window index setting. If you need to page through more than 10,000 hits, use the search_after parameter instead.</p>
<p>You can use the search_after parameter to retrieve the next page of hits using a set of sort values from the previous page.</p>
<p>Using search_after requires multiple search requests with the same query and sort values. The first step is to run an initial request.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000001/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 3,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;scott&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To retrieve the next page of results, repeat the request, take the sort values from the last hit, and insert those into the search_after array:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000001/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 3,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;scott&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;search_after&quot;: [20],</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Repeat this process by updating the search_after array every time you retrieve a new page of results. If a refresh occurs between these requests, the order of your results may change, causing inconsistent results across pages. To prevent this, you can create a point in time (PIT) to preserve the current index state over your searches.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000001/_pit?keep_alive=1m</span><br></pre></td></tr></table></figure>
<p>The API returns a PIT ID.</p>
<p>{<br>  “id”: “o93qAwEEdXNlchZfVWRURzY0UFJISzljbnZPTzhlaXhRABZWd1A3b3BIM1NpV1pTdHNsYmxENm5nAAAAAAAAAz-XFmNtX1lpSE9hVEx5T1Q2anRHQ1NZVWcAARZfVWRURzY0UFJISzljbnZPTzhlaXhRAAA=”<br>}</p>
<p>To get the first page of results, submit a search request with a sort argument. If using a PIT, specify the PIT ID in the pit.id parameter and omit the target data stream or index from the request path.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 3,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;scott&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;pit&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;o93qAwEEdXNlchZfVWRURzY0UFJISzljbnZPTzhlaXhRABZWd1A3b3BIM1NpV1pTdHNsYmxENm5nAAAAAAAAAz-XFmNtX1lpSE9hVEx5T1Q2anRHQ1NZVWcAARZfVWRURzY0UFJISzljbnZPTzhlaXhRAAA=&quot;,</span><br><span class="line">    &quot;keep_alive&quot;: &quot;1m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>To get the next page of results, rerun the previous search using the last hit’s sort values (including the tiebreaker) as the search_after argument. If using a PIT, use the latest PIT ID in the pit.id parameter. The search’s query and sort arguments must remain unchanged. If provided, the from argument must be 0 (default) or -1.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 3,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;scott&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;pit&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: &quot;o93qAwEEdXNlchZfVWRURzY0UFJISzljbnZPTzhlaXhRABZWd1A3b3BIM1NpV1pTdHNsYmxENm5nAAAAAAAAAz-XFmNtX1lpSE9hVEx5T1Q2anRHQ1NZVWcAARZfVWRURzY0UFJISzljbnZPTzhlaXhRAAA=&quot;,</span><br><span class="line">    &quot;keep_alive&quot;: &quot;1m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;search_after&quot;: [20, 7],</span><br><span class="line">  &quot;track_total_hits&quot;: false,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>When you’re finished, you should delete your PIT.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DELETE /_pit</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot; : &quot;o93qAwEEdXNlchZfVWRURzY0UFJISzljbnZPTzhlaXhRABZWd1A3b3BIM1NpV1pTdHNsYmxENm5nAAAAAAAAAz-XFmNtX1lpSE9hVEx5T1Q2anRHQ1NZVWcAARZfVWRURzY0UFJISzljbnZPTzhlaXhRAAA=&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="pinyin分词的使用"><a href="#pinyin分词的使用" class="headerlink" title="pinyin分词的使用"></a>pinyin分词的使用</h3><p>1.1 使用pinyin分词器创建一个索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000003/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;pinyin_analyzer&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;my_pinyin&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;tokenizer&quot;: &#123;</span><br><span class="line">        &quot;my_pinyin&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">          &quot;keep_separate_first_letter&quot;: false,</span><br><span class="line">          &quot;keep_full_pinyin&quot;: true,</span><br><span class="line">          &quot;keep_original&quot;: true,</span><br><span class="line">          &quot;limit_first_letter_length&quot;: 16,</span><br><span class="line">          &quot;lowercase&quot;: true,</span><br><span class="line">          &quot;remove_duplicated_term&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.2 测试分词器，分析一个中文名字，例如中：刘德华<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000003/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: [</span><br><span class="line">    &quot;刘德华&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;analyzer&quot;: &quot;pinyin_analyzer&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;liu&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;刘德华&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;ldh&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;de&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.3 创建mapping<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000003/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">      &quot;fields&quot;: &#123;</span><br><span class="line">        &quot;pinyin&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;store&quot;: false,</span><br><span class="line">          &quot;term_vector&quot;: &quot;with_offsets&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;pinyin_analyzer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.4 索引数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000003/_create/andy</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;刘德华&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.5 查询全部数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000003/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 891,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: &#123;</span><br><span class="line">      &quot;value&quot;: 1,</span><br><span class="line">      &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot;: 1,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;my-index-000003&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;andy&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;刘德华&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.6 使用拼音分词搜索，下面的搜索方式，都能搜索到数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000003/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;刘德华&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my-index-000003/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;刘德华&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my-index-000003/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;ldh&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my-index-000003/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;liu&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my-index-000003/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;de hua&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.1 使用pinyin Token Filter，首先创建一个索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000004/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;user_name_analyzer&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;whitespace&quot;,</span><br><span class="line">          &quot;filter&quot;: &quot;pinyin_first_letter_and_full_pinyin_filter&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;pinyin_first_letter_and_full_pinyin_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">          &quot;keep_first_letter&quot;: true,</span><br><span class="line">          &quot;keep_full_pinyin&quot;: true,</span><br><span class="line">          &quot;keep_none_chinese&quot;: true,</span><br><span class="line">          &quot;keep_original&quot;: false,</span><br><span class="line">          &quot;limit_first_letter_length&quot;: 16,</span><br><span class="line">          &quot;lowercase&quot;: true,</span><br><span class="line">          &quot;trim_whitespace&quot;: true,</span><br><span class="line">          &quot;keep_none_chinese_in_first_letter&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.2 测试分词器，分析一个中文名字，例如中：刘德华 张学友 郭富城 黎明 四大天王<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000004/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: [</span><br><span class="line">    &quot;刘德华 张学友 郭富城 黎明 四大天王&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;analyzer&quot;: &quot;user_name_analyzer&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;liu&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 3,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;ldh&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 3,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;de&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 3,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 3,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;zhang&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 4,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;xue&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 4,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;you&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 4,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;zxy&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 4,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;guo&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 8,</span><br><span class="line">      &quot;end_offset&quot;: 11,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 6</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;fu&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 8,</span><br><span class="line">      &quot;end_offset&quot;: 11,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 7</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;cheng&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 8,</span><br><span class="line">      &quot;end_offset&quot;: 11,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 8</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;gfc&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 8,</span><br><span class="line">      &quot;end_offset&quot;: 11,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 8</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;li&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 12,</span><br><span class="line">      &quot;end_offset&quot;: 14,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 9</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;ming&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 12,</span><br><span class="line">      &quot;end_offset&quot;: 14,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 10</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;lm&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 12,</span><br><span class="line">      &quot;end_offset&quot;: 14,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 10</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;si&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 15,</span><br><span class="line">      &quot;end_offset&quot;: 19,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 11</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;da&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 15,</span><br><span class="line">      &quot;end_offset&quot;: 19,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 12</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;tian&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 15,</span><br><span class="line">      &quot;end_offset&quot;: 19,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 13</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;wang&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 15,</span><br><span class="line">      &quot;end_offset&quot;: 19,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 14</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;sdtw&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 15,</span><br><span class="line">      &quot;end_offset&quot;: 19,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 14</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.1 使用phrase query，首先创建一个索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000005/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;pinyin_analyzer&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;my_pinyin&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;tokenizer&quot;: &#123;</span><br><span class="line">        &quot;my_pinyin&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">          &quot;keep_first_letter&quot;: false,</span><br><span class="line">          &quot;keep_separate_first_letter&quot;: false,</span><br><span class="line">          &quot;keep_full_pinyin&quot;: true,</span><br><span class="line">          &quot;keep_original&quot;: false,</span><br><span class="line">          &quot;limit_first_letter_length&quot;: 16,</span><br><span class="line">          &quot;lowercase&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.2 测试分词器，分析一个中文名字，例如中：刘德华<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000005/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: [</span><br><span class="line">    &quot;刘德华&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;analyzer&quot;: &quot;pinyin_analyzer&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;liu&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;de&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.3 索引数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000005/_create/andy</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;刘德华&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.4 使用分词搜索，使用下面的搜索方式，是搜索不到数据的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000005/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;刘德华&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.1 另一种使用phrase query，首先创建一个索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000006/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;pinyin_analyzer&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;my_pinyin&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;tokenizer&quot;: &#123;</span><br><span class="line">        &quot;my_pinyin&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">          &quot;keep_first_letter&quot;: true,</span><br><span class="line">          &quot;keep_separate_first_letter&quot;: true,</span><br><span class="line">          &quot;keep_full_pinyin&quot;: true,</span><br><span class="line">          &quot;keep_original&quot;: false,</span><br><span class="line">          &quot;limit_first_letter_length&quot;: 16,</span><br><span class="line">          &quot;lowercase&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.2 创建mapping<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000006/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">      &quot;fields&quot;: &#123;</span><br><span class="line">        &quot;pinyin&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;store&quot;: false,</span><br><span class="line">          &quot;term_vector&quot;: &quot;with_offsets&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;pinyin_analyzer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.3 测试分词器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000006/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: [</span><br><span class="line">    &quot;刘德华&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;analyzer&quot;: &quot;pinyin_analyzer&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;l&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;liu&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;ldh&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;d&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;de&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;h&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 0,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.4 索引数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000006/_create/andy</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;刘德华&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.5 搜索数据，下面的搜索方式，都能搜索到数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000006/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;刘德h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my-index-000006/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;刘dh&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my-index-000006/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;liudh&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my-index-000006/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;liudeh&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my-index-000006/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;name.pinyin&quot;: &quot;liude华&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ik分词的使用"><a href="#ik分词的使用" class="headerlink" title="ik分词的使用"></a>ik分词的使用</h3><p><a href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>ik_max_word 和 ik_smart 的区别<br>ik_max_word：会将文本做最细粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,中华人民,中华,华人,人民共和国,人民,人,民,共和国,共和,和,国国,国歌”，会穷尽各种可能的组合，适合 Term Query；<br>ik_smart：会做最粗粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,国歌”，适合 Phrase 查询。</p>
<p>1.1 使用ik分词器创建一个索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000007/</span><br></pre></td></tr></table></figure></p>
<p>1.2 创建mapping<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000007/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;content&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">      &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.3 测试分词器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000007/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: [</span><br><span class="line">    &quot;中华人民共和国MN&quot;,</span><br><span class="line">    &quot;刘德华&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;tokenizer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;中华人民共和国&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;中华人民&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 4,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;中华&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 2,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;华人&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 1,</span><br><span class="line">      &quot;end_offset&quot;: 3,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;人民共和国&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 2,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;人民&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 2,</span><br><span class="line">      &quot;end_offset&quot;: 4,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;共和国&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 4,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 6</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;共和&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 4,</span><br><span class="line">      &quot;end_offset&quot;: 6,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 7</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;国&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 6,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_CHAR&quot;,</span><br><span class="line">      &quot;position&quot;: 8</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;mn&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 7,</span><br><span class="line">      &quot;end_offset&quot;: 9,</span><br><span class="line">      &quot;type&quot;: &quot;ENGLISH&quot;,</span><br><span class="line">      &quot;position&quot;: 9</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;刘德华&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 10,</span><br><span class="line">      &quot;end_offset&quot;: 13,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 110</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.4 索引数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000007/_create/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;美国留给叙利亚的是个烂摊子吗&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /my-index-000007/_create/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;公安厅：各地校车将享最高路权&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /my-index-000007/_create/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;中日渔警冲突调查：日警平均每天扣1艘中国渔船&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /my-index-000007/_create/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;中国驻纽约领事馆遭亚裔男子枪击 嫌犯已自首&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.5 搜索数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000007/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &quot;中国&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;pre_tags&quot;: [</span><br><span class="line">      &quot;&lt;tag1&gt;&quot;,</span><br><span class="line">      &quot;&lt;tag2&gt;&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;post_tags&quot;: [</span><br><span class="line">      &quot;&lt;/tag1&gt;&quot;,</span><br><span class="line">      &quot;&lt;/tag2&gt;&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 70,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: &#123;</span><br><span class="line">      &quot;value&quot;: 2,</span><br><span class="line">      &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot;: 0.642793,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;my-index-000007&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot;: 0.642793,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &quot;中日渔警冲突调查：日警平均每天扣1艘中国渔船&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;highlight&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: [</span><br><span class="line">            &quot;中日渔警冲突调查：日警平均每天扣1艘&lt;tag1&gt;中国&lt;/tag1&gt;渔船&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;my-index-000007&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;4&quot;,</span><br><span class="line">        &quot;_score&quot;: 0.642793,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &quot;中国驻纽约领事馆遭亚裔男子枪击 嫌犯已自首&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;highlight&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: [</span><br><span class="line">            &quot;&lt;tag1&gt;中国&lt;/tag1&gt;驻纽约领事馆遭亚裔男子枪击 嫌犯已自首&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="pinyin分词、ik分词联合使用"><a href="#pinyin分词、ik分词联合使用" class="headerlink" title="pinyin分词、ik分词联合使用"></a>pinyin分词、ik分词联合使用</h3><p>1.1 首先创建一个索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index-000008/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;ik_smart_pinyin&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">          &quot;filter&quot;: &quot;pinyin_first_letter_and_full_pinyin_filter&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ik_max_pinyin&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">          &quot;filter&quot;: &quot;pinyin_first_letter_and_full_pinyin_filter&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;pinyin_first_letter_and_full_pinyin_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">          &quot;keep_separate_first_letter&quot;: false,</span><br><span class="line">          &quot;keep_full_pinyin&quot;: true,</span><br><span class="line">          &quot;keep_original&quot;: true,</span><br><span class="line">          &quot;limit_first_letter_length&quot;: 16,</span><br><span class="line">          &quot;lowercase&quot;: true,</span><br><span class="line">          &quot;remove_duplicated_term&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.2 创建mapping<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000008/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;content&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;ik_smart_pinyin&quot;,</span><br><span class="line">      &quot;search_analyzer&quot;: &quot;ik_max_pinyin&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.3 测试分词器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000008/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: [</span><br><span class="line">    &quot;中华人民共和国MN&quot;,</span><br><span class="line">    &quot;刘德华&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart_pinyin&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;zhong&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;ren&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;min&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;gong&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;he&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;guo&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 6</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;中华人民共和国&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 6</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;zhrmghg&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 6</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;m&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 7,</span><br><span class="line">      &quot;end_offset&quot;: 9,</span><br><span class="line">      &quot;type&quot;: &quot;ENGLISH&quot;,</span><br><span class="line">      &quot;position&quot;: 7</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;n&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 7,</span><br><span class="line">      &quot;end_offset&quot;: 9,</span><br><span class="line">      &quot;type&quot;: &quot;ENGLISH&quot;,</span><br><span class="line">      &quot;position&quot;: 8</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;mn&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 7,</span><br><span class="line">      &quot;end_offset&quot;: 9,</span><br><span class="line">      &quot;type&quot;: &quot;ENGLISH&quot;,</span><br><span class="line">      &quot;position&quot;: 8</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;liu&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 10,</span><br><span class="line">      &quot;end_offset&quot;: 13,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 109</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;de&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 10,</span><br><span class="line">      &quot;end_offset&quot;: 13,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 110</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 10,</span><br><span class="line">      &quot;end_offset&quot;: 13,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 111</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;刘德华&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 10,</span><br><span class="line">      &quot;end_offset&quot;: 13,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 111</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;ldh&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 10,</span><br><span class="line">      &quot;end_offset&quot;: 13,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 111</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.4 索引数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /my-index-000008/_create/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;香港的刘德华&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /my-index-000008/_create/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;香港的郭富城&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /my-index-000008/_create/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;香港的林忆莲&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /my-index-000008/_create/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;香港的周星驰&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.5 搜索数据，下面的搜索方式，都能搜索到数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">GET /my-index-000008/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;content&quot;: &quot;liu&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my-index-000008/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;content&quot;: &quot;刘&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="以下是一些常用查询："><a href="#以下是一些常用查询：" class="headerlink" title="以下是一些常用查询："></a>以下是一些常用查询：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;_id&quot;: &quot;http://www.abc.com&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;_id&quot;: &quot;http://www.csdn.net/tag/scala&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &quot;*canton*&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;name&quot;: &quot;Tim&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;should&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                  &quot;title&quot;: &#123;</span><br><span class="line">                    &quot;minimum_should_match&quot;: &quot;100%&quot;,</span><br><span class="line">                    &quot;query&quot;: &quot;Air Quality&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                  &quot;body_text&quot;: &#123;</span><br><span class="line">                    &quot;minimum_should_match&quot;: &quot;100%&quot;,</span><br><span class="line">                    &quot;query&quot;: &quot;Air Quality&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;wildcard&quot;: &#123;</span><br><span class="line">            &quot;user_ids&quot;: &quot;*760aa069-2ed2-40d6-89da-f62e83f82887*&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must_not&quot;: [],</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;should&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;match_phrase&quot;: &#123;</span><br><span class="line">                  &quot;app_type.title&quot;: &#123;</span><br><span class="line">                    &quot;query&quot;: &quot;china&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;match_phrase&quot;: &#123;</span><br><span class="line">                  &quot;app_type.title&quot;: &#123;</span><br><span class="line">                    &quot;query&quot;: &quot;中国&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;should&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;match_phrase&quot;: &#123;</span><br><span class="line">                  &quot;app_type.body_text&quot;: &#123;</span><br><span class="line">                    &quot;query&quot;: &quot;china&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;match_phrase&quot;: &#123;</span><br><span class="line">                  &quot;app_type.body_text&quot;: &#123;</span><br><span class="line">                    &quot;query&quot;: &quot;中国&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must&quot;: [],</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">          &quot;should&quot;: [],</span><br><span class="line">          &quot;must&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;range&quot;: &#123;</span><br><span class="line">                &quot;updatetime&quot;: &#123;</span><br><span class="line">                  &quot;lte&quot;: 1474617163524</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;wildcard&quot;: &#123;</span><br><span class="line">                &quot;user_ids&quot;: &quot;*760aa069-2ed2-40d6-89da-f62e83f82887*&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 20,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;updatetime_6h&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_score&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;:&#123;</span><br><span class="line">      &quot;must&quot;:[&#123;</span><br><span class="line">        &quot;match&quot;:&#123;&quot;birthYear&quot;:1989&#125;&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggregations&quot; : &#123;</span><br><span class="line">    &quot;CATEGORY&quot; : &#123;</span><br><span class="line">      &quot;terms&quot; : &#123;</span><br><span class="line">        &quot;field&quot; : &quot;deposit&quot;,</span><br><span class="line">        &quot;size&quot; : 100,</span><br><span class="line">        &quot;order&quot; : &#123;</span><br><span class="line">          &quot;_count&quot; : &quot;desc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;:0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;NAME&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;username&quot;,</span><br><span class="line">        &quot;size&quot;: 100</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;wildcard&quot;: &#123;</span><br><span class="line">            &quot;username&quot;: &#123;</span><br><span class="line">              &quot;value&quot;: &quot;*文*&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;:100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;city&quot;: &quot;深圳市&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;should&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                  &quot;industry&quot;: &quot;制造业&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                  &quot;industry&quot;: &quot;通用设备制造业&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                  &quot;industry&quot;: &quot;专用设备制造业&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;patentCount&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: 5</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;regCapital&quot;: &#123;</span><br><span class="line">               &quot;gte&quot;: 200,</span><br><span class="line">              &quot;lte&quot;: 5000</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;isGaoXin&quot;: 0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;regYear&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: 2015,</span><br><span class="line">              &quot;lte&quot;: 2017</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;exists&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;username&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>未完待续……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/09/18/elasticsearch-note/" data-id="clf9thvlb000r6h3ki69uhgfx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elasticsearch/">elasticsearch</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-elasticsearch-install" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/16/elasticsearch-install/" class="article-date">
  <time datetime="2018-09-16T03:18:34.000Z" itemprop="datePublished">2018-09-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/16/elasticsearch-install/">elasticsearch 的安装</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="单节点的安装"><a href="#单节点的安装" class="headerlink" title="单节点的安装"></a>单节点的安装</h3><p>本文将说下<code>elasticsearch</code>的单节点安装，我的机器为<code>Ubuntu 18.04 LTS</code>，当前用户为<code>hadoop</code></p>
<p>首先，我们要将<code>elasticsearch</code>安装包下载回来，截止本文写时，它的最新版本为<code>8.4.0</code>，可以在它的<a href="https://www.elastic.co/downloads/elasticsearch" target="_blank" rel="noopener">官网</a>下载。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/</span><br><span class="line">$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.4.0-linux-x86_64.tar.gz</span><br><span class="line">$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.4.0-linux-x86_64.tar.gz.sha512</span><br><span class="line"></span><br><span class="line">验证下载文件的完整性</span><br><span class="line">$ sha512sum -c elasticsearch-8.4.0-linux-x86_64.tar.gz.sha512</span><br><span class="line">elasticsearch-8.4.0-linux-x86_64.tar.gz: OK</span><br><span class="line"></span><br><span class="line">$ tar -xzf elasticsearch-8.4.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>
<p>对<code>elasticsearch</code>进行设置（目前是单节点，所以也可以不对<code>elasticsearch.yml</code>进行设置，可直接跳过）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/elasticsearch-8.4.0/config</span><br><span class="line">$ vi elasticsearch.yml 		     <span class="comment"># 增加下面的配置</span></span><br><span class="line"></span><br><span class="line">cluster.name: hewentian-cluster	 <span class="comment"># 配置集群的名字</span></span><br><span class="line">node.name: node-1		         <span class="comment"># 配置集群下的节点的名字</span></span><br><span class="line"></span><br><span class="line">network.host: 192.168.56.113	 <span class="comment"># 设置本机IP地址，这里可不设置，但是在集群环境中必须设置。如果在这里指定了IP，则localhost可能无法使用，这个要注意</span></span><br><span class="line"></span><br><span class="line">http.port: 9200			         <span class="comment"># 默认也是这个端口</span></span><br><span class="line"></span><br><span class="line">下面的配置保持默认即可，它会将数据和日志保存到elasticsearch-8.4.0目录下的data和logs目录</span><br><span class="line"><span class="comment">#path.data: /path/to/data</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># Path to log files:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#path.logs: /path/to/logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cluster.initial_master_nodes: ["node-1"]  # 启动后，这个会自动产生</span></span><br></pre></td></tr></table></figure></p>
<p>内存大小的设置，根据机器内存大小而设置，一般不超过系统总内存的一半：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/elasticsearch-8.4.0/config</span><br><span class="line">$ vi jvm.options</span><br><span class="line"></span><br><span class="line">-Xms1g</span><br><span class="line">-Xmx1g</span><br></pre></td></tr></table></figure></p>
<p><strong>Do not modify the root jvm.options file. Use files in jvm.options.d/ instead.</strong></p>
<p>To configure the heap size, add the Xms and Xmx JVM arguments to a custom JVM options file with the extension <code>.options</code> and store it in the <code>jvm.options.d/</code> directory. For example, to set the maximum heap size to 2GB, set both Xms and Xmx to 2g:<br>-Xms2g<br>-Xmx2g</p>
<p><strong>cluster.initial_master_nodes</strong><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/modules-discovery-settings.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/8.5/modules-discovery-settings.html</a></p>
<p>(Static) Sets the initial set of master-eligible nodes in a brand-new cluster. By default this list is empty, meaning that this node expects to join a cluster that has already been bootstrapped. Remove this setting once the cluster has formed. Do not use this setting when restarting nodes or when adding new nodes to an existing cluster.</p>
<h3 id="修改linux系统参数"><a href="#修改linux系统参数" class="headerlink" title="修改linux系统参数"></a>修改linux系统参数</h3><p>你在安装的过程中，有可能会遇到下面的问题之一：</p>
<pre><code>bootstrap check failure [1] of [2]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]
bootstrap check failure [2] of [2]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
</code></pre><p>解决方法如下，就算它不报上面的错误，我们也应该根据机器的性能，对下面的选项作相应配置（下面是根据我机器的情况作的配置）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ su root			            <span class="comment"># 必须在 root 下才有权限修改系统配置文件</span></span><br><span class="line">Password: </span><br><span class="line">$ vi /etc/security/limits.conf	<span class="comment"># 添加如下配置</span></span><br><span class="line">* soft nofile 65536             <span class="comment"># 上面第一个错误有提示</span></span><br><span class="line">* hard nofile 131072            <span class="comment"># 一般为 soft nofile 的2倍</span></span><br><span class="line">* soft nproc 4096               <span class="comment"># 这个设置线程数</span></span><br><span class="line">* hard nproc 8192</span><br><span class="line"></span><br><span class="line">$ vi /etc/sysctl.conf		    <span class="comment"># 添加如下配置</span></span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"></span><br><span class="line">$ sysctl -p			            <span class="comment"># 最后执行这个命令，你会见到如下输出</span></span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">exit</span>				            <span class="comment"># 退出 root</span></span><br></pre></td></tr></table></figure></p>
<p>设置好之后，要重新登录，才会生效。</p>
<h3 id="启动elasticsearch"><a href="#启动elasticsearch" class="headerlink" title="启动elasticsearch"></a>启动elasticsearch</h3><p>注意，不能以root帐号启动elasticsearch。要用普通用户，并且要以 sudo 方式启动。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/elasticsearch-8.4.0/</span><br><span class="line">$ sudo su hadoop</span><br><span class="line">$ ./bin/elasticsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">✅ Elasticsearch security features have been automatically configured!</span><br><span class="line">✅ Authentication is enabled and cluster connections are encrypted.</span><br><span class="line"></span><br><span class="line">ℹ️  Password <span class="keyword">for</span> the elastic user (reset with `bin/elasticsearch-reset-password -u elastic`):</span><br><span class="line">  wnh=7lOdD*uF=TpYny2x</span><br><span class="line"></span><br><span class="line">ℹ️  HTTP CA certificate SHA-256 fingerprint:</span><br><span class="line">  da2e917d8c6cf3b1d32068092cff23985ad4fcc0c1eb0e6a215744ca6f1cc4e4</span><br><span class="line"></span><br><span class="line">ℹ️  Configure Kibana to use this cluster:</span><br><span class="line">• Run Kibana and click the configuration link <span class="keyword">in</span> the terminal when Kibana starts.</span><br><span class="line">• Copy the following enrollment token and paste it into Kibana <span class="keyword">in</span> your browser (valid <span class="keyword">for</span> the next 30 minutes):</span><br><span class="line">  eyJ2ZXIiOiI4LjQuMCIsImFkciI6WyIxOTIuMTY4LjU2LjExMzo5MjAwIl0sImZnciI6ImRhMmU5MTdkOGM2Y2YzYjFkMzIwNjgwOTJjZmYyMzk4NWFkNGZjYzBjMWViMGU2YTIxNTc0NGNhNmYxY2M0ZTQiLCJrZXkiOiI1Z3lUdDRJQnVuYXpXOHNIdFFYUjpNZzdYSzRlLVFTbUxCQnVOQm5qNXhRIn0=</span><br><span class="line"></span><br><span class="line">ℹ️ Configure other nodes to join this cluster:</span><br><span class="line">• Copy the following enrollment token and start new Elasticsearch nodes with `bin/elasticsearch --enrollment-token &lt;token&gt;` (valid <span class="keyword">for</span> the next 30 minutes):</span><br><span class="line">  eyJ2ZXIiOiI4LjQuMCIsImFkciI6WyIxOTIuMTY4LjU2LjExMzo5MjAwIl0sImZnciI6ImRhMmU5MTdkOGM2Y2YzYjFkMzIwNjgwOTJjZmYyMzk4NWFkNGZjYzBjMWViMGU2YTIxNTc0NGNhNmYxY2M0ZTQiLCJrZXkiOiI1d3lUdDRJQnVuYXpXOHNIdFFYazpoRzBUVzlwZVE4eWtJLW5Sdll0ZGFRIn0=</span><br><span class="line"></span><br><span class="line">  If you<span class="string">'re running in Docker, copy the enrollment token and run:</span></span><br><span class="line"><span class="string">  `docker run -e "ENROLLMENT_TOKEN=&lt;token&gt;" docker.elastic.co/elasticsearch/elasticsearch:8.4.0`</span></span><br></pre></td></tr></table></figure>
<p>You can complete the following actions at any time:<br>Reset the password of the elastic built-in superuser with<br>‘bin/elasticsearch-reset-password -u elastic’.</p>
<p>Generate an enrollment token for Kibana instances with<br>‘bin/elasticsearch-create-enrollment-token -s kibana’.</p>
<p>Generate an enrollment token for Elasticsearch nodes with<br>‘bin/elasticsearch-create-enrollment-token -s node’.</p>
<p>我们也可以在启动的时候加上参数<code>-d</code>，以后台运行方式启动：<code>./bin/elasticsearch -d -p pid</code>，进程id将会记录在<code>$ES_HOME</code>目录下，相应的停止命令为：<code>pkill -F pid</code>。</p>
<p>这样单节点版本的<code>elasticsearch</code>就安装完了。</p>
<h3 id="检查elasticsearch是否正确启动"><a href="#检查elasticsearch是否正确启动" class="headerlink" title="检查elasticsearch是否正确启动"></a>检查elasticsearch是否正确启动</h3><p>使用命令<br>        curl –cacert $ES_HOME/config/certs/http_ca.crt -u elastic <a href="https://localhost:9200" target="_blank" rel="noopener">https://localhost:9200</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl --cacert /home/hadoop/elasticsearch-8.4.0/config/certs/http_ca.crt -u elastic https://192.168.56.113:9200</span><br><span class="line">Enter host password <span class="keyword">for</span> user <span class="string">'elastic'</span>:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"node-1"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"hewentian-cluster"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"XnyeZ-UQSWmyocWOUSgyKA"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"8.4.0"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"tar"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"f56126089ca4db89b631901ad7cce0a8e10e2fe5"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2022-08-19T19:23:42.954591481Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"9.3.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"7.17.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"7.0.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你见到上面的输出，证明安装成功了。</p>
<h3 id="安装kibana"><a href="#安装kibana" class="headerlink" title="安装kibana"></a>安装kibana</h3><p>kibana的版本，要和elasticsearch的版本一致，我们都下载<code>8.4.0</code>，可以在它的<a href="https://www.elastic.co/downloads/kibana" target="_blank" rel="noopener">官网</a>下载。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/</span><br><span class="line">$ wget https://artifacts.elastic.co/downloads/kibana/kibana-8.4.0-linux-x86_64.tar.gz</span><br><span class="line">$ wget https://artifacts.elastic.co/downloads/kibana/kibana-8.4.0-linux-x86_64.tar.gz.sha512</span><br><span class="line"></span><br><span class="line">验证下载文件的完整性</span><br><span class="line">$ sha512sum -c kibana-8.4.0-linux-x86_64.tar.gz.sha512</span><br><span class="line">kibana-8.4.0-linux-x86_64.tar.gz: OK</span><br><span class="line"></span><br><span class="line">$ tar -xzf kibana-8.4.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>
<p>配置kibana<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vi /home/hadoop/kibana-8.4.0/config/kibana.yml</span><br><span class="line"></span><br><span class="line">server.port: 5601</span><br><span class="line">server.host: <span class="string">"192.168.56.113"</span></span><br></pre></td></tr></table></figure></p>
<p>启动 Kibana<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ /home/hadoop/kibana-8.4.0/</span><br><span class="line">$ ./bin/kibana</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[2022-08-20T07:33:26.679+08:00][INFO ][node] Kibana process configured with roles: [background_tasks, ui]</span><br><span class="line">[2022-08-20T07:33:36.041+08:00][INFO ][http.server.Preboot] http server running at http://192.168.56.113:5601</span><br><span class="line">[2022-08-20T07:33:36.141+08:00][INFO ][plugins-system.preboot] Setting up [1] plugins: [interactiveSetup]</span><br><span class="line">[2022-08-20T07:33:36.144+08:00][INFO ][preboot] <span class="string">"interactiveSetup"</span> plugin is holding setup: Validating Elasticsearch connection configuration…</span><br><span class="line">[2022-08-20T07:33:36.214+08:00][INFO ][root] Holding setup until preboot stage is completed.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i Kibana has not been configured.</span><br><span class="line"></span><br><span class="line">Go to http://192.168.56.113:5601/?code=299251 to get started.</span><br></pre></td></tr></table></figure></p>
<p>也可以以后台方式启动kibana：<code>nohup ./bin/kibana 2&gt;&amp;1 &amp;</code></p>
<p>打开 Kibana</p>
<ol>
<li>在浏览器打开<code>http://192.168.56.113:5601</code>，输入Enrollment token即可连接到 Elasticsearch。</li>
<li>如果token过期，则要进入<code>$ES_HOME</code>目录，使用命令<code>bin/elasticsearch-create-enrollment-token -s kibana</code>重新生成一个token。</li>
<li>用新生成的 token 粘贴到 kibana 页面上，此时kibana后台会产生一个验证码，类似：Your verification code is:  952 566，在页面上输入。</li>
<li>最后，输入elasticsearch的用户名、密码，即可登录到kibana。</li>
</ol>
<p>登录 Kibana 后，点击左则菜单的”Dev Tools”，即可以打开搜索的窗口。</p>
<h3 id="集群的安装"><a href="#集群的安装" class="headerlink" title="集群的安装"></a>集群的安装</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.4/add-elasticsearch-nodes.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/8.4/add-elasticsearch-nodes.html</a></p>
<p>我们将安装3个节点的集群。在3个节点上面，都要<code>修改linux系统参数</code>，具体设置方式见上面单节点安装。</p>
<p>我们将上面已经安装好的单节点，作为我们集群的第一个节点。然后，我们在另外两台机器上面，分别安装elasticsearch。</p>
<p>在<code>192.168.56.112</code>上面安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/</span><br><span class="line">$ tar -xzf elasticsearch-8.4.0-linux-x86_64.tar.gz</span><br><span class="line">$ vi elasticsearch-8.4.0/config/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">cluster.name: hewentian-cluster</span><br><span class="line">node.name: node-2</span><br><span class="line"></span><br><span class="line">network.host: 192.168.56.112</span><br><span class="line">http.port: 9200</span><br><span class="line"></span><br><span class="line"><span class="comment">#transport.host    # Defaults to the address given by network.host</span></span><br><span class="line"><span class="comment">#transport.port    # Defaults to 9300-9400</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#discovery.seed_hosts: ["192.168.56.111", "192.168.56.112", "192.168.56.113"]  # 这个不用配置，会自动产生</span></span><br><span class="line"><span class="comment">#cluster.initial_master_nodes: ["node-1", "node-2", "node-3"]</span></span><br></pre></td></tr></table></figure></p>
<p>内存大小的设置，参考上面单节点安装。</p>
<p>到<code>192.168.56.113</code>节点上面的elasticsearch安装目录生成一个新的token：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/elasticsearch-8.4.0/</span><br><span class="line">$ ./bin/elasticsearch-create-enrollment-token -s node</span><br></pre></td></tr></table></figure></p>
<p>然后回到我们准备安装的新节点，启动elasticsearch，将<code>&lt;enrollment-token&gt;</code>替换成上面产生的token：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/elasticsearch-8.4.0/</span><br><span class="line">$ ./bin/elasticsearch --enrollment-token &lt;enrollment-token&gt;</span><br></pre></td></tr></table></figure></p>
<p>启动后，会自动在<code>/home/hadoop/elasticsearch-8.4.0/config</code>目前下生成一个<code>certs</code>目录，这个目录中的证书和<code>192.168.56.113</code>上的是一样的。</p>
<p>验证安装是否成功：<br>        curl –cacert /home/hadoop/elasticsearch-8.4.0/config/certs/http_ca.crt -u elastic <a href="https://192.168.56.112:9200" target="_blank" rel="noopener">https://192.168.56.112:9200</a></p>
<p>将上面的安装步骤，在<code>192.168.56.111</code>上面安装也执行一次。到此，集群安装完毕。</p>
<p>查看集群状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET _cat/health</span><br><span class="line"></span><br><span class="line">GET _cat/nodes</span><br></pre></td></tr></table></figure></p>
<p>重启集群步骤：</p>
<ol>
<li><p>Disable shard allocation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.enable&quot;: &quot;primaries&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Stop indexing and perform a flush.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /_flush</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启所有节点，重启节点的时候使用<code>./bin/elasticsearch</code>就可以了，不用再带<code>&lt;enrollment-token&gt;</code>参数。</p>
</li>
<li><p>Re-enable allocation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.enable&quot;: null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>删除节点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /_cluster/voting_config_exclusions?node_names=node_name</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">POST /_cluster/voting_config_exclusions?node_names=node-3</span><br></pre></td></tr></table></figure></p>
<p>删除的节点重启后，会自动重新加入集群的。</p>
<h3 id="安装ik分词和pinyin分词"><a href="#安装ik分词和pinyin分词" class="headerlink" title="安装ik分词和pinyin分词"></a>安装ik分词和pinyin分词</h3><p>下载和elasticsearch版本对应的ik分词和pinyin分词，下载地址如下：<br><a href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a><br><a href="https://github.com/medcl/elasticsearch-analysis-pinyin/releases">https://github.com/medcl/elasticsearch-analysis-pinyin/releases</a></p>
<p>这里下载了 elasticsearch-analysis-ik-8.4.0.zip、elasticsearch-analysis-pinyin-8.4.0.zip，安装方式如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/elasticsearch-8.4.0/plugins</span><br><span class="line">$ mkdir ik pinyin</span><br><span class="line">$</span><br><span class="line">$ <span class="built_in">cd</span> /home/hadoop/</span><br><span class="line">$ unzip -d /home/hadoop/elasticsearch-8.4.0/plugins/ik/ elasticsearch-analysis-ik-8.4.0.zip</span><br><span class="line">$ unzip -d /home/hadoop/elasticsearch-8.4.0/plugins/pinyin/ elasticsearch-analysis-pinyin-8.4.0.zip</span><br></pre></td></tr></table></figure></p>
<p>重启elasticsearch<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/elasticsearch-8.4.0/</span><br><span class="line">$ pkill -F pid</span><br><span class="line">$ ./bin/elasticsearch -d -p pid</span><br></pre></td></tr></table></figure></p>
<p>查看已经安装的插件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd /home/hadoop/elasticsearch-8.4.0</span><br><span class="line">$ ./bin/elasticsearch-plugin list</span><br><span class="line">ik</span><br><span class="line">pinyin</span><br></pre></td></tr></table></figure></p>
<p>由上面的输出可知，安装成功。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/09/16/elasticsearch-install/" data-id="clf9thvke00066h3kjey49lkm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elasticsearch/">elasticsearch</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-redis-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/12/redis-note/" class="article-date">
  <time datetime="2018-09-12T00:54:32.000Z" itemprop="datePublished">2018-09-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/12/redis-note/">redis 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>首先，你必须有一台<code>redis</code>服务器可以使用，如果还没安装，可以参考我的上一篇 <a href="../../../../2018/08/07/redis-standalone/">redis 的安装使用</a></p>
<p>使用JAVA API来操作Redis的例子可以在这里找到：<a href="https://github.com/hewentian/studyResource/blob/master/src/main/java/com/hewentian/util/RedisUtil.java">RedisUtil.java</a>、<a href="https://github.com/hewentian/studyResource/blob/master/src/main/java/com/hewentian/redis/RedisDemo.java">RedisDemo.java</a></p>
<p>部分笔记摘自《Redis 实战》，它总结得很好。</p>
<p>Redis默认16个数据库，并以数字为索引，从0开始到15，可以手工修改这个配置，增加数量。登录的时候，默认为0库。</p>
<h4 id="Redis与其他数据库的对比"><a href="#Redis与其他数据库的对比" class="headerlink" title="Redis与其他数据库的对比"></a>Redis与其他数据库的对比</h4><p>  高性能键值缓存服务器<code>memcached</code>也经常被拿来与<code>Redis</code>进行比较：这两者都可以用于存储键值映射，彼此的性能也相关无几，但是<code>Redis</code>能够自动以两种不同的方式将数据写入硬盘，并且<code>Redis</code>除了能存储普通的字符串之外，还可以存储其他4种数据结构，而<code>memcached</code>只能存储普通的字符串键。这些不同之处使得<code>Redis</code>可以用于解决更为广泛的问题，并且既可以用作主数据库(primary database)使用，又可以作为其他存储系统的辅助数据库(auxiliary database)使用。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">数据存储选项</th>
<th style="text-align:left">查询类型</th>
<th style="text-align:left">附加功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>Redis</td>
<td style="text-align:left">使用内存存储的非关系数据库</td>
<td style="text-align:left">字符串、列表、集合、散列表、有序集合</td>
<td style="text-align:left">每种数据类型都有自已的专属命令，另外还有批量操作(bulk operation)和不完全(partial)的事务支持</td>
<td style="text-align:left">发布与订阅，主从复制(master/slave replication)，持久化，脚本(存储过程，stored procedure)</td>
</tr>
<tr>
<td>memcached</td>
<td style="text-align:left">使用内存存储的键值缓存</td>
<td style="text-align:left">键值之间的映射</td>
<td style="text-align:left">创建命令、读取命令、更新命令、删除命令以及其他几个命令</td>
<td style="text-align:left">为提升性能而设的多线程服务器</td>
</tr>
<tr>
<td>Mysql</td>
<td style="text-align:left">关系数据库</td>
<td style="text-align:left">每个数据库可以包含多个表，每个表可以包含多个行；可以处理多个表的视图(view)；支持空间(spatial)和第三方扩展</td>
<td style="text-align:left">SELECT、INSERT、UPDATE、DELETE、函数、存储过程</td>
<td style="text-align:left">支持ACID性质(需要使用InnoDB)，主从复制，主主复制(master/master replication)</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td style="text-align:left">关系数据库</td>
<td style="text-align:left">每个数据库可以包含多个表，每个表可以包含多个行；可以处理多个表的视图(view)；支持空间(spatial)和第三方扩展；支持可定制类型</td>
<td style="text-align:left">SELECT、INSERT、UPDATE、DELETE、内置函数、自定义存储过程</td>
<td style="text-align:left">支持ACID性质，主从复制，由第三方支持的多主复制(multi-master replication)</td>
</tr>
<tr>
<td>MongoDB</td>
<td style="text-align:left">使用硬盘存储的非关系文档存储</td>
<td style="text-align:left">每个数据库可以包含多个表，每个表可以包含多个无schema(schema-less)的BSON文档</td>
<td style="text-align:left">创建命令、读取命令、更新命令、删除命令、条件查询命令等</td>
<td style="text-align:left">支持 map-reduce 操作，主从复制，分片，空间索引(spatial index)</td>
</tr>
</tbody>
</table>
<h4 id="Redis提供的5种结构"><a href="#Redis提供的5种结构" class="headerlink" title="Redis提供的5种结构"></a>Redis提供的5种结构</h4><table>
<thead>
<tr>
<th>结构类型</th>
<th style="text-align:left">结构存储的值</th>
<th style="text-align:left">结构的读写能力</th>
</tr>
</thead>
<tbody>
<tr>
<td>STRING</td>
<td style="text-align:left">可以是字符串、整数或者浮点数</td>
<td style="text-align:left">对整个字符串或者字符串的其中一部分执行操作，对整数和浮点数执行自增或者自减操作</td>
</tr>
<tr>
<td>LIST</td>
<td style="text-align:left">一个链表，链表上的每个节点都包含了一个字符串</td>
<td style="text-align:left">从链表的两端推入或者弹出元素；根据偏移量对链表进行修剪；读取单个或者多个元素；根据值查找或者移除元素</td>
</tr>
<tr>
<td>SET</td>
<td style="text-align:left">包含字符串的无序收集器，并且被包含的每个字符串都是独一无二、各不相同的</td>
<td style="text-align:left">添加、获取、移除单个元素；检查一个元素是否存在于集合中；计算交集、并集、差集；从集合里面随机获取元素</td>
</tr>
<tr>
<td>HASH</td>
<td style="text-align:left">包含键值对的无序散列表</td>
<td style="text-align:left">添加、获取、移除单个键值对；获取所有键值对</td>
</tr>
<tr>
<td>ZSET(有序集合)</td>
<td style="text-align:left">字符串成员与浮点数分值之间的有序映射，元素的排列顺序由分值的大小决定</td>
<td style="text-align:left">添加、获取、删除单个元素；根据分值范围或者成员来获取元素</td>
</tr>
</tbody>
</table>
<p>  在实际中最好还是让主服务器只使用50%~65%的内存，留下30%~45%的内存用于执行BGSAVE命令和创建记录写命令的缓冲区。</p>
<p>  当所有成员的分值都相同时，有序集合将根据成员的名字来进行排序；而当所有成员的分值都是0的时候，成员将按照字符串的二进制顺序进行排序。</p>
<p>  对于大部分数据库来说，插入行操作的执行速度非常快（插入行只会在硬盘文件末尾进行写入）。不过，对表里面的行进行更新却是一个速度相当慢的操作，因为这种更新除了会引起一次随机读(random read)之外，还可能会引起一次随机写(random write)。</p>
<p>使用cookie实现购物车–也就是将整个购物车都存储到cookie里面的做法非常常见，这种做法的一大优点是无须对数据库进行写入就可以实现购物车功能，而缺点则是程序需要重新解析和验证cookie，确保cookie的格式正确，并且包含的商品都是真正可购买的商品。cookie购物车还有一个缺点：因为浏览器每次发送请求都会连cookie一起发送，所以如果购物车cookie的体积比较大，那么请求发送和处理的速度可能会有所降低。</p>
<p>如果用户对一个不存在的键或者一个保存了空串的键执行自增或者自减操作，那么Redis在执行操作时会将这个键的值当作是0来处理。如果用户尝试对一个值无法被解释为整数或者浮点数的字符串键执行自增或者自减操作，那么Redis将向用户返回一个错误。</p>
<p>Redis不支持嵌套结构特性</p>
<h4 id="Redis的基本事务"><a href="#Redis的基本事务" class="headerlink" title="Redis的基本事务"></a>Redis的基本事务</h4><p>  Redis的基本事务(basic transaction)需要用到MULTI命令和EXEC命令，这种事务可以让一个客户端在不被其他客户端打断的情况下执行多个命令。和关系数据库那种可以在执行的过程中进行回滚(rollback)的事务不同，在Redis里面，被MULTI命令和EXEC命令包围的所有命令会一个接一个地执行，直到所有命令都执行完毕为止。当一个事务执行完毕之后，Redis才会处理其他客户端的命令。<br>  要在Redis里面执行事务，我们首先需要执行MULTI命令，然后输入那些我们想要在事务里面执行的命令，最后再执行EXEC命令。当Redis从一个客户端那里接收到MULTI命令时，Redis会将这个客户端之后发送的所有命令都放入到一个队列里面，直到这个客户端发送EXEC命令为止，然后Redis就会在不被打断的情况下，一个接一个地执行存储在队列里面的命令。从语义上来说，Redis事务在Python客户端上面是由流水线(pipeline)实现的：对连接对象调用pipeline()方法将创建一个事务，在一切正常的情况下，客户端会自动地使用MULTI和EXEC包裹起用户输入的多个命令。此外，为了减少Redis与客户端之间的通信往返次数，提升执行多个命令时的性能，Python的Redis客户端会存储起事务包含的多个命令，然后在事务执行时一次性地将所有命令都发送给Redis。</p>
<h4 id="持久化选项"><a href="#持久化选项" class="headerlink" title="持久化选项"></a>持久化选项</h4><p>  Redis提供了两种不同的持久化方法来将数据存储到硬盘里面。一种方法叫快照(snapshotting)，它可以将存在于某一时刻的所有数据都写入硬盘里面。另一种方法叫只追加文件(append-only file, AOF)，它会在执行写命令时，将被执行的写命令复制到硬盘里面。这两种持久化方法既可以同时使用，又可以单独使用，在某些情况下甚至可以两种方法都不使用。<br>  为了防止Redis因为创建子进程而出现停顿，我们可以考虑关闭自动保存，转而通过手动发送BGSAVE或者SAVE来进行持久化。手动发送BGSAVE一样会引起停顿，唯一不同的是用户可以通过手动发送BGSAVE命令来控制停顿出现的时间。另一方面，虽然SAVE会一直阻塞Redis直到快照生成完毕，但是因为它不需要创建子进程，所以就不会像BGSAVE一样因为创建子进程而导致Redis停顿；并且因为没有子进程在争抢资源，所以SAVE创建快照的速度会比BGSAVE创建快照的速度要来得更快一些。</p>
<h4 id="配置AOF持久化机制"><a href="#配置AOF持久化机制" class="headerlink" title="配置AOF持久化机制"></a>配置AOF持久化机制</h4><p>修改redis配置文件，增加如下配置。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vi &#123;REDIS_HOME&#125;/redis.conf</span><br><span class="line"></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br></pre></td></tr></table></figure></p>
<p>然后重启redis即可。可以登录redis，然后使用命令<code>config get *</code>查看配置。</p>
<h4 id="创建快照的办法有以下几种"><a href="#创建快照的办法有以下几种" class="headerlink" title="创建快照的办法有以下几种"></a>创建快照的办法有以下几种</h4><ol>
<li>客户端可以通过向Redis发送BGSAVE命令来创建一个快照；</li>
<li>客户端还可以通过向Redis发送SAVE命令来创建一个快照，接到SAVE命令的Redis服务器在快照创建完毕之前将不再响应任何其他命令；</li>
<li>用户设置save配置选项；</li>
<li>当Redis通过SHUTDOWN命令接收到关闭服务器的请求时，或者接收到标准TERM信号时，会执行一个SAVE命令；</li>
<li>当一个Redis服务器连接另一个Redis服务器，并向对方发送SYNC命令来开始一次复制操作的时候，如果主服务器目前没有在执行BGSAVE操作，或者主服务器并非刚刚执行完BGSAVE操作，那么主服务器就会执行BGSAVE命令。</li>
</ol>
<p>在只使用快照持久化来保存数据时，一定要记住：如果系统真的发生崩溃，用户将丢失最近一次生成快照之后更改的所有数据。因此，快照持久化只适用于那些即使丢失一部分数据也不会造成问题的应用程序。</p>
<p>  当Redis存储的数据量只有几个GB的时候，使用快照来保存数据是没有问题的。Redis会创建子进程并将数据保存到硬盘里面，生成快照所需的时间比你读这句话所需的时间还要短。但随着Redis占用的内存越来越多，BGSAVE在创建子进程时耗费的时间也会越来越多。如果Redis的内存占用量达到数十个GB，并且剩余的空闲内存并不多，或者Redis运行在虚拟机上面，那么执行BGSAVE可能会导致系统长时间地停顿，也可能引发系统大量地使用虚拟内存，从而导致Redis的性能降低至无法使用的程度。</p>
<p>  AOF持久化会将被执行的写命令写到AOF文件的末尾，以此来记录数据发生的变化。因此，Redis只要从头到尾重新执行一次AOF文件包含的所有写命令，就可以恢复AOF文件所记录的数据集。通过<code>appendonly yes</code>配置选项来打开。</p>
<p>  Redis每秒同步一次AOF文件时的性能和不使用任何持久化特性时的性能相关无几，而通过每秒同步一次AOF文件，Redis可以保证，即使出现系统崩溃，用户也最多只会丢失一秒之内产生的数据。</p>
<p>  因为Redis会不断地将被执行的写命令记录到AOF文件里面，所以随着Redis不断运行，AOF文件的体积也会不断增长，在极端情况下，体积不断增大的AOF文件甚至可能会用完硬盘的所有可用空间。还有另一个问题就是，因为Redis在重启之后需要通过重新执行AOF文件记录的所有写命令来还原数据集，所以如果AOF文件的体积非常大，那么还原操作执行的时间就可能会非常长。为了解决AOF文件体积不断增大的问题，用户可以向Redis发送BGREWRITEAOF命令，这个命令会通过移除AOF文件中的冗余命令来重写(rewrite)AOF文件，使AOF文件的体积变得尽可能地小。</p>
<p>  关系数据库通常会使用一个主服务器(master)向多个从服务器(slave)发送更新，并使用从服务器来处理所有读请求。在Redis中开启从服务器所必须的选项只有<code>slaveof</code>一个。通过向从服务器发送<code>SLAVEOF no one</code>命令，我们可以让这个从服务器断开与主服务器的连接。因为Redis的主服务器和从服务器并没有特别不同的地方，所以从服务器也可以拥有自已的从服务器，并由此形成主从链(master/slave chaining)，如下图：<br><img src="/img/redis-master-slave-chaining.png" alt=""></p>
<p>  解决从服务器重同步(resync)问题的其中一个方法，就是减少主服务器需要传送给从服务器的数据数量，这可以通过构建像上图所示的树状复制中间层来完成。除了构建树状的从服务器群组之外，解决从服务器重同步问题的另一个方法就是对网络连接进行压缩，从而减少需要传送的数据量。一些Redis用户就发现使用带压缩的SSH隧道(tunnel)进行连接可以明显地降低带宽占用，如果使用这个方法，记得使用SSH提供的选项来让SSH连接在断线后自动进行连接。</p>
<p>  提升Redis读取能力的最简单方法，就是添加只读从服务器。在使用只读从服务器的时候，请务必记得只对Redis主服务器进行写入。在默认情况下，尝试对一个被配置为从服务器的Redis服务器进行写入将引发一个错误（就算这个从服务器是其他从服务器的主服务器，也是如此）。不过，可以通过设置配置选项使从服务器也能执行写入操作，不过由于这一功能通常都处于关闭状态，所以对从服务器进行写入一般都会引发错误。使用多个Redis从服务器处理读查询时可能会遇到的最棘手的问题，就是主服务器临时下线或者永久下线。</p>
<p>  Redis Sentinel可以配合Redis的复制功能使用，并对下线的主服务器进行故障转移。</p>
<h4 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h4><p>  一般来说，在对数据进行“加锁”时，程序首先需要通过获取(acquire)锁来得到对数据进行排他性访问的能力，然后才能对数据进行一系列的操作，最后还要将锁释放(release)给其他程序。对于能够被多个线程访问的共享内存数据结构来说，这种“先获取锁，然后执行操作，最后释放锁”的动作非常常见。Redis使用WATCH命令来代替对数据进行加锁，因为WATCH只会在数据被其他客户端抢先修改了的情况下通知执行了这个命令的客户端，而不会阻止其他客户端对数据进行修改，所以这个命令被称为乐观锁(optimistic locking)。</p>
<p>  分布式锁也有类似的“首先获取锁，然后执行操作，最后释放锁”动作，但这种锁既不是给同一个进程中的多个线程使用，也不是给同一台机器上的多个进程使用，而是由不同机器上的不同Redis客户端进行获取和释放锁的。</p>
<p>  我们没有直接使用操作系统级别的锁、编程语言级别的锁，或者其他各式各样的锁，而是选择了花费大量时间去使用Redis构建锁，这其中一个原因和范围有关：为了对Redis存储的数据进行排他性访问，客户端需要访问一个锁，这个锁必须定义在一个可以让所有客户端都看得见的范围之内，而这个范围就是Redis本身，因此我们需要把锁构建在Redis里面。另一方面，虽然Redis提供SETNX命令确实具有基本的加锁功能，但它的功能并不完整，并且也不具备分布式锁常见的一些高级特性，所以我们还是需要自已动手来构建分布式锁。</p>
<p>  WATCH、MULTI和EXEC组成的事务并不具有可扩展性，原因在于程序在尝试完成一个事务的时候，可能会因为事务执行失败而反复地进行重试。保证数据的正确性是一件非常重要的事情，但使用WATCH命令的做法并不完美 。为了解决这个问题，我们将使用锁。</p>
<p>  因为客户端即使在使用锁的过程中也可能会因为这样或那样的原因而下线，所以为了防止客户端在取得锁之后崩溃，并导致锁一直处于“已被获取”的状态，最终版的锁实现将带有超时限制特性：如果获得锁的进程未能在指定的时限内完成操作，那么锁将自动被释放。下面列出了一些导致锁出现不正确实行为的原因，也及锁在不正确运行时的症状：</p>
<ol>
<li>持有锁的进程因为操作时间过长而导致锁被自动释放，但进程本身并不知晓这一点，甚至还可能会错误地释放掉了其他进程持有的锁；</li>
<li>一个持有锁并打算执行长时间操作的进程已经崩溃，但其他想要获取锁的进程不知道哪个进程持有着锁，也无法检测出持有锁的进程已经崩溃，只能白白地浪费时间等待锁被释放；</li>
<li>在一个进程持有的锁过期之后，其他多个进程同时尝试去获取锁，并且都获得了锁；</li>
<li>上面提到的第一种情况和第三种情况同时出现，导致有多个进程获得了锁，而每个进程都以为自已是唯一一个获得锁的进程。</li>
</ol>
<p>在高负载情况下，使用锁可以减少重试次数、降低延迟时间、提升性能并将加锁的粒度调整至合适的大小。</p>
<p>一般来说，当程序使用一个来自Redis的值去构建另一个将要被添加到Redis里面的值时，就需要使用锁或者由WATCH、MULTI和EXEC组成的事务来消除竞争条件。</p>
<h4 id="计数信号量"><a href="#计数信号量" class="headerlink" title="计数信号量"></a>计数信号量</h4><p>  计数信号量是一种锁，它可以让用户限制一项资源最多能够同时被多少个进程访问，通常用于限定能够同时使用的资源数量。你可以把我们在前一节创建的锁看作是只能被一个进程访问的信号量。计数信号量和其他锁的区别在于，当客户端获取锁失败的时候，客户端通常会选择进行等待；而当客户端获取计数信号量失败的时候，客户端通常会选择立即返回失败结果。</p>
<p>  以下是之前介绍过的各个信号量实现的优缺点：</p>
<ol>
<li>如果你对于使用系统时钟没有意见，也不需要对信号量进行刷新，并且能够接受信号量的数量偶尔超过限制，那么可以使用我们给出的第一个信号量实现；</li>
<li>如果你只信任差距在一两秒之间的系统时钟，但仍然能够接受信号量的数量偶尔超过限制，那么你可以使用第二个信号量实现；</li>
<li>如果你希望信号量一直都具有正确的行为，那么可以使用带锁的信号量实现来保证正确性。</li>
</ol>
<h4 id="消息拉取"><a href="#消息拉取" class="headerlink" title="消息拉取"></a>消息拉取</h4><p>  两个或多个客户端在互相发送和接收消息的时候，通常会使用以下两种方法来传递消息。第一种被称为消息推送(push messaging)，也就是由发送者来确保所有接收者已经成功接收到了消息。Redis内置了用于进行消息推送的PUBLISH命令和SUBSCRIBE命令。这两个命令有个缺陷：客户端必须一直在线才能接收到消息，断线可能会导致客户端丢失消息。第二种方法被称为消息拉取(pull messaging)，这种方法要求接收者自已去获取存储在某种邮箱(mailbox)里面的消息。</p>
<h4 id="索引相关"><a href="#索引相关" class="headerlink" title="索引相关"></a>索引相关</h4><p>  从文档里面提取单词的过程通常被称为语法分析(parsing)和标记化(tokenization)，这个过程可以产生出一系列用于标识文档的标记(token)，标记有时候又被称为单词(word)。标记化的一个常见的附加步骤，就是移除内容中的非用词(stop word)。非用词就是那些在文档中频繁出现但是却没有提供相应信息量的单词，对这些单词进行搜索将返回大量无用的结果。移除非用词不仅可以提高搜索性能，还可以减少索引的体积。<br>  用户有些时候可能会想要使用多个具有相同意思的单词进行搜索，并把它们看作是同一个单词，我们把这样的单词称为同义词。<br>  搜索程序在取得多个文档之后，通常还需要根据每个文档的重要性对它们进行排序–搜索领域把这一问题称为关联度计算问题。</p>
<h4 id="广告相关"><a href="#广告相关" class="headerlink" title="广告相关"></a>广告相关</h4><p>  广告索引操作的特别之处在于它返回的不是一组广告或者一组搜索结果，而是单个广告；并且被索引的广告通常都拥有像位置、年龄或者性别这类必须的定向参数。</p>
<p>  Web页面上展示的广告主要有3种类型：按展示次数计费(cost per view)、按点击次数计费(cost per click)和按动作执行次数计费(cost per action)。按展示次数计费的广告又称为CPM广告或按千次计费(cost per mile)广告，这种广告每展示1000次就需要收取固定的费用。按点击计费的广告又称为CPC广告，这种广告根据被点击的次数收取固定的费用。按动作执行次数计费的广告又称为CPA广告，这种广告根据用户在广告的目的地网站上执行的动作收取不同的费用。</p>
<p>  让广告的价格保持一致：为了尽可能地简化广告价格的计算方式，程序将对所有类型的广告进行转换，使得它们的价格可以基于每千次展示进行计算，产生出一个估算CPM(estimated CPM)，简称eCPM。对于CPM广告来说，因为这种广告已经给出了CPM价格，所以程序只要直接把它的CPM用作eCPM就可以了。至于CPC广告和CPA广告，程序则需要根据相应的规则为它们计算出eCPM。</p>
<h4 id="优化Redis"><a href="#优化Redis" class="headerlink" title="优化Redis"></a>优化Redis</h4><p>  降低Redis的内存占用有助于减少创建快照和加载快照所需的时间、提升载入AOF文件和重写AOF文件时的效率、缩短从服务器进行同步所需的时间，并且能让Redis存储更多的数据而无需添加额外的硬件。</p>
<p>  在列表、散列和有序集合的长度较短或者体积较小的时候，Redis可以选择使用一种名为压缩列表(ziplist)的紧凑存储方式来存储这些结构。压缩列表会以序列化的方式存储数据，这些序列化数据每次被读取的时候都要进行解码，每次被写入的时候也要进行局部的重新编码，并且可能需要对内存里面的数据进行移动。</p>
<h4 id="不同结构关于使用压缩列表表示的配置选项（我安装的是-4-0-11-版本），配置文件位于-REDIS-HOME-redis-conf"><a href="#不同结构关于使用压缩列表表示的配置选项（我安装的是-4-0-11-版本），配置文件位于-REDIS-HOME-redis-conf" class="headerlink" title="不同结构关于使用压缩列表表示的配置选项（我安装的是 4.0.11 版本），配置文件位于{REDIS_HOME}/redis.conf"></a>不同结构关于使用压缩列表表示的配置选项（我安装的是 4.0.11 版本），配置文件位于<code>{REDIS_HOME}/redis.conf</code></h4><pre><code># Hashes are encoded using a memory efficient data structure when they have a
# small number of entries, and the biggest entry does not exceed a given
# threshold. These thresholds can be configured using the following directives.
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# Lists are also encoded in a special way to save a lot of space.
# The number of entries allowed per internal list node can be specified
# as a fixed maximum size or a maximum number of elements.
# For a fixed maximum size, use -5 through -1, meaning:
# -5: max size: 64 Kb  &lt;-- not recommended for normal workloads
# -4: max size: 32 Kb  &lt;-- not recommended
# -3: max size: 16 Kb  &lt;-- probably not recommended
# -2: max size: 8 Kb   &lt;-- good
# -1: max size: 4 Kb   &lt;-- good
# Positive numbers mean store up to _exactly_ that number of elements
# per list node.
# The highest performing option is usually -2 (8 Kb size) or -1 (4 Kb size),
# but if your use case is unique, adjust the settings as necessary.
list-max-ziplist-size -2

# Sets have a special encoding in just one case: when a set is composed
# of just strings that happen to be integers in radix 10 in the range
# of 64 bit signed integers.
# The following configuration setting sets the limit in the size of the
# set in order to use this special memory saving encoding.
set-max-intset-entries 512

# Similarly to hashes and lists, sorted sets are also specially encoded in
# order to save a lot of space. This encoding is only used when the length and
# elements of a sorted set are below the following limits:
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
</code></pre><p>说明：</p>
<ol>
<li>entries选项说明散列、集合和有序集合在被编码为压缩列表的情况下，允许包含的最大元素数量；</li>
<li>value选项则说明了压缩列表每个节点的最大体积是多少个字节；</li>
<li>当上述两个选项的限制条件中的任意一个被突破的时候，Redis就会将相应的列表、散列或是有序集合从压缩列表编码转换为其他结构，而内存占用也会因此而增加；</li>
<li>当压缩列表被转换为普通的结构之后，即使结构将来重新满足配置选项设置的限制条件，结构也不会重新转换回压缩列表；</li>
<li>如果整数包含的所有成员都可以被解释为十进制整数，而这些整数又处于平台的有符号整数范围之内，并且集合成员的数量又足够少的话（上面有配置），那么Redis就会以有序整数数组的方式存储集合，这种存储方式又被称为整数集合(intset)。以有序数组的方式存储集合不仅可以降低内存消耗，还可以提升所有标准集合的执行速度。</li>
</ol>
<p>缺点：读写一个长度较大的压缩列表可能会给性能带来负面的影响，随着紧凑结构的体积变得越来越大，操作这些结构的速度也会变得越来越慢。</p>
<h4 id="让键名保持简短"><a href="#让键名保持简短" class="headerlink" title="让键名保持简短"></a>让键名保持简短</h4><p>  到目前为止尚未提到的一件事，就是减少键长度的作用，这里所说的“键”包括所有数据库键、散列的域、集合和有序集合的成员以及所有列表的节点，键的长度越长，Redis需要存储的数据也就越多。</p>
<h4 id="分片结构"><a href="#分片结构" class="headerlink" title="分片结构"></a>分片结构</h4><p>  分片本质上就是基于某些简单的规则将数据划分为更小的部分，然后根据数据所属的部分来决定将数据发送到哪个位置上面。</p>
<h4 id="使用Lua来扩展Redis"><a href="#使用Lua来扩展Redis" class="headerlink" title="使用Lua来扩展Redis"></a>使用Lua来扩展Redis</h4><p>  使用Lua编程语言进行的服务器端脚本编程功能，这个功能可以让用户直接在Redis内部执行各种操作，从而达到简化代码并提高性能的作用。将脚本载入Redis需要用到一个名为<code>SCRIPT LOAD</code>的命令，这个命令接受一个字符串格式的Lua脚本为参数，它会把脚本存储起来等待之后使用，然后返回被存储脚本的SHA1校验和。之后，用户只要调用<code>EVALSHA</code>命令，并输入脚本的SHA1校验和以及脚本所需的全部参数就可以调用之前存储的脚本。</p>
<p>  Lua版本的锁实现减少了加锁时所需的通信往返次数，所以Lua版本的锁实现在尝试获取锁时的速度比原版的锁要快得多。虽然Lua脚本可以提供巨大的性能优势，并且能在一些情况下大幅地简化代码，但是我们也要记住，运行在Redis内部的Lua脚本只能访问位于Lua脚本之内或者Redis数据库之内的数据，而锁或<code>WATCH/MULTI/EXEC</code>事务并没有这一限制。</p>
<p>  Redis在将数据库持久化到硬盘的时候，需要用到fork系统调用，而Windows并不支持这个调用。在缺少fork调用的情况下，Redis在执行持久化操作期间就只能够阻塞所有客户端，直到持久化操作执行完毕为止。</p>
<p>查看一个对象的类型可以使用<code>DEBUG OBJECT</code>命令</p>
<pre><code>127.0.0.1:6379&gt; rpush test a b c d
(integer) 4
127.0.0.1:6379&gt; DEBUG OBJECT test
Value at:0x7f6160c774e0 refcount:1 encoding:quicklist serializedlength:25 lru:9577083 lru_seconds_idle:44 ql_nodes:1 ql_avg_node:4.00 ql_ziplist_max:-2 ql_compressed:0 ql_uncompressed_size:23
127.0.0.1:6379&gt;
</code></pre><h3 id="redis命令行查看中文显示乱码"><a href="#redis命令行查看中文显示乱码" class="headerlink" title="redis命令行查看中文显示乱码"></a>redis命令行查看中文显示乱码</h3><p>Redis在使用命令行操作时，如果查看内容中包含中文，会显示16进制的字符串<code>\xe4\xbf\xa1\xe9\x98\xb3\xe5\xb8\x82\</code>，为了正确显示中文，在启动客启端的时候，加上<code>--raw</code>参数即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./redis-cli -h 127.0.0.1 --raw</span><br><span class="line">127.0.0.1:6379&gt; get city</span><br><span class="line">广州</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/09/12/redis-note/" data-id="clf9thvmw002z6h3kvuqz9fmf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-redis-ha" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/14/redis-ha/" class="article-date">
  <time datetime="2018-08-14T06:53:19.000Z" itemprop="datePublished">2018-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/14/redis-ha/">redis 高可用配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="主从配置"><a href="#主从配置" class="headerlink" title="主从配置"></a>主从配置</h2><p>要配置主从，我们必须安装两台<code>redis</code>：主服务器为<code>master</code>，从服务器为<code>slave</code>。安装步骤请参考我的上一篇 <a href="../../../../2018/08/07/redis-standalone/">redis 的安装使用</a></p>
<h3 id="我们在一台机器上面配置主从，多台的配置是一样的，只要修改下IP和PORT即可。以我们上一篇安装好的一台redis为基础，它的安装路径为：-home-hewentian-ProjectD-redis-4-0-11"><a href="#我们在一台机器上面配置主从，多台的配置是一样的，只要修改下IP和PORT即可。以我们上一篇安装好的一台redis为基础，它的安装路径为：-home-hewentian-ProjectD-redis-4-0-11" class="headerlink" title="我们在一台机器上面配置主从，多台的配置是一样的，只要修改下IP和PORT即可。以我们上一篇安装好的一台redis为基础，它的安装路径为：/home/hewentian/ProjectD/redis-4.0.11"></a>我们在一台机器上面配置主从，多台的配置是一样的，只要修改下<code>IP</code>和<code>PORT</code>即可。以我们上一篇安装好的一台<code>redis</code>为基础，它的安装路径为：<code>/home/hewentian/ProjectD/redis-4.0.11</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD</span><br><span class="line">$ mv redis-4.0.11 redis-4.0.11_master</span><br><span class="line">$ cp -r redis-4.0.11_master/ redis-4.0.11_slave/</span><br></pre></td></tr></table></figure>
<p><code>master</code>服务器为：<code>/home/hewentian/ProjectD/redis-4.0.11_master</code><br><code>slave</code>服务器为：<code>/home/hewentian/ProjectD/redis-4.0.11_slave</code></p>
<h3 id="master服务器使用默认端口6379，所以不用配置。下面我们配置slave服务器："><a href="#master服务器使用默认端口6379，所以不用配置。下面我们配置slave服务器：" class="headerlink" title="master服务器使用默认端口6379，所以不用配置。下面我们配置slave服务器："></a><code>master</code>服务器使用默认端口<code>6379</code>，所以不用配置。下面我们配置<code>slave</code>服务器：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/redis-4.0.11_slave/</span><br><span class="line">$ vi redis.conf</span><br><span class="line"></span><br><span class="line">// 将默认端口改为6380，并加上 slaveof 127.0.0.1 6379 和 pidfile，在文件里面改动如下：</span><br><span class="line">port 6380</span><br><span class="line">slaveof 127.0.0.1 6379</span><br><span class="line">pidfile /var/run/redis_6380.pid</span><br></pre></td></tr></table></figure>
<p>保存文件并退出，<code>slave</code>服务器配置完成。</p>
<h3 id="接着我们启动master和slave服务器"><a href="#接着我们启动master和slave服务器" class="headerlink" title="接着我们启动master和slave服务器"></a>接着我们启动<code>master</code>和<code>slave</code>服务器</h3><p>启动<code>master</code>服务器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/redis-4.0.11_master/src/</span><br><span class="line">$ ./redis-server /home/hewentian/ProjectD/redis-4.0.11_master/redis.conf</span><br></pre></td></tr></table></figure></p>
<p>启动<code>slave</code>服务器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/redis-4.0.11_slave/src/</span><br><span class="line">$ ./redis-server /home/hewentian/ProjectD/redis-4.0.11_slave/redis.conf</span><br></pre></td></tr></table></figure></p>
<p>在<code>master</code>服务器窗口中，可以看到如下信息：</p>
<pre><code>1514:M 14 Aug 15:58:33.568 * Slave 127.0.0.1:6380 asks for synchronization
1514:M 14 Aug 15:58:33.568 * Full resync requested by slave 127.0.0.1:6380
1514:M 14 Aug 15:58:33.568 * Starting BGSAVE for SYNC with target: disk
1514:M 14 Aug 15:58:33.569 * Background saving started by pid 1584
1584:C 14 Aug 15:58:33.573 * DB saved on disk
1584:C 14 Aug 15:58:33.573 * RDB: 0 MB of memory used by copy-on-write
1514:M 14 Aug 15:58:33.576 * Background saving terminated with success
1514:M 14 Aug 15:58:33.576 * Synchronization with slave 127.0.0.1:6380 succeeded
</code></pre><p>在<code>slave</code>服务器窗口中，可以看到如下信息：</p>
<pre><code>1579:S 14 Aug 15:58:33.567 * Connecting to MASTER 127.0.0.1:6379
1579:S 14 Aug 15:58:33.567 * MASTER &lt;-&gt; SLAVE sync started
1579:S 14 Aug 15:58:33.568 * Non blocking connect for SYNC fired the event.
1579:S 14 Aug 15:58:33.568 * Master replied to PING, replication can continue...
1579:S 14 Aug 15:58:33.568 * Partial resynchronization not possible (no cached master)
1579:S 14 Aug 15:58:33.569 * Full resync from master: 7f883c61e9326b040b150462901e70afd5c4a49c:0
1579:S 14 Aug 15:58:33.576 * MASTER &lt;-&gt; SLAVE sync: receiving 176 bytes from master
1579:S 14 Aug 15:58:33.577 * MASTER &lt;-&gt; SLAVE sync: Flushing old data
1579:S 14 Aug 15:58:33.577 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory
1579:S 14 Aug 15:58:33.577 * MASTER &lt;-&gt; SLAVE sync: Finished with success
</code></pre><p>从上面的信息中，我们可以知道，<code>slave</code>服务器已经连上<code>master</code>服务器。</p>
<h3 id="测试同步数据"><a href="#测试同步数据" class="headerlink" title="测试同步数据"></a>测试同步数据</h3><p>登录<code>master</code>服务器并在其中插入一个键<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/redis-4.0.11_master/src/</span><br><span class="line">$ ./redis-cli -p 6379</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty list or <span class="built_in">set</span>)</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name <span class="string">"Tim Ho"</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">"Tim Ho"</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></p>
<p>登录<code>slave</code>服务器并在其中获取一个键<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/redis-4.0.11_slave/src/</span><br><span class="line">$ ./redis-cli -p 6380</span><br><span class="line"></span><br><span class="line">127.0.0.1:6380&gt; keys *</span><br><span class="line">(empty list or <span class="built_in">set</span>)</span><br><span class="line">127.0.0.1:6380&gt; keys *</span><br><span class="line">1) <span class="string">"name"</span></span><br><span class="line">127.0.0.1:6380&gt; get name </span><br><span class="line"><span class="string">"Tim Ho"</span></span><br><span class="line">127.0.0.1:6380&gt;</span><br></pre></td></tr></table></figure></p>
<p>至此，主从配置完成。</p>
<h2 id="哨兵配置"><a href="#哨兵配置" class="headerlink" title="哨兵配置"></a>哨兵配置</h2><p>下面演示在<code>docker</code>里配置<code>一主两从三哨兵</code>的redis哨兵模式。</p>
<h4 id="先部署一主两从"><a href="#先部署一主两从" class="headerlink" title="先部署一主两从"></a>先部署一主两从</h4><p>先在宿主机建立保存数据的目录和设置好配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /root/db/redis-master</span><br><span class="line">$ <span class="built_in">cd</span> /root/db/redis-master</span><br><span class="line">$ mkdir data conf</span><br><span class="line">$ <span class="built_in">cd</span> conf</span><br><span class="line">$ vi redis.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">bind</span> 192.168.56.113    <span class="comment"># 这里要指定IP地址。如果用 127.0.0.1，则 sentinel 将获取到 127.0.0.1 ，这样将导致客户端连接到它本机了</span></span><br><span class="line">port 6379</span><br><span class="line">requirepass abc123</span><br><span class="line">masterauth abc123</span><br><span class="line"></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br></pre></td></tr></table></figure></p>
<p>将配置好的文件复制两份作为从库来修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/db</span><br><span class="line">$ cp -r redis-master redis-replica-1</span><br><span class="line">$ cp -r redis-master redis-replica-2</span><br><span class="line">$</span><br><span class="line">$ vi redis-replica-1/conf/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">bind</span> 192.168.56.113</span><br><span class="line">port 6380</span><br><span class="line">requirepass abc123</span><br><span class="line">masterauth abc123</span><br><span class="line">replicaof 192.168.56.113 6379</span><br><span class="line"></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ vi redis-replica-2/conf/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">bind</span> 192.168.56.113</span><br><span class="line">port 6381</span><br><span class="line">requirepass abc123</span><br><span class="line">masterauth abc123</span><br><span class="line">replicaof 192.168.56.113 6379</span><br><span class="line"></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br></pre></td></tr></table></figure></p>
<p>启动一主两从<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull redis:7.0.2</span><br><span class="line">$</span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name redis-master \</span><br><span class="line">    --net=host \</span><br><span class="line">    -v /root/db/redis-master/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">    -v /root/db/redis-master/data:/data \</span><br><span class="line">    redis:7.0.2 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name redis-replica-1 \</span><br><span class="line">    --net=host \</span><br><span class="line">    -v /root/db/redis-replica-1/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">    -v /root/db/redis-replica-1/data:/data \</span><br><span class="line">    redis:7.0.2 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name redis-replica-2 \</span><br><span class="line">    --net=host \</span><br><span class="line">    -v /root/db/redis-replica-2/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">    -v /root/db/redis-replica-2/data:/data \</span><br><span class="line">    redis:7.0.2 redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure></p>
<p>查看连接情况：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h redis.hewentian.com -p 6379 -a abc123 -n 0 --raw</span><br><span class="line">$ redis.hewentian.com:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.56.113,port=6380,state=online,offset=98,lag=1</span><br><span class="line">slave1:ip=192.168.56.113,port=6381,state=online,offset=98,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:2539e5441c16b58f2b934274db472690a9dd9139</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:98</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:98</span><br><span class="line">redis.hewentian.com:6379&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ redis-cli -h redis.hewentian.com -p 6380 -a abc123 -n 0 --raw</span><br><span class="line">redis.hewentian.com:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.56.113</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:5</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:532</span><br><span class="line">slave_repl_offset:532</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:2539e5441c16b58f2b934274db472690a9dd9139</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:532</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:15</span><br><span class="line">repl_backlog_histlen:518</span><br><span class="line">redis.hewentian.com:6380&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ redis-cli -h redis.hewentian.com -p 6381 -a abc123 -n 0 --raw</span><br><span class="line">redis.hewentian.com:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.56.113</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:9</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:588</span><br><span class="line">slave_repl_offset:588</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:2539e5441c16b58f2b934274db472690a9dd9139</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:588</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:43</span><br><span class="line">repl_backlog_histlen:546</span><br><span class="line">redis.hewentian.com:6381&gt;</span><br></pre></td></tr></table></figure></p>
<p>由上面的信息可知，一主两从部署成功。下面开始部署三哨兵。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/db</span><br><span class="line">$ vi sentinel-1.conf</span><br><span class="line"></span><br><span class="line">port 26379</span><br><span class="line">requirepass abc123</span><br><span class="line">dir /tmp</span><br><span class="line">sentinel monitor mymaster 192.168.56.113 6379 2</span><br><span class="line">sentinel auth-pass mymaster abc123</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ vi sentinel-2.conf</span><br><span class="line"></span><br><span class="line">port 26380</span><br><span class="line">requirepass abc123</span><br><span class="line">dir /tmp</span><br><span class="line">sentinel monitor mymaster 192.168.56.113 6379 2</span><br><span class="line">sentinel auth-pass mymaster abc123</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ vi sentinel-3.conf</span><br><span class="line"></span><br><span class="line">port 26381</span><br><span class="line">requirepass abc123</span><br><span class="line">dir /tmp</span><br><span class="line">sentinel monitor mymaster 192.168.56.113 6379 2</span><br><span class="line">sentinel auth-pass mymaster abc123</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br></pre></td></tr></table></figure></p>
<p>启动三哨兵<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name redis-sentinel-1 \</span><br><span class="line">    --net=host \</span><br><span class="line">    -v /root/db/sentinel-1.conf:/etc/redis/sentinel.conf \</span><br><span class="line">    redis:7.0.2 redis-sentinel /etc/redis/sentinel.conf</span><br><span class="line"></span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name redis-sentinel-2 \</span><br><span class="line">    --net=host \</span><br><span class="line">    -v /root/db/sentinel-2.conf:/etc/redis/sentinel.conf \</span><br><span class="line">    redis:7.0.2 redis-sentinel /etc/redis/sentinel.conf</span><br><span class="line"></span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name redis-sentinel-3 \</span><br><span class="line">    --net=host \</span><br><span class="line">    -v /root/db/sentinel-3.conf:/etc/redis/sentinel.conf \</span><br><span class="line">    redis:7.0.2 redis-sentinel /etc/redis/sentinel.conf</span><br></pre></td></tr></table></figure></p>
<p>查看连接情况：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h redis.hewentian.com -p 26379 -a abc123 --raw</span><br><span class="line">redis.hewentian.com:26379&gt; info sentinel</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_tilt_since_seconds:-1</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=192.168.56.113:6379,slaves=2,sentinels=3</span><br><span class="line">redis.hewentian.com:26379&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ redis-cli -h redis.hewentian.com -p 26380 -a abc123 --raw</span><br><span class="line">redis.hewentian.com:26380&gt; info sentinel</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_tilt_since_seconds:-1</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=192.168.56.113:6379,slaves=2,sentinels=3</span><br><span class="line">redis.hewentian.com:26380&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ redis-cli -h redis.hewentian.com -p 26381 -a abc123 --raw</span><br><span class="line">redis.hewentian.com:26381&gt; info sentinel</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_tilt_since_seconds:-1</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=192.168.56.113:6379,slaves=2,sentinels=3</span><br><span class="line">redis.hewentian.com:26381&gt;</span><br></pre></td></tr></table></figure></p>
<p>其中一个哨兵的启动日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker logs -f redis-sentinel-1</span><br><span class="line">1:X 15 Dec 2021 00:21:50.548 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.549 <span class="comment"># Redis version=7.0.2, bits=64, commit=00000000, modified=0, pid=1, just started</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.549 <span class="comment"># Configuration loaded</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.550 * monotonic clock: POSIX clock_gettime</span><br><span class="line">                _._</span><br><span class="line">           _.-``__ <span class="string">''</span>-._</span><br><span class="line">      _.-``    `.  `_.  <span class="string">''</span>-._           Redis 7.0.2 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">''</span>-._</span><br><span class="line"> (    <span class="string">'      ,       .-`  | `,    )     Running in sentinel mode</span></span><br><span class="line"><span class="string"> |`-._`-...-` __...-.``-._|'</span>` _.-<span class="string">'|     Port: 26379</span></span><br><span class="line"><span class="string"> |    `-._   `._    /     _.-'</span>    |     PID: 1</span><br><span class="line">  `-._    `-._  `-./  _.-<span class="string">'    _.-'</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-'</span>_.-<span class="string">'    |           https://redis.io</span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-'</span>_.-<span class="string">'    |</span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span></span><br><span class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></span><br><span class="line">          `-._        _.-<span class="string">'</span></span><br><span class="line"><span class="string">              `-.__.-'</span></span><br><span class="line"></span><br><span class="line">1:X 15 Dec 2021 00:21:50.551 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.561 <span class="comment"># Could not rename tmp config file (Device or resource busy)</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.561 <span class="comment"># WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.561 <span class="comment"># Sentinel ID is 4d87c515992607402e2d787d768798aa40708ccf</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.561 <span class="comment"># +monitor master mymaster 192.168.56.113 6379 quorum 2</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.561 * +slave slave 192.168.56.113:6380 192.168.56.113 6380 @ mymaster 192.168.56.113 6379</span><br><span class="line">1:X 15 Dec 2021 00:21:50.563 <span class="comment"># Could not rename tmp config file (Device or resource busy)</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.563 <span class="comment"># WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.563 * +slave slave 192.168.56.113:6381 192.168.56.113 6381 @ mymaster 192.168.56.113 6379</span><br><span class="line">1:X 15 Dec 2021 00:21:50.565 <span class="comment"># Could not rename tmp config file (Device or resource busy)</span></span><br><span class="line">1:X 15 Dec 2021 00:21:50.565 <span class="comment"># WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy</span></span><br><span class="line">1:X 15 Dec 2021 00:22:06.426 * +sentinel sentinel 6c0a9d267de6b16a3f7e6ff7bd16c10c84299c5b 192.168.56.113 26380 @ mymaster 192.168.56.113 6379</span><br><span class="line">1:X 15 Dec 2021 00:22:06.432 <span class="comment"># Could not rename tmp config file (Device or resource busy)</span></span><br><span class="line">1:X 15 Dec 2021 00:22:06.433 <span class="comment"># WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy</span></span><br><span class="line">1:X 15 Dec 2021 00:22:18.257 * +sentinel sentinel 53c09ff57b5927ca5ccf4d76216bcb926c38ad1e 192.168.56.113 26381 @ mymaster 192.168.56.113 6379</span><br><span class="line">1:X 15 Dec 2021 00:22:18.267 <span class="comment"># Could not rename tmp config file (Device or resource busy)</span></span><br><span class="line">1:X 15 Dec 2021 00:22:18.267 <span class="comment"># WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy</span></span><br></pre></td></tr></table></figure></p>
<p>由上面的信息可知，三哨兵部署成功。下面将<code>redis-master</code>停掉，模拟宕机的情况。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker stop redis-master</span><br></pre></td></tr></table></figure></p>
<p>查看<code>redis-sentinel-1</code>的日志输出如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1:X 15 Dec 2021 00:42:14.088 <span class="comment"># +sdown master mymaster 192.168.56.113 6379</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.173 <span class="comment"># +odown master mymaster 192.168.56.113 6379 #quorum 2/2</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.173 <span class="comment"># +new-epoch 1</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.173 <span class="comment"># +try-failover master mymaster 192.168.56.113 6379</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.182 <span class="comment"># Could not rename tmp config file (Device or resource busy)</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.182 <span class="comment"># WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.183 <span class="comment"># +vote-for-leader 6c0a9d267de6b16a3f7e6ff7bd16c10c84299c5b 1</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.208 <span class="comment"># 4d87c515992607402e2d787d768798aa40708ccf voted for 6c0a9d267de6b16a3f7e6ff7bd16c10c84299c5b 1</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.209 <span class="comment"># 53c09ff57b5927ca5ccf4d76216bcb926c38ad1e voted for 6c0a9d267de6b16a3f7e6ff7bd16c10c84299c5b 1</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.242 <span class="comment"># +elected-leader master mymaster 192.168.56.113 6379</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.242 <span class="comment"># +failover-state-select-slave master mymaster 192.168.56.113 6379</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.308 <span class="comment"># +selected-slave slave 192.168.56.113:6380 192.168.56.113 6380 @ mymaster 192.168.56.113 6379</span></span><br><span class="line">1:X 15 Dec 2021 00:42:14.308 * +failover-state-send-slaveof-noone slave 192.168.56.113:6380 192.168.56.113 6380 @ mymaster 192.168.56.113 6379</span><br><span class="line">1:X 15 Dec 2021 00:42:14.364 * +failover-state-wait-promotion slave 192.168.56.113:6380 192.168.56.113 6380 @ mymaster 192.168.56.113 6379</span><br><span class="line">1:X 15 Dec 2021 00:42:15.022 <span class="comment"># Could not rename tmp config file (Device or resource busy)</span></span><br><span class="line">1:X 15 Dec 2021 00:42:15.023 <span class="comment"># WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy</span></span><br><span class="line">1:X 15 Dec 2021 00:42:15.023 <span class="comment"># +promoted-slave slave 192.168.56.113:6380 192.168.56.113 6380 @ mymaster 192.168.56.113 6379</span></span><br><span class="line">1:X 15 Dec 2021 00:42:15.023 <span class="comment"># +failover-state-reconf-slaves master mymaster 192.168.56.113 6379</span></span><br><span class="line">1:X 15 Dec 2021 00:42:15.104 * +slave-reconf-sent slave 192.168.56.113:6381 192.168.56.113 6381 @ mymaster 192.168.56.113 6379</span><br><span class="line">1:X 15 Dec 2021 00:42:15.285 <span class="comment"># -odown master mymaster 192.168.56.113 6379</span></span><br><span class="line">1:X 15 Dec 2021 00:42:16.063 * +slave-reconf-inprog slave 192.168.56.113:6381 192.168.56.113 6381 @ mymaster 192.168.56.113 6379</span><br><span class="line">1:X 15 Dec 2021 00:42:16.064 * +slave-reconf-done slave 192.168.56.113:6381 192.168.56.113 6381 @ mymaster 192.168.56.113 6379</span><br><span class="line">1:X 15 Dec 2021 00:42:16.129 <span class="comment"># +failover-end master mymaster 192.168.56.113 6379</span></span><br><span class="line">1:X 15 Dec 2021 00:42:16.129 <span class="comment"># +switch-master mymaster 192.168.56.113 6379 192.168.56.113 6380</span></span><br><span class="line">1:X 15 Dec 2021 00:42:16.130 * +slave slave 192.168.56.113:6381 192.168.56.113 6381 @ mymaster 192.168.56.113 6380</span><br><span class="line">1:X 15 Dec 2021 00:42:16.131 * +slave slave 192.168.56.113:6379 192.168.56.113 6379 @ mymaster 192.168.56.113 6380</span><br><span class="line">1:X 15 Dec 2021 00:42:16.135 <span class="comment"># Could not rename tmp config file (Device or resource busy)</span></span><br><span class="line">1:X 15 Dec 2021 00:42:16.136 <span class="comment"># WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy</span></span><br><span class="line">1:X 15 Dec 2021 00:42:46.200 <span class="comment"># +sdown slave 192.168.56.113:6379 192.168.56.113 6379 @ mymaster 192.168.56.113 6380</span></span><br></pre></td></tr></table></figure></p>
<p>由日志可知，端口为<code>6380</code>的redis已经被选举为master节点，我们看下<code>6380</code>、<code>6381</code>的情况：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">redis.hewentian.com:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=192.168.56.113,port=6381,state=online,offset=262678,lag=1</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:dc5c403d30736f872625b3669a7a721234cfe92f</span><br><span class="line">master_replid2:2539e5441c16b58f2b934274db472690a9dd9139</span><br><span class="line">master_repl_offset:262678</span><br><span class="line">second_repl_offset:237869</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:15</span><br><span class="line">repl_backlog_histlen:262664</span><br><span class="line">redis.hewentian.com:6380&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis.hewentian.com:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.56.113</span><br><span class="line">master_port:6380</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:0</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:264421</span><br><span class="line">slave_repl_offset:264421</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:dc5c403d30736f872625b3669a7a721234cfe92f</span><br><span class="line">master_replid2:2539e5441c16b58f2b934274db472690a9dd9139</span><br><span class="line">master_repl_offset:264421</span><br><span class="line">second_repl_offset:237869</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:43</span><br><span class="line">repl_backlog_histlen:264379</span><br><span class="line">redis.hewentian.com:6381&gt;</span><br></pre></td></tr></table></figure></p>
<p>最后将<code>redis-master</code>重新启动。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker start redis-master</span><br></pre></td></tr></table></figure></p>
<p>查看<code>redis-sentinel-1</code>的日志输出如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1:X 15 Dec 2021 00:51:52.101 <span class="comment"># -sdown slave 192.168.56.113:6379 192.168.56.113 6379 @ mymaster 192.168.56.113 6380</span></span><br><span class="line">1:X 15 Dec 2021 00:52:02.065 * +convert-to-slave slave 192.168.56.113:6379 192.168.56.113 6379 @ mymaster 192.168.56.113 6380</span><br></pre></td></tr></table></figure></p>
<p>由日志可知，端口为<code>6379</code>的redis已经变成slave节点，我们看下<code>6379</code>、<code>6380</code>、<code>6381</code>的情况：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">redis.hewentian.com:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.56.113</span><br><span class="line">master_port:6380</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:0</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:363284</span><br><span class="line">slave_repl_offset:363284</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:dc5c403d30736f872625b3669a7a721234cfe92f</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:363284</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:354813</span><br><span class="line">repl_backlog_histlen:8472</span><br><span class="line">redis.hewentian.com:6379&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis.hewentian.com:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.56.113,port=6381,state=online,offset=367435,lag=1</span><br><span class="line">slave1:ip=192.168.56.113,port=6379,state=online,offset=367568,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:dc5c403d30736f872625b3669a7a721234cfe92f</span><br><span class="line">master_replid2:2539e5441c16b58f2b934274db472690a9dd9139</span><br><span class="line">master_repl_offset:367568</span><br><span class="line">second_repl_offset:237869</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:15</span><br><span class="line">repl_backlog_histlen:367554</span><br><span class="line">redis.hewentian.com:6380&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis.hewentian.com:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.56.113</span><br><span class="line">master_port:6380</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:0</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:408147</span><br><span class="line">slave_repl_offset:408147</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:dc5c403d30736f872625b3669a7a721234cfe92f</span><br><span class="line">master_replid2:2539e5441c16b58f2b934274db472690a9dd9139</span><br><span class="line">master_repl_offset:408147</span><br><span class="line">second_repl_offset:237869</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:43</span><br><span class="line">repl_backlog_histlen:408105</span><br><span class="line">redis.hewentian.com:6381&gt;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/08/14/redis-ha/" data-id="clf9thvmq002l6h3kszhdrx2o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-redis-standalone" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/07/redis-standalone/" class="article-date">
  <time datetime="2018-08-07T02:50:27.000Z" itemprop="datePublished">2018-08-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/07/redis-standalone/">redis 的安装使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="要使用redis我们首先要安装这个软件。下面，我们说说redis的安装过程："><a href="#要使用redis我们首先要安装这个软件。下面，我们说说redis的安装过程：" class="headerlink" title="要使用redis我们首先要安装这个软件。下面，我们说说redis的安装过程："></a>要使用<code>redis</code>我们首先要安装这个软件。下面，我们说说<code>redis</code>的安装过程：</h4><p>首先，我们要将<code>redis</code>安装包下载回来，截止本文写时，<code>redis</code>官网发布的最新版本为<code>4.0.11</code>。当然，我们也可以从这里下载 <a href="/download/redis-4.0.11.tar.gz">redis-4.0.11.tar.gz</a> 和 <a href="/download/redis-4.0.11.tar.gz.md5">redis-4.0.11.tar.gz.md5</a>。推荐从<code>redis</code>官网下载最新版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/</span><br><span class="line">$ wget http://download.redis.io/releases/redis-4.0.11.tar.gz</span><br><span class="line"></span><br><span class="line">// 验证下载文件的完整性，在下载的时候要将MD5文件或者SHA256文件也下载回来</span><br><span class="line">$ md5sum -c redis-4.0.11.tar.gz.md5 </span><br><span class="line">redis-4.0.11.tar.gz: OK</span><br><span class="line"></span><br><span class="line">$ tar xzf redis-4.0.11.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> redis-4.0.11/</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>
<h4 id="After-building-Redis-it-is-a-good-idea-to-test-it-using"><a href="#After-building-Redis-it-is-a-good-idea-to-test-it-using" class="headerlink" title="After building Redis, it is a good idea to test it using:"></a>After building Redis, it is a good idea to test it using:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">// 如果见到下面的结果，证明我们已经成功安装</span><br><span class="line">\o/ All tests passed without errors!</span><br></pre></td></tr></table></figure>
<h4 id="下面的内容摘自-REDIS-HOME-README-md"><a href="#下面的内容摘自-REDIS-HOME-README-md" class="headerlink" title="下面的内容摘自${REDIS_HOME}/README.md"></a>下面的内容摘自<code>${REDIS_HOME}/README.md</code></h4><h2 id="Running-Redis"><a href="#Running-Redis" class="headerlink" title="Running Redis"></a>Running Redis</h2><p>To run Redis with the default configuration just type:</p>
<pre><code>$ cd src
$ ./redis-server
</code></pre><p>If you want to provide your redis.conf, you have to run it using an additional<br>parameter (the path of the configuration file):</p>
<pre><code>$ cd src
$ ./redis-server /path/to/redis.conf
</code></pre><p>It is possible to alter the Redis configuration by passing parameters directly<br>as options using the command line. Examples:</p>
<pre><code>$ ./redis-server --port 9999 --slaveof 127.0.0.1 6379
$ ./redis-server /etc/redis/6379.conf --loglevel debug
</code></pre><p>All the options in redis.conf are also supported as options using the command<br>line, with exactly the same name.</p>
<h2 id="Playing-with-Redis"><a href="#Playing-with-Redis" class="headerlink" title="Playing with Redis"></a>Playing with Redis</h2><p>You can use redis-cli to play with Redis. Start a redis-server instance,<br>then in another terminal try the following:</p>
<pre><code>$ cd src
$ ./redis-cli    # 如果需要连接到指定的redis可以使用：-h {IP_ADDRESS}参数，如：./redis-cli -h 127.0.0.1
redis&gt; ping
PONG
redis&gt; set foo bar
OK
redis&gt; get foo
&quot;bar&quot;
redis&gt; incr mycounter
(integer) 1
redis&gt; incr mycounter
(integer) 2
redis&gt;
</code></pre><p>You can find the list of all the available commands at <a href="http://redis.io/commands" target="_blank" rel="noopener">http://redis.io/commands</a>.</p>
<p>  <strong><em>注意：启动Redis服务器的时候，请务必指定它的配置文件，否则有可能会出现意想不到的情况。</em></strong></p>
<h4 id="为Redis设置登录密码"><a href="#为Redis设置登录密码" class="headerlink" title="为Redis设置登录密码"></a>为Redis设置登录密码</h4><p>  为Redis设置登录密码的方法比较简单，打开<code>${REDIS_HOME}/redis.conf</code>文件，找到<code>requirepass foobared</code>这一行，如下：</p>
<pre><code>################################## SECURITY ###################################

# Require clients to issue AUTH &lt;PASSWORD&gt; before processing any other
# commands.  This might be useful in environments in which you do not trust
# others with access to the host running redis-server.
#
# This should stay commented out for backward compatibility and because most
# people do not need auth (e.g. they run their own servers).
#
# Warning: since Redis is pretty fast an outside user can try up to
# 150k passwords per second against a good box. This means that you should
# use a very strong password otherwise it will be very easy to break.
#
# requirepass foobared
</code></pre><p>将<code>requirepass foobared</code>的注释打开，并把foobared设置成自己的密码即可，如将其设为abc123： </p>
<pre><code>requirepass abc123
</code></pre><p>保存文件，并重启Redis。</p>
<p>在使用客户端登录的时候，将使用如下命令：</p>
<pre><code>$ cd src
$ ./redis-cli -a abc123

或者使用下面的方式更安全
$ cd src
$ ./redis-cli
127.0.0.1:6379&gt; AUTH abc123
OK
</code></pre><h3 id="一些常规配置"><a href="#一些常规配置" class="headerlink" title="一些常规配置"></a>一些常规配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vi &#123;REDIS_HOME&#125;/redis.conf</span><br><span class="line"></span><br><span class="line">pidfile /home/hewentian/db/redis/redis.pid</span><br><span class="line">logfile /home/hewentian/db/redis/logs/redis.log</span><br><span class="line">dir /home/hewentian/db/redis/data</span><br><span class="line">daemonize yes                       <span class="comment"># 是否以后台进程运行</span></span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1 redis.hewentian.com  <span class="comment"># 127.0.0.1只能在本机访问，如果要在外网访问，要配置多一个地址，用空格隔开</span></span><br></pre></td></tr></table></figure>
<p>docker的安装方式，请参考<a href="../../../../2019/07/26/docker-note" title="docker 学习笔记">这里</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/08/07/redis-standalone/" data-id="clf9thvmn002g6h3k9lfllciv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-jvm-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/06/jvm-note/" class="article-date">
  <time datetime="2018-04-06T03:29:42.000Z" itemprop="datePublished">2018-04-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/06/jvm-note/">jvm 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在看周志明先生的《深入理解JAVA虚拟机JVM高级特性与最佳实践》，作笔记如下，以便自已复习。文中代码，大部分摘自书中。</p>
<p>JVM的基本结构：类加载子系统、方法区、JAVA堆、JAVA栈、本地方法区、程序计数器、直接内存、垃圾回收系统和执行引擎。</p>
<p>JVM的运行时数据区如下所示：<br><img src="/img/jvm-runtime-data-schema.png" alt="" title="图片来源于网络，仅用于学习使用"></p>
<p>JAVA的NIO库允许程序使用直接内存，从而提高性能，通常直接内存速度会优于堆。读写频繁的场合，可以优先考虑使用。</p>
<p>lambda函数式编程的一个重要优点就是这样的程序天然地适合并行运行，这对JAVA语言在多核时代继续保持主流语言的地位有很大的帮助。</p>
<h3 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h3><ol>
<li>引用计数法：是古老而经典的垃圾收集算法，其核心就是在对象被其他对象所引用的时候计数器加1，而当引用失效时则减1。但是这种方式有非常严重的问题：无法处理循环引用的情况、还有的就是每次进行加减操作比较浪费系统性能。</li>
<li>标记清除法：分为标记和清除两个阶段，这种方式也有非常大的漏洞弊端，就是空间碎片问题，垃圾回收后，空间不是连续的。</li>
<li>复制算法：其核心思想就是将内存分为两块，每次只使用其中一块。在回收时，将正在使用的内存中的存留对象复制到未被使用的内存中去，之后清除之前正在使用的内存中的所有对象，反复去交换两个内存的角式。</li>
<li>标记压缩法：是在标记清除法的基础上做了优化，把存活的对象压缩到内存的一端，然后进行垃圾清理（老年代中使用的回收方法）</li>
<li>分代算法：根据对象的特点把内存分成N块，然后根据每个对象的特点使用不同的算法。对于新生代，它的回收频率很高，但是每次回收耗时都很短；而老年代回收频率较低，但是耗时相对较长，所以应该尽量减少老年代的GC。</li>
</ol>
<h3 id="确定对象是否已死的方法"><a href="#确定对象是否已死的方法" class="headerlink" title="确定对象是否已死的方法"></a>确定对象是否已死的方法</h3><p>也就是如何判定对象是否为垃圾。</p>
<ol>
<li>引用计数法；</li>
<li>可达性分析算法GC Root.</li>
</ol>
<p>GC Root有以下几种：</p>
<ol>
<li>jvm stack</li>
<li>native method stack</li>
<li>runtime constant pool</li>
<li>static references in method area</li>
</ol>
<p>翻译如下：</p>
<ol>
<li>虚拟机栈中（局部变量）的引用对象</li>
<li>本地方法栈中JNI（Native方法）的引用对象</li>
<li>方法区中常量引用的对象（final 的常量值）</li>
<li>方法区中的类静态属性引用对象</li>
</ol>
<h3 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h3><ol>
<li>串行回收器： 使用单线程进行垃圾回收的回收器。每次回收时，串行回收器只有一个工作线程，对于并行能力较弱的计算机来说，串行回收器的专注性和独占性往往有更好的性能表现。新生代采用复制算法，老年代采用标记-整理算法，它在收集的同时，所有的用户线程必须暂停（Stop The World）。可以在新生代和老年代使用。新生代，<code>-XX:+UseSerialGC</code>。老年代，<code>-XX:+UseSerialOldGC</code>。</li>
<li>并行回收器： 在串行回收器的基础上作了改进，他可以使用多个线程同时进行垃圾回收，对于计算能力强的计算机而言，可以有效的缩短回收所需的实际时间。他只是简单的将串行回收器多线程化，他的回收策略和算法和串行回收器一样，同样采用复制算法。只使用在新生代。<code>-XX:+UseParNewGC</code></li>
<li>Parallel Scavenge： 新生代回收器，使用了复杂算法的收集器，也是多线程独占形式的收集器，它有个特点，就是它非常关注系统的吞吐量。适用场景：注重吞吐量，高效利用CPU，需要高效运算且不需要太多交互。可以使用<code>-XX:+UseParallelGC</code>来选择<code>Parallel Scavenge</code>作为新生代收集器，jdk7、jdk8默认使用它作为新生代收集器。</li>
<li>CMS：全称为<code>Concurrent Mark Sweep</code>，意为并发标记清除，他使用的是标记清除法，主要关注系统停顿时间。<code>-XX:+UseConcMarkSweepGC</code>进行设置，<code>-XX:ConcGCThreads</code>设置并发线程数量。CMS并不是独占的回收器，也就是说CMS回收的过程中，应用程序仍然可以在不停的工作。无法处理浮动垃圾：在并发清理阶段，由于用户线程还在运行，还会不断产生新的垃圾，CMS收集器无法在当次收集中清除这部分垃圾。CMS比较耗内存，CMS不会等到应用程序饱和的时候才去回收垃圾，而是在某一个阀值的时候开始回收，可以使用参数指定：<code>-XX:CMSInitiatingOccupancyFraction</code>来指定，默认为68，也就是说当老年代的空间使用率达68%的时候，会执行CMS回收。如果内存不足，收集可能会失败，如果失败了，会启动老年代串行回收器。CMS收集器是一种以最短回收停顿时间为目标的收集器，以“最短用户线程停顿时间”著称。整个垃圾收集过程分为4个步骤：(1)初始标记：标记一下GC Roots能直接关联到的对象，速度较快。(2)并发标记：进行GC Roots Tracing，标记出全部的垃圾对象，耗时较长。(3)重新标记：修正并发标记阶段因用户程序继续运行而导致变化的对象的标记记录，耗时较短。(4)并发清除：用标记-清除算法清除垃圾对象，耗时较长。整个过程耗时最长的并发标记和并发清除都是和用户线程一起工作，所以从总体上来说，CMS收集器垃圾收集可以看做是和用户线程并发执行的。适用场景：重视服务器响应速度，要求系统停顿时间最短。</li>
<li>G1：<code>Garbage-First</code>是在JDK1.7中提出的垃圾回收器，是为了取代CMS的回收器。它属于分代回收器，并行性和并发性。并行性是G1回收期间可多线程同时工作，而并发性是G1拥有与应用程序交替执行能力，部分工作可与应用程序同时执行，在整个GC期间不会完全阻塞应用程序。它可以工作在新生代和老年代。之前的回收器，或者工作在新生代，或者工作在老年代。G1使用了有益智复制对象的方式，减少空间碎片。G1收集器收集器收集过程有初始标记、并发标记、最终标记、筛选回收，和CMS收集器前几步的收集过程很相似：(1)初始标记：标记出GC Roots直接关联的对象，这个阶段速度较快，需要停止用户线程，单线程执行。(2)并发标记：从GC Root开始对堆中的对象进行可达性分析，找出存活对象，这个阶段耗时较长，但可以和用户线程并发执行。(3)最终标记：修正在并发标记阶段因用户程序执行而产生变动的标记记录。(4)筛选回收：筛选回收阶段会对各个Region的回收价值和成本进行排序，根据用户所期望的GC停顿时间来指定回收计划（用最少的时间来回收包含垃圾最多的区域，这就是Garbage First的由来——第一时间清理垃圾最多的区块），这里为了提高回收效率，并没有采用和用户线程并发执行的方式，而是停顿用户线程。适用场景：要求尽可能可控GC停顿时间；内存占用较大的应用。可以用<code>-XX:+UseG1GC</code>使用G1收集器，JDK9默认使用G1收集器。</li>
</ol>
<p>一些参数：<br>-XX:+UseSerialGC：在新生代和老年代使用串行收集器<br>-XX:+UseParNewGC：在新生代使用并行收集器<br>-XX:+UseParallelGC：新生代使用并行回收收集器，更加关注吞吐量<br>-XX:+UseParallelOldGC：老年代使用并行回收收集器<br>-XX:ParallelGCThreads：设置用于垃圾回收的线程数<br>-XX:+UseConcMarkSweepGC：新生代使用并行收集器，老年代使用CMS+串行收集器<br>-XX:ParallelCMSThreads：设定CMS的线程数量<br>-XX:+UseG1GC：启用G1垃圾回收器</p>
<p>将GC的日志输出到文件可以配置JVM启动参数：<code>-Xloggc:/home/hewentian/Document/gc.log</code></p>
<p>minorGC：Eden区满的时候执行；<br>FullGC：老年代空间不足时，或方法区空间不足时执行，<code>System.gc()</code>；</p>
<h3 id="class文件格式"><a href="#class文件格式" class="headerlink" title="class文件格式"></a>class文件格式</h3><p>class文件是一组以8位字节码为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在class文件之中，中间没有添加任何分隔符，这使得整个class文件中存储的内容几乎全部是程序运行的必要数据，没有空隙存在。当遇到需要占用8位字节以上空间的数据项时，则会按照高位在前的方式分割成若干个8位字节进行存储。</p>
<p>无符号数属于基本的数据类型，以u1, u2, u4, u8来分别代表1，2，4，8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成字符串值。</p>
<p>如下图所示：<br><img src="/img/class-file-format.png" alt="" title="图片来源：周志明先生的《深入理解JAVA虚拟机JVM高级特性与最佳实践》"></p>
<h3 id="魔数与class文件的版本"><a href="#魔数与class文件的版本" class="headerlink" title="魔数与class文件的版本"></a>魔数与class文件的版本</h3><p><strong>魔数：</strong> 每个class文件的头4个字节称为魔数(Magic Number)，它的唯一作用是确定这个文件是否为一个能被虚拟机接受的class文件。<br><strong>版本号：</strong> 紧接着魔数的4个字节存储的是class文件的版本号：第5和第6个字节是次版本号(Minor Version)，第7和第8个字节是主版本号(Major Version)。只有当前JVM的版本号大于等于这个文件的版本号，该文件才会被JVM加载。</p>
<h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><p>JVM直接支持（转换时无需显式的转换指令）：</p>
<ol>
<li>int类型到long, float或者double类型；</li>
<li>long类型到float, double类型；</li>
<li>float类型到double类型。</li>
</ol>
<h3 id="JVM中对象的创建过程"><a href="#JVM中对象的创建过程" class="headerlink" title="JVM中对象的创建过程"></a>JVM中对象的创建过程</h3><ol>
<li>当使用创建指令new一个对象的时候，在方法区的常量池中定位一个对象的符号引用，如果该类未被加载就先加载；</li>
<li>然后再为该对象分配内存，最后是对象初始化，即调用它的构造方法。分配内存分指针碰撞和空闲链表两种。</li>
</ol>
<h3 id="类的加载过程"><a href="#类的加载过程" class="headerlink" title="类的加载过程"></a>类的加载过程</h3><p>JVM中类的加载过程：加载、验证、准备、解析、初始化。如果算上：使用和缷载这两个过程，则一共有7个过程。</p>
<p>加载：加载要完成以下三件事：</p>
<ol>
<li>通过一个类的全限定名来获取定义此类的二进制字节流（不一定从文件中读取，可以从网络或数据库中）；</li>
<li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构;</li>
<li>在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口。</li>
</ol>
<p>验证：验证是连接阶段的第一步，这一阶段的目的是为了确保class文件的字节流中包含的信息符合当前JVM的要求，并且不会危害JVM自身的安全。<br>准备：正式为类变量（static修饰）分配内存并设置类变量初始值的阶段，通常是该类型的零值；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</span><br></pre></td></tr></table></figure></p>
<p>变量value在准备阶段过后的初始值为0，而不是123。赋值为123在初始化阶段才会执行。</p>
<p>解析：JVM将常量池内的符号引用替换为直接引用的过程；<br>初始化：执行类构造器的过程，设置实例变量的初始值。</p>
<p>其中，加载、验证、准备、初始化和缷载这5个阶段的顺序是确定的。如下图所示：<br><img src="/img/class-loading.png" alt="" title="图片来源：周志明先生的《深入理解JAVA虚拟机JVM高级特性与最佳实践》"></p>
<h3 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h3><p>从JAVA开发人员的角度来看，绝大部分JAVA程序都会使用到以下3种系统提供的类加载器：</p>
<ol>
<li>启动类加载器(Bootstrap ClassLoader)：这个类加载器负责将存放在<code>&lt;JAVA_HOME&gt;/lib</code>目录中的，或者被<code>-Xbootclasspath</code>参数所指定的路径中的，并且是虚拟机识别的（仅按照文件名识别，如rt.jar，名字不符合的类库即使放在lib目录中也不会被加载）类库加载到虚拟机内存中。启动类加载器无法被JAVA程序直接引用，用户在编写自定义类加载器时，如果需要把加载请求委派给引导类加载器，那么使用null代替即可。</li>
<li>扩展类加载器(Extension ClassLoader)：这个加载器由<code>sun.misc.Launcher$ExtClassLoader</code>实现，它负责加载<code>&lt;JAVA_HOME&gt;/lib/ext</code>目录中的，或者被<code>java.ext.dirs</code>系统变量所指定的路径中的所有类库，开发者可以直接使用扩展类加载器。</li>
<li>应用程序类加载器(Application ClassLoader)：这个类加载器由<code>sun.misc.Launcher$AppClassLoader</code>实现。由于这个类加载器是<code>ClassLoader中的getSystemClassLoader()</code>方法的返回值，所以一般也称它为系统类加载器。它负责加载用户类路径(ClassPath)上所指定的类库，开发者可以直接使用这个类加载器，如果应用程序中没有自定义过自已的类加载器，一般情况下这个就是程序中默认的类加载器。</li>
</ol>
<p>我们的应用程序都是由这3种类加载器互相配合进行加载的，如果有必要，还可以加入自已定义的类加载器。这些类加载器之间的关系一般如下图所示，这种层次关系，称为类加载器的双亲委派模型。<br><img src="/img/class-loader-mode.png" alt="" title="图片来源：周志明先生的《深入理解JAVA虚拟机JVM高级特性与最佳实践》"></p>
<p>什么时候触发类加载：</p>
<ol>
<li><code>new</code>一个类实例的时候；</li>
<li>调用一个类的<code>static</code>变量或方法的时候，例如：<code>System.out</code>；</li>
<li>反射调用的时候，如果该类还没进行过初始化；</li>
<li>初始化一个类，其父类还没初始化时，会先初始化其父类；</li>
<li>启动时的类，即运行<code>main</code>方法类。</li>
</ol>
<p>静态加载和动态加载：<br>静态加载：在代码中通过<code>new</code>创建实例，称为静态加载；<br>动态加载：在运行时，通过<code>Class.forName()</code>加载一个类，称为动态加载。</p>
<p><code>loadClass()</code>和<code>Class.forName()</code>的区别：<br><code>ClassLoader.loadClass()</code>仅会将类加载到内存中，但不会实例化对象。而<code>Class.forName()</code>在加载之后，会实例化对象，也就是说它会返回一个对象。</p>
<p><code>new</code>和<code>newInstance()</code>创建类的区别：</p>
<ol>
<li><code>newInstance()</code>必须保证这个类被加载；</li>
<li><code>new</code>关键字，如果类没有被加载，那么就会先加载；</li>
<li><code>new</code>可以调用类的任何构造方法，而<code>newInstance()</code>只能调用默认的无参构造方法；</li>
<li><code>new</code>出来的对象是强类型的，效率高；<code>newInstance()</code>创建的对象是弱类型的，效率相对较低。</li>
</ol>
<h3 id="当泛型遇上重载"><a href="#当泛型遇上重载" class="headerlink" title="当泛型遇上重载"></a>当泛型遇上重载</h3><p>下面的代码是不能通过编译的，因为参数<code>List&lt;String&gt;</code>和<code>List&lt;Integer&gt;</code>编译之后都被擦除了，变成了一样的<code>List&lt;E&gt;</code>，擦除动作导致这两种方法的特征签名变得一模一样。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(List&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"invoke method(List&lt;String&gt; list)"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(List&lt;Integer&gt; list)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"invoke method(List&lt;Integer&gt; list)"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果真是要重载，可以适当修改上述代码，只要增加返回值即可，它也只能在JDK1.6上可以编译通过。在JDK1.8也是无法编译通过的。如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">method</span><span class="params">(List&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"invoke method(List&lt;String&gt; list)"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">method</span><span class="params">(List&lt;Integer&gt; list)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"invoke method(List&lt;Integer&gt; list)"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而改成下面这种，则可以通过编译<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"invoke method(String s)"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(List&lt;Integer&gt; list)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"invoke method(List&lt;Integer&gt; list)"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="自动装箱的陷阱"><a href="#自动装箱的陷阱" class="headerlink" title="自动装箱的陷阱"></a>自动装箱的陷阱</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Integer a = <span class="number">1</span>;</span><br><span class="line">    Integer b = <span class="number">2</span>;</span><br><span class="line">    Integer c = <span class="number">3</span>;</span><br><span class="line">    Integer d = <span class="number">3</span>;</span><br><span class="line">    Integer e = <span class="number">321</span>;</span><br><span class="line">    Integer f = <span class="number">321</span>;</span><br><span class="line">    Long g = <span class="number">3L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 JDK1.8 中的结果如下</span></span><br><span class="line">    System.out.println(c == d);             <span class="comment">// true, [-127, 128]之间的Integer数字会被缓存</span></span><br><span class="line">    System.out.println(e == f);             <span class="comment">// false</span></span><br><span class="line">    System.out.println(e.equals(f));        <span class="comment">// true</span></span><br><span class="line">    System.out.println(c == (a + b));       <span class="comment">// true</span></span><br><span class="line">    System.out.println(c.equals(a + b));    <span class="comment">// true</span></span><br><span class="line">    System.out.println(g == (a + b));       <span class="comment">// true</span></span><br><span class="line">    System.out.println(g.equals(a + b));    <span class="comment">// false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="final语言校验"><a href="#final语言校验" class="headerlink" title="final语言校验"></a>final语言校验</h3><p>下面这两段代码编译出来的class文件是一样的，没有任何区别。只是在编写程序的时候会受到final的约束。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法一：带有final修饰</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> var = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法二：没有final修饰</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> var = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="解释器与编译器"><a href="#解释器与编译器" class="headerlink" title="解释器与编译器"></a>解释器与编译器</h3><p>尽管不是所有的JVM都采用解释器与编译器并存的架构，但许多主流的商用JVM，如HotSpot、J9等，都同时包含解释器与编译器。<strong>但是，三大商用JVM之一的JRockit是个例外，它内部没有解释器。</strong>解释器与编译器两者各有优势：当程序需要迅速启动和执行的时候，解释器可以首先发挥作用，省去编译的时间，立即执行。在程序运行后，随着时间的推移，编译器逐渐发挥作用，把越来越多的代码编译成本地代码之后，可以获取更高的执行效率。当程序运行环境中内存资源限制较大（如部分嵌入式系统中），可以使用解释执行节约内存，反之可以使用编译执行来提升效率。在整个JVM执行架构中，解释器与编译器经常配合工作，如下图。<br><img src="/img/compiler-and-interpreter.png" alt="" title="图片来源：周志明先生的《深入理解JAVA虚拟机JVM高级特性与最佳实践》"></p>
<h3 id="程序编译与代码优化"><a href="#程序编译与代码优化" class="headerlink" title="程序编译与代码优化"></a>程序编译与代码优化</h3><p>从sun javac的代码来看，编译过程大致可以分成3个过程：</p>
<ol>
<li>解析与填充符号表的过程(Parse and Enter);</li>
<li>插入式注解处理器的注解处理过程(Annotation Processing);</li>
<li>分析与字节码生成的过程(Analyse and Generate)。</li>
</ol>
<h3 id="编译对象与触发条件"><a href="#编译对象与触发条件" class="headerlink" title="编译对象与触发条件"></a>编译对象与触发条件</h3><p>在程序运行的过程中会被即时编译器JIT编译的“热点代码”有两类：</p>
<ol>
<li>被多次调用的方法；</li>
<li>被多次执行的循环体。</li>
</ol>
<p>判断一段代码是不是热点代码，是不是需要触发即时编译，这样的行为称为热点探测(Hot Spot Detection)，其实进行热点探测并不一定要知道方法具体被调用了多少次，目前主要的热点探测判定方法有两种，分别如下：</p>
<ul>
<li>基于采样的热点探测(Sample Based Hot Spot Detection)：采用这种方法的JVM会周期性地检查各个线程的栈顶，如果发现某个（或某些）方法经常出现在栈顶，那这个方法就是“热点方法”。基于采样的热点探测的好处是实现简单、高效，还可以很容易地获取方法调用关系（将调用堆栈展开即可），缺点是很难精确地确认一个方法的热度，容易因为受到线程阻塞或别的外界因素的影响而扰乱热点探测。</li>
<li>基于计数器的热点探测(Counter Based Hot Spot Detection)：采用这种方法的JVM会为每个方法（甚至是代码块）建立计数器，统计方法的执行次数，如果执行次数超过一定的阈值就认为它是“热点方法”。这种统计方法实现起来麻烦一些，需要为每个方法建立并维护计数器，而且不能直接获取到方法的调用关系，但是它的统计结果相对来说更加精确和严谨。</li>
</ul>
<p>在HotSpot虚拟机中使用的是第二种–基于计数器的热点探测方法，因此它为每个方法准备了两类计数器：方法调用计数器(Invocation Counter)和回边计数器(Back Edge Counter)。</p>
<p>在确定虚拟机运行参数的前提下，这两个计数器都有一个确定的阈值，当计数器超过阈值溢出了，就会触发JIT编译。</p>
<p>我们首先来看看方法调用计数器，顾名思义，这个计数器就用于统计方法被调用的次数，它的默认阈值在Client模式下是1500次，在Server模式下是10000次，这个阈值可以通过JVM参数<code>-XX:CompileThreshold</code>来人为设定。</p>
<p>下面我们再来看看回边计数器。<strong>什么是回边？ 在字节码遇到控制流向后跳转的指令称为回边（Back Edge）。</strong>回边计数器是用来统计一个方法中循环体代码执行的次数，回边计数器的阈值可以通过参数<code>-XX：OnStackReplacePercentage</code>来调整。</p>
<p>虚拟机运行在Client模式下，回边计数器阈值计算公式为：<br>方法调用计数器阈值(CompileThreshold) x OSR比率(OnStackReplacePercentage) / 100<br>其中OnStackReplacePercentage默认值为933，如果都取默认值，那Client模式虚拟机的回边计数器的阈值为13995.</p>
<p>虚拟机运行在Server模式下，回边计数器阈值的计算公式为：<br>方法调用计数器阈值(CompileThreshold) x (OSR比率(OnStackReplacePercentage) - 解释器监控比率(InterpreterProfilePercentage) / 100<br>其中OnStackReplacePercentage默认值为140，InterpreterProfilePercentage默认值为33。<br>如果都取默认值，那Server模式虚拟机回边计数器的阑值为10700。</p>
<p>回边计数器与方法调用计数器不同的是，回边计数器没有热度衰减，因此这个计数器统计的就是循环执行的绝对次数。</p>
<p>参见下图：<br><img src="/img/method-invoke-trigger-jit.png" alt="" title="图片来源：周志明先生的《深入理解JAVA虚拟机JVM高级特性与最佳实践》"></p>
<h3 id="程序延时一定时间"><a href="#程序延时一定时间" class="headerlink" title="程序延时一定时间"></a>程序延时一定时间</h3><p>像下面的空循环经JIT编译器优化后，会被消除掉，以前很多入门教程把空循环当做程序延时的手段来介绍，其实是错误的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10000</span>; i++)</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure></p>
<p>要延时应该使用下面的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不使用的对象应手动设为null，不过，赋值为null的操作在经过JIT编译优化后就会被消除掉，这时候将变量设置为null就是没有意义的。</p>
<h3 id="线程、主内存、工作内存、处理器的关系图"><a href="#线程、主内存、工作内存、处理器的关系图" class="headerlink" title="线程、主内存、工作内存、处理器的关系图"></a>线程、主内存、工作内存、处理器的关系图</h3><p><img src="/img/cpu-thread-memory.png" alt="" title="图片来源：周志明先生的《深入理解JAVA虚拟机JVM高级特性与最佳实践》"></p>
<p>除了增加高速缓存，为了使处理器内部运算单元尽可能被充分利用，处理器还会对输入的代码进行乱序执行(Out-Of-Order Execution)优化，处理器会在乱序执行之后的结果进行重组，保证结果的正确性，也就是保证结果与顺序执行的结果一致。但是在真正的执行过程中，代码执行的顺序并不一定按照代码的书写顺序来执行，可能和代码的书写顺序不同。</p>
<h3 id="java内存模型"><a href="#java内存模型" class="headerlink" title="java内存模型"></a>java内存模型</h3><p>虽然java程序所有的运行都是在虚拟机中，涉及到的内存等信息都是虚拟机的一部分，但实际也是物理机的，只不过是虚拟机作为最外层的容器统一做了处理。虚拟机的内存模型，以及多线程的场景下与物理机的情况是很相似的，可以类比参考。<br>Java内存模型的主要目标是定义程序中变量的访问规则。即在虚拟机中将变量存储到主内存或者将变量从主内存取出这样的底层细节。需要注意的是这里的变量跟我们写java程序中的变量不是完全等同的。这里的变量是指实例字段，静态字段，构成数组对象的元素，但是不包括局部变量和方法参数（因为这是线程私有的）。这里可以简单的认为主内存是java虚拟机内存区域中的堆，局部变量和方法参数是在虚拟机栈中定义的。但是在堆中的变量如果在多线程中都使用，就涉及到了堆和不同虚拟机栈中变量的值的一致性问题了。</p>
<p>Java内存模型中涉及到的概念有：</p>
<ul>
<li>主内存：java虚拟机规定所有的变量（不是程序中的变量）都必须在主内存中产生，为了方便理解，可以认为是堆区。可以与前面说的物理机的主内存相比，只不过物理机的主内存是整个机器的内存，而虚拟机的主内存是虚拟机内存中的一部分。</li>
<li>工作内存：java虚拟机中每个线程都有自己的工作内存，该内存是线程私有的为了方便理解，可以认为是虚拟机栈。可以与前面说的高速缓存相比。线程的工作内存保存了线程需要的变量在主内存中的副本。虚拟机规定，线程对主内存变量的修改必须在线程的工作内存中进行，不能直接读写主内存中的变量。不同的线程之间也不能相互访问对方的工作内存。如果线程之间需要传递变量的值，必须通过主内存来作为中介进行传递。</li>
</ul>
<p>这里需要说明一下：主内存、工作内存与java内存区域中的java堆、虚拟机栈、方法区并不是一个层次的内存划分。这两者基本上是没有关系的，上文只是为了便于理解，做的类比。</p>
<h3 id="内存间交互操作"><a href="#内存间交互操作" class="headerlink" title="内存间交互操作"></a>内存间交互操作</h3><p>关于主内存与工作内存之间具体的交互协议，即一个变量如何从主内存复制到工作内存、如何从工作内存同步回主内存之类的实现细节，JAVA内存模型中定义了以下8种操作来完成，虚拟机实现时必须保证下面提及的每一种操作都是原子的、不可再分的（对于double和long类型的变量来说，load、store、read和write操作在某些平台上允许有例外）。</p>
<ul>
<li>lock（锁定）：作用于主内存的变量，它把一个变量标识为一条线程独占的状态；</li>
<li>read（读取）：作用于主内存的变量，它把一个变量的值从主内存传输到线程的工作内存中，以便随后的load动作使用；</li>
<li>load（载入）：作用于工作内存的变量，它把read操作从主内存中得到的变量值放入工作内存的变量副本中；</li>
<li>use（使用）：作用于工作内存的变量，它把工作内存中一个变量的值传递给执行引擎，每当虚拟机遇到一个需要使用到变量的值的字节码指令时将会执行这个操作；</li>
<li>assign（赋值）：作用于工作内存的变量，它把一个从执行引擎接收到的值赋给工作内存的变量，每当虚拟机遇到一个给变量赋值的字节码指令时执行这个操作；</li>
<li>store（存储）：作用于工作内存的变量，它把工作内存中一个变量的值传送到主内存中，以便随后的write操作使用；</li>
<li>write（写入）：作用于主内存的变量，它把store操作从工作内存中得到的变量的值放入主内存的变量中。</li>
<li>unlock（解锁）：作用于主内存的变量，它把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定；</li>
</ul>
<h3 id="volatile变量的使用场景"><a href="#volatile变量的使用场景" class="headerlink" title="volatile变量的使用场景"></a>volatile变量的使用场景</h3><p>关键字volatile可以说是java虚拟机中提供的最轻量级的同步机制。java内存模型对volatile专门定义了一些特殊的访问规则。这些规则有些晦涩拗口，先列出规则，然后用更加通俗易懂的语言来解释：<br>假定T表示一个线程，V和W分别表示两个volatile修饰的变量，那么在进行read、load、use、assign、store和write操作的时候需要满足如下规则：</p>
<ul>
<li><p><strong>只有当线程T对变量V执行的前一个动作是load，线程T对变量V才能执行use动作；同时只有当线程T对变量V执行的后一个动作是use的时候线程T对变量V才能执行load操作。</strong>所以，线程T对变量V的use动作和线程T对变量V的read、load动作相关联，必须是连续一起出现。也就是在线程T的工作内存中，每次使用变量V之前必须从主内存去重新获取最新的值，用于保证线程T能看得见其他线程对变量V的最新的修改后的值。</p>
</li>
<li><p><strong>只有当线程T对变量V执行的前一个动作是assign的时候，线程T对变量V才能执行store动作；同时只有当线程T对变量V执行的后一个动作是store的时候，线程T对变量V才能执行assign动作。</strong>所以，线程T对变量V的assign操作和线程T对变量V的store、write动作相关联，必须一起连续出现。也即是在线程T的工作内存中，每次修改变量V之后必须立刻同步回主内存，用于保证线程T对变量V的修改能立刻被其他线程看到。</p>
</li>
<li><p><strong>假定动作A是线程T对变量V实施的use或assign动作，动作F是和动作A相关联的load或store动作，动作P是和动作F相对应的对变量V的read或write动作；类似的，假定动作B是线程T对变量W实施的use或assign动作，动作G是和动作B相关联的load或store动作，动作Q是和动作G相对应的对变量W的read或write动作。如果动作A先于B，那么P先于Q。</strong>也就是说在同一个线程内部，被volatile修饰的变量不会被指令重排序，保证代码的执行顺序和程序的顺序相同。</p>
</li>
</ul>
<p>总结上面三条规则，前面两条可以概括为：<strong>volatile类型的变量保证对所有线程的可见性。</strong>第三条为：<strong>volatile类型的变量禁止指令重排序优化。</strong>下面分别说明一下：</p>
<ul>
<li>valatile类型的变量保证对所有线程的可见性<br>可见性是指当一个线程修改了这个变量的值，新值（修改后的值）对于其他线程来说是立即可以得知的。正如上面的前两条规则规定，volatile类型的变量每次值被修改了就立即同步回主内存，每次使用时就需要从主内存重新读取值。返回到前面对普通变量的规则中，并没有要求这一点，所以普通变量的值是不会立即对所有线程可见的。<br>误解：volatile变量对所有线程是立即可见的，所以对volatile变量的所有修改(写操作)都立刻能反应到其他线程中。或者换句话说：volatile变量在各个线程中是一致的，所以基于volatile变量的运算在并发下是线程安全的。<br>这个观点的论据是正确的，但是根据论据得出的结论是错误的，并不能得出这样的结论。volatile的规则，保证了read、load、use的顺序和连续行，同理assign、store、write也是顺序和连续的。也就是这几个动作是原子性的，但是对变量的修改，或者对变量的运算，却不能保证是原子性的。如果对变量的修改是分为多个步骤的，那么多个线程同时从主内存拿到的值是最新的，但是经过多步运算后回写到主内存的值是有可能存在覆盖情况发生的。如下代码的例子：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THREADS_NUM = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(THREADS_NUM);</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[THREADS_NUM];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREADS_NUM; i++) &#123;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                    increase();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            threads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        latch.await();</span><br><span class="line"></span><br><span class="line">        System.out.println(count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>代码就是对volatile类型的变量启动了20个线程，每个线程对变量执行1w次加1操作，如果volatile变量并发操作没有问题的话，那么结果应该是输出20w，但是结果运行的时候每次都是小于20w，这就是因为count++操作不是原子性的，是分多个步骤完成的。假设两个线程a、b同时取到了主内存的值，是0，这是没有问题的，在进行++操作的时候假设线程a执行到一半，线程b执行完了，这时线程b立即同步给了主内存，主内存的值为1，而线程a此时也执行完了，同步给了主内存，此时的值仍然是1，线程b的结果被覆盖掉了。</p>
<ul>
<li>volatile变量禁止指令重排序优化<br>普通的变量仅仅会保证在该方法执行的过程中，所有依赖赋值结果的地方都能获取到正确的结果，但不能保证变量赋值的操作顺序和程序代码的顺序一致。因为在一个线程的方法执行过程中无法感知到这一点，这也就是java内存模型中描述的所谓的“线程内部表现为串行的语义”。也就是在单线程内部，我们看到的或者感知到的结果和代码顺序是一致的，即使代码的执行顺序和代码顺序不一致，但是在需要赋值的时候结果也是正确的，所以看起来就是串行的。但实际结果有可能代码的执行顺序和代码顺序是不一致的。这在多线程中就会出现问题。<br>看下面的伪代码举例：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; configOptions;</span><br><span class="line"><span class="keyword">char</span>[] configText;</span><br><span class="line"><span class="comment">// volatile类型变量</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设以下代码在线程A中执行</span></span><br><span class="line"><span class="comment">// 模拟读取配置信息，读取完成后认为是初始化完成</span></span><br><span class="line">configOptions = <span class="keyword">new</span> HashMap();</span><br><span class="line">configText = readConfigFile(fileName);</span><br><span class="line">processConfigOptions(configText, configOptions);</span><br><span class="line">initialized = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设以下代码在线程B中执行</span></span><br><span class="line"><span class="comment">// 等待initialized为true后，读取配置信息进行操作</span></span><br><span class="line"><span class="keyword">while</span> (!initialized) &#123;</span><br><span class="line">  sleep();</span><br><span class="line">&#125;</span><br><span class="line">doSomethingWithConfig();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如果initialized是普通变量，没有被volatile修饰，那么线程A执行的代码的修改初始化完成的结果<code>initialized = true</code>就有可能先于之前的三行代码执行，而此时线程B发现initialized为true了，就执行<code>doSomethingWithConfig()</code>方法，但是里面的配置信息都是null的，就会出现问题了。现在initialized是volatile类型变量，保证禁止代码重排序优化，那么就可以保证<code>initialized = true</code>执行的时候，前边的三行代码一定执行完成了，那么线程B读取的配置文件信息就是正确的。</p>
<p>由于volatile变量只能保证可见性，在不符合以下两条规则的运算场景中，我们仍然要通过加锁（使用synchronized或java.util.concurrent中的原子类）来保证原子性。</p>
<ol>
<li>运算结果并不依赖变量的当前值，或者能够确保只有单一的线程修改变量的值；</li>
<li>变量不需要与其他的状态变量共同参与不变约束。</li>
</ol>
<p>像下面的代码就很适合使用volatile变量来控制并发，当shutdown方法被调用时，能保证所有线程中执行的doWork()方法都立即停下来。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> shutdownRequest;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    shutdownRequest = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(!shutdownRequest) &#123;</span><br><span class="line">    <span class="comment">// do stuff</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="线程状态转换"><a href="#线程状态转换" class="headerlink" title="线程状态转换"></a>线程状态转换</h3><p>Java语言定义了6种线程状态，在任意一个时间点，一个线程只能有且只有其中的一种状态，这6种状态分别如下：</p>
<ul>
<li>新建（New）：创建后尚未启动的线程处于这种状态；</li>
<li>运行（Runnable）：Runnable包括了操作系统线程状态中的Running和Ready，也就是处于此状态的线程有可能正在执行，也有可能正在等待着CPU为它分配执行时间；</li>
<li>无限期等待（Waiting）：处于这种状态的线程不会被分配CPU执行时间，它们要等待被其他线程显式地唤醒。以下方法会让线程陷入无限期的等待状态：<ul>
<li>没有设置Timeout参数的Object.wait()方法；</li>
<li>没有设置Timeout参数的Thread.join()方法；</li>
<li>LockSupport.park()方法；</li>
</ul>
</li>
<li>限期等待（Timed Waiting）：处于这种状态的线程也不会被分配CPU执行时间，不过无须等待被其他线程显式地唤醒，在一定的时间之后它们会由系统自动唤醒。以下方法会让线程进入限期等待状态：<ul>
<li>Thread.sleep()方法；</li>
<li>设置了Timeout参数的Object.wait()方法；</li>
<li>设置了Timeout参数的Thread.join()方法；</li>
<li>LockSupport.parkNanos()方法；</li>
<li>LockSupport.parkUntil()方法；</li>
</ul>
</li>
<li>阻塞（Blocked）：线程被阻塞了，“阻塞状态”与“等待状态”的区别是：“阻塞状态”在等待着获取到一个排他锁，这个事件将在另外一个线程放弃这个锁的时候发生；而“等待状态”则是在等待一段时间，或者唤醒动作的发生。在程序等待进入同步区域的时候，线程将进入这种状态。</li>
<li>结束（Terminated）：已终止线程的线程状态，线程已经执行结束。</li>
</ul>
<p>上述6种状态在遇到特定事件发生的时候会互相转换，它们的转换关系如下图所示：<br><img src="/img/thread-state-transform.png" alt="" title="图片来源：周志明先生的《深入理解JAVA虚拟机JVM高级特性与最佳实践》"></p>
<h3 id="Java生成Heap-Dump及OOM问题排查"><a href="#Java生成Heap-Dump及OOM问题排查" class="headerlink" title="Java生成Heap Dump及OOM问题排查"></a>Java生成Heap Dump及OOM问题排查</h3><p>引用自 <a href="https://www.baeldung.com/java-heap-dump-capture" target="_blank" rel="noopener">https://www.baeldung.com/java-heap-dump-capture</a><br>A heap dump is a snapshot of all the objects that are in memory in the JVM at a certain moment. They are very useful to troubleshoot memory-leak problems and optimize memory usage in Java applications.</p>
<p>Heap dumps are usually stored in binary format hprof files. We can open and analyze these files using tools like jhat or JVisualVM. Also, for Eclipse users it’s very common to use MAT.</p>
<p><strong>1. jmap</strong><br>jmap is a tool to print statistics about the memory in a running JVM. We can use it for local or remote processes.</p>
<p>To capture a heap dump using jmap we need to use the dump option:</p>
<pre><code>jmap -dump:[live],format=b,file=&lt;file-path&gt; &lt;pid&gt;
</code></pre><p>Along with that option, we should specify several parameters:</p>
<ul>
<li>live: if set it only prints objects which have active references and discards the ones that are ready to be garbage collected. This parameter is optional</li>
<li>format=b: specifies that the dump file will be in binary format. If not set the result is the same</li>
<li>file: the file where the dump will be written to</li>
<li>pid: id of the Java process</li>
</ul>
<p>An example would be like this:</p>
<pre><code>jmap -dump:live,format=b,file=/tmp/dump.hprof 12587
</code></pre><p>Remember that we can easily get the pid of a Java process by using the jps command.<br>Keep in mind that jmap was introduced in the JDK as an experimental tool and it’s unsupported. Therefore, in some cases, it may be preferable to use other tools instead.</p>
<p><strong>2. jcmd</strong><br>jcmd is a very complete tool which works by sending command requests to the JVM. We have to use it in the same machine where the Java process is running.</p>
<p>One of its many commands is the GC.heap_dump. We can use it to get a heap dump just by specifying the pid of the process and the output file path:</p>
<pre><code>jcmd &lt;pid&gt; GC.heap_dump &lt;file-path&gt;
</code></pre><p>We can execute it with the same parameters that we used before:</p>
<pre><code>jcmd 12587 GC.heap_dump /tmp/dump.hprof
</code></pre><p>As with jmap, the dump generated is in binary format.</p>
<p><strong>3. JVisualVM</strong><br>JVisualVM is a tool with a graphical user interface that lets us monitor, troubleshoot and profile Java applications. The GUI is simple but very intuitive and easy to use.</p>
<p>One of its many options allows us to capture a heap dump. If we right-click on a Java process and select the “Heap Dump” option, the tool will create a heap dump and open it in a new tab:</p>
<pre><code>jvisualvm
</code></pre><p>Notice that we can find the path of the file created in the “Basic Info” section.</p>
<p><strong>Capture a Heap Dump Automatically</strong><br>All the tools that we’ve shown in the previous sections are intended to capture heap dumps manually at a specific time. In some cases, we want to get a heap dump when a java.lang.OutOfMemoryError occurs so it helps us investigate the error.</p>
<p>For these cases, Java provides the HeapDumpOnOutOfMemoryError command-line option that generates a heap dump when a java.lang.OutOfMemoryError is thrown:</p>
<pre><code>java -XX:+HeapDumpOnOutOfMemoryError
</code></pre><p>By default, it stores the dump in a <code>java_pid&lt;pid&gt;.hprof</code> file in the directory where we’re running the application. If we want to specify another file or directory we can set it in the HeapDumpPath option:</p>
<pre><code>java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=&lt;file-or-dir-path&gt;
</code></pre><p>When our application runs out of memory using this option, we’ll be able to see in the logs the created file that contains the heap dump:</p>
<pre><code>java.lang.OutOfMemoryError: Requested array size exceeds VM limit
Dumping heap to java_pid12587.hprof ...
Exception in thread &quot;main&quot; Heap dump file created [4744371 bytes in 0.029 secs]
java.lang.OutOfMemoryError: Requested array size exceeds VM limit
    at com.baeldung.heapdump.App.main(App.java:7)
</code></pre><p>In the example above, it was written to the java_pid12587.hprof file.</p>
<p>As we can see, this option is very useful and there is no overhead when running an application with this option. Therefore, it’s highly recommended to use this option always, especially in production.</p>
<p>Finally, this option can also be specified at runtime by using the HotSpotDiagnostic MBean. To do so, we can use JConsole and set the HeapDumpOnOutOfMemoryError VM option to true:</p>
<p><strong>4. JMX</strong><br>The last approach that we’ll cover in this article is using JMX. We’ll use the HotSpotDiagnostic MBean that we briefly introduced in the previous section. This MBean provides a dumpHeap method that accepts 2 parameters:</p>
<ul>
<li>outputFile: the path of the file for the dump. The file should have the hprof extension</li>
<li>live: if set to true it dumps only the active objects in memory, as we’ve seen with jmap before</li>
</ul>
<p>In the next sections, we’ll show 2 different ways to invoke this method in order to capture a heap dump.</p>
<p><strong>4.1. JConsole</strong><br>The easiest way to use the HotSpotDiagnostic MBean is by using a JMX client such as JConsole.</p>
<p>If we open JConsole and connect to a running Java process, we can navigate to the MBeans tab and find the HotSpotDiagnostic under com.sun.management. In operations, we can find the dumpHeap method that we’ve described before:</p>
<p>As shown, we just need to introduce the parameters outputFile and live into the p0 and p1 text fields in order to perform the dumpHeap operation.</p>
<p><strong>4.2. Programmatic Way</strong><br>The other way to use the HotSpotDiagnostic MBean is by invoking it programmatically from Java code.</p>
<p>To do so, we first need to get an MBeanServer instance in order to get an MBean that is registered in the application. After that, we simply need to get an instance of a HotSpotDiagnosticMXBean and call its dumpHeap method.</p>
<p>Let’s see it in code:</p>
<pre><code>public static void dumpHeap(String filePath, boolean live) throws IOException {
    MBeanServer server = ManagementFactory.getPlatformMBeanServer();
    HotSpotDiagnosticMXBean mxBean = ManagementFactory.newPlatformMXBeanProxy(
    server, &quot;com.sun.management:type=HotSpotDiagnostic&quot;, HotSpotDiagnosticMXBean.class);
    mxBean.dumpHeap(filePath, live);
}
</code></pre><p>Notice that an hprof file cannot be overwritten. Therefore, we should take this into account when creating an application that prints heap dumps. If we fail to do so we’ll get an exception:</p>
<pre><code>Exception in thread &quot;main&quot; java.io.IOException: File exists
at sun.management.HotSpotDiagnostic.dumpHeap0(Native Method)
at sun.management.HotSpotDiagnostic.dumpHeap(HotSpotDiagnostic.java:60)
</code></pre><p><strong>5. Conclusion</strong><br>In this tutorial, we’ve shown multiple ways to capture a heap dump in Java.</p>
<p>As a rule of thumb, we should remember to use the HeapDumpOnOutOfMemoryError option always when running Java applications. For other purposes, any of the other tools can be perfectly used as long as we keep in mind the unsupported status of jmap.</p>
<p>we can open the file in Java VisualVM by choosing <code>File -&gt; Load</code> from the main menu.</p>
<h3 id="使用jstat命令查看jvm的GC情况"><a href="#使用jstat命令查看jvm的GC情况" class="headerlink" title="使用jstat命令查看jvm的GC情况"></a>使用jstat命令查看jvm的GC情况</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ jps</span><br><span class="line">130014 Jps</span><br><span class="line">129998 Test</span><br><span class="line"></span><br><span class="line">$ jstat -gc 129998 2000</span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br><span class="line">5120.0 5120.0  0.0    0.0   31744.0   3810.3   84992.0      0.0     4480.0 774.3  384.0   75.9       0    0.000   0      0.000    0.000</span><br></pre></td></tr></table></figure>
<p>使用下面2个命令也行：</p>
<pre><code>jstat -gcutil 129998 2000
jstat -gccause 129998 2000
</code></pre><p>上面的命令，最后2个参数指：进程号，时间间隔。示例的是，每2秒显示一次进程号为129998的java进程的GC情况。一些参数说明如下：<br>Column    Description<br>S0C          Current survivor space 0 capacity (KB).<br>S1C          Current survivor space 1 capacity (KB).<br>S0U          Survivor space 0 utilization (KB).<br>S1U          Survivor space 1 utilization (KB).<br>EC          Current eden space capacity (KB).<br>EU          Eden space utilization (KB).<br>OC          Current old space capacity (KB).<br>OU          Old space utilization (KB).<br>PC          Current permanent space capacity (KB).<br>PU          Permanent space utilization (KB).<br>YGC          Number of young generation GC Events.<br>YGCT      Young generation garbage collection time.<br>FGC          Number of full GC events.<br>FGCT      Full garbage collection time.<br>GCT          Total garbage collection time.</p>
<p>更多选项，请参见：<br><a href="https://docs.oracle.com/javase/7/docs/technotes/tools/share/jstat.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/7/docs/technotes/tools/share/jstat.html</a></p>
<p><strong>声明：</strong>图片来源于网络，仅用于学习使用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/04/06/jvm-note/" data-id="clf9thvlr001n6h3k4alfavsx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jvm/">jvm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mongo-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/07/mongo-note/" class="article-date">
  <time datetime="2018-03-07T06:39:42.000Z" itemprop="datePublished">2018-03-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/db/">db</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/07/mongo-note/">mongo 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安装mongodb数据库"><a href="#安装mongodb数据库" class="headerlink" title="安装mongodb数据库"></a>安装mongodb数据库</h3><p>首先，我们必须安装mongodb，这样才能使用。我们下载相应版本的mongodb，因为我的笔记本电脑是ubuntu，所以我下载mongodb的tgz版本，下载地址如下：</p>
<pre><code>https://www.mongodb.com/download-center/community
</code></pre><p>下载之后，得到如下两个文件：<br>mongodb-linux-x86_64-ubuntu1804-4.0.6.tgz<br>mongodb-linux-x86_64-ubuntu1804-4.0.6.tgz.md5</p>
<p>mongodb依赖libcurl4、openssl，我们必须先安装这两个依赖包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">如已安装，则可跳过，验证命令如下</span><br><span class="line">$ dpkg -s libcurl4</span><br><span class="line">$ dpkg -s openssl</span><br><span class="line"></span><br><span class="line">安装命令</span><br><span class="line">$ sudo apt-get install libcurl4 openssl</span><br></pre></td></tr></table></figure></p>
<p>我们将压缩包下载到<code>/home/hewentian/ProjectD</code>目录，然后解压：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD</span><br><span class="line">$ tar xf mongodb-linux-x86_64-ubuntu1804-4.0.6.tgz</span><br><span class="line">$</span><br><span class="line">$ ls mongodb-linux-x86_64-ubuntu1804-4.0.6/</span><br><span class="line">bin  LICENSE-Community.txt  MPL-2  README  THIRD-PARTY-NOTICES</span><br></pre></td></tr></table></figure></p>
<p>创建data目录和log目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD</span><br><span class="line">$ mkdir -p db/mongodb/data</span><br><span class="line">$ mkdir -p db/mongodb/<span class="built_in">log</span></span><br></pre></td></tr></table></figure></p>
<p>创建mongod.conf配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/</span><br><span class="line">$ vi mongod.conf</span><br></pre></td></tr></table></figure></p>
<p>并在其中输入如下内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line">storage:</span><br><span class="line">  dbPath: /home/hewentian/ProjectD/db/mongodb/data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /home/hewentian/ProjectD/db/mongodb/<span class="built_in">log</span>/mongod.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 127.0.0.1,192.168.56.110 <span class="comment"># 127.0.0.1只能从本机访问，将本机的IP配置到这里，这样其他机器才能通过该IP访问</span></span><br><span class="line"><span class="comment">#  bindIp: 0.0.0.0  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line">  pidFilePath: /home/hewentian/ProjectD/db/mongodb/mongod.pid  <span class="comment"># location of pidfile</span></span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line"></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#  authorization: enabled</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Enterprise-Only Options:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure></p>
<h3 id="启动mongodb"><a href="#启动mongodb" class="headerlink" title="启动mongodb"></a>启动mongodb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/bin</span><br><span class="line">$ ./mongod -f ../mongod.conf</span><br><span class="line"></span><br><span class="line">about to fork child process, waiting until server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 24049</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>
<h3 id="停止mongodb"><a href="#停止mongodb" class="headerlink" title="停止mongodb"></a>停止mongodb</h3><p>不要直接通过kill命令杀掉mongodb的进程，而应通过它官方提供的关闭脚本，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/bin</span><br><span class="line">$ ./mongod -f ../mongod.conf --shutdown</span><br><span class="line"></span><br><span class="line">killing process with pid: 24049</span><br></pre></td></tr></table></figure></p>
<h3 id="配置登录用户名和密码"><a href="#配置登录用户名和密码" class="headerlink" title="配置登录用户名和密码"></a>配置登录用户名和密码</h3><p>要开启密码登录，首先要将mongod.conf中的以下选项打开：</p>
<pre><code>security:
  authorization: enabled
</code></pre><p>然后重启mongodb服务。</p>
<ol>
<li><p>添加管理员<br>使用mongo命令进入命令行交互模式，创建第一个用户admin，该用户需要有用户管理权限，其角色为root。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/bin</span><br><span class="line">$ ./bin/mongo --host 127.0.0.1</span><br><span class="line">MongoDB shell version v4.0.6</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">"id"</span> : UUID(<span class="string">"cbd0445f-667b-4d2a-92a8-66f8ad1d07ef"</span>) &#125;</span><br><span class="line">MongoDB server version: 4.0.6</span><br><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">&gt; db.createUser(&#123;user:<span class="string">"admin"</span>,<span class="built_in">pwd</span>:<span class="string">"admin"</span>,roles:[<span class="string">"root"</span>]&#125;)</span><br><span class="line">Successfully added user: &#123; <span class="string">"user"</span> : <span class="string">"admin"</span>, <span class="string">"roles"</span> : [ <span class="string">"root"</span> ] &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; show collections</span><br><span class="line">Warning: unable to run listCollections, attempting to approximate collection names by parsing connectionStatus</span><br><span class="line">&gt; db.auth(<span class="string">"admin"</span>,<span class="string">"admin"</span>)</span><br><span class="line">1</span><br><span class="line">&gt; show collections</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加数据库用户<br>为数据库添加用户，添加用户前需要切换到该数据库，这里简单设置其角色为dbOwner</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; use bfg</span><br><span class="line">switched to db bfg</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">"bfg"</span>, <span class="built_in">pwd</span>: <span class="string">"bfg100"</span>, roles: [&#123; role: <span class="string">"dbOwner"</span>, db: <span class="string">"bfg"</span> &#125;]&#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">	<span class="string">"user"</span> : <span class="string">"bfg"</span>,</span><br><span class="line">	<span class="string">"roles"</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"role"</span> : <span class="string">"dbOwner"</span>,</span><br><span class="line">			<span class="string">"db"</span> : <span class="string">"bfg"</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这样，bfg的用户就只能访问bfg这个库了，登录方式如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/mongo --host 127.0.0.1</span><br><span class="line">MongoDB shell version v4.0.6</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">"id"</span> : UUID(<span class="string">"873114cf-fb7e-436a-b939-7e765dbecee9"</span>) &#125;</span><br><span class="line">MongoDB server version: 4.0.6</span><br><span class="line">&gt; use bfg</span><br><span class="line">switched to db bfg</span><br><span class="line">&gt; db.auth(<span class="string">"bfg"</span>,<span class="string">"bfg100"</span>)</span><br><span class="line">1</span><br><span class="line">&gt; show dbs</span><br><span class="line">bfg  0.000GB</span><br></pre></td></tr></table></figure></p>
<p>至此，数据库安装完毕（此安装过程2019年初才补上）。</p>
<h3 id="修改用户密码"><a href="#修改用户密码" class="headerlink" title="修改用户密码"></a>修改用户密码</h3><p>修改用户密码使用<code>db.changeUserPassword(username, password)</code>，Updates a user’s password. Run the method in the database where the user is defined, i.e. the database you created the user.</p>
<h3 id="shell命令行方式连接到mongodb"><a href="#shell命令行方式连接到mongodb" class="headerlink" title="shell命令行方式连接到mongodb"></a>shell命令行方式连接到mongodb</h3><p>连接到单机：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo --host 192.168.1.111:27017 --authenticationDatabase user_database -u user_name -p user_password</span><br></pre></td></tr></table></figure></p>
<p>连接到单机中的指定数据库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017/user_database"</span> --authenticationDatabase user_database -u user_name -p user_password</span><br></pre></td></tr></table></figure></p>
<p>连接到副本集：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017,192.168.1.112:27017/user_database?replicaSet=mgset-9527&amp;readPreference=secondaryPreferred"</span> --authenticationDatabase user_database -u user_name -p user_password</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb查询数组大小"><a href="#mongodb查询数组大小" class="headerlink" title="mongodb查询数组大小"></a>mongodb查询数组大小</h3><p>mongodb查询数组大小使用<code>$size</code>，例如：我们有一个名为<code>person</code>的集合，其中有个字段为<code>childrenNames</code>，是数组类型，如果我们要查询<code>childrenNames</code>长度为2的数据，则查询语句为：</p>
<pre><code>db.getCollection(&apos;person&apos;).find({&apos;childrenNames&apos;:{&apos;$size&apos;:2}})
</code></pre><p>但是它不能限定数组的大小范围，只能查询指定的长度。要查询数组范围，我们使用<code>$exists</code>，例如：查询数组长度大于等于3的语句如下（检查数组第3个元素是否存了）</p>
<pre><code>db.getCollection(&apos;person&apos;).find({&apos;childrenNames.2&apos;:{&apos;$exists&apos;:1}})
</code></pre><h3 id="数组查询"><a href="#数组查询" class="headerlink" title="数组查询"></a>数组查询</h3><p>有如下数组，它的查询方式为：<br>        db.getCollection(‘userInfo’).find({“sons”: {$elemMatch: {“birthday”: {$gte:1594252800000, $lte:1594339200000}}}})</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5f0e26bcf0a06369a460b4c8"</span>),</span><br><span class="line">    <span class="string">"name"</span> : <span class="string">"tony"</span>,</span><br><span class="line">    <span class="string">"sons"</span> : [ </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"h"</span>,</span><br><span class="line">            <span class="string">"birthday"</span> : NumberLong(<span class="number">1594762936000</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">		  &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"w"</span>,</span><br><span class="line">            <span class="string">"birthday"</span> : NumberLong(<span class="number">1594762936000</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mongodb分组查询"><a href="#mongodb分组查询" class="headerlink" title="mongodb分组查询"></a>mongodb分组查询</h3><p>如果我们要对集合<code>person</code>中的地区字段<code>area</code>来分组统计，语法如下：</p>
<pre><code>db.getCollection(&apos;person&apos;).aggregate([{&apos;$group&apos;:{&apos;_id&apos;:&apos;$area&apos;,&apos;count&apos;:{&apos;$sum&apos;:1}}}])
</code></pre><p>如果我们还想将分组统计结果，按数量倒序输出显示：</p>
<pre><code>db.getCollection(&apos;person&apos;).aggregate([{&apos;$group&apos;:{&apos;_id&apos;:&apos;$area&apos;,&apos;count&apos;:{&apos;$sum&apos;:1}}},{&apos;$sort&apos;:{&apos;count&apos;:-1}}])
</code></pre><p>对应的JAVA代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MongoDatabase mongoDatabase = MongoUtil.getMongoDatabase(); <span class="comment">// 这个是我自已写的工具类</span></span><br><span class="line">MongoCollection&lt;Document&gt; personCollection = mongoDatabase.getCollection(<span class="string">"person"</span>);</span><br><span class="line"></span><br><span class="line">List&lt;BasicDBObject&gt; pipeline = <span class="keyword">new</span> ArrayList&lt;BasicDBObject&gt;();</span><br><span class="line">pipeline.add(<span class="keyword">new</span> BasicDBObject(<span class="string">"$group"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="string">"$area"</span>).append(<span class="string">"count"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"$sum"</span>, <span class="number">1</span>))));</span><br><span class="line">pipeline.add(<span class="keyword">new</span> BasicDBObject(<span class="string">"$sort"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"count"</span>, -<span class="number">1</span>))); <span class="comment">// 如果不要排序，则注释这一行</span></span><br><span class="line"></span><br><span class="line">AggregateIterable&lt;Document&gt; aggregate = personCollection.aggregate(pipeline);</span><br><span class="line">MongoCursor&lt;Document&gt; iterator = aggregate.iterator();</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb更新部分字段"><a href="#mongodb更新部分字段" class="headerlink" title="mongodb更新部分字段"></a>mongodb更新部分字段</h3><p>例如我们要将<code>person</code>中<code>_id</code>为<code>123</code>的数据的<code>address</code>修改为：广东，语句如下：</p>
<pre><code>db.getCollection(&apos;person&apos;).update({&apos;_id&apos;:&apos;123&apos;},{$set:{&apos;address&apos;:&apos;广东&apos;}})
</code></pre><h3 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; show dbs</span><br><span class="line">&gt; use monitor</span><br><span class="line">&gt; db.dropDatabase()</span><br></pre></td></tr></table></figure>
<h3 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; show collections</span><br><span class="line">&gt; db.collection_name.drop()</span><br></pre></td></tr></table></figure>
<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><p>删除数据的时候，要注意条件为null的情况，这在组成json条件的时候，会变成{}，这会将整个库的数据都删掉，这个要避免。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MongoCollection&lt;Document&gt; mongoCollection = <span class="keyword">null</span>; <span class="comment">// 这里不建连接，仅演示</span></span><br><span class="line">JSONArray userNames = <span class="keyword">new</span> JSONArray();</span><br><span class="line"><span class="keyword">for</span> (String userName : Arrays.asList(<span class="string">""</span>, <span class="keyword">null</span>, <span class="string">"xiao ming"</span>)) &#123;</span><br><span class="line">    JSONObject obj = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    obj.put(<span class="string">"userName"</span>, userName);</span><br><span class="line">    userNames.add(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JSONObject condition = <span class="keyword">new</span> JSONObject();</span><br><span class="line">condition.put(<span class="string">"$or"</span>, userNames);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除原有的数据</span></span><br><span class="line">log.info(<span class="string">"删除的语句为："</span> + condition); <span class="comment">// &#123;"$or":[&#123;"userName":""&#125;,&#123;&#125;,&#123;"userName":"xiao ming"&#125;]&#125;</span></span><br><span class="line">DeleteResult deleteResult = mongoCollection.deleteMany(BsonDocument.parse(condition.toJSONString()));</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">"======mongo删除原有的数据条数：======"</span> + deleteResult.getDeletedCount());</span><br></pre></td></tr></table></figure></p>
<h3 id="导出、导入数据库"><a href="#导出、导入数据库" class="headerlink" title="导出、导入数据库"></a>导出、导入数据库</h3><h4 id="我们使用mongoexport来导出指定的collection"><a href="#我们使用mongoexport来导出指定的collection" class="headerlink" title="我们使用mongoexport来导出指定的collection"></a>我们使用<code>mongoexport</code>来导出指定的<code>collection</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把一个<code>collection</code>导出成JSON或CSV格式的文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongoexport -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; -c &#123;COLLECTION_NAME&#125; -o &#123;EXPORT_FILE_PATH&#125; --<span class="built_in">type</span> json/csv -f fields</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	-c: collection名</span><br><span class="line">	-o: 输出的文件名</span><br><span class="line">	--<span class="built_in">type</span>: 输出的格式，默认为json</span><br><span class="line">	-f: 输出的字段，如果-<span class="built_in">type</span>为csv，则需要加上-f <span class="string">"字段名"</span></span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">$ mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.json</span><br><span class="line">$ mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.json --<span class="built_in">type</span> json -f  <span class="string">"_id,name"</span></span><br><span class="line">$ mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.csv --<span class="built_in">type</span> csv -f  <span class="string">"_id,name"</span></span><br></pre></td></tr></table></figure></p>
<p>如果导出的数据中包含查询条件，则要用下面这种方式导出：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017/user_database"</span> --authenticationDatabase user_database -u user_name -p user_password --quiet --<span class="built_in">eval</span> <span class="string">'db.user.find(&#123; _id: &#123;$gt: ObjectId("5ee08d67e144cb56edf945da")&#125;&#125;).forEach(printjson);'</span> &gt; a.json</span><br></pre></td></tr></table></figure></p>
<p>如果导出的查询条件中包含ObjectId，则要用<code>$oid</code>来代替它：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.json -q <span class="string">'&#123;"_id":&#123;"$oid":"5ece9b4d8008d750e611010c"&#125;&#125;'</span></span><br></pre></td></tr></table></figure></p>
<h4 id="我们使用mongoimport来导入指定的collection"><a href="#我们使用mongoimport来导入指定的collection" class="headerlink" title="我们使用mongoimport来导入指定的collection"></a>我们使用<code>mongoimport</code>来导入指定的<code>collection</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把一个json/csv文件导入到指定的<code>collection</code>中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongoimport -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; -c &#123;COLLECTION_NAME&#125; --file &#123;IMPORT_FILE_PATH&#125; --headerline --<span class="built_in">type</span> json/csv -f fields</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	-c: collection名</span><br><span class="line">	--file: 要导入的文件</span><br><span class="line">	--<span class="built_in">type</span>: input format to import: json, csv, or tsv (defaults to <span class="string">'json'</span>) (default: json)</span><br><span class="line">	--headerline: use first line <span class="keyword">in</span> input <span class="built_in">source</span> as the field list (CSV and TSV only)</span><br><span class="line">	-f: 导入的字段名，CSV或TSV的时候可用</span><br><span class="line"> </span><br><span class="line">示例：</span><br><span class="line">$ mongoimport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user --file /home/hewentian/ProjectD/db/user.json</span><br><span class="line"></span><br><span class="line">注意：--headerline 和 -f 不能同时使用</span><br><span class="line"></span><br><span class="line">	--headerline: 使用CSV文件中首列指定的列名作为导入的name</span><br><span class="line">	-f: 会将CSV文件的所有列，作为数据进行导入，包括第一列的列名（如果文件中有指定列名）</span><br><span class="line"></span><br><span class="line">$ mongoimport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user --file /home/hewentian/ProjectD/db/user.csv --<span class="built_in">type</span> csv --headerline</span><br><span class="line">$ mongoimport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user --file /home/hewentian/ProjectD/db/user.csv --<span class="built_in">type</span> csv -f <span class="string">"_id,name,age"</span></span><br></pre></td></tr></table></figure></p>
<h4 id="我们使用mongodump来导出指定的database"><a href="#我们使用mongodump来导出指定的database" class="headerlink" title="我们使用mongodump来导出指定的database"></a>我们使用<code>mongodump</code>来导出指定的<code>database</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把一个<code>database</code>导出成指定目录下的JSON、BSON的文件集<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongodump -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; -o &#123;DUMP_FILE_PATH&#125;</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	-o: 输出的文件路径，要事先创建该目录，在该目录下会自动创建要导出的数据库作为子目录</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">$ mongodump -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -o /home/hewentian/ProjectD/db/</span><br></pre></td></tr></table></figure></p>
<h4 id="我们使用mongorestore来恢复指定的database"><a href="#我们使用mongorestore来恢复指定的database" class="headerlink" title="我们使用mongorestore来恢复指定的database"></a>我们使用<code>mongorestore</code>来恢复指定的<code>database</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把指定目录下的JSON、BSON的文件集恢复成<code>database</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongorestore -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; --dir &#123;RESTORE_FILE_PATH&#125;</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	--dir: 要恢复的数据库的位置，注意与上面备份的 -o 不同，这里要指定到数据库的目录</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">$ mongorestore -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg --dir /home/hewentian/ProjectD/db/bfg/</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb类型转换"><a href="#mongodb类型转换" class="headerlink" title="mongodb类型转换"></a>mongodb类型转换</h3><p>如下所示，将字符串类型的数据转换为int, double, date类型：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">先插入一条数据，都是字符串类型：</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="string">"20"</span>, <span class="string">"salary"</span>:<span class="string">"30"</span>, <span class="string">"birthday"</span>:<span class="string">"2018-12-21"</span>&#125;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5c45b7099a14ab9807edaa75"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="string">"20"</span>,</span><br><span class="line">    <span class="string">"salary"</span> : <span class="string">"30"</span>,</span><br><span class="line">    <span class="string">"birthday"</span> : <span class="string">"2018-12-21"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">改变字段类型：</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;&#125;).forEach(function(doc) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).updateOne(&#123;_id: doc._id&#125;, &#123;$set: &#123;<span class="string">"age"</span>: NumberInt(doc.age), <span class="string">"salary"</span>: parseInt(doc.salary), <span class="string">"birthday"</span>: <span class="keyword">new</span> ISODate(doc.birthday)&#125;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5c45b7099a14ab9807edaa75"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="number">20</span>,</span><br><span class="line">    <span class="string">"salary"</span> : <span class="number">30.0</span>,</span><br><span class="line">    <span class="string">"birthday"</span> : ISODate(<span class="string">"2018-12-21T00:00:00.000Z"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果要将集合中已有文档的<code>ISODate</code>类型转换成<code>String</code>类型的日期，例如：将<code>updateTime</code>由<code>ISODate(&quot;2019-04-04T07:12:37.295Z&quot;)</code>转换为<code>2019-04-04 07:12:37</code>类型：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"updateTime"</span>:&#123;<span class="string">"$type"</span>:<span class="number">9</span>&#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> mydate = doc.updateTime;</span><br><span class="line">    <span class="keyword">if</span> (mydate) &#123;</span><br><span class="line">        mydate = mydate.toJSON();</span><br><span class="line">        <span class="keyword">if</span> (mydate.length &gt; <span class="number">19</span>) &#123;</span><br><span class="line">            mydate = mydate.substr(<span class="number">0</span>, <span class="number">19</span>)</span><br><span class="line">            mydate = mydate.replace(<span class="string">'T'</span>,<span class="string">' '</span>);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   db.getCollection(<span class="string">'userInfo'</span>).update(&#123;<span class="string">"_id"</span>:doc._id&#125;, &#123;<span class="string">"$set"</span>:&#123;<span class="string">"updateTime"</span>:mydate&#125;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">验证结果：</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>:ObjectId(<span class="string">"5abc7ffc00a32c2b045e598c"</span>)&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="MongoDB的主键类型修改"><a href="#MongoDB的主键类型修改" class="headerlink" title="MongoDB的主键类型修改"></a>MongoDB的主键类型修改</h3><p><strong>主键类型的修改不能像其他字段一样直接修改</strong></p>
<p>将String类型的主键修改为ObjectId类型，在Mongodb中String类型对应的int值为2，<br>我们先增加一条主键为ObjectId记录，然后删除主键为String的记录。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">2</span>&#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    doc._id = ObjectId(doc._id);</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).save(doc);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).remove(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">2</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<p>反之，将ObjectId类型的主键修改为String类型，在Mongodb中ObjectId类型对应的int值为7。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">7</span>&#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    doc._id = doc._id.toJSON().$oid;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).save(doc);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).remove(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">7</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb默认插入类型"><a href="#mongodb默认插入类型" class="headerlink" title="mongodb默认插入类型"></a>mongodb默认插入类型</h3><p>插入的int32整数会默认转为Double类型，若需插入为整数，需指定NumberInt：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="number">20</span>, <span class="string">"salary"</span>:NumberInt(<span class="number">30</span>), <span class="string">"birthday"</span>:<span class="string">"2018-12-21"</span>&#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;&#125;)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5d3815a2a7de52e9fed7bbcf"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="number">20.0</span>,</span><br><span class="line">    <span class="string">"salary"</span> : <span class="number">30</span>,</span><br><span class="line">    <span class="string">"birthday"</span> : <span class="string">"2018-12-21"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb模糊查询"><a href="#mongodb模糊查询" class="headerlink" title="mongodb模糊查询"></a>mongodb模糊查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"name"</span>:&#123;<span class="string">"$regex"</span>:<span class="string">"t"</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>这样名字中包含”tom”和”scott”的记录都会查询出来。</p>
<h3 id="mongodb日期查询"><a href="#mongodb日期查询" class="headerlink" title="mongodb日期查询"></a>mongodb日期查询</h3><p>日期的类型不同，查询的方式也不同：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">如果日期的类型为String：</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"insertTime"</span>:&#123;$regex:<span class="string">"2019-01-07 *"</span>&#125;&#125;) <span class="comment">// *号前有个空格</span></span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"insertTime"</span>:&#123;$gte:<span class="string">"2019-02-01 00:00:00"</span>,$lte:<span class="string">"2019-02-11 23:59:59"</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">如果日期的类型为ISODate：</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"insertTime"</span>:&#123;$gte:ISODate(<span class="string">"2019-01-01T00:00:00Z"</span>),$lte:ISODate(<span class="string">"2019-02-11T23:59:59Z"</span>)&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="复制集合"><a href="#复制集合" class="headerlink" title="复制集合"></a>复制集合</h3><p>在复制集合的时候，修改某些值，可以使用javascript实现（建议在mongo shell下执行，这样不容易超时），示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var count = <span class="number">0</span>;</span><br><span class="line">var totalCount = db.getCollection(<span class="string">'user'</span>).count(&#123;&#125;);</span><br><span class="line">var lastId = <span class="string">"000000000000000000000000"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(count &lt; totalCount) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'user'</span>).find(&#123;<span class="string">"_id"</span>:&#123;<span class="string">"$gt"</span>:lastId&#125;&#125;).sort(&#123;<span class="string">"_id"</span>:<span class="number">1</span>&#125;).limit(<span class="number">100</span>).forEach((doc)=&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (++count % <span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            print(<span class="string">'handling: '</span> + count + <span class="string">' / '</span> + totalCount)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        lastId = doc._id;</span><br><span class="line">        doc._id=doc.regId;</span><br><span class="line">       db.getCollection(<span class="string">'user_new'</span>).save(doc);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="正则表达式的使用"><a href="#正则表达式的使用" class="headerlink" title="正则表达式的使用"></a>正则表达式的使用</h3><p>查询用户名<code>name</code>前后有空格的记录：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"name"</span>:/^\s+|\s+$/&#125;)</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"$or"</span>:[&#123;<span class="string">"name"</span>:/^\s+|\s+$/&#125;, &#123;<span class="string">"postCode"</span>:/^\s+|\s+$/&#125;]&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><p>The following update() operation uses the <code>$unset</code> operator to remove the fields <code>quantity</code> and <code>instock</code> from the first document in the <code>products</code> collection where the field <code>sku</code> has a value of <code>unknown</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.products.update(</span><br><span class="line">   &#123; sku: <span class="string">"unknown"</span> &#125;,</span><br><span class="line">   &#123; <span class="variable">$unset</span>: &#123; quantity: <span class="string">""</span>, instock: <span class="string">""</span> &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>if you want to update all matched, use <code>updateMany</code> instead.</p>
<h3 id="mongo执行一个js脚本文件"><a href="#mongo执行一个js脚本文件" class="headerlink" title="mongo执行一个js脚本文件"></a>mongo执行一个js脚本文件</h3><p>例如有一个js脚本文件，位于<code>/home/hewentian/Documents/updateMongo.js</code>，内容如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 处理字段中数据重复的方法：将字符串一分为二，如果前后两部分相同，则更新成其中一部分</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handleCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> updateCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> totalCount = db.getCollection(<span class="string">'userInfo'</span>).count(&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> lastId = ObjectId(<span class="string">'000000000000000000000000'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (handleCount &lt; totalCount) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$gt"</span>: lastId&#125;&#125;).sort(&#123;<span class="string">"_id"</span>: <span class="number">1</span>&#125;).limit(<span class="number">5</span>).forEach(<span class="function">(<span class="params">doc</span>) =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (++handleCount % <span class="number">10</span> == <span class="number">0</span> || handleCount == totalCount) &#123;</span><br><span class="line">            print(<span class="string">'handling: '</span> + handleCount + <span class="string">' / '</span> + totalCount + <span class="string">", updateCount = "</span> + updateCount + <span class="string">", lastId = "</span> + lastId.toJSON().$oid + (handleCount == totalCount ? <span class="string">" end"</span> : <span class="string">""</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastId = doc._id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> userName = doc.userName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (userName) &#123; <span class="comment">// 这个字段必须要存在</span></span><br><span class="line">            <span class="keyword">var</span> len = userName.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (len % <span class="number">2</span> == <span class="number">0</span>) &#123; <span class="comment">// 字符数必须为偶数倍</span></span><br><span class="line">                <span class="keyword">var</span> middleIndex = len / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">var</span> substrA = userName.substr(<span class="number">0</span>, middleIndex);</span><br><span class="line">                <span class="keyword">var</span> substrB = userName.substr(middleIndex);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (substrA == substrB) &#123; <span class="comment">// 前后两半字符串相同时，才更新</span></span><br><span class="line">                    db.getCollection(<span class="string">'userInfo'</span>).update(&#123;<span class="string">"_id"</span>: doc._id&#125;, &#123;<span class="string">"$set"</span>: &#123;<span class="string">"userName"</span>: substrA&#125;&#125;)</span><br><span class="line">                    updateCount++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们这样执行这个脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017/user_database"</span> --authenticationDatabase user_database -u user_name -p user_password /home/hewentian/Documents/updateMongo.js</span><br></pre></td></tr></table></figure></p>
<h3 id="使用typeof操作符"><a href="#使用typeof操作符" class="headerlink" title="使用typeof操作符"></a>使用typeof操作符</h3><p>有时候，我们在使用javascript操作Mongodb的过程中，可能要根据数据类型进行相关操作：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 对集合进行清洗，保证字段 telephone 是字符串格式</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handleCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> updateCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> totalCount = db.getCollection(<span class="string">'userInfo'</span>).count(&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> lastId = <span class="string">"000000000000000000000000"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (handleCount &lt; totalCount) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$gt"</span>: lastId&#125;&#125;).sort(&#123;<span class="string">"_id"</span>: <span class="number">1</span>&#125;).limit(<span class="number">100</span>).forEach(<span class="function">(<span class="params">doc</span>) =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (++handleCount % <span class="number">1000</span> == <span class="number">0</span> || handleCount == totalCount) &#123;</span><br><span class="line">            print(<span class="string">'handling: '</span> + handleCount + <span class="string">' / '</span> + totalCount + <span class="string">", updateCount = "</span> + updateCount + <span class="string">", lastId = "</span> + lastId + (handleCount == totalCount ? <span class="string">" end"</span> : <span class="string">""</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastId = doc._id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> telephone = doc.telephone;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (telephone &amp;&amp; <span class="keyword">typeof</span>(telephone) == <span class="string">'object'</span>) &#123; <span class="comment">// 这个字段必须要存在，并且是内嵌类型文档</span></span><br><span class="line">            <span class="keyword">var</span> fixTelephone = telephone.phoneNumber;</span><br><span class="line">            <span class="keyword">if</span> (fixTelephone &amp;&amp; <span class="keyword">typeof</span>(fixTelephone) == <span class="string">'string'</span>) &#123;</span><br><span class="line">                db.getCollection(<span class="string">'userInfo'</span>).updateOne(&#123;<span class="string">"_id"</span>: doc._id&#125;, &#123;<span class="string">"$set"</span>: &#123;<span class="string">"telephone"</span>: fixTelephone&#125;&#125;);</span><br><span class="line">                updateCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MongoDB-去重-distinct-查询后求总数-count"><a href="#MongoDB-去重-distinct-查询后求总数-count" class="headerlink" title="MongoDB 去重(distinct)查询后求总数(count)"></a>MongoDB 去重(distinct)查询后求总数(count)</h3><ol>
<li>直接使用distinct语句查询，这种查询会将所有查询出来的数据返回给用户，然后对查询出来的结果集求总数（耗内存，耗时一些）<pre><code>db.student.distinct(&quot;name&quot;, {&quot;age&quot; : 18}).length
</code></pre></li>
</ol>
<p>使用这种方法查询时，查询的结果集大于16M时会查询失败：<br>        {“message” : “distinct failed: MongoError: distinct too big, 16mb cap”,”stack” : “script:1:20”}</p>
<ol>
<li>使用聚合函数，多次分组统计结果，最终将聚合的结果数返回给用户<pre><code>db.student.aggregate([
    {$match:{&quot;age&quot; : 18}},
    {$project:{&quot;name&quot;:1}},
    {$group:{&quot;_id&quot;:&quot;$name&quot;,&quot;count&quot;:{$sum:1}}},
    {$sort:{&quot;count&quot;:-1}}
])
</code></pre></li>
</ol>
<p>这种查询数据量大时就不会出现如上查询失败的情况，而且这种查询不管是内存消耗还是时间消耗都优于上面一种查询。</p>
<h3 id="BSON-ObjectID-Specification"><a href="#BSON-ObjectID-Specification" class="headerlink" title="BSON ObjectID Specification"></a>BSON ObjectID Specification</h3><p>A BSON ObjectID is a 12-byte value consisting of a 4-byte timestamp (seconds since epoch), a 3-byte machine id,<br>a 2-byte process id, and a 3-byte counter. Note that the timestamp and counter fields must be stored big endian<br>unlike the rest of BSON. This is because they are compared byte-by-byte and we want to ensure a mostly increasing<br>order. The format:</p>
<pre><code>0 1 2 3    4 5 6    7 8    9 10 11
time       machine    pid       inc
</code></pre><ul>
<li>TimeStamp: This is a unix style timestamp. It is a signed int representing the number of seconds before or after January 1st 1970 (UTC).</li>
<li>Machine: This is the first three bytes of the (md5) hash of the machine host name, or of the mac/network address, or the virtual machine id.</li>
<li>Pid: This is 2 bytes of the process id (or thread id) of the process generating the object id.</li>
<li>Increment: This is an ever incrementing value, or a random number if a counter can’t be used in the language/runtime.</li>
</ul>
<p>BSON ObjectIds can be any 12 byte binary string that is unique; however, the server itself and almost all drivers use the format above.</p>
<p>ObjectId占用12字节的存储空间，由“时间戳” 、“机器名”、“PID号”和“计数器”组成。使用机器名的好处是在分布式环境中能够避免<br>单点计数的性能瓶颈。使用PID号的好处是支持同一机器内运行多个mongod实例。最终采用时间戳和计数器的组合来保证唯一性。</p>
<p>自动生成的主键objectId是一个24位的字符串，它是由一组十六进制的字符构成，每个字节两位的十六进制数字，总共用了12字节的存储空间。</p>
<ul>
<li><p>时间戳<br>确保ObjectId唯一性依赖的是时间的顺序，不依赖时间的取值，因此集群节点的时间不必完全同步。既然ObjectId已经有了时间戳，<br>那么在文档中就可以省掉一个时间戳了。在使用ObjectID提取时间时，应注意到MongoDB允许各节点时间不一致这一细节。</p>
</li>
<li><p>机器名<br>机器名通过Md5加密后取前三个字节，应该还是有重复概率的，配置生产集群时检查一下总不会错。另外，我也注意到重启MongoDB后<br>MD5加密结果会发生变化，在利用ObjectID提取机器名信息时需格外注意。</p>
</li>
<li><p>PID号<br>注意到每次重启mongod进程后PID号通常会发生变化就可以了。</p>
</li>
<li><p>计数器<br>计数器占3个字节，表示的取值范围就是<code>256*256*256-1=16777215</code>。不妨认为MongDB性能的极限是单台设备一秒钟插入一千万条记录。<br>以目前的水平看，单台设备一秒钟插入一万条就很不错了，因此ObjectID计数器的设计是够用的。</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.user.findOne()._id</span><br><span class="line">ObjectId(<span class="string">"5eda936e8008d750e63ee723"</span>)</span><br><span class="line"></span><br><span class="line">&gt; db.user.findOne()._id.toString()</span><br><span class="line">ObjectId(<span class="string">"5eda936e8008d750e63ee723"</span>)</span><br><span class="line"></span><br><span class="line">&gt; db.user.findOne()._id.toJSON()</span><br><span class="line">&#123; <span class="string">"$oid"</span> : <span class="string">"5eda936e8008d750e63ee723"</span> &#125;</span><br><span class="line"></span><br><span class="line">&gt; db.user.findOne()._id.toJSON().$oid.substring(<span class="number">0</span>, <span class="number">8</span>)</span><br><span class="line"><span class="number">5</span>eda936e</span><br><span class="line"></span><br><span class="line">&gt; db.user.findOne()._id.getTimestamp()</span><br><span class="line">ISODate(<span class="string">"2020-06-06T02:48:14Z"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>从mongoDB的ObjectId中提取时间信息<br>取8个字符，得到的是这条数据创建时的时间戳（不带毫秒位数），在后面补上毫秒位数”000”。</li>
</ul>
<p>java代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectId("5eda936e8008d750e63ee723")</span></span><br><span class="line">String id = <span class="string">"5eda936e8008d750e63ee723"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取前8位</span></span><br><span class="line"><span class="keyword">long</span> timestamp = Long.parseLong(Integer.parseInt(id.substring(<span class="number">0</span>, <span class="number">8</span>), <span class="number">16</span>) + <span class="string">"000"</span>);</span><br><span class="line"></span><br><span class="line">Date date = <span class="keyword">new</span> Date(timestamp);</span><br><span class="line">System.out.println(date); <span class="comment">// Sat Jun 06 02:48:14 CST 2020</span></span><br></pre></td></tr></table></figure></p>
<p>javascript代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectId("5eda936e8008d750e63ee723")</span></span><br><span class="line"><span class="keyword">var</span> id = <span class="string">"5eda936e8008d750e63ee723"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取前8位</span></span><br><span class="line"><span class="keyword">var</span> timestamp = <span class="built_in">Number</span>(<span class="built_in">parseInt</span>(id.substring(<span class="number">0</span>, <span class="number">8</span>), <span class="number">16</span>).toString() + <span class="string">"000"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>(timestamp);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(date); <span class="comment">// Sat Jun 06 2020 02:48:14 GMT+0800 (China Standard Time)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="explain查询执行情况"><a href="#explain查询执行情况" class="headerlink" title="explain查询执行情况"></a>explain查询执行情况</h3><p>explain的目的是将mongo的黑盒操作白盒化。比如查询很慢的时候想知道原因。explain有三种模式：</p>
<ol>
<li>queryPlanner: 不会真正的执行查询，只是分析查询，选出winningPlan。</li>
<li>executionStats: 返回winningPlan的关键数据。</li>
<li>allPlansExecution: 执行所有的plans。</li>
</ol>
<p>通过explain(“executionStats”)来选择模式，默认是第一种模式。一些返回字段的说明：<br>namespace: 本次所查询的集合<br>indexFilterSet: 是否使用partial index，比如只对某个集合中的部分文档进行index<br>parsedQuery: 本次执行的查询<br>executionTimeMillis: 该query查询的总体时间<br>indexName: 所使用的索引的名字<br>indexBounds: 索引查找时使用的范围<br>stage:<br>  COLLSCAN: 全表扫描<br>  IXSCAN: 索引扫描<br>  FETCH: 根据索引去检索指定document<br>  SHARD_MERGE: 将各个分片返回数据进行merge<br>  SORT: 表明在内存中进行了排序<br>  LIMIT: 使用limit限制返回数<br>  SKIP: 使用skip进行跳过<br>  IDHACK: 针对_id进行查询</p>
<p>通过这些信息就能判断查询时如何执行的了。示例如下，先插入3个文档：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="string">"20"</span>, <span class="string">"name"</span>:<span class="string">"scott"</span>, <span class="string">"birthday"</span>:<span class="string">"2018-12-21"</span>&#125;)</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="string">"21"</span>, <span class="string">"name"</span>:<span class="string">"tiger"</span>, <span class="string">"birthday"</span>:<span class="string">"2019-12-21"</span>&#125;)</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="string">"23"</span>, <span class="string">"name"</span>:<span class="string">"tom"</span>, <span class="string">"birthday"</span>:<span class="string">"1919-11-21"</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>没有建立索引的时候查询：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;<span class="string">"name"</span>:<span class="string">"tom"</span>&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"queryPlanner"</span> : &#123;</span><br><span class="line">		<span class="string">"plannerVersion"</span> : <span class="number">1</span>,</span><br><span class="line">		<span class="string">"namespace"</span> : <span class="string">"bfg.userInfo"</span>,</span><br><span class="line">		<span class="string">"indexFilterSet"</span> : <span class="literal">false</span>,</span><br><span class="line">		<span class="string">"parsedQuery"</span> : &#123;</span><br><span class="line">			<span class="string">"name"</span> : &#123;</span><br><span class="line">				<span class="string">"$eq"</span> : <span class="string">"tom"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"queryHash"</span> : <span class="string">"01AEE5EC"</span>,</span><br><span class="line">		<span class="string">"planCacheKey"</span> : <span class="string">"01AEE5EC"</span>,</span><br><span class="line">		<span class="string">"winningPlan"</span> : &#123;</span><br><span class="line">			<span class="string">"stage"</span> : <span class="string">"COLLSCAN"</span>,</span><br><span class="line">			<span class="string">"filter"</span> : &#123;</span><br><span class="line">				<span class="string">"name"</span> : &#123;</span><br><span class="line">					<span class="string">"$eq"</span> : <span class="string">"tom"</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">"direction"</span> : <span class="string">"forward"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"rejectedPlans"</span> : [ ]</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"serverInfo"</span> : &#123;</span><br><span class="line">		<span class="string">"host"</span> : <span class="string">"0d550468977f"</span>,</span><br><span class="line">		<span class="string">"port"</span> : <span class="number">27017</span>,</span><br><span class="line">		<span class="string">"version"</span> : <span class="string">"4.4.0"</span>,</span><br><span class="line">		<span class="string">"gitVersion"</span> : <span class="string">"563487e100c4215e2dce98d0af2a6a5a2d67c5cf"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从<code>&quot;stage&quot; : &quot;COLLSCAN&quot;</code>可知，没有使用到索引，是全表扫描的。我们建个索引，再查询。</p>
<pre><code>db.getCollection(&apos;userInfo&apos;).ensureIndex({&quot;name&quot;:1}, {background:true})
</code></pre><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;<span class="string">"name"</span>:<span class="string">"tom"</span>&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"queryPlanner"</span> : &#123;</span><br><span class="line">		<span class="string">"plannerVersion"</span> : <span class="number">1</span>,</span><br><span class="line">		<span class="string">"namespace"</span> : <span class="string">"bfg.userInfo"</span>,</span><br><span class="line">		<span class="string">"indexFilterSet"</span> : <span class="literal">false</span>,</span><br><span class="line">		<span class="string">"parsedQuery"</span> : &#123;</span><br><span class="line">			<span class="string">"name"</span> : &#123;</span><br><span class="line">				<span class="string">"$eq"</span> : <span class="string">"tom"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"queryHash"</span> : <span class="string">"01AEE5EC"</span>,</span><br><span class="line">		<span class="string">"planCacheKey"</span> : <span class="string">"4C5AEA2C"</span>,</span><br><span class="line">		<span class="string">"winningPlan"</span> : &#123;</span><br><span class="line">			<span class="string">"stage"</span> : <span class="string">"FETCH"</span>,</span><br><span class="line">			<span class="string">"inputStage"</span> : &#123;</span><br><span class="line">				<span class="string">"stage"</span> : <span class="string">"IXSCAN"</span>,</span><br><span class="line">				<span class="string">"keyPattern"</span> : &#123;</span><br><span class="line">					<span class="string">"name"</span> : <span class="number">1</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">"indexName"</span> : <span class="string">"name_1"</span>,</span><br><span class="line">				<span class="string">"isMultiKey"</span> : <span class="literal">false</span>,</span><br><span class="line">				<span class="string">"multiKeyPaths"</span> : &#123;</span><br><span class="line">					<span class="string">"name"</span> : [ ]</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">"isUnique"</span> : <span class="literal">false</span>,</span><br><span class="line">				<span class="string">"isSparse"</span> : <span class="literal">false</span>,</span><br><span class="line">				<span class="string">"isPartial"</span> : <span class="literal">false</span>,</span><br><span class="line">				<span class="string">"indexVersion"</span> : <span class="number">2</span>,</span><br><span class="line">				<span class="string">"direction"</span> : <span class="string">"forward"</span>,</span><br><span class="line">				<span class="string">"indexBounds"</span> : &#123;</span><br><span class="line">					<span class="string">"name"</span> : [</span><br><span class="line">						<span class="string">"[\"tom\", \"tom\"]"</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"rejectedPlans"</span> : [ ]</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"serverInfo"</span> : &#123;</span><br><span class="line">		<span class="string">"host"</span> : <span class="string">"0d550468977f"</span>,</span><br><span class="line">		<span class="string">"port"</span> : <span class="number">27017</span>,</span><br><span class="line">		<span class="string">"version"</span> : <span class="string">"4.4.0"</span>,</span><br><span class="line">		<span class="string">"gitVersion"</span> : <span class="string">"563487e100c4215e2dce98d0af2a6a5a2d67c5cf"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次可以看到，它使用了索引。</p>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><pre><code>mongodb可以通过profile来监控数据，进行优化。查看当前是否开启profile功能用命令：`db.getProfilingLevel()`
</code></pre><p>返回level等级，值为<code>0|1|2</code>，分别代表意思：0代表关闭，1代表记录慢命令，2代表全部。开启profile功能为<br><code>db.setProfilingLevel(level)</code>，level为1的时候，慢命令默认值为100ms，更改为<code>db.setProfilingLevel(level, slowms)</code><br>如<code>db.setProfilingLevel(1,50)</code>这样就更改为50毫秒。通过<code>db.system.profile.find()</code>查看当前的监控日志。通过执行<br><code>db.system.profile.find({millis:{$gt:500}})</code>能够返回查询时间在500毫秒以上的查询命令。</p>
<p>这里值的含义<br>op: query，代表查询<br>ns: 代表查询的库与集合<br>command: 命令的内容<br>responseLength: 返回的结果集大小，byte数<br>nscanned: 扫描记录数量<br>filter: 后面是查询条件<br>nreturned: 返回记录数<br>ts: 命令执行的时刻<br>millis: 所花时间</p>
<p>如果发现时间比较长，那么就需要作优化。比如nscanned数很大，或者接近记录总数，那么可能没有用到索引查询。<br>responseLength很大，有可能返回没必要的字段。<br>nreturned很大，那么有可能查询的时候没有加限制。</p>
<p>mongo可以通过<code>db.serverStatus()</code>查看mongod的运行状态<br>mongo可以通过<code>db.currentOp()</code>可以查看当前正在执行的操作。这两个命令，必须用<code>admin</code>帐号才能操作。</p>
<p>如果出现如下错误提示，则是由于auth太多了，退出，并且以admin帐号登录admin库来执行<br>        mongo –host 192.168.1.100 –port 27017 –authenticationDatabase admin -u admin -p admin</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.currentOp()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"ok"</span> : <span class="number">0</span>,</span><br><span class="line">	<span class="string">"errmsg"</span> : <span class="string">"too many users are authenticated"</span>,</span><br><span class="line">	<span class="string">"code"</span> : <span class="number">13</span>,</span><br><span class="line">	<span class="string">"codeName"</span> : <span class="string">"Unauthorized"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/03/07/mongo-note/" data-id="clf9thvmj002a6h3k30ht37a1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-solr-cloud" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/03/solr-cloud/" class="article-date">
  <time datetime="2018-03-03T08:38:59.000Z" itemprop="datePublished">2018-03-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/03/solr-cloud/">solr 集群的创建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>solr 集群，即 solrcloud 的创建<br>下面说说solr集群的安装使用，同样是使用前面例子使用的 solr6.5.0 版本，我在一台机器上安装，所以这是伪集群，当修改为真集群的时候，只要将IP地址修改下即可，下面会说明。</p>
<p>首先，你得搭建 zookeeper 集群，可以参考 <a href="../../../../2017/12/06/zookeeper-cluster/">zookeeper集群版安装方法</a></p>
<h3 id="下面开始创建solr集群："><a href="#下面开始创建solr集群：" class="headerlink" title="下面开始创建solr集群："></a>下面开始创建solr集群：</h3><p>创建一个目录用于存放集群使用到的所有实例和配置信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD</span><br><span class="line">$ mkdir solrCloud		<span class="comment"># 存放集群的所有文件，包括：三个solr实例、和实例共享的配置文件solr-configs</span></span><br><span class="line">$ mkdir solrCloud/solr-configs	<span class="comment"># 用于存放集群的core的配置信息，会被上传到zookeeper</span></span><br></pre></td></tr></table></figure></p>
<p>将一个SOLR压缩包放到这个目录，我之前已在Downloads目录下载好了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cp /home/hewentian/Downloads/solr-6.5.0.tgz ./</span><br><span class="line">$ tar xzvf solr-6.5.0.tgz</span><br><span class="line">$ mv solr-6.5.0 solr1	<span class="comment"># 为方便起见，这里将其重命名为solr1，先将solr1配置好，后面会将其复制为solr2, solr3</span></span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">solr1  solr-6.5.0.tgz  solr-configs</span><br></pre></td></tr></table></figure></p>
<p>我们仍然使用之前的例子，演示使用DIH方式将数据导入到SOLR，只不过，这次是集群的方式，所以需要将<code>data_driven_schema_configs/conf</code>的配置信息复制到<code>solr-configs</code>中，并将其命名为<code>mysqlCore</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/home/hewentian/ProjectD/solrCloud</span><br><span class="line"></span><br><span class="line">$ cp -r solr1/server/solr/configsets/data_driven_schema_configs/conf/ solr-configs/mysqlCore/</span><br></pre></td></tr></table></figure></p>
<p>将mysql-connector-java-5.1.25.jar放到<code>solr1/server/lib/ext</code>目录下面，并将上一个例子，<a href="../../../../2017/10/28/solr-standalone/">solr的安装使用</a>的那三个文件: solrconfig.xml、db-data-config.xml、managed-schema复制到<code>solr-configs/mysqlCore/</code>下，override存在的。</p>
<p>接下来还有2个文件需要修改：<br>修改文件一：solr.in.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vi solr1/bin/solr.in.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改以下内容即可</span></span><br><span class="line">ZK_HOST=<span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183"</span></span><br><span class="line">ZK_CLIENT_TIMEOUT=<span class="string">"15000"</span></span><br><span class="line">SOLR_PORT=8983</span><br></pre></td></tr></table></figure></p>
<p>修改文件二：solr.xml<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vi solr1/server/solr/solr.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改下面的内容即可</span></span><br><span class="line">&lt;str name=<span class="string">"host"</span>&gt;<span class="variable">$&#123;host:127.0.0.1&#125;</span>&lt;/str&gt;   	<span class="comment"># 当修改为真集群的时候，只修改这个IP地址即可</span></span><br><span class="line">&lt;int name=<span class="string">"hostPort"</span>&gt;<span class="variable">$&#123;jetty.port:8983&#125;</span>&lt;/int&gt;	<span class="comment"># 这里端口为 8983</span></span><br></pre></td></tr></table></figure></p>
<p>这样一个实例就配置好了，将其复制为solr2, solr3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp -r solr1 solr2</span><br><span class="line">$ cp -r solr1 solr3</span><br></pre></td></tr></table></figure></p>
<p>修改solr2, solr3的端口为8984, 8985<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ vi solr2/bin/solr.in.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改以下内容即可</span></span><br><span class="line">SOLR_PORT=8984</span><br><span class="line"></span><br><span class="line">$ vi solr3/bin/solr.in.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改以下内容即可</span></span><br><span class="line">SOLR_PORT=8985</span><br><span class="line"></span><br><span class="line">$ vi solr2/server/solr/solr.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改下面的内容即可</span></span><br><span class="line">&lt;str name=<span class="string">"host"</span>&gt;<span class="variable">$&#123;host:127.0.0.1&#125;</span>&lt;/str&gt;   	<span class="comment"># 当修改为真集群的时候，只修改这个IP地址即可</span></span><br><span class="line">&lt;int name=<span class="string">"hostPort"</span>&gt;<span class="variable">$&#123;jetty.port:8984&#125;</span>&lt;/int&gt;	<span class="comment"># 这里端口为 8984</span></span><br><span class="line"></span><br><span class="line">$ vi solr3/server/solr/solr.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改下面的内容即可</span></span><br><span class="line">&lt;str name=<span class="string">"host"</span>&gt;<span class="variable">$&#123;host:127.0.0.1&#125;</span>&lt;/str&gt;   	<span class="comment"># 当修改为真集群的时候，只修改这个IP地址即可</span></span><br><span class="line">&lt;int name=<span class="string">"hostPort"</span>&gt;<span class="variable">$&#123;jetty.port:8985&#125;</span>&lt;/int&gt;	<span class="comment"># 这里端口为 8985</span></span><br></pre></td></tr></table></figure></p>
<p>这样，三个solr实例就已经配置好了，下面将其都启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/home/hewentian/ProjectD/solrCloud</span><br><span class="line"></span><br><span class="line">$ solr1/bin/solr start</span><br><span class="line">Waiting up to 180 seconds to see Solr running on port 8983 [\]  </span><br><span class="line">Started Solr server on port 8983 (pid=15292). Happy searching!</span><br><span class="line"></span><br><span class="line">$ solr2/bin/solr start</span><br><span class="line">Waiting up to 180 seconds to see Solr running on port 8984 [\]  </span><br><span class="line">Started Solr server on port 8984 (pid=15507). Happy searching!</span><br><span class="line"></span><br><span class="line">$ solr3/bin/solr start</span><br><span class="line">Waiting up to 180 seconds to see Solr running on port 8985 [\]  </span><br><span class="line">Started Solr server on port 8985 (pid=15706). Happy searching!</span><br></pre></td></tr></table></figure></p>
<p>在浏览器中可以如下访问：<br><a href="http://localhost:8983" target="_blank" rel="noopener">http://localhost:8983</a><br><a href="http://localhost:8984" target="_blank" rel="noopener">http://localhost:8984</a><br><a href="http://localhost:8985" target="_blank" rel="noopener">http://localhost:8985</a></p>
<p>下面，我们将<code>solr-configs/mysqlCore</code>的内容上传到zookeeper，以便让三台solr都使用这个配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /home/hewentian/ProjectD/solrCloud/solr1/server/scripts/cloud-scripts/zkcli.sh -zkhost 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183 -cmd upconfig -confdir /home/hewentian/ProjectD/solrCloud/solr-configs/mysqlCore -confname mysqlCore</span><br></pre></td></tr></table></figure></p>
<h4 id="说明："><a href="#说明：" class="headerlink" title="说明："></a>说明：</h4><ol>
<li>-confdir：这个指的是 本地上传的文件位置    </li>
<li>-confname：上传后在zookeeper中的节点名称</li>
</ol>
<p>也可以上传单个文件，单个文件上传先要删除，不然会报错：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /home/hewentian/ProjectD/solrCloud/solr1/server/scripts/cloud-scripts/zkcli.sh -zkhost 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183 -cmd putfile /configs/mysqlCore/solrconfig.xml /home/hewentian/ProjectD/solrCloud/solr-configs/mysqlCore/solrconfig.xml</span><br></pre></td></tr></table></figure></p>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明:"></a>说明:</h4><p>putfile 后第一个<code>/configs/mysqlCore/solrconfig.xml</code>指的是<code>zookeeper</code>中的配置文件，第二个<code>/home/hewentian/ProjectD/solrCloud/solr-configs/mysqlCore/solrconfig.xml</code>指的是本地文件路径</p>
<p>下面我们在solr1中创建一个core，并命名为 mysqlCore，在浏览器中输入如下url即可，它有3个分片，每个分片有2个副本：<br><a href="http://localhost:8983/solr/admin/collections?action=CREATE&amp;name=mysqlCore&amp;numShards=3&amp;replicationFactor=2&amp;maxShardsPerNode=3&amp;collection.configName=mysqlCore" target="_blank" rel="noopener">http://localhost:8983/solr/admin/collections?action=CREATE&amp;name=mysqlCore&amp;numShards=3&amp;replicationFactor=2&amp;maxShardsPerNode=3&amp;collection.configName=mysqlCore</a><br>执行成功后，你可能会看到如下输出：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">This XML file does not appear to have any style information associated with it. The document tree is shown below.</span><br><span class="line"><span class="tag">&lt;<span class="name">response</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>16020<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"success"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8983_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>13930<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard3_replica2<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8983_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14273<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard2_replica1<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8984_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14479<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard3_replica1<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8985_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14597<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard2_replica2<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8985_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14748<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard1_replica1<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8984_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14778<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard1_replica2<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">response</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>也可以使用下面的方式，指定在哪台机器中创建哪个分片的哪个副本。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">"http://localhost:8983/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard1_replica1&amp;instanceDir=mysqlCore_shard1_replica1&amp;collection=mysqlCore&amp;shard=mysqlCore_shard1"</span></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8983/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard3_replica2&amp;instanceDir=mysqlCore_shard3_replica2&amp;collection=mysqlCore&amp;shard=mysqlCore_shard3"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8984/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard1_replica2&amp;instanceDir=mysqlCore_shard1_replica2&amp;collection=mysqlCore&amp;shard=mysqlCore_shard1"</span></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8984/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard2_replica1&amp;instanceDir=mysqlCore_shard2_replica1&amp;collection=mysqlCore&amp;shard=mysqlCore_shard2"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8985/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard2_replica2&amp;instanceDir=mysqlCore_shard2_replica2&amp;collection=mysqlCore&amp;shard=mysqlCore_shard2"</span></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8985/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard3_replica1&amp;instanceDir=mysqlCore_shard3_replica1&amp;collection=mysqlCore&amp;shard=mysqlCore_shard3"</span></span><br></pre></td></tr></table></figure></p>
<p>你也可以查看分片是否创建成功：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ls solr1/server/solr</span><br><span class="line">configsets  mysqlCore_shard2_replica1  mysqlCore_shard3_replica2  README.txt  solr.xml  zoo.cfg</span><br><span class="line"></span><br><span class="line">$ ls solr2/server/solr</span><br><span class="line">configsets  mysqlCore_shard1_replica2  mysqlCore_shard3_replica1  README.txt  solr.xml  zoo.cfg</span><br><span class="line"></span><br><span class="line">$ ls solr3/server/solr</span><br><span class="line">configsets  mysqlCore_shard1_replica1  mysqlCore_shard2_replica2  README.txt  solr.xml  zoo.cfg</span><br></pre></td></tr></table></figure></p>
<p>在<a href="http://localhost:8983" target="_blank" rel="noopener">http://localhost:8983</a>上面执行DIH将user索引进solr，成功之后你就可以在<a href="http://localhost:8984" target="_blank" rel="noopener">http://localhost:8984</a>, <a href="http://localhost:8985" target="_blank" rel="noopener">http://localhost:8985</a>上面看到同样的结果。</p>
<p>当然，我们也可以在启动的时候，才指定zookeeper<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/solr start -c -z zk1:port,zk2:port,zk3:port</span><br></pre></td></tr></table></figure></p>
<p>说明：</p>
<ol>
<li>-c：以solr_cloud的方式启动；</li>
<li>-z:指定zookeeper集群的地址和端口，上面搭建zookeeper集群时的3台机器</li>
</ol>
<h3 id="solr备份"><a href="#solr备份" class="headerlink" title="solr备份"></a>solr备份</h3><p>在进行solr备份的时候，一定要先将solr服务停了，然后再备份。否则在还原的时候有可能会产生<code>write.lock</code>，在产生<code>write.lock</code>的时候也不要怕，你可以按下面的方法解决：</p>
<ol>
<li><p>将<code>write.lock</code>删掉，然后再新建一个，然后修改权限；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rm write.lock</span><br><span class="line">$ touch write.lock</span><br><span class="line">$ chmod 666 write.lock</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启solr服务；</p>
</li>
<li>在浏览器登录到那个solr的cord，reload一下，然后查询，如果没报错的话，可能要等5分钟左右，查询结果就出来了。<br>[solr界面]-&gt;[collections]-&gt;[点击你的那个 collection]-&gt;[Reload]</li>
</ol>
<p>JAVA示例代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CloudSolrClient cloudSolrClient = <span class="keyword">new</span> CloudSolrClient.Builder()</span><br><span class="line">				.withZkHost(<span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183"</span>).build();</span><br><span class="line">		cloudSolrClient.setDefaultCollection(<span class="string">"mysqlCore"</span>);</span><br><span class="line"></span><br><span class="line">		SolrQuery solrQuery = <span class="keyword">new</span> SolrQuery();</span><br><span class="line"></span><br><span class="line">		solrQuery.setQuery(<span class="string">"schools:\"北京第一中学\" AND id:[1 TO 3]"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 分页</span></span><br><span class="line">		solrQuery.setStart(<span class="number">0</span>);</span><br><span class="line">		solrQuery.setRows(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">		SolrDocumentList results = cloudSolrClient.query(solrQuery).getResults();</span><br><span class="line"></span><br><span class="line">		logger.info(<span class="string">"numFound: "</span> + results.getNumFound());</span><br><span class="line">		<span class="keyword">if</span> (CollectionUtils.isEmpty(results)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		results.stream().forEach(logger::info);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>未完，待续……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/03/03/solr-cloud/" data-id="clf9thvmx00326h3k6b2kxu3a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solr/">solr</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-neo4j-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/17/neo4j-note/" class="article-date">
  <time datetime="2018-02-17T01:59:18.000Z" itemprop="datePublished">2018-02-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/db/">db</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/17/neo4j-note/">neo4j 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一些基本概念，从官网copy过来的，如下："><a href="#一些基本概念，从官网copy过来的，如下：" class="headerlink" title="一些基本概念，从官网copy过来的，如下："></a>一些基本概念，从官网copy过来的，如下：</h2><h3 id="Graph-Fundamentals"><a href="#Graph-Fundamentals" class="headerlink" title="Graph Fundamentals"></a>Graph Fundamentals</h3><p>Basic concepts to get you going.</p>
<p>A graph database can store any kind of data using a few simple concepts:</p>
<ol>
<li>Nodes - graph data records</li>
<li>Relationships - connect nodes</li>
<li>Properties - named data values</li>
</ol>
<h3 id="A-Graph-Database"><a href="#A-Graph-Database" class="headerlink" title="A Graph Database"></a>A Graph Database</h3><p>Neo4j stores data in a Graph, with records called Nodes.</p>
<p>The simplest graph has just a single node with some named values called Properties. Let’s draw a social graph of our friends on the Neo4j team:</p>
<ol>
<li>Start by drawing a circle for the node</li>
<li>Add the name Emil</li>
<li>Note that he is from Sweden</li>
</ol>
<ul>
<li>Nodes are the name for data records in a graph</li>
<li>Data is stored as Properties</li>
<li>Properties are simple name/value pairs</li>
</ul>
<h3 id="Labels"><a href="#Labels" class="headerlink" title="Labels"></a>Labels</h3><p>Associate a set of nodes.</p>
<p>Nodes can be grouped together by applying a Label to each member. In our social graph, we’ll label each node that represents a Person.</p>
<ol>
<li>Apply the label “Person” to the node we created for Emil</li>
<li>Color “Person” nodes red</li>
</ol>
<ul>
<li>A node can have zero or more labels</li>
<li>Labels do not have any properties</li>
</ul>
<h3 id="More-Nodes"><a href="#More-Nodes" class="headerlink" title="More Nodes"></a>More Nodes</h3><p>Schema-free, nodes can have a mix of common and unique properties.</p>
<p>Like any database, storing data in Neo4j can be as simple as adding more records. We’ll add a few more nodes:</p>
<ol>
<li>Emil has a klout score of 99</li>
<li>Johan, from Sweden, who is learning to surf</li>
<li>Ian, from England, who is an author</li>
<li>Rik, from Belgium, has a cat named Orval</li>
<li>Allison, from California, who surfs</li>
</ol>
<ul>
<li>Similar nodes can have different properties</li>
<li>Properties can be strings, numbers, or booleans</li>
<li>Neo4j can store billions of nodes</li>
</ul>
<h3 id="Consider-Relationships"><a href="#Consider-Relationships" class="headerlink" title="Consider Relationships"></a>Consider Relationships</h3><p>Connect nodes in the graph</p>
<p>The real power of Neo4j is in connected data. To associate any two nodes, add a Relationship which describes how the records are related.</p>
<p>In our social graph, we simply say who KNOWS whom:</p>
<ol>
<li>Emil KNOWS Johan and Ian</li>
<li>Johan KNOWS Ian and Rik</li>
<li>Rik and Ian KNOWS Allison</li>
</ol>
<ul>
<li>Relationships always have direction</li>
<li>Relationships always have a type</li>
<li>Relationships form patterns of data</li>
</ul>
<h3 id="Relationship-properties"><a href="#Relationship-properties" class="headerlink" title="Relationship properties"></a>Relationship properties</h3><p>Store information shared by two nodes.</p>
<p>In a property graph, relationships are data records that can also contain properties. Looking more closely at Emil’s relationships, note that:</p>
<ul>
<li>Emil has known Johan since 2001</li>
<li>Emil rates Ian 5 (out of 5)</li>
<li>Everyone else can have similar relationship properties</li>
</ul>
<p>可以使用这种方式访问neo4j数据库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:7474/browser/</span><br></pre></td></tr></table></figure></p>
<h3 id="清空neo4j数据库"><a href="#清空neo4j数据库" class="headerlink" title="清空neo4j数据库"></a>清空neo4j数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match(n)</span><br><span class="line">optional match(n)-[r]-()</span><br><span class="line">delete n,r</span><br></pre></td></tr></table></figure>
<p>执行上面的命令后，会删除节点及与该节点相关的关系，但是property keys删不干净</p>
<p>未完，待续……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/02/17/neo4j-note/" data-id="clf9thvmh00276h3kxuf1tgoz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/neo4j/">neo4j</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-gitbook-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/29/gitbook-note/" class="article-date">
  <time datetime="2018-01-29T05:59:48.000Z" itemprop="datePublished">2018-01-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/other/">other</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/29/gitbook-note/">gitbook 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>下面说下如何安装gitbook</p>
<h3 id="1-安装-Node-js"><a href="#1-安装-Node-js" class="headerlink" title="1. 安装 Node.js"></a>1. 安装 Node.js</h3><p>先测试一下Node.js是否已安装，在命令行中直接输入<code>node</code>可以看到提示符变成了一个向右<br>的箭头就表示成功了，然后按ctrl + c退出node模式，出现$符号才表示正常了</p>
<p>如果未安裝 node，安裝方法如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install nodejs-legacy</span><br></pre></td></tr></table></figure></p>
<p>剩下的安装过程参考<a href="https://yq.aliyun.com/articles/7506" target="_blank" rel="noopener">https://yq.aliyun.com/articles/7506</a>，但是会有一些不同，如下所示：</p>
<h3 id="2-安装gitbook"><a href="#2-安装gitbook" class="headerlink" title="2. 安装gitbook"></a>2. 安装gitbook</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install -g gitbook-cli</span><br></pre></td></tr></table></figure>
<h3 id="3-初始化"><a href="#3-初始化" class="headerlink" title="3. 初始化"></a>3. 初始化</h3><p>在你的文档目录下新建文件 SUMMARY.md，这个文件就是这本书的目录啦：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> docs</span><br><span class="line">$ touch SUMMARY.md</span><br></pre></td></tr></table></figure></p>
<p>SUMMARY.md 的格式规范如下：</p>
<pre><code># uitest 文档

- [uitest 是什么](users/index.md)
    - [如何使用 uitest](users/use.md)
    - [如何编写自定义的测试用例](users/case.md)
    - [browserjs API 文档](users/api.md)
- [uitest 开发者文档](devs/index.md)
    - [browserjs 开发者文档](devs/browserjs.md)
    - [utci 文档](devs/utci.md)
    - [utserver &amp; utclient 文档](devs/utserver.md)
- [相关文章沉淀](artical.md)
- [关于 gitbook](gitbook.md)
</code></pre><p>然后执行<code>gitbook init</code>初始化，gitbook 会根据 SUMMARY 的结构生成对应的目录文件：</p>
<pre><code>├── README.md           // 首页
├── SUMMARY.md          // 目录
└── users               // 用户文档
    └── index.md        // 是什么
    ├── use.md          // 如何使用
    ├── api.md          // browserjs API
    ├── case.md         // 如何写测试用例
├── devs                // 开发者文档目录
    │   ├── index.md        // 开发者文文档首页
    │   ├── browserjs.md    // browserjs 开发文档
    │   ├── utci.md         // utci 开发文档
    │   └── utserver.md     // utserver 和 utclien 开发文档
├── artical.md          // 文章沉淀
├── gitbook.md          // gitbook 相关
</code></pre><h3 id="4-本地调试"><a href="#4-本地调试" class="headerlink" title="4. 本地调试"></a>4. 本地调试</h3><p>在对应的文档目录下运行<code>gitbook serve</code>会启动一个本地的静态服务器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> docs</span><br><span class="line">$ gitbook serve</span><br><span class="line"></span><br><span class="line">Live reload server started on port: 35729</span><br><span class="line">Press CTRL+C to quit ...</span><br><span class="line"></span><br><span class="line">info: 7 plugins are installed </span><br><span class="line">info: loading plugin <span class="string">"livereload"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"highlight"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"search"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"lunr"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"sharing"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"fontsettings"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"theme-default"</span>... OK </span><br><span class="line">info: found 27 pages </span><br><span class="line">info: found 2 asset files</span><br></pre></td></tr></table></figure></p>
<p>访问 <a href="http://localhost:4000/" target="_blank" rel="noopener">http://localhost:4000/</a> 就可以实时的预览啦，并且支持<code>livereload</code>, 灰常赞~接下来结合预览的功能编辑对应的文档，完成之后就可以发布啦。</p>
<h3 id="5-发布"><a href="#5-发布" class="headerlink" title="5. 发布"></a>5. 发布</h3><p>在文档目录下执行<code>gitbook build</code>会生成一个<code>_book</code>的目录，这个目录就是我们的静态网站啦，然后通过 demo 平台或者 github pages 就可以很简单的完成部署了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/01/29/gitbook-note/" data-id="clf9thvl0000e6h3kjshosrdn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">bigdata</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/container/">container</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-server/">web server</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/03/07/xxl-job-note/">xxl-job 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/11/28/seata-note/">seata 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/09/25/spring-note/">spring 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/04/01/mybatis-note/">mybatis 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/01/22/canal-note/">canal 学习笔记</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">link</h3>
    <div class="widget">
      <li><a href="https://github.com/hewentian" title="Tim Ho's Blog">我的github</a></li>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 Tim Ho<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/categories/" class="mobile-nav-link">Categories</a>
  
    <a href="/tags/" class="mobile-nav-link">Tags</a>
  
    <a href="/about/" class="mobile-nav-link">About</a>
  
</nav>
    

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<!-- <script src="//code.jquery.com/jquery-2.2.4.min.js"></script> -->
<script src="/js/jquery-3.5.1.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>