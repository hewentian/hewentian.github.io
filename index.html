<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tim Ho&#39;s Technology Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="my personal blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Tim Ho&#39;s Technology Blog">
<meta property="og:url" content="https://github.com/hewentian/index.html">
<meta property="og:site_name" content="Tim Ho&#39;s Technology Blog">
<meta property="og:description" content="my personal blog">
<meta property="og:locale" content="en-US">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tim Ho&#39;s Technology Blog">
<meta name="twitter:description" content="my personal blog">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tim Ho&#39;s Technology Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心如止水</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/categories/">Categories</a>
        
          <a class="main-nav-link" href="/tags/">Tags</a>
        
          <a class="main-nav-link" href="/about/">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/hewentian"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-xxl-job-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/07/xxl-job-note/" class="article-date">
  <time datetime="2022-03-07T06:31:20.000Z" itemprop="datePublished">2022-03-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/07/xxl-job-note/">xxl-job 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本篇将说说分布式任务调度平台<a href="https://www.xuxueli.com/xxl-job/" target="_blank" rel="noopener">XXL-JOB</a>的安装使用。</p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/gitHub/</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/xuxueli/xxl-job.git</span><br><span class="line">$ <span class="built_in">cd</span> xxl-job/</span><br><span class="line">$ git checkout -b 2.3.0 origin/2.3.0</span><br><span class="line">$ ls</span><br><span class="line">doc  LICENSE  NOTICE  pom.xml  README.md  xxl-job-admin  xxl-job-core  xxl-job-executor-samples</span><br></pre></td></tr></table></figure>
<p>下载后，将代码导入IDEA，这样方便修改文件。</p>
<h3 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h3><p>数据库文件在<code>/home/hewentian/ProjectD/gitHub/xxl-job/doc/db/tables_xxl_job.sql</code><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; source /home/hewentian/ProjectD/gitHub/xxl-job/doc/db/tables_xxl_job.sql</span><br><span class="line"></span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| Tables_in_xxl_job  |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| xxl_job_group      |</span><br><span class="line">| xxl_job_info       |</span><br><span class="line">| xxl_job_lock       |</span><br><span class="line">| xxl_job_log        |</span><br><span class="line">| xxl_job_log_report |</span><br><span class="line">| xxl_job_logglue    |</span><br><span class="line">| xxl_job_registry   |</span><br><span class="line">| xxl_job_user       |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">8 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="部署调度中心"><a href="#部署调度中心" class="headerlink" title="部署调度中心"></a>部署调度中心</h3><p>调度中心项目：xxl-job-admin</p>
<p>配置日志存放路径，<code>/home/hewentian/ProjectD/gitHub/xxl-job/xxl-job-admin/src/main/resources/logback.xml</code>，仅配置下面这一项即可：</p>
<pre><code>&lt;property name=&quot;log.path&quot; value=&quot;/home/hewentian/logs/xxl-job/xxl-job-admin.log&quot;/&gt;
</code></pre><p>配置项目基本配置文件，<code>/home/hewentian/ProjectD/gitHub/xxl-job/xxl-job-admin/src/main/resources/application.properties</code>，修改项如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.url=jdbc:mysql://mysql.hewentian.com:3306/xxl_job?useUnicode=<span class="literal">true</span>&amp;characterEncoding=UTF-8&amp;autoReconnect=<span class="literal">true</span>&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456</span><br><span class="line">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure></p>
<p>启动项目：启动类为<code>com.xxl.job.admin.XxlJobAdminApplication</code></p>
<p>WEB访问地址：<br><a href="http://localhost:8080/xxl-job-admin" target="_blank" rel="noopener">http://localhost:8080/xxl-job-admin</a></p>
<p>默认用户名/密码：admin/123456</p>
<p><img src="/img/xxl-job-1.png" alt=""></p>
<h3 id="部署执行器项目"><a href="#部署执行器项目" class="headerlink" title="部署执行器项目"></a>部署执行器项目</h3><p>执行器项目，我部署的是：xxl-job-executor-samples/xxl-job-executor-sample-springboot</p>
<p>配置日志存放路径，<code>/home/hewentian/ProjectD/gitHub/xxl-job/xxl-job-executor-samples/xxl-job-executor-sample-springboot/src/main/resources/logback.xml</code>，仅配置下面这一项即可：</p>
<pre><code>&lt;property name=&quot;log.path&quot; value=&quot;/home/hewentian/logs/xxl-job/xxl-job-executor-sample-springboot.log&quot;/&gt;
</code></pre><p>配置项目基本配置文件，<code>/home/hewentian/ProjectD/gitHub/xxl-job/xxl-job-executor-samples/xxl-job-executor-sample-springboot/src/main/resources/application.properties</code>，修改项如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xxl.job.admin.addresses=http://127.0.0.1:8080/xxl-job-admin</span><br><span class="line">xxl.job.executor.logpath=/home/hewentian/logs/xxl-job/jobhandler</span><br></pre></td></tr></table></figure></p>
<p>启动项目：启动类为<code>com.xxl.job.executor.XxlJobExecutorApplication</code></p>
<h3 id="在调度中心新建任务"><a href="#在调度中心新建任务" class="headerlink" title="在调度中心新建任务"></a>在调度中心新建任务</h3><p>登录下面的地址，进行配置：<br><a href="http://localhost:8080/xxl-job-admin" target="_blank" rel="noopener">http://localhost:8080/xxl-job-admin</a></p>
<p>项目中的代码如下：<br><img src="/img/xxl-job-2.png" alt=""></p>
<p>执行器管理：<br><img src="/img/xxl-job-3.png" alt=""></p>
<p>任务管理：<br><img src="/img/xxl-job-4.png" alt=""></p>
<p>调度日志：<br><img src="/img/xxl-job-5.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2022/03/07/xxl-job-note/" data-id="clf9thvnu003s6h3kp6rvyej5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/job/">job</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-seata-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/11/28/seata-note/" class="article-date">
  <time datetime="2021-11-28T09:45:55.000Z" itemprop="datePublished">2021-11-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/11/28/seata-note/">seata 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>安装过程参考<br><a href="https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html" target="_blank" rel="noopener">https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html</a></p>
<p>Server端存储模式（store.mode）现有file、db、redis三种（后续将引入raft,mongodb），file模式无需改动，直接启动即可，下面专门讲下db模式启动步骤。<br>注： </p>
<ol>
<li>file模式为单机模式，全局事务会话信息在内存中读写并持久化到本地文件root.data，性能较高;</li>
<li>db模式为高可用模式，全局事务会话信息通过db共享，相应性能差些;</li>
<li>redis模式Seata-Server 1.3及以上版本支持，性能较高，存在事务信息丢失风险，请提前配置合适当前场景的redis持久化配置。</li>
</ol>
<h4 id="第一步：首先，到如下地址，下载最新版本，截止目前，最新版本为seata-server-1-4-2-zip"><a href="#第一步：首先，到如下地址，下载最新版本，截止目前，最新版本为seata-server-1-4-2-zip" class="headerlink" title="第一步：首先，到如下地址，下载最新版本，截止目前，最新版本为seata-server-1.4.2.zip"></a>第一步：首先，到如下地址，下载最新版本，截止目前，最新版本为<code>seata-server-1.4.2.zip</code></h4><p><a href="https://seata.io/en-us/blog/download.html" target="_blank" rel="noopener">https://seata.io/en-us/blog/download.html</a></p>
<p>解压</p>
<pre><code>unzip -O CP936 seata-server-1.4.2.zip
</code></pre><h4 id="第二步：建表（仅db模式）"><a href="#第二步：建表（仅db模式）" class="headerlink" title="第二步：建表（仅db模式）"></a>第二步：建表（仅db模式）</h4><p>建表语句，可以在下面的地址找到（注意版本号）<br><a href="https://github.com/seata/seata/blob/1.4.2/script/server/db/mysql.sql">https://github.com/seata/seata/blob/1.4.2/script/server/db/mysql.sql</a></p>
<p>全局事务会话信息由3块内容构成，全局事务–&gt;分支事务–&gt;全局锁，对应表global_table、branch_table、lock_table</p>
<h4 id="第三步，方式一：注册到nacos，配置信息存放在file"><a href="#第三步，方式一：注册到nacos，配置信息存放在file" class="headerlink" title="第三步，方式一：注册到nacos，配置信息存放在file"></a>第三步，方式一：注册到nacos，配置信息存放在file</h4><p>打开文件<code>{SEATA_HOME}/conf/file.conf</code>，主要修改部分，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">service &#123;</span><br><span class="line">  # transaction service group mapping</span><br><span class="line">  vgroupMapping.hwt_tx_group = &quot;default&quot; # 修改事务组名称为：hwt_tx_group，和客户端自定义的名称对应</span><br><span class="line">  # only support when registry.type=file, please don&apos;t set multiple addresses</span><br><span class="line">  default.grouplist = &quot;127.0.0.1:8091&quot;</span><br><span class="line">  # degrade, current not support</span><br><span class="line">  enableDegrade = false</span><br><span class="line">  # disable seata</span><br><span class="line">  disableGlobalTransaction = false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">store &#123;</span><br><span class="line">  mode = &quot;db&quot;</span><br><span class="line"></span><br><span class="line">  ## database store property</span><br><span class="line">  db &#123;</span><br><span class="line">    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp)/HikariDataSource(hikari) etc.</span><br><span class="line">    datasource = &quot;druid&quot;</span><br><span class="line">    ## mysql/oracle/postgresql/h2/oceanbase etc.</span><br><span class="line">    dbType = &quot;mysql&quot;</span><br><span class="line">    driverClassName = &quot;com.mysql.cj.jdbc.Driver&quot;</span><br><span class="line">    ## if using mysql to store the data, recommend add rewriteBatchedStatements=true in jdbc connection param</span><br><span class="line">    url = &quot;jdbc:mysql://127.0.0.1:3306/seata?rewriteBatchedStatements=true&quot;</span><br><span class="line">    user = &quot;mysql&quot;</span><br><span class="line">    password = &quot;mysql&quot;</span><br><span class="line">    minConn = 5</span><br><span class="line">    maxConn = 100</span><br><span class="line">    globalTable = &quot;global_table&quot;</span><br><span class="line">    branchTable = &quot;branch_table&quot;</span><br><span class="line">    lockTable = &quot;lock_table&quot;</span><br><span class="line">    queryLimit = 100</span><br><span class="line">    maxWait = 5000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>打开文件<code>{SEATA_HOME}/conf/registry.conf</code>，主要修改部分，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    application = &quot;seata-server&quot;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8848&quot;</span><br><span class="line">    group = &quot;DEFAULT_GROUP&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    username = &quot;nacos&quot;</span><br><span class="line">    password = &quot;nacos&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line">  type = &quot;file&quot;</span><br><span class="line"></span><br><span class="line">  file &#123;</span><br><span class="line">    name = &quot;file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="第三步，方式二：注册到nacos，配置信息存放在nacos"><a href="#第三步，方式二：注册到nacos，配置信息存放在nacos" class="headerlink" title="第三步，方式二：注册到nacos，配置信息存放在nacos"></a>第三步，方式二：注册到nacos，配置信息存放在nacos</h4><p>打开文件<code>{SEATA_HOME}/conf/registry.conf</code>，主要修改部分，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    application = &quot;seata-server&quot;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8848&quot;</span><br><span class="line">    group = &quot;DEFAULT_GROUP&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    username = &quot;nacos&quot;</span><br><span class="line">    password = &quot;nacos&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8848&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    group = &quot;DEFAULT_GROUP&quot;</span><br><span class="line">    username = &quot;nacos&quot;</span><br><span class="line">    password = &quot;nacos&quot;</span><br><span class="line">    dataId = &quot;seataServer.properties&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，在nacos新建配置<br>Data Id: seataServer.properties<br>Group: DEFAULT_GROUP<br>配置格式： Properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">transport.type=TCP</span><br><span class="line">transport.server=NIO</span><br><span class="line">transport.heartbeat=true</span><br><span class="line">transport.enableClientBatchSendRequest=false</span><br><span class="line">transport.threadFactory.bossThreadPrefix=NettyBoss</span><br><span class="line">transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker</span><br><span class="line">transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler</span><br><span class="line">transport.threadFactory.shareBossWorker=false</span><br><span class="line">transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector</span><br><span class="line">transport.threadFactory.clientSelectorThreadSize=1</span><br><span class="line">transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread</span><br><span class="line">transport.threadFactory.bossThreadSize=1</span><br><span class="line">transport.threadFactory.workerThreadSize=default</span><br><span class="line">transport.shutdown.wait=3</span><br><span class="line">service.vgroupMapping.hwt_tx_group=default</span><br><span class="line">service.default.grouplist=127.0.0.1:8091</span><br><span class="line">service.enableDegrade=false</span><br><span class="line">service.disableGlobalTransaction=false</span><br><span class="line">client.rm.asyncCommitBufferLimit=10000</span><br><span class="line">client.rm.lock.retryInterval=10</span><br><span class="line">client.rm.lock.retryTimes=30</span><br><span class="line">client.rm.lock.retryPolicyBranchRollbackOnConflict=true</span><br><span class="line">client.rm.reportRetryCount=5</span><br><span class="line">client.rm.tableMetaCheckEnable=false</span><br><span class="line">client.rm.tableMetaCheckerInterval=60000</span><br><span class="line">client.rm.sqlParserType=druid</span><br><span class="line">client.rm.reportSuccessEnable=false</span><br><span class="line">client.rm.sagaBranchRegisterEnable=false</span><br><span class="line">client.tm.commitRetryCount=5</span><br><span class="line">client.tm.rollbackRetryCount=5</span><br><span class="line">client.tm.defaultGlobalTransactionTimeout=60000</span><br><span class="line">client.tm.degradeCheck=false</span><br><span class="line">client.tm.degradeCheckAllowTimes=10</span><br><span class="line">client.tm.degradeCheckPeriod=2000</span><br><span class="line">store.mode=db</span><br><span class="line">store.publicKey=</span><br><span class="line">store.file.dir=file_store/data</span><br><span class="line">store.file.maxBranchSessionSize=16384</span><br><span class="line">store.file.maxGlobalSessionSize=512</span><br><span class="line">store.file.fileWriteBufferCacheSize=16384</span><br><span class="line">store.file.flushDiskMode=async</span><br><span class="line">store.file.sessionReloadReadSize=100</span><br><span class="line">store.db.datasource=druid</span><br><span class="line">store.db.dbType=mysql</span><br><span class="line">store.db.driverClassName=com.mysql.cj.jdbc.Driver</span><br><span class="line">store.db.url=jdbc:mysql://mysql.hewentian.com:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span><br><span class="line">store.db.user=root</span><br><span class="line">store.db.password=123456</span><br><span class="line">store.db.minConn=5</span><br><span class="line">store.db.maxConn=30</span><br><span class="line">store.db.globalTable=global_table</span><br><span class="line">store.db.branchTable=branch_table</span><br><span class="line">store.db.queryLimit=100</span><br><span class="line">store.db.lockTable=lock_table</span><br><span class="line">store.db.maxWait=5000</span><br><span class="line">store.redis.mode=single</span><br><span class="line">store.redis.single.host=127.0.0.1</span><br><span class="line">store.redis.single.port=6379</span><br><span class="line">store.redis.sentinel.masterName=</span><br><span class="line">store.redis.sentinel.sentinelHosts=</span><br><span class="line">store.redis.maxConn=10</span><br><span class="line">store.redis.minConn=1</span><br><span class="line">store.redis.maxTotal=100</span><br><span class="line">store.redis.database=0</span><br><span class="line">store.redis.password=</span><br><span class="line">store.redis.queryLimit=100</span><br><span class="line">server.recovery.committingRetryPeriod=1000</span><br><span class="line">server.recovery.asynCommittingRetryPeriod=1000</span><br><span class="line">server.recovery.rollbackingRetryPeriod=1000</span><br><span class="line">server.recovery.timeoutRetryPeriod=1000</span><br><span class="line">server.maxCommitRetryTimeout=-1</span><br><span class="line">server.maxRollbackRetryTimeout=-1</span><br><span class="line">server.rollbackRetryTimeoutUnlockEnable=false</span><br><span class="line">client.undo.dataValidation=true</span><br><span class="line">client.undo.logSerialization=jackson</span><br><span class="line">client.undo.onlyCareUpdateColumns=true</span><br><span class="line">server.undo.logSaveDays=7</span><br><span class="line">server.undo.logDeletePeriod=86400000</span><br><span class="line">client.undo.logTable=undo_log</span><br><span class="line">client.undo.compress.enable=true</span><br><span class="line">client.undo.compress.type=zip</span><br><span class="line">client.undo.compress.threshold=64k</span><br><span class="line">log.exceptionRate=100</span><br><span class="line">transport.serialization=seata</span><br><span class="line">transport.compressor=none</span><br><span class="line">metrics.enabled=false</span><br><span class="line">metrics.registryType=compact</span><br><span class="line">metrics.exporterList=prometheus</span><br><span class="line">metrics.exporterPrometheusPort=9898</span><br></pre></td></tr></table></figure>
<p>配置的内容可以从下面的文件获取（注意版本号）<br><a href="https://github.com/seata/seata/blob/1.4.2/script/config-center/config.txt">https://github.com/seata/seata/blob/1.4.2/script/config-center/config.txt</a></p>
<p>主要修改点，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">service.vgroupMapping.hwt_tx_group=default</span><br><span class="line">store.mode=db</span><br><span class="line">store.db.driverClassName=com.mysql.cj.jdbc.Driver</span><br><span class="line">store.db.url=jdbc:mysql://mysql.hewentian.com:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span><br><span class="line">store.db.user=root</span><br><span class="line">store.db.password=123456</span><br></pre></td></tr></table></figure></p>
<h4 id="第四步：启动"><a href="#第四步：启动" class="headerlink" title="第四步：启动"></a>第四步：启动</h4><p>启动命令如下：</p>
<pre><code>bash {SEATA_HOME}/bin/seata-server.sh -h 127.0.0.1 -p 8091 -m db -n 1
</code></pre><p>参数说明：</p>
<pre><code>-h: 注册到注册中心的ip
-p: Server rpc 监听端口
-m: 全局事务会话信息存储模式，file、db、redis，优先读取启动参数 (Seata-Server 1.3及以上版本支持redis)
-n: Server node，多个Server时，需区分各自节点，用于生成不同区间的transactionId，以免冲突
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2021/11/28/seata-note/" data-id="clf9thvmu002v6h3kxemn2sca" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/seata/">seata</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-spring-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/25/spring-note/" class="article-date">
  <time datetime="2021-09-25T12:09:40.000Z" itemprop="datePublished">2021-09-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/25/spring-note/">spring 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="在filter中无法使用Autowired的问题"><a href="#在filter中无法使用Autowired的问题" class="headerlink" title="在filter中无法使用Autowired的问题"></a>在filter中无法使用Autowired的问题</h3><p>解决方案：<br><a href="https://stackoverflow.com/questions/32494398/unable-to-autowire-the-service-inside-my-authentication-filter-in-spring/32495757" target="_blank" rel="noopener">https://stackoverflow.com/questions/32494398/unable-to-autowire-the-service-inside-my-authentication-filter-in-spring/32495757</a></p>
<p>代码片段如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.hewentian.service.ISiteConfigService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.support.WebApplicationContextUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.GenericFilterBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerifySignFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String secretSalt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ISiteConfigService siteConfigService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initFilterBean</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.initFilterBean();</span><br><span class="line"></span><br><span class="line">        FilterConfig filterConfig = getFilterConfig();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != filterConfig) &#123;</span><br><span class="line">            secretSalt = filterConfig.getInitParameter(<span class="string">"secretSalt"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == siteConfigService) &#123;</span><br><span class="line">            WebApplicationContext webApplicationContext = WebApplicationContextUtils.getWebApplicationContext(getServletContext());</span><br><span class="line">            siteConfigService = webApplicationContext.getBean(ISiteConfigService.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中，web.xml的配置片段如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>verifySignFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.hewentian.study.filter.VerifySignFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>secretSalt<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>MH39MmRxziHOC43t<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>verifySignFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="在filter中处理异常"><a href="#在filter中处理异常" class="headerlink" title="在filter中处理异常"></a>在filter中处理异常</h3><p>解决方案：<br><a href="https://stackoverflow.com/questions/34595605/how-to-manage-exceptions-thrown-in-filters-in-spring" target="_blank" rel="noopener">https://stackoverflow.com/questions/34595605/how-to-manage-exceptions-thrown-in-filters-in-spring</a></p>
<p>当在filter中抛出异常时，得向前端返回错误信息</p>
<p>代码片段如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// code that throws exception</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// set the response object</span></span><br><span class="line">            HttpServletResponse response = (HttpServletResponse) servletResponse;</span><br><span class="line">            response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">            Result result = <span class="keyword">new</span> Result(); <span class="comment">// self-defined result object</span></span><br><span class="line">            result.setCode(<span class="number">40001</span>);</span><br><span class="line">            result.setMsg(e.getMessage());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pass down the actual obj that exception handler normally send</span></span><br><span class="line">            ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            PrintWriter out = response.getWriter();</span><br><span class="line">            out.print(mapper.writeValueAsString(result));</span><br><span class="line">            out.flush();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// proceed normally otherwise</span></span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="如何多次读输入流InputStream"><a href="#如何多次读输入流InputStream" class="headerlink" title="如何多次读输入流InputStream"></a>如何多次读输入流InputStream</h3><p>解决方案：<br><a href="https://coderanch.com/t/364591/java/read-request-body-filter" target="_blank" rel="noopener">https://coderanch.com/t/364591/java/read-request-body-filter</a></p>
<p>代码片段如下：<br>对 ServletRequest 进行一层包装的类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerifySignRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] payload;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VerifySignRequestWrapper</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// read the original payload into the payload variable</span></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// read the payload into the ByteArrayOutputStream</span></span><br><span class="line">            InputStream inputStream = request.getInputStream();</span><br><span class="line">            IOUtils.copy(inputStream, byteArrayOutputStream);</span><br><span class="line"></span><br><span class="line">            payload = byteArrayOutputStream.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            log.error(<span class="string">"Error reading the request payload"</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Error reading the request payload"</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (byteArrayOutputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    byteArrayOutputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException iox) &#123;</span><br><span class="line">                    <span class="comment">// ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(payload);</span><br><span class="line"></span><br><span class="line">        ServletInputStream inputStream = <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> byteArrayInputStream.read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> inputStream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>过虑器Filter<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// perform request filtering</span></span><br><span class="line">        HttpServletRequest httpServletRequest = (HttpServletRequest) servletRequest;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先对 ServletRequest 进行一层包装</span></span><br><span class="line">        VerifySignRequestWrapper verifySignRequestWrapper;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            verifySignRequestWrapper = <span class="keyword">new</span> VerifySignRequestWrapper(httpServletRequest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">"Unable to wrap the request"</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Unable to wrap the request"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将流读出来，用于验签等操作</span></span><br><span class="line">        String requestBody = IOUtils.toString(verifySignRequestWrapper.getInputStream(), StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 省略相关操作...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这样，后面的filter，还可以从 request 中读到流</span></span><br><span class="line">        filterChain.doFilter(verifySignRequestWrapper, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2021/09/25/spring-note/" data-id="clf9thvns003p6h3ks5mkua1u" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/">spring</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mybatis-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/01/mybatis-note/" class="article-date">
  <time datetime="2021-04-01T12:29:02.000Z" itemprop="datePublished">2021-04-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/db/">db</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/01/mybatis-note/">mybatis 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="mybatis的xml中的比较符号处理方法"><a href="#mybatis的xml中的比较符号处理方法" class="headerlink" title="mybatis的xml中的比较符号处理方法"></a>mybatis的xml中的比较符号处理方法</h3><p>第一种方法：<br>用转义字符把<code>&gt;</code>和<code>&lt;</code>替换掉，mapper文件示例代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createDateStart != null "</span>&gt;</span></span><br><span class="line">    AND create_date &amp;gt;= #&#123;createDateStart,jdbcType=DATE&#125; </span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createDateEnd != null "</span>&gt;</span></span><br><span class="line">    AND create_date &amp;lt;= #&#123;createDateEnd,jdbcType=DATE&#125; </span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>XML转义字符表</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>符号</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&amp;lt;</code></td>
<td>&lt;</td>
<td>小于号</td>
</tr>
<tr>
<td><code>&amp;gt;</code></td>
<td>&gt;</td>
<td>大于号</td>
</tr>
<tr>
<td><code>&amp;amp;</code></td>
<td>&amp;</td>
<td>和</td>
</tr>
<tr>
<td><code>&amp;apos;</code></td>
<td>’</td>
<td>单引号</td>
</tr>
<tr>
<td><code>&amp;quot;</code></td>
<td>“</td>
<td>双引号</td>
</tr>
</tbody>
</table>
<p>第二种方法：<br>xml格式中，不允许出现类似<code>&gt;</code>这样的字符，但是可以使用<code>&lt;![CDATA[ ]]&gt;</code>符号进行说明，将此类符号不进行解析，mapper文件示例代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createDateStart != null "</span>&gt;</span></span><br><span class="line">    AND create_date &lt;![CDATA[ &gt;= ]]&gt; #&#123;createDateStart,jdbcType=DATE&#125; </span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createDateEnd != null "</span>&gt;</span></span><br><span class="line">    AND create_date &lt;![CDATA[ &lt;= ]]&gt; #&#123;createDateEnd,jdbcType=DATE&#125; </span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2021/04/01/mybatis-note/" data-id="clf9thvm6001t6h3kcg2z3di5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-canal-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/22/canal-note/" class="article-date">
  <time datetime="2021-01-22T02:16:21.000Z" itemprop="datePublished">2021-01-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/22/canal-note/">canal 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本篇将说说阿里巴巴开源的mysql数据库同步工具<a href="https://github.com/alibaba/canal">canal</a>的使用，详细说明可以参考<a href="https://github.com/alibaba/canal/wiki">wiki</a>。主要用途是基于mysql数据库增量日志解析，提供增量数据订阅和消费。</p>
<p>基于日志增量订阅和消费的业务包括</p>
<ul>
<li>数据库镜像</li>
<li>数据库实时备份</li>
<li>索引构建和实时维护（拆分异构索引、倒排索引等）</li>
<li>业务 cache 刷新</li>
<li>带业务逻辑的增量数据处理</li>
</ul>
<p>当前的 canal 支持源端 mysql 版本包括 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.x</p>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>mysql主备复制原理</p>
<p><img src="/img/mysql-1.png" alt="" title="mysql主备复制原理"></p>
<ul>
<li>mysql master 将数据变更写入二进制日志（binary log，其中记录叫做二进制日志事件binary log events，可以通过 show binlog events 进行查看）</li>
<li>mysql slave 将 master 的 binary log events 复制到它的中继日志(relay log)</li>
<li>mysql slave 重放 relay log 中事件，将数据变更反映它自己的数据</li>
</ul>
<p>canal工作原理</p>
<p><img src="/img/canal-1.png" alt="" title="canal工作原理"></p>
<ul>
<li>canal 模拟 mysql slave 的交互协议，伪装自己为 mysql slave，向 mysql master 发送 dump 请求</li>
<li>mysql master 收到 dump 请求，开始推送 binary log 给 slave （即 canal）</li>
<li>canal 解析 binary log 对象（原始为 byte 流）</li>
</ul>
<h3 id="配置mysql服务器"><a href="#配置mysql服务器" class="headerlink" title="配置mysql服务器"></a>配置mysql服务器</h3><p>在文件<code>/etc/mysql/conf.d/mysql.cnf</code>中增加如下配置信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log_bin=mysql-bin    # 开启 binlog，其中 mysql-bin 是日志名称前缀</span><br><span class="line">binlog_format=ROW    # 选择 ROW 模式</span><br><span class="line">server_id=1          # 默认值是0，如果使用默认值则不能和从节点通信，这个值的区间是：1到(2^32)-1。注意不要和 canal 的 slaveId 重复</span><br></pre></td></tr></table></figure></p>
<p>配置后，重启mysql服务器，验证是否配置成功：</p>
<pre><code>SHOW VARIABLES LIKE &apos;server_id&apos;;
SHOW VARIABLES LIKE &apos;log_%&apos;;
SHOW VARIABLES LIKE &apos;binlog_format&apos;;
</code></pre><p>创建 canal 链接 mysql 的账号，并分配作为 mysql slave 的权限，如果已有账户则可直接 grant</p>
<pre><code>CREATE USER canal IDENTIFIED BY &apos;canal&apos;;
GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &apos;canal&apos;@&apos;%&apos;;
-- GRANT ALL PRIVILEGES ON *.* TO &apos;canal&apos;@&apos;%&apos;;
FLUSH PRIVILEGES;
</code></pre><h3 id="安装canal"><a href="#安装canal" class="headerlink" title="安装canal"></a>安装canal</h3><p>下载，可以在<a href="https://github.com/alibaba/canal/releases">releases</a>页面进行下载<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/alibaba/canal/releases/download/canal-1.1.4/canal.deployer-1.1.4.tar.gz</span><br><span class="line"></span><br><span class="line">$ mkdir ~/canal</span><br><span class="line">$ tar xf canal.deployer-1.1.4.tar.gz -C ~/canal</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ~/canal</span><br><span class="line">$ ls</span><br><span class="line">bin  conf  lib  logs</span><br></pre></td></tr></table></figure></p>
<p>配置canal server<br>配置端口、用户名和访问密码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vi ~/canal/conf/canal.properties</span><br><span class="line"></span><br><span class="line">canal.port = 11111</span><br><span class="line">canal.user = canal</span><br><span class="line">canal.passwd = E3619321C1A937C46A0D8BD1DAC39F93B27D4458    <span class="comment"># 这个是加密后的密码，未加密前是canal</span></span><br><span class="line">canal.destinations = example                               <span class="comment"># 当前默认开启了一个名为example的instance，多个之间用逗号(,)分隔</span></span><br></pre></td></tr></table></figure></p>
<p>配置canal instance<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vi ~/canal/conf/example/instance.properties</span><br><span class="line"></span><br><span class="line">canal.instance.mysql.slaveId=1234    <span class="comment"># mysql serverId , v1.0.26+ will autoGen</span></span><br><span class="line">canal.instance.master.address=127.0.0.1:3306</span><br><span class="line">canal.instance.dbUsername=canal</span><br><span class="line">canal.instance.dbPassword=canal</span><br><span class="line">canal.instance.connectionCharset = UTF-8</span><br><span class="line">canal.instance.filter.regex=.*\\..*</span><br></pre></td></tr></table></figure></p>
<p>启动canal<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/canal</span><br><span class="line">$ sh bin/startup.sh</span><br></pre></td></tr></table></figure></p>
<p>查看 server 日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ more logs/canal/canal.log</span><br><span class="line"></span><br><span class="line">2021-01-22 20:12:11.735 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class="comment">## set default uncaught exception handler</span></span><br><span class="line">2021-01-22 20:12:11.797 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class="comment">## load canal configurations</span></span><br><span class="line">2021-01-22 20:12:11.813 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class="comment">## start the canal server.</span></span><br><span class="line">2021-01-22 20:12:11.869 [main] INFO  com.alibaba.otter.canal.deployer.CanalController - <span class="comment">## start the canal server[172.18.0.1(172.18.0.1):11111]</span></span><br><span class="line">2021-01-22 20:12:13.779 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class="comment">## the canal server is running now ......</span></span><br></pre></td></tr></table></figure></p>
<p>查看 instance 的日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ more logs/example/example.log</span><br><span class="line"></span><br><span class="line">2021-01-22 20:12:12.428 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]</span><br><span class="line">2021-01-22 20:12:12.436 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [example/instance.properties]</span><br><span class="line">2021-01-22 20:12:12.722 [main] WARN  o.s.beans.GenericTypeAwarePropertyDescriptor - Invalid JavaBean property <span class="string">'connectionCharset'</span> being accessed! Ambiguous write methods found next to actually used [public void com.alibaba.otter.canal.parse.inbound.mysql.AbstractMysqlEventParser.setConnectionCharset(java.nio.charset.Charset)]: [public void com.alibaba.otter.canal.parse.inbound.mysql.AbstractMysqlEventParser.setConnectionCharset(java.lang.String)]</span><br><span class="line">2021-01-22 20:12:12.803 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]</span><br><span class="line">2021-01-22 20:12:12.803 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [example/instance.properties]</span><br><span class="line">2021-01-22 20:12:13.524 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance <span class="keyword">for</span> 1-example</span><br><span class="line">2021-01-22 20:12:13.536 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --&gt; init table filter : ^.*\..*$</span><br><span class="line">2021-01-22 20:12:13.536 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --&gt; init table black filter :</span><br><span class="line">2021-01-22 20:12:13.570 [main] INFO  c.a.otter.canal.instance.core.AbstractCanalInstance - start successful....</span><br><span class="line">2021-01-22 20:12:13.801 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - ---&gt; begin to find start position, it will be long time <span class="keyword">for</span> reset or first position</span><br><span class="line">2021-01-22 20:12:13.801 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - prepare to find start position just show master status</span><br><span class="line">2021-01-22 20:12:15.240 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - ---&gt; find start position successfully, EntryPosition[included=<span class="literal">false</span>,journalName=mysql-bin.000003,position=4,serverId=1,gtid=&lt;null&gt;,timestamp=1591628633000] cost : 1408ms , the next step is binlog dump</span><br></pre></td></tr></table></figure></p>
<p>关闭<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/canal</span><br><span class="line">$ sh bin/stop.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="JAVA使用示例"><a href="#JAVA使用示例" class="headerlink" title="JAVA使用示例"></a>JAVA使用示例</h3><p>在JAVA项目中的pom.xml加入依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.otter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal.client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>JAVA代码如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hewentian.canal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.Column;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.Entry;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.EntryType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.EventType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.RowChange;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.RowData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleCanalClientExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建链接</span></span><br><span class="line">        CanalConnector connector = CanalConnectors.newSingleConnector(</span><br><span class="line">                <span class="keyword">new</span> InetSocketAddress(<span class="string">"192.168.56.113"</span>, <span class="number">11111</span>),</span><br><span class="line">                <span class="string">"example"</span>, <span class="string">"canal"</span>, <span class="string">"canal"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> batchSize = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">int</span> emptyCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connector.connect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//订阅 监控的 数据库.表</span></span><br><span class="line"><span class="comment">//            connector.subscribe("test.t_user");</span></span><br><span class="line">            connector.subscribe(<span class="string">".*\\..*"</span>);</span><br><span class="line">            connector.rollback();</span><br><span class="line">            <span class="keyword">int</span> totalEmptyCount = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (emptyCount &lt; totalEmptyCount) &#123;</span><br><span class="line">                Message message = connector.getWithoutAck(batchSize); <span class="comment">// 获取指定数量的数据</span></span><br><span class="line">                <span class="keyword">long</span> batchId = message.getId();</span><br><span class="line">                <span class="keyword">int</span> size = message.getEntries().size();</span><br><span class="line">                System.out.println(<span class="string">"batchId: "</span> + batchId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (batchId == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">                    emptyCount++;</span><br><span class="line">                    System.out.println(<span class="string">"empty count: "</span> + emptyCount);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    emptyCount = <span class="number">0</span>;</span><br><span class="line">                    <span class="comment">// System.out.printf("message[batchId=%s,size=%s] \n", batchId, size);</span></span><br><span class="line">                    printEntry(message.getEntries());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                connector.ack(batchId); <span class="comment">// 提交确认</span></span><br><span class="line">                <span class="comment">// connector.rollback(batchId); // 处理失败, 回滚数据</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"empty too many times, exit"</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printEntry</span><span class="params">(List&lt;Entry&gt; entrys)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry entry : entrys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            RowChange rowChage;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rowChage = RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ERROR ## parser of eromanga-event has an error, data:"</span> + entry.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            EventType eventType = rowChage.getEventType();</span><br><span class="line">            <span class="keyword">long</span> delayTime = <span class="keyword">new</span> Date().getTime() - entry.getHeader().getExecuteTime();</span><br><span class="line">            System.out.println(String.format(<span class="string">"================ binlog[%s:%s], name[%s,%s], eventType: %s, delayTime: %s"</span>,</span><br><span class="line">                    entry.getHeader().getLogfileName(), entry.getHeader().getLogfileOffset(),</span><br><span class="line">                    entry.getHeader().getSchemaName(), entry.getHeader().getTableName(),</span><br><span class="line">                    eventType, delayTime));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DDL数据，打印SQL</span></span><br><span class="line">            <span class="keyword">if</span> (eventType == EventType.QUERY || rowChage.getIsDdl()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"sql -----&gt; "</span> + rowChage.getSql());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DML数据，打印字段信息</span></span><br><span class="line">            <span class="keyword">for</span> (RowData rowData : rowChage.getRowDatasList()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (eventType == EventType.DELETE) &#123;</span><br><span class="line">                    printColumn(rowData.getBeforeColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventType == EventType.INSERT) &#123;</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"---------- before"</span>);</span><br><span class="line">                    printColumn(rowData.getBeforeColumnsList());</span><br><span class="line">                    System.out.println(<span class="string">"---------- after"</span>);</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printColumn</span><span class="params">(List&lt;Column&gt; columns)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Column column : columns) &#123;</span><br><span class="line">            System.out.println(column.getName() + <span class="string">" : "</span> + column.getValue() + <span class="string">", update = "</span> + column.getUpdated());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行上面的JAVA代码后，可以从控制台看到类似消息：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br></pre></td></tr></table></figure></p>
<p>此时代表当前数据库无变更数据</p>
<p>触发数据库变更<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'ID'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户名'</span>,</span><br><span class="line"> PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC <span class="keyword">COMMENT</span>=<span class="string">'用户表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">VALUE</span>(<span class="number">1</span>,<span class="string">'Scott'</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> t_user <span class="keyword">SET</span> <span class="keyword">name</span> = <span class="string">'Tiger'</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>可以从控制台中看到：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br><span class="line">empty count: <span class="number">5</span></span><br><span class="line">empty count: <span class="number">6</span></span><br><span class="line">================ binlog[mysql-bin.000003:<span class="number">2626</span>], name[test,t_user], eventType: INSERT</span><br><span class="line">id : <span class="number">1</span>, update = <span class="keyword">true</span></span><br><span class="line">name : Scott, update = <span class="keyword">true</span></span><br><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br><span class="line">empty count: <span class="number">5</span></span><br><span class="line">empty count: <span class="number">6</span></span><br><span class="line">empty count: <span class="number">7</span></span><br><span class="line">empty count: <span class="number">8</span></span><br><span class="line">================ binlog[mysql-bin.000003:<span class="number">2892</span>], name[test,t_user], eventType: UPDATE</span><br><span class="line">---------- before</span><br><span class="line">id : <span class="number">1</span>, update = <span class="keyword">false</span></span><br><span class="line">name : Scott, update = <span class="keyword">false</span></span><br><span class="line">---------- after</span><br><span class="line">id : <span class="number">1</span>, update = <span class="keyword">false</span></span><br><span class="line">name : Tiger, update = <span class="keyword">true</span></span><br><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br><span class="line">empty count: <span class="number">5</span></span><br><span class="line">empty count: <span class="number">6</span></span><br><span class="line">================ binlog[mysql-bin.000003:<span class="number">3170</span>], name[test,t_user], eventType: DELETE</span><br><span class="line">id : <span class="number">1</span>, update = <span class="keyword">false</span></span><br><span class="line">name : Tiger, update = <span class="keyword">false</span></span><br><span class="line">empty count: <span class="number">1</span></span><br><span class="line">empty count: <span class="number">2</span></span><br><span class="line">empty count: <span class="number">3</span></span><br><span class="line">empty count: <span class="number">4</span></span><br><span class="line">empty count: <span class="number">5</span></span><br><span class="line">empty count: <span class="number">6</span></span><br><span class="line">empty count: <span class="number">7</span></span><br><span class="line">empty count: <span class="number">8</span></span><br></pre></td></tr></table></figure></p>
<p>完整代码在<a href="https://github.com/hewentian/study-lib/tree/main/codes/canal">这里</a>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2021/01/22/canal-note/" data-id="clf9thvk900026h3kt2hcapvk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-springboot-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/08/springboot-note/" class="article-date">
  <time datetime="2020-06-08T07:21:35.000Z" itemprop="datePublished">2020-06-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/08/springboot-note/">springboot 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="springboot前后端分离，跨域问题解决"><a href="#springboot前后端分离，跨域问题解决" class="headerlink" title="springboot前后端分离，跨域问题解决"></a>springboot前后端分离，跨域问题解决</h3><p>在java后端启动类中加上跨域处理即可，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CorsFilter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsFilter <span class="title">corsFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 设置跨域</span></span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        CorsConfiguration corsConfiguration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">        corsConfiguration.addAllowedOrigin(<span class="string">"*"</span>);</span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">"*"</span>);</span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">"*"</span>);</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">"/**"</span>, corsConfiguration);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CorsFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是，如果前端发请求时，使用了<code>withCredentials</code>，如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    type : <span class="string">"POST"</span>,</span><br><span class="line">    contentType: <span class="string">"application/json;charset=UTF-8"</span>,</span><br><span class="line">    url : <span class="string">"http://www.a.com/admin/user/save"</span>,</span><br><span class="line">    <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">    xhrFields: &#123;<span class="attr">withCredentials</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    data : <span class="built_in">JSON</span>.stringify(list),</span><br><span class="line">    success : <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(result);</span><br><span class="line">    &#125;,</span><br><span class="line">    error : <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e.status);</span><br><span class="line">        <span class="built_in">console</span>.log(e.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>并且前端域名为<code>http://www.b.com</code>，则后端需做如下修改（共修改了2行代码）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CorsFilter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsFilter <span class="title">corsFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 设置跨域</span></span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        CorsConfiguration corsConfiguration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">        corsConfiguration.addAllowedOrigin(<span class="string">"http://www.b.com"</span>);           <span class="comment">// 这里要指定域名</span></span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">"*"</span>);</span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">"*"</span>);</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">"/**"</span>, corsConfiguration);</span><br><span class="line">        corsConfiguration.setAllowCredentials(<span class="keyword">true</span>);                      <span class="comment">// 增加这行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CorsFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于附带身份凭证的请求，服务器不得设置<code>Access-Control-Allow-Origin</code>的值为<code>*</code>。这是因为请求的首部中携带<br>了<code>Cookie</code>信息，如果<code>Access-Control-Allow-Origin</code>的值为<code>*</code>，请求将会失败。而将<code>Access-Control-Allow-Origin</code><br>的值设置为<code>http://www.b.com</code>，则请求将成功执行。也就是说<code>Access-Control-Allow-Credentials</code>设置为true的<br>情况下<code>Access-Control-Allow-Origin</code>不能设置为<code>*</code></p>
<h3 id="springboot启动时，指定加载的信息"><a href="#springboot启动时，指定加载的信息" class="headerlink" title="springboot启动时，指定加载的信息"></a>springboot启动时，指定加载的信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nohup java -Dloader.path=/home/root/userinfo/libs \</span><br><span class="line">    -Dlogging.path=/home/root/logs/userinfo \</span><br><span class="line">    -Dspring.config.location=/home/root/userinfo/config/application.yml \</span><br><span class="line">    -jar /home/root/userinfo/userinfo-0.0.1-SNAPSHOT.jar \</span><br><span class="line">    &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ol>
<li><code>loader.path</code>用于指定加载一些外部的JAR包，指定到目录；</li>
<li><code>logging.path</code>指定日志文件存放的目录；</li>
<li><code>spring.config.location</code>指定要加载的配置文件。</li>
</ol>
<h3 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h3><p>如果要编写除控制台输出之外的日志文件，则需在 application.properties 中设置 logging.file 或 logging.path 属性。<br>logging.file： 设置文件，可以是绝对路径，也可以是相对路径。如： logging.file=my.log<br>logging.path： 设置目录，会在该目录下创建 spring.log 文件，并写入日志内容，如： logging.path=/var/log</p>
<p>如果只配置 logging.file ，会在项目的当前路径下生成一个 xxx.log 日志文件。<br>如果只配置 logging.path ，在 /var/log 文件夹生成一个日志文件为 spring.log</p>
<p>注：二者不能同时使用，如若同时使用，则只有 logging.file 生效</p>
<p>默认情况下，日志文件的大小达到 10MB 时会切分一次，产生新的日志文件，默认级别为： ERROR、WARN、INFO</p>
<h3 id="通过命令行设置属性值"><a href="#通过命令行设置属性值" class="headerlink" title="通过命令行设置属性值"></a>通过命令行设置属性值</h3><p>相信使用过一段时间Spring Boot的用户，一定知道这两条命令：</p>
<pre><code>java -jar xxx.jar --server.port=8888 --spring.profiles.active=dev
java -Dserver.port=8888 -Dspring.profiles.active=dev -jar xxx.jar
</code></pre><p>通过使用<code>--server.port</code>属性来设置<code>xxx.jar</code>应用的端口为8888。</p>
<p>在命令行运行时，连续的两个减号<code>--</code>就是对application.properties中的属性值进行覆盖的标识。</p>
<p>通过命令行来修改属性值固然提供了不错的便利性，但是通过命令行就能更改应用运行的参数，那岂不是很不安全？是的，所以Spring Boot也提供了屏蔽命令行访问属性的设置，只需要这句设置就能屏蔽：</p>
<pre><code>SpringApplication.setAddCommandLineProperties(false);
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2020/06/08/springboot-note/" data-id="clf9thvnp003m6h3kls6nthhx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/springboot/">springboot</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-spark-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/14/spark-note/" class="article-date">
  <time datetime="2020-01-14T11:57:24.000Z" itemprop="datePublished">2020-01-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/14/spark-note/">spark 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="standalone模式"><a href="#standalone模式" class="headerlink" title="standalone模式"></a>standalone模式</h3><p>为便于学习spark，这里安装standalone模式，在下面三台机器搭建一个简单的集群。我们将slave3作为spark的master节点，而slave1、slave2作为从节点。</p>
<pre><code>slave1:
    ip: 192.168.56.111
    hostname: hadoop-host-slave-1
slave2:
    ip: 192.168.56.112
    hostname: hadoop-host-slave-2
slave3:
    ip: 192.168.56.113
    hostname: hadoop-host-slave-3
</code></pre><p>安装过程参考官方文档：<br><a href="http://spark.apache.org/docs/latest/spark-standalone.html" target="_blank" rel="noopener">http://spark.apache.org/docs/latest/spark-standalone.html</a></p>
<p>目前spark的稳定版本为2.4.4，可以在下面的地址找到然后下载。<br><a href="http://spark.apache.org/downloads.html" target="_blank" rel="noopener">http://spark.apache.org/downloads.html</a><br><a href="https://www.apache.org/dyn/closer.lua/spark/spark-2.4.4/spark-2.4.4-bin-hadoop2.7.tgz" target="_blank" rel="noopener">https://www.apache.org/dyn/closer.lua/spark/spark-2.4.4/spark-2.4.4-bin-hadoop2.7.tgz</a></p>
<p>在slave3中启动spark作为master<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tar xf spark-2.4.4-bin-hadoop2.7.tgz</span><br><span class="line">$ <span class="built_in">cd</span> spark-2.4.4-bin-hadoop2.7/</span><br><span class="line">$ ./sbin/start-master.sh</span><br></pre></td></tr></table></figure></p>
<p>启动后，在启动日志中可以看到部分输出，如下：</p>
<pre><code>20/01/14 16:54:24 INFO Master: Starting Spark master at spark://hadoop-host-slave-3:7077
20/01/14 16:54:24 INFO Master: Running Spark version 2.4.4
20/01/14 16:54:25 INFO Utils: Successfully started service &apos;MasterUI&apos; on port 8080.
20/01/14 16:54:25 INFO MasterWebUI: Bound MasterWebUI to 0.0.0.0, and started at http://hadoop-host-slave-3:8080
20/01/14 16:54:25 INFO Master: I have been elected leader! New state: ALIVE
</code></pre><p>接着分别在slave1、slave2中启动spark作为从节点<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tar xf spark-2.4.4-bin-hadoop2.7.tgz</span><br><span class="line">$ <span class="built_in">cd</span> spark-2.4.4-bin-hadoop2.7/</span><br><span class="line">$ ./sbin/start-slave.sh spark://hadoop-host-slave-3:7077</span><br></pre></td></tr></table></figure></p>
<p>在浏览器中可以通过访问如下地址，看到整个集群的情况<br><a href="http://hadoop-host-slave-3:8080/" target="_blank" rel="noopener">http://hadoop-host-slave-3:8080/</a></p>
<p>可以通过交互式命令连接到集群</p>
<pre><code>./bin/spark-shell --master spark://IP:PORT
</code></pre><p>也可以将程序打包成jar包，然后在主节点上面提交给集群，如下</p>
<pre><code>./bin/spark-submit --class com.hewentian.spark.SparkPi --master spark://hadoop-host-slave-3:7077 /home/hadoop/spark-1.0-SNAPSHOT.jar
</code></pre><p>我们可以通过配置，在一台机器一键启动所有节点的spark进程。分别在三个节点执行如下操作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> spark-2.4.4-bin-hadoop2.7/conf</span><br><span class="line">$ cp slaves.template slaves</span><br><span class="line">$ vi slaves</span><br><span class="line"></span><br><span class="line">去掉文件中原来的localhost配置，并加入下面两行</span><br><span class="line">hadoop-host-slave-1</span><br><span class="line">hadoop-host-slave-2</span><br></pre></td></tr></table></figure></p>
<p>这样在slave3节点上就可以通过如下命令，一次将master、slave进程启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> spark-2.4.4-bin-hadoop2.7/</span><br><span class="line">$ ./sbin/start-all.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="读取mysql数据"><a href="#读取mysql数据" class="headerlink" title="读取mysql数据"></a>读取mysql数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/spark-2.4.4-bin-hadoop2.7/</span><br><span class="line">$ ./bin/spark-shell --jars /home/hadoop/spark-2.4.4-bin-hadoop2.7/jars/mysql-connector-java-5.1.25.jar</span><br><span class="line"></span><br><span class="line">scala&gt; val sqlContext = spark.sqlContext</span><br><span class="line">scala&gt; val df = sqlContext.read.format(<span class="string">"jdbc"</span>).option(<span class="string">"url"</span>, <span class="string">"jdbc:mysql://mysql.hewentian.com:3306/bfg_db?useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull"</span>).option(<span class="string">"driver"</span>, <span class="string">"com.mysql.jdbc.Driver"</span>).option(<span class="string">"user"</span>, <span class="string">"bfg_db"</span>).option(<span class="string">"password"</span>, <span class="string">"iE1zNB?A91*YbQ9hK"</span>).option(<span class="string">"dbtable"</span>, <span class="string">"student"</span>).load()</span><br></pre></td></tr></table></figure>
<h3 id="yarn模式"><a href="#yarn模式" class="headerlink" title="yarn模式"></a>yarn模式</h3><p>Spark支持将作业提交到yarn上运行，此时不需要启动master节点，也不需要启动worker节点。</p>
<p>同样需在slaves文件下配置worker节点的机器，像standalone模式那样。</p>
<p>只需在spark中指定hadoop的配置文件目录即可，在所有spark节点中执行如下操作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> spark-2.4.4-bin-hadoop2.7/conf</span><br><span class="line">$ cp spark-env.sh.template spark-env.sh</span><br><span class="line">$ vi spark-env.sh</span><br><span class="line"></span><br><span class="line">配置这行即可</span><br><span class="line">HADOOP_CONF_DIR=/home/hadoop/hadoop-2.7.3/etc/hadoop</span><br></pre></td></tr></table></figure></p>
<p>要保证hdfs和yarn已经启动。</p>
<p>以交互方式连接到yarn模式的spark<br>        ./bin/spark-shell –master yarn –deploy-mode client</p>
<p>也可以将程序打包成jar包，然后在主节点上面提交给集群，如下<br>        ./bin/spark-submit –class path.to.your.Class –master yarn –deploy-mode cluster [options] <app jar=""> [app options]</app></p>
<p>例如：<br>        ./bin/spark-submit \<br>        –class org.apache.spark.examples.SparkPi \<br>        –master yarn \<br>        –deploy-mode cluster \<br>        –driver-memory 4g \<br>        –executor-memory 2g \<br>        –executor-cores 1 \<br>        –queue thequeue \<br>        examples/jars/spark-examples*.jar \<br>        10</p>
<p>如果还想将此yarn模式配置成基于zookeeper的高可用，如将主机<code>hadoop-host-slave-2</code>配置成备用的master。则需如下配置：<br>分别在所有spark节点中执行如下操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> spark-2.4.4-bin-hadoop2.7/conf</span><br><span class="line">$ vi spark-env.sh</span><br><span class="line"></span><br><span class="line">配置zookeeper地址</span><br><span class="line">SPARK_DAEMON_JAVA_OPTS=<span class="string">"-Dspark.deploy.recoveryMode=ZOOKEEPER -Dspark.deploy.zookeeper.url=hadoop-host-master:2181,hadoop-host-slave-1:2181,hadoop-host-slave-2:2181 -Dspark.deploy.zookeeper.dir=/spark"</span></span><br></pre></td></tr></table></figure></p>
<p>启动顺序：</p>
<ol>
<li>启动的zookeeper集群；</li>
<li>启动的hdfs和yarn；</li>
<li>在主节点<code>hadoop-host-slave-3</code>执行如下脚本，启动所有服务<code>./sbin/start-all.sh</code>；</li>
<li>在节点<code>hadoop-host-slave-2</code>执行如下脚本，启动它作为备份主节点<code>./sbin/start-master.sh</code>。</li>
</ol>
<p>通过浏览器，观看集群状态：<br><a href="http://hadoop-host-slave-2:8080/" target="_blank" rel="noopener">http://hadoop-host-slave-2:8080/</a><br><a href="http://hadoop-host-slave-3:8080/" target="_blank" rel="noopener">http://hadoop-host-slave-3:8080/</a></p>
<p>未完待续……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2020/01/14/spark-note/" data-id="clf9thvnn003j6h3kzhxggax4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spark/">spark</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-scala-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/30/scala-note/" class="article-date">
  <time datetime="2019-12-30T02:33:00.000Z" itemprop="datePublished">2019-12-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/30/scala-note/">scala 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="在Linux下面安装SDK"><a href="#在Linux下面安装SDK" class="headerlink" title="在Linux下面安装SDK"></a>在Linux下面安装SDK</h3><p>Scala依赖于JAVA，所以，在安装Scala之前必须先安装JDK，安装过程可以参考：<a href="../../../../2017/12/08/jdk-install/">安装 JDK</a>。</p>
<p>第一步：下载Scala，在<code>https://www.scala-lang.org/download/</code>可以找到下载链接，目前最新版本是<code>scala-2.11.12</code>，下载地址：<br><a href="https://downloads.lightbend.com/scala/2.11.12/scala-2.11.12.tgz" target="_blank" rel="noopener">https://downloads.lightbend.com/scala/2.11.12/scala-2.11.12.tgz</a></p>
<p>第二步：解压安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/Downloads</span><br><span class="line">$ tar xf scala-2.11.12.tgz</span><br></pre></td></tr></table></figure></p>
<p>解压后会得到<code>scala-2.11.12</code>文件夹，接着就是将解压出来的文件夹移动到<code>/usr/local</code>的目录下。在这之前当然需要你拥有root的权限<code>su root</code>(对于ubuntu)再输入root账户的密码，做好这些准备之后，我们就可以把sdk的文件移动到我们想要的位置了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ su root</span><br><span class="line">Password: </span><br><span class="line">$ mv scala-2.11.12 /usr/<span class="built_in">local</span>/</span><br></pre></td></tr></table></figure></p>
<p>第三步：修改环境变量，若<code>PATH</code>已存在，则用冒号作间隔，将sdk的bin目录地址加上，配置如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile </span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> SCALA_HOME=/usr/<span class="built_in">local</span>/scala-2.11.12</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$SCALA_HOME</span>/bin</span><br></pre></td></tr></table></figure></p>
<p>记得保存，最后执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure></p>
<p>第四步：验证安装是否成功，执行如下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ scalac -version</span><br><span class="line">Scala compiler version 2.11.12 -- Copyright 2002-2017, LAMP/EPFL</span><br><span class="line">$</span><br><span class="line">$ scala -version</span><br><span class="line">Scala code runner version 2.11.12 -- Copyright 2002-2017, LAMP/EPFL</span><br></pre></td></tr></table></figure></p>
<p>看到上面的输出，证明安装成功。</p>
<h3 id="在IDEA中安装Scala开发插件"><a href="#在IDEA中安装Scala开发插件" class="headerlink" title="在IDEA中安装Scala开发插件"></a>在IDEA中安装Scala开发插件</h3><p>启动IDEA，在启动界面中依次选择：<code>Configure-&gt;Settings-&gt;Plugins</code>，在右则搜索框中输入Scala进行搜索，找到如下图所示插件。</p>
<p><img src="/img/scala-1.png" alt=""></p>
<p>点击<code>Install</code>进行安装。安装成功后，需重启IDEA。重启IDEA后，在启动界面中点击<code>Create New Project</code>，如果能看到有Scala选项，则证明安装成功。</p>
<p><img src="/img/scala-2.png" alt=""></p>
<p>接着在IDEA中配置SDK，点击上图的<code>Cancel</code>，回到刚才的启动界面。依次选择：<code>Configure-&gt;Project Defaults-&gt;Project Structure</code>，在弹出的界面中选择<code>Global Libraries</code>，然后在右则点击<code>+</code>号，并在弹出的下拉列表中选择<code>Scala SDK</code>，配置如下：</p>
<p><img src="/img/scala-3.png" alt=""></p>
<p>在上图中点击<code>Apply</code>，至此IDEA中Scala开发环境配置完成。</p>
<h3 id="在IDEA中已创建好的java项目中编写scala代码"><a href="#在IDEA中已创建好的java项目中编写scala代码" class="headerlink" title="在IDEA中已创建好的java项目中编写scala代码"></a>在IDEA中已创建好的java项目中编写scala代码</h3><ol>
<li>在src/main/下创建一个目录scala；</li>
<li>将src/main/scala设置成sources目录：File -&gt; Project Structure -&gt; Modules -&gt; 在右则选择我们的项目 -&gt; 然后在右则选择Sources这个tab -&gt; 选中我们刚才的目录src/main/scala -&gt; 点击上面的 Mark as: Sources -&gt; 最后点右下角的OK；</li>
<li>有可能还要将刚才添加的SDK(Global Libraries)包删除，重新再添加。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2019/12/30/scala-note/" data-id="clf9thvms002p6h3kvw7yg0dg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scala/">scala</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-docker-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/26/docker-note/" class="article-date">
  <time datetime="2019-07-26T02:32:30.000Z" itemprop="datePublished">2019-07-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/container/">container</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/26/docker-note/">docker 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天开始学习一下docker，因为它越来越流行了。首先，我们来安装一下。因为我的系统为<code>Ubuntu Linux</code>，所以我的安装过程，参照这里：<br><a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>
<p>安装过程如下，在系统上首次安装的时候需要执行<strong>安装前的准备工作</strong>：</p>
<h3 id="安装前的准备工作"><a href="#安装前的准备工作" class="headerlink" title="安装前的准备工作"></a>安装前的准备工作</h3><p>第一步：首先卸载系统自带的旧版docker（如系统有预安装docker）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get remove docker docker-engine docker.io containerd runc</span><br></pre></td></tr></table></figure></p>
<p>第二步：更新<code>apt</code>包索引：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br></pre></td></tr></table></figure></p>
<p>第三步：安装允许<code>apt</code>通过HTTPS访问仓库的软件包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg-agent \</span><br><span class="line">    software-properties-common</span><br></pre></td></tr></table></figure></p>
<p>第四步： 添加docker官方的GPG key：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure></p>
<p>验证添加KEY的指纹是否是<code>9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88</code>，我们只需搜索最后8个字符即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-key fingerprint 0EBFCD88</span><br><span class="line">pub   rsa4096 2017-02-22 [SCEA]</span><br><span class="line">      9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88</span><br><span class="line">uid           [ unknown] Docker Release (CE deb) &lt;docker@docker.com&gt;</span><br><span class="line">sub   rsa4096 2017-02-22 [S]</span><br></pre></td></tr></table></figure></p>
<p>第五步：将docker的下载路径添加到下载源中：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo add-apt-repository \</span><br><span class="line">   <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">   <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">   stable"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="开始正式安装"><a href="#开始正式安装" class="headerlink" title="开始正式安装"></a>开始正式安装</h3><p>第一步：更新<code>apt</code>包索引：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br></pre></td></tr></table></figure></p>
<p>第二步：开始安装docker最新的社区版：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure></p>
<p>安装结束后，docker的daemon进程默认自动启动，否则需要手动启动。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service docker start</span><br></pre></td></tr></table></figure></p>
<p>可选命令有：</p>
<pre><code>service docker {start|stop|restart|status}
</code></pre><p>第三步：验证安装是否正确无误，通过运行一个测试用例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run hello-world</span><br><span class="line"></span><br><span class="line">Unable to find image <span class="string">'hello-world:latest'</span> locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">1b930d010525: Pull complete </span><br><span class="line">Digest: sha256:6540fc08ee6e6b7b63468dc3317e3303aae178cb8a45ed3123180328bcc1d20f</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"> 1. The Docker client contacted the Docker daemon.</span><br><span class="line"> 2. The Docker daemon pulled the <span class="string">"hello-world"</span> image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"> 3. The Docker daemon created a new container from that image <span class="built_in">which</span> runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> 4. The Docker daemon streamed that output to the Docker client, <span class="built_in">which</span> sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"> $ docker run -it ubuntu bash</span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/get-started/</span><br></pre></td></tr></table></figure></p>
<p>至此，安装完成。</p>
<h3 id="卸载方法"><a href="#卸载方法" class="headerlink" title="卸载方法"></a>卸载方法</h3><p>要卸载软件本身和删除相关的docker文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get purge docker-ce</span><br><span class="line">$ sudo rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure></p>
<h3 id="docker的一些操作命令"><a href="#docker的一些操作命令" class="headerlink" title="docker的一些操作命令"></a>docker的一些操作命令</h3><p>一个简单的示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run ubuntu:18.04 /bin/<span class="built_in">echo</span> <span class="string">"Hello world"</span></span><br></pre></td></tr></table></figure></p>
<p>或者交互式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -i -t ubuntu:18.04 /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>以后台模式启动容器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -d ubuntu:18.04 /bin/sh -c <span class="string">"while true; do echo hello world; sleep 1; done"</span></span><br><span class="line"></span><br><span class="line">d7c1549c2a495499270eb31819ce5e9ea9748ab8126f025f33b06612491fd447</span><br></pre></td></tr></table></figure></p>
<p>输出的那一长长的字符串，是容器ID。</p>
<p>查看容器内的标准输出：</p>
<pre><code>sudo docker logs -f {CONTAINER ID}|{NAMES}
</code></pre><p>示例如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker logs d7c1549c2a495499270eb31819ce5e9ea9748ab8126f025f33b06612491fd447</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure></p>
<h3 id="查看正在运行中的容器"><a href="#查看正在运行中的容器" class="headerlink" title="查看正在运行中的容器"></a>查看正在运行中的容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">d7c1549c2a49        ubuntu:18.04        <span class="string">"/bin/sh -c 'while t…"</span>   4 minutes ago       Up 4 minutes                            friendly_minsky</span><br></pre></td></tr></table></figure>
<h3 id="停止容器，可以使用容器ID或者容器名"><a href="#停止容器，可以使用容器ID或者容器名" class="headerlink" title="停止容器，可以使用容器ID或者容器名"></a>停止容器，可以使用容器ID或者容器名</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker stop &#123;CONTAINER ID&#125;|&#123;NAMES&#125;</span><br></pre></td></tr></table></figure>
<h3 id="docker的帮助命令"><a href="#docker的帮助命令" class="headerlink" title="docker的帮助命令"></a>docker的帮助命令</h3><p>在命令行中直接输入docker即可看到它的提示，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">$ docker</span><br><span class="line"></span><br><span class="line">Usage:	docker [OPTIONS] COMMAND</span><br><span class="line"></span><br><span class="line">A self-sufficient runtime <span class="keyword">for</span> containers</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --config string      Location of client config files (default <span class="string">"/home/hewentian/.docker"</span>)</span><br><span class="line">  -c, --context string     Name of the context to use to connect to the daemon (overrides DOCKER_HOST env var and default context <span class="built_in">set</span> with <span class="string">"docker context use"</span>)</span><br><span class="line">  -D, --debug              Enable debug mode</span><br><span class="line">  -H, --host list          Daemon socket(s) to connect to</span><br><span class="line">  -l, --<span class="built_in">log</span>-level string   Set the logging level (<span class="string">"debug"</span>|<span class="string">"info"</span>|<span class="string">"warn"</span>|<span class="string">"error"</span>|<span class="string">"fatal"</span>) (default <span class="string">"info"</span>)</span><br><span class="line">      --tls                Use TLS; implied by --tlsverify</span><br><span class="line">      --tlscacert string   Trust certs signed only by this CA (default <span class="string">"/home/hewentian/.docker/ca.pem"</span>)</span><br><span class="line">      --tlscert string     Path to TLS certificate file (default <span class="string">"/home/hewentian/.docker/cert.pem"</span>)</span><br><span class="line">      --tlskey string      Path to TLS key file (default <span class="string">"/home/hewentian/.docker/key.pem"</span>)</span><br><span class="line">      --tlsverify          Use TLS and verify the remote</span><br><span class="line">  -v, --version            Print version information and quit</span><br><span class="line"></span><br><span class="line">Management Commands:</span><br><span class="line">  builder     Manage builds</span><br><span class="line">  config      Manage Docker configs</span><br><span class="line">  container   Manage containers</span><br><span class="line">  context     Manage contexts</span><br><span class="line">  engine      Manage the docker engine</span><br><span class="line">  image       Manage images</span><br><span class="line">  network     Manage networks</span><br><span class="line">  node        Manage Swarm nodes</span><br><span class="line">  plugin      Manage plugins</span><br><span class="line">  secret      Manage Docker secrets</span><br><span class="line">  service     Manage services</span><br><span class="line">  stack       Manage Docker stacks</span><br><span class="line">  swarm       Manage Swarm</span><br><span class="line">  system      Manage Docker</span><br><span class="line">  trust       Manage trust on Docker images</span><br><span class="line">  volume      Manage volumes</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  attach      Attach <span class="built_in">local</span> standard input, output, and error streams to a running container</span><br><span class="line">  build       Build an image from a Dockerfile</span><br><span class="line">  commit      Create a new image from a container<span class="string">'s changes</span></span><br><span class="line"><span class="string">  cp          Copy files/folders between a container and the local filesystem</span></span><br><span class="line"><span class="string">  create      Create a new container</span></span><br><span class="line"><span class="string">  deploy      Deploy a new stack or update an existing stack</span></span><br><span class="line"><span class="string">  diff        Inspect changes to files or directories on a container'</span>s filesystem</span><br><span class="line">  events      Get real time events from the server</span><br><span class="line">  <span class="built_in">exec</span>        Run a <span class="built_in">command</span> <span class="keyword">in</span> a running container</span><br><span class="line">  <span class="built_in">export</span>      Export a container<span class="string">'s filesystem as a tar archive</span></span><br><span class="line"><span class="string">  history     Show the history of an image</span></span><br><span class="line"><span class="string">  images      List images</span></span><br><span class="line"><span class="string">  import      Import the contents from a tarball to create a filesystem image</span></span><br><span class="line"><span class="string">  info        Display system-wide information</span></span><br><span class="line"><span class="string">  inspect     Return low-level information on Docker objects</span></span><br><span class="line"><span class="string">  kill        Kill one or more running containers</span></span><br><span class="line"><span class="string">  load        Load an image from a tar archive or STDIN</span></span><br><span class="line"><span class="string">  login       Log in to a Docker registry</span></span><br><span class="line"><span class="string">  logout      Log out from a Docker registry</span></span><br><span class="line"><span class="string">  logs        Fetch the logs of a container</span></span><br><span class="line"><span class="string">  pause       Pause all processes within one or more containers</span></span><br><span class="line"><span class="string">  port        List port mappings or a specific mapping for the container</span></span><br><span class="line"><span class="string">  ps          List containers</span></span><br><span class="line"><span class="string">  pull        Pull an image or a repository from a registry</span></span><br><span class="line"><span class="string">  push        Push an image or a repository to a registry</span></span><br><span class="line"><span class="string">  rename      Rename a container</span></span><br><span class="line"><span class="string">  restart     Restart one or more containers</span></span><br><span class="line"><span class="string">  rm          Remove one or more containers</span></span><br><span class="line"><span class="string">  rmi         Remove one or more images</span></span><br><span class="line"><span class="string">  run         Run a command in a new container</span></span><br><span class="line"><span class="string">  save        Save one or more images to a tar archive (streamed to STDOUT by default)</span></span><br><span class="line"><span class="string">  search      Search the Docker Hub for images</span></span><br><span class="line"><span class="string">  start       Start one or more stopped containers</span></span><br><span class="line"><span class="string">  stats       Display a live stream of container(s) resource usage statistics</span></span><br><span class="line"><span class="string">  stop        Stop one or more running containers</span></span><br><span class="line"><span class="string">  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE</span></span><br><span class="line"><span class="string">  top         Display the running processes of a container</span></span><br><span class="line"><span class="string">  unpause     Unpause all processes within one or more containers</span></span><br><span class="line"><span class="string">  update      Update configuration of one or more containers</span></span><br><span class="line"><span class="string">  version     Show the Docker version information</span></span><br><span class="line"><span class="string">  wait        Block until one or more containers stop, then print their exit codes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Run '</span>docker COMMAND --<span class="built_in">help</span><span class="string">' for more information on a command.</span></span><br></pre></td></tr></table></figure></p>
<h3 id="查找镜像"><a href="#查找镜像" class="headerlink" title="查找镜像"></a>查找镜像</h3><p>默认从 <a href="https://hub.docker.com/" target="_blank" rel="noopener">https://hub.docker.com/</a> 查找我们需要的镜像，例如，搜索<code>httpd</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker search httpd</span><br><span class="line">NAME                                 DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">httpd                                The Apache HTTP Server Project                  2567                [OK]                </span><br><span class="line">centos/httpd                                                                         23                                      [OK]</span><br><span class="line">centos/httpd-24-centos7              Platform <span class="keyword">for</span> running Apache httpd 2.4 or bui…   22                                      </span><br><span class="line">armhf/httpd                          The Apache HTTP Server Project                  8                                       </span><br><span class="line">polinux/httpd-php                    Apache with PHP <span class="keyword">in</span> Docker (Supervisor, CentO…   3                                       [OK]</span><br></pre></td></tr></table></figure></p>
<h3 id="下载并运行容器"><a href="#下载并运行容器" class="headerlink" title="下载并运行容器"></a>下载并运行容器</h3><p>我们可以在 <a href="https://hub.docker.com/" target="_blank" rel="noopener">https://hub.docker.com/</a> 上面查询所有可用的镜像，找到需要的镜像后，可以下载，例如<code>training/webapp</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull training/webapp</span><br><span class="line">$ sudo docker run -d -P training/webapp python app.py</span><br><span class="line"></span><br><span class="line">a2d42ce3df7d0dc34b93095fe3cd526de22f75f2f49a7762e395c32cecae82e5</span><br></pre></td></tr></table></figure></p>
<p>我们也可以通过<code>-p</code>参数来设置不一样的端口，（格式为 本机端口:容器端口）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -d -p 5001:5000 training/webapp python app.py</span><br><span class="line"></span><br><span class="line">2f8c4e68d8fbb3130fb51197218b9024bed5de1c4614cd7cca198a68807b57a9</span><br><span class="line"></span><br><span class="line">$ sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                     NAMES</span><br><span class="line">2f8c4e68d8fb        training/webapp     <span class="string">"python app.py"</span>     27 seconds ago      Up 26 seconds       0.0.0.0:5001-&gt;5000/tcp    infallible_greider</span><br><span class="line">a2d42ce3df7d        training/webapp     <span class="string">"python app.py"</span>     41 seconds ago      Up 40 seconds       0.0.0.0:32769-&gt;5000/tcp   epic_pasteur</span><br></pre></td></tr></table></figure></p>
<p>这样在本机的浏览器上面通过如下2种方式，都能访问到应用：<br><a href="http://localhost:32769/" target="_blank" rel="noopener">http://localhost:32769/</a><br><a href="http://localhost:5001/" target="_blank" rel="noopener">http://localhost:5001/</a></p>
<h3 id="查看容器内的进程状况"><a href="#查看容器内的进程状况" class="headerlink" title="查看容器内的进程状况"></a>查看容器内的进程状况</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker top infallible_greider</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                28721               28694               0                   14:49               ?                   00:00:00            python app.py</span><br></pre></td></tr></table></figure>
<h3 id="查看指定容器的配置和状态信息"><a href="#查看指定容器的配置和状态信息" class="headerlink" title="查看指定容器的配置和状态信息"></a>查看指定容器的配置和状态信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker inspect infallible_greider</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"2f8c4e68d8fbb3130fb51197218b9024bed5de1c4614cd7cca198a68807b57a9"</span>,</span><br><span class="line">        <span class="string">"Created"</span>: <span class="string">"2019-07-29T06:49:41.334728611Z"</span>,</span><br><span class="line">        <span class="string">"Path"</span>: <span class="string">"python"</span>,</span><br><span class="line">        <span class="string">"Args"</span>: [</span><br><span class="line">            <span class="string">"app.py"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"State"</span>: &#123;</span><br><span class="line">            <span class="string">"Status"</span>: <span class="string">"running"</span>,</span><br><span class="line">            <span class="string">"Running"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">"Paused"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"Restarting"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"OOMKilled"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"Dead"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"Pid"</span>: 28721,</span><br><span class="line">            <span class="string">"ExitCode"</span>: 0,</span><br><span class="line">            <span class="string">"Error"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="string">"StartedAt"</span>: <span class="string">"2019-07-29T06:49:42.075479437Z"</span>,</span><br><span class="line">            <span class="string">"FinishedAt"</span>: <span class="string">"0001-01-01T00:00:00Z"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Image"</span>: <span class="string">"sha256:6fae60ef344644649a39240b94d73b8ba9c67f898ede85cf8e947a887b3e6557"</span>,</span><br><span class="line">        <span class="string">"ResolvConfPath"</span>: <span class="string">"/var/lib/docker/containers/2f8c4e68d8fbb3130fb51197218b9024bed5de1c4614cd7cca198a68807b57a9/resolv.conf"</span>,</span><br><span class="line">        <span class="string">"HostnamePath"</span>: <span class="string">"/var/lib/docker/containers/2f8c4e68d8fbb3130fb51197218b9024bed5de1c4614cd7cca198a68807b57a9/hostname"</span>,</span><br><span class="line">        <span class="string">"HostsPath"</span>: <span class="string">"/var/lib/docker/containers/2f8c4e68d8fbb3130fb51197218b9024bed5de1c4614cd7cca198a68807b57a9/hosts"</span>,</span><br><span class="line">        <span class="string">"LogPath"</span>: <span class="string">"/var/lib/docker/containers/2f8c4e68d8fbb3130fb51197218b9024bed5de1c4614cd7cca198a68807b57a9/2f8c4e68d8fbb3130fb51197218b9024bed5de1c4614cd7cca198a68807b57a9-json.log"</span>,</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"/infallible_greider"</span>,</span><br><span class="line">        <span class="string">"RestartCount"</span>: 0,</span><br><span class="line">        <span class="string">"Driver"</span>: <span class="string">"overlay2"</span>,</span><br><span class="line">        <span class="string">"Platform"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="string">"MountLabel"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"ProcessLabel"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"AppArmorProfile"</span>: <span class="string">"docker-default"</span>,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="容器可以停止、重新启动和移除"><a href="#容器可以停止、重新启动和移除" class="headerlink" title="容器可以停止、重新启动和移除"></a>容器可以停止、重新启动和移除</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker start infallible_greider</span><br><span class="line">$ sudo docker stop infallible_greider</span><br><span class="line">$ sudo docker rm infallible_greider</span><br></pre></td></tr></table></figure>
<h3 id="列出本机上的所有镜像"><a href="#列出本机上的所有镜像" class="headerlink" title="列出本机上的所有镜像"></a>列出本机上的所有镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker images</span><br><span class="line"></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              18.04               3556258649b2        5 days ago          64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        6 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure>
<h3 id="列出本机上所有已创建的容器"><a href="#列出本机上所有已创建的容器" class="headerlink" title="列出本机上所有已创建的容器"></a>列出本机上所有已创建的容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS               NAMES</span><br><span class="line">ee4b72860ab3        ubuntu:18.04        <span class="string">"/bin/sh -c 'while t…"</span>   8 minutes ago       Up 8 minutes                                      brave_edison</span><br><span class="line">3063341debf2        ubuntu:18.04        <span class="string">"/bin/bash"</span>              9 minutes ago       Exited (0) 9 minutes ago                          friendly_poitras</span><br><span class="line">6623f20692a4        ubuntu:18.04        <span class="string">"/bin/echo 'Hello wo…"</span>   9 minutes ago       Exited (0) 9 minutes ago                          intelligent_roentgen</span><br><span class="line">a2d42ce3df7d        training/webapp     <span class="string">"python app.py"</span>          2 hours ago         Exited (137) 48 minutes ago                       epic_pasteur</span><br><span class="line">1058cf5fafad        training/webapp     <span class="string">"python app.py"</span>          2 hours ago         Exited (137) 2 hours ago                          goofy_lewin</span><br><span class="line">2c113cc40c51        training/webapp     <span class="string">"python app.py"</span>          2 hours ago         Exited (137) 2 hours ago                          confident_gagarin</span><br><span class="line">c9102f1d9541        training/webapp     <span class="string">"python app.py"</span>          3 hours ago         Exited (137) 2 hours ago                          crazy_borg</span><br><span class="line">a4e84d331fbd        hello-world         <span class="string">"/hello"</span>                 6 hours ago         Exited (0) 6 hours ago                            epic_fermi</span><br><span class="line">b03a6f03bd39        hello-world         <span class="string">"/hello"</span>                 2 days ago          Exited (0) 2 days ago                             competent_cartwright</span><br><span class="line">b7c3f4699549        hello-world         <span class="string">"/hello"</span>                 2 days ago          Exited (0) 2 days ago                             crazy_brattain</span><br><span class="line">bb7eb9e197b4        hello-world         <span class="string">"/hello"</span>                 2 days ago          Exited (0) 2 days ago                             pensive_lalande</span><br></pre></td></tr></table></figure>
<h3 id="修改镜像"><a href="#修改镜像" class="headerlink" title="修改镜像"></a>修改镜像</h3><p>我们以已存在的ubuntu镜像为原始版本，创建新的镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -t -i ubuntu:18.04 /bin/bash</span><br><span class="line">root@d23dc5d88f11:/<span class="comment"># apt-get update</span></span><br><span class="line">root@d23dc5d88f11:/<span class="comment"># exit</span></span><br></pre></td></tr></table></figure></p>
<p>查看最后创建的容器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker ps -l</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                          PORTS               NAMES</span><br><span class="line">d23dc5d88f11        ubuntu:18.04        <span class="string">"/bin/bash"</span>         2 minutes ago       Exited (0) About a minute ago                       amazing_vaughan</span><br></pre></td></tr></table></figure></p>
<p>可以看到ID为<code>d23dc5d88f11</code>的容器为我们刚才创建的容器，提交这个容器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker commit -m=<span class="string">"exec apt-get update"</span> -a=<span class="string">"hewentian"</span> d23dc5d88f11 hewentian/ubuntu:v2</span><br><span class="line"></span><br><span class="line">sha256:2bdf86d10fbc18204e04fe5a30dee06dfeb30683247c41e85e8cfe6d66d5d9d6</span><br></pre></td></tr></table></figure></p>
<p>查看我们刚刚创建的镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hewentian/ubuntu    v2                  2bdf86d10fbc        6 seconds ago       91MB</span><br><span class="line">ubuntu              18.04               3556258649b2        5 days ago          64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        6 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure></p>
<p>然后，我们就可以使用我们新建的镜像创建容器了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -it hewentian/ubuntu:v2 /bin/bash</span><br><span class="line">root@10adcace776b:/<span class="comment"># cat /proc/version</span></span><br><span class="line">Linux version 4.15.0-47-generic (buildd@lgw01-amd64-001) (gcc version 7.3.0 (Ubuntu 7.3.0-16ubuntu3)) <span class="comment">#50-Ubuntu SMP Wed Mar 13 10:44:52 UTC 2019</span></span><br><span class="line">root@10adcace776b:/<span class="comment"># whoami</span></span><br><span class="line">root</span><br><span class="line">root@10adcace776b:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure></p>
<h3 id="创建镜像"><a href="#创建镜像" class="headerlink" title="创建镜像"></a>创建镜像</h3><p>从零开始创建一个镜像，我们需要一个Dockerfile文件，示例如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat /home/hewentian/Documents/docker/ubuntu/Dockerfile</span><br><span class="line"></span><br><span class="line">FROM    ubuntu:18.04</span><br><span class="line">MAINTAINER    hewentian <span class="string">"wentian.he@qq.com"</span></span><br><span class="line"></span><br><span class="line">ENV    AUTHOR=<span class="string">"hewentian"</span></span><br><span class="line">WORKDIR    /tmp/</span><br><span class="line">RUN    /usr/bin/touch he.txt</span><br><span class="line">RUN    /bin/<span class="built_in">echo</span> <span class="string">"The author is <span class="variable">$AUTHOR</span>, created at "</span> &gt;&gt; /tmp/he.txt</span><br><span class="line">RUN    /bin/date &gt;&gt; /tmp/he.txt</span><br></pre></td></tr></table></figure></p>
<p>开始创建镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker build -t hewentian/ubuntu:v2.1 -f /home/hewentian/Documents/docker/ubuntu/Dockerfile .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon   2.56kB</span><br><span class="line">Step 1/7 : FROM    ubuntu:18.04</span><br><span class="line"> ---&gt; 3556258649b2</span><br><span class="line">Step 2/7 : MAINTAINER    hewentian <span class="string">"wentian.he@qq.com"</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 9684fd7dab36</span><br><span class="line">Removing intermediate container 9684fd7dab36</span><br><span class="line"> ---&gt; 87f25ba61a99</span><br><span class="line">Step 3/7 : ENV    AUTHOR=<span class="string">"hewentian"</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 22e933129053</span><br><span class="line">Removing intermediate container 22e933129053</span><br><span class="line"> ---&gt; 23c5a574b01c</span><br><span class="line">Step 4/7 : WORKDIR    /tmp/</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> a4341dbc2164</span><br><span class="line">Removing intermediate container a4341dbc2164</span><br><span class="line"> ---&gt; 94663075f2b0</span><br><span class="line">Step 5/7 : RUN    /usr/bin/touch he.txt</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> e54479ffd964</span><br><span class="line">Removing intermediate container e54479ffd964</span><br><span class="line"> ---&gt; a196207c63e9</span><br><span class="line">Step 6/7 : RUN    /bin/<span class="built_in">echo</span> <span class="string">"The author is <span class="variable">$AUTHOR</span>, created at "</span> &gt;&gt; /tmp/he.txt</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 89d010bd1b78</span><br><span class="line">Removing intermediate container 89d010bd1b78</span><br><span class="line"> ---&gt; 11aa9b6d3605</span><br><span class="line">Step 7/7 : RUN    /bin/date &gt;&gt; /tmp/he.txt</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 66627425d24c</span><br><span class="line">Removing intermediate container 66627425d24c</span><br><span class="line"> ---&gt; c6cd98aa1461</span><br><span class="line">Successfully built c6cd98aa1461</span><br><span class="line">Successfully tagged hewentian/ubuntu:v2.1</span><br></pre></td></tr></table></figure></p>
<p>查看生成的镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hewentian/ubuntu    v2.1                c6cd98aa1461        43 seconds ago      64.2MB</span><br><span class="line">hewentian/ubuntu    v2                  2bdf86d10fbc        18 hours ago        91MB</span><br><span class="line">ubuntu              18.04               3556258649b2        6 days ago          64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure></p>
<p>用我们新建的镜像创建容器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -it hewentian/ubuntu:v2.1 /bin/bash</span><br><span class="line"></span><br><span class="line">root@335d56425694:/tmp<span class="comment"># ls /tmp/</span></span><br><span class="line">he.txt</span><br><span class="line">root@335d56425694:/tmp<span class="comment"># more /tmp/he.txt </span></span><br><span class="line">The author is hewentian, created at </span><br><span class="line">Tue Jul 30 03:10:50 UTC 2019</span><br><span class="line">root@335d56425694:/tmp<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure></p>
<p>可见，镜像包含我们自已创建的文件。</p>
<h3 id="将JAR程序部署到容器中"><a href="#将JAR程序部署到容器中" class="headerlink" title="将JAR程序部署到容器中"></a>将JAR程序部署到容器中</h3><p>假设我们现在有一个springBoot的WEB项目，里面有一个接口<code>/hello</code>，已经打好了JAR包。我们要将它部署到容器中运行，目录结构如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/home/hewentian/Documents/docker/showIp</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">Dockerfile  showIp-1.0.0.jar</span><br></pre></td></tr></table></figure></p>
<p>我们创建一个镜像，因此需要一个Dockerfile文件，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat /home/hewentian/Documents/docker/showIp/Dockerfile</span><br><span class="line"></span><br><span class="line">FROM    java:8</span><br><span class="line">MAINTAINER    hewentian <span class="string">"wentian.he@qq.com"</span></span><br><span class="line"></span><br><span class="line">ADD showIp-1.0.0.jar showIp.jar</span><br><span class="line">EXPOSE 8080</span><br><span class="line">ENTRYPOINT [<span class="string">"java"</span>,<span class="string">"-jar"</span>,<span class="string">"showIp.jar"</span>]</span><br></pre></td></tr></table></figure></p>
<p>开始创建镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/Documents/docker/showIp/</span><br><span class="line">$ sudo docker build -t hewentian/show-ip:v1.0.0 -f /home/hewentian/Documents/docker/showIp/Dockerfile .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon   13.4MB</span><br><span class="line">Step 1/5 : FROM    java:8</span><br><span class="line"> ---&gt; d23bdf5b1b1b</span><br><span class="line">Step 2/5 : MAINTAINER    hewentian <span class="string">"wentian.he@qq.com"</span></span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 8ef66d4bf19b</span><br><span class="line">Step 3/5 : ADD showIp-1.0.0.jar showIp.jar</span><br><span class="line"> ---&gt; 74faf7fe0fdf</span><br><span class="line">Step 4/5 : EXPOSE 8080</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 605f90040e44</span><br><span class="line">Removing intermediate container 605f90040e44</span><br><span class="line"> ---&gt; 2de558b34abc</span><br><span class="line">Step 5/5 : ENTRYPOINT [<span class="string">"java"</span>,<span class="string">"-jar"</span>,<span class="string">"showIp.jar"</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> e8436a5ea5e0</span><br><span class="line">Removing intermediate container e8436a5ea5e0</span><br><span class="line"> ---&gt; 5f89e1fe5e7e</span><br><span class="line">Successfully built 5f89e1fe5e7e</span><br><span class="line">Successfully tagged hewentian/show-ip:v1.0.0</span><br></pre></td></tr></table></figure></p>
<p>运行新创建的镜像：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -p 8081:8080 -d hewentian/show-ip:v1.0.0</span><br></pre></td></tr></table></figure></p>
<p>运行成功后，可以访问：<br><a href="http://localhost:8081/hello" target="_blank" rel="noopener">http://localhost:8081/hello</a></p>
<h3 id="一些启动参数"><a href="#一些启动参数" class="headerlink" title="一些启动参数"></a>一些启动参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--network host      <span class="comment"># 用了这个参数，表示使用本机的网络，一般可以省略-p参数</span></span><br><span class="line">--restart always    <span class="comment"># 意外关闭（例如OOM）之后，的处理方式</span></span><br><span class="line">--cpus 2            <span class="comment"># 使用的CPU数量</span></span><br><span class="line">--memory 2g         <span class="comment"># 内存</span></span><br><span class="line">--memory-swap 2g    <span class="comment"># 交换空间</span></span><br></pre></td></tr></table></figure>
<p>当然，还有如下可选安装参数：</p>
<pre><code>-e TZ=Asia/Shanghai \
--net=host \
--cpus=8 \
-m 8g \
--restart=always \
</code></pre><h3 id="docker安装nginx"><a href="#docker安装nginx" class="headerlink" title="docker安装nginx"></a>docker安装nginx</h3><p>首先拉取镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker search nginx</span><br><span class="line">$ sudo docker pull nginx</span><br><span class="line"></span><br><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hewentian/ubuntu    v2.1                c6cd98aa1461        4 hours ago         64.2MB</span><br><span class="line">hewentian/ubuntu    v2                  2bdf86d10fbc        22 hours ago        91MB</span><br><span class="line">nginx               latest              e445ab08b2be        6 days ago          126MB</span><br><span class="line">ubuntu              18.04               3556258649b2        6 days ago          64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure></p>
<p>使用nginx的默认配置来启动一个容器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run --name nginx-test -p 8081:80 -d nginx</span><br><span class="line"></span><br><span class="line">838ebabcc937cf9a8e13946f92d104b2eb153cc61f21cb47e7661d6bbe205253</span><br></pre></td></tr></table></figure></p>
<p>如果启动成功，则可以在浏览器中访问：<br><a href="http://localhost:8081/" target="_blank" rel="noopener">http://localhost:8081/</a></p>
<p>然后，开始部署我们想要的nginx，首先在本机上创建nginx相关文件目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/Documents/docker</span><br><span class="line">$ mkdir -p nginx/www nginx/logs nginx/conf</span><br></pre></td></tr></table></figure></p>
<p>将刚才启动的nginx容器内的配置文件，复制到本机中：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker cp 838ebabcc937:/etc/nginx/nginx.conf /home/hewentian/Documents/docker/nginx/conf</span><br></pre></td></tr></table></figure></p>
<p><strong>docker cp: 用于本地主机与容器之间的数据复制</strong></p>
<p>创建nginx欢迎页面<code>/home/hewentian/Documents/docker/nginx/www/index.html</code>：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    body &#123;</span></span><br><span class="line"><span class="undefined">        width: 35em;</span></span><br><span class="line"><span class="undefined">        margin: 0 auto;</span></span><br><span class="line"><span class="undefined">        font-family: Tahoma, Verdana, Arial, sans-serif;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to docker nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.org/"</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">Commercial support is available at</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.com/"</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>启动nginx：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name nginx-test2 \</span><br><span class="line">    -p 8082:80 \</span><br><span class="line">    -v /home/hewentian/Documents/docker/nginx/www:/usr/share/nginx/html \</span><br><span class="line">    -v /home/hewentian/Documents/docker/nginx/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line">    -v /home/hewentian/Documents/docker/nginx/logs:/var/<span class="built_in">log</span>/nginx \</span><br><span class="line">    nginx</span><br></pre></td></tr></table></figure></p>
<p>参数说明：</p>
<pre><code>-v /home/hewentian/Documents/docker/nginx/www:/usr/share/nginx/html：将在本机创建的目录，挂载到容器内的/usr/share/nginx/html目录
</code></pre><p>如果启动成功，则可以在浏览器中访问：<br><a href="http://localhost:8082/" target="_blank" rel="noopener">http://localhost:8082/</a></p>
<h3 id="docker安装redis"><a href="#docker安装redis" class="headerlink" title="docker安装redis"></a>docker安装redis</h3><p>先建立保存数据的目录和设置好配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/db/redis</span><br><span class="line">$ mkdir data conf</span><br><span class="line">$ <span class="built_in">cd</span> conf</span><br><span class="line">$ vi redis.conf</span><br><span class="line"></span><br><span class="line">requirepass abc123</span><br><span class="line"></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br></pre></td></tr></table></figure></p>
<p>开始安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull redis:7.0.2</span><br><span class="line">$</span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name redis-hwt \</span><br><span class="line">    -p 6379:6379 \</span><br><span class="line">    -v /root/db/redis/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">    -v /root/db/redis/data:/data \</span><br><span class="line">    redis:7.0.2 redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure></p>
<h3 id="docker安装mysql"><a href="#docker安装mysql" class="headerlink" title="docker安装mysql"></a>docker安装mysql</h3><p>先建立保存数据的目录和设置好配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/db/mysql</span><br><span class="line">$ mkdir data conf logs</span><br><span class="line">$ <span class="built_in">cd</span> conf</span><br><span class="line">$ vi mysql.cnf</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line"><span class="comment">#port=3306</span></span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#port=3306</span></span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line">max_connections=100</span><br><span class="line"><span class="comment">#sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span></span><br><span class="line"><span class="comment">#slow-query-log=1</span></span><br><span class="line"><span class="comment">#default-time_zone = '+8:00'</span></span><br><span class="line"><span class="comment">#secure-file-priv=""</span></span><br><span class="line"><span class="comment">#log_timestamps=SYSTEM</span></span><br><span class="line"><span class="comment">#skip-name-resolve</span></span><br><span class="line"><span class="comment">#sort_buffer_size =2M</span></span><br><span class="line"><span class="comment">#tmp_table_size=128M</span></span><br><span class="line"><span class="comment">#innodb_buffer_pool_size = 8G</span></span><br><span class="line"><span class="comment">#binlog_expire_logs_seconds=259200</span></span><br><span class="line"><span class="comment">#performance_schema_max_table_instances=400</span></span><br><span class="line"><span class="comment">#table_definition_cache=400</span></span><br><span class="line"><span class="comment">#table_open_cache=256</span></span><br></pre></td></tr></table></figure></p>
<p>拉取镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker search mysql</span><br><span class="line">$ sudo docker pull mysql:8.0.26</span><br><span class="line"></span><br><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hewentian/ubuntu    v2.1                c6cd98aa1461        4 hours ago         64.2MB</span><br><span class="line">hewentian/ubuntu    v2                  2bdf86d10fbc        22 hours ago        91MB</span><br><span class="line">nginx               latest              e445ab08b2be        6 days ago          126MB</span><br><span class="line">ubuntu              18.04               3556258649b2        6 days ago          64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br><span class="line">mysql               8.0.26              9da615fced53        2 months ago        514MB</span><br></pre></td></tr></table></figure></p>
<p>运行容器</p>
<ol>
<li><p>简单安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name mysql-hwt \</span><br><span class="line">    -p 3306:3306 \</span><br><span class="line">    -e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">    mysql:8.0.26</span><br></pre></td></tr></table></figure>
</li>
<li><p>详细安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name mysql-hwt \</span><br><span class="line">    -p 3306:3306 \</span><br><span class="line">    -v /root/db/mysql/conf/mysql.cnf:/etc/mysql/conf.d/mysql.cnf \</span><br><span class="line">    -v /root/db/mysql/data:/var/lib/mysql \</span><br><span class="line">    -v /root/db/mysql/logs:/logs \</span><br><span class="line">    -e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">    mysql:8.0.26</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                PORTS                       NAMES</span><br><span class="line">524097ed5349        mysql:8.0.26        <span class="string">"docker-entrypoint.s…"</span>   3 minutes ago       Up 3 minutes          0.0.0.0:3306-&gt;3306/tcp      mysql-hwt</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>进入mysql，将root用户密码修改，并且禁用root远程登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker <span class="built_in">exec</span> -it mysql-hwt mysql -uroot -p123456</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT ALL ON *.* TO <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'root'</span>;</span><br><span class="line">mysql&gt; DELETE FROM mysql.user WHERE User=<span class="string">'root'</span> AND Host NOT IN (<span class="string">'localhost'</span>, <span class="string">'127.0.0.1'</span>, <span class="string">'::1'</span>);</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">-- 从mysql8.0开始，语法用下面的</span><br><span class="line">mysql&gt; ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'root'</span>;</span><br><span class="line">mysql&gt; GRANT ALL ON *.* TO <span class="string">'root'</span>@<span class="string">'localhost'</span>;</span><br><span class="line">mysql&gt; DELETE FROM mysql.user WHERE User=<span class="string">'root'</span> AND Host NOT IN (<span class="string">'localhost'</span>, <span class="string">'127.0.0.1'</span>, <span class="string">'::1'</span>);</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></p>
<p>查看编码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'char%'</span>;</span><br><span class="line">+--------------------------+--------------------------------+</span><br><span class="line">| Variable_name            | Value                          |</span><br><span class="line">+--------------------------+--------------------------------+</span><br><span class="line">| character_set_client     | utf8mb4                        |</span><br><span class="line">| character_set_connection | utf8mb4                        |</span><br><span class="line">| character_set_database   | utf8mb4                        |</span><br><span class="line">| character_set_filesystem | binary                         |</span><br><span class="line">| character_set_results    | utf8mb4                        |</span><br><span class="line">| character_set_server     | utf8mb4                        |</span><br><span class="line">| character_set_system     | utf8mb3                        |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql-8.0/charsets/ |</span><br><span class="line">+--------------------------+--------------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>然后创建一个用于操作mysql的简单用户，参考之前的 <a href="../../../../2017/12/07/mysql-note/">mysql 学习笔记</a>。</p>
<p>如果此时尝试用 Workbench 或 Navicat 连接，会报如下错误：</p>
<pre><code>ERROR 2059 (HY000): Authentication plugin &apos;caching_sha2_password&apos; cannot be loaded: dlopen(/usr/local/mysql/lib/plugin/caching_sha2_password.so, 2): image not found
</code></pre><p>报错原因<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select version();</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| version() |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| 8.0.26    |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.28</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'default_authentication_plugin'</span>;</span><br><span class="line">+<span class="comment">-------------------------------+-----------------------+</span></span><br><span class="line">| Variable_name                 | Value                 |</span><br><span class="line">+<span class="comment">-------------------------------+-----------------------+</span></span><br><span class="line">| default_authentication_plugin | caching_sha2_password |</span><br><span class="line">+<span class="comment">-------------------------------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.26</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> host,<span class="keyword">user</span>,<span class="keyword">plugin</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line">+<span class="comment">-----------+------------------+-----------------------+</span></span><br><span class="line">| host      | user             | plugin                |</span><br><span class="line">+<span class="comment">-----------+------------------+-----------------------+</span></span><br><span class="line">| %         | hwh              | caching_sha2_password |</span><br><span class="line">| localhost | mysql.infoschema | caching_sha2_password |</span><br><span class="line">| localhost | mysql.session    | caching_sha2_password |</span><br><span class="line">| localhost | mysql.sys        | caching_sha2_password |</span><br><span class="line">| localhost | root             | caching_sha2_password |</span><br><span class="line">+<span class="comment">-----------+------------------+-----------------------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.31</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>可以看到<code>mysql 8.0.26</code>版本默认的认证方式是<code>caching_sha2_password</code>，连接不上的原因在于连接数据库工具不支持该格式的密码。</p>
<p>解决方法：修改密码加密方式<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">user</span> <span class="string">'hwh'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'123456'</span> <span class="keyword">PASSWORD</span> <span class="keyword">EXPIRE</span> <span class="keyword">NEVER</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">user</span> <span class="string">'hwh'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="docker安装mongo"><a href="#docker安装mongo" class="headerlink" title="docker安装mongo"></a>docker安装mongo</h3><p>先建立保存数据的目录和设置好配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/db/mongodb</span><br><span class="line">$ mkdir configdb data logs</span><br><span class="line">$ <span class="built_in">cd</span> configdb</span><br><span class="line">$ vi mongod.conf</span><br><span class="line"></span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /var/<span class="built_in">log</span>/mongodb/mongod.log</span><br></pre></td></tr></table></figure></p>
<p>开始安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull mongo</span><br><span class="line">$</span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name mongo \</span><br><span class="line">    -p 27017:27017 \</span><br><span class="line">    -v /root/db/mongodb/data:/data/db \</span><br><span class="line">    -v /root/db/mongodb/configdb:/data/configdb \</span><br><span class="line">    -v /root/db/mongodb/logs:/data/logs \</span><br><span class="line">    --auth \</span><br><span class="line">    -f /data/configdb/mongod.conf \</span><br><span class="line">    --bind_ip_all \</span><br><span class="line">    mongo:latest</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>进入mongo，添加管理员。创建第一个用户admin，该用户需要有用户管理权限，其角色为root。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker <span class="built_in">exec</span> -it mongo mongo</span><br><span class="line">MongoDB shell version v4.2.7</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">"id"</span> : UUID(<span class="string">"81ad33aa-6318-4854-98df-9910a8927698"</span>) &#125;</span><br><span class="line">MongoDB server version: 4.2.7</span><br><span class="line">Welcome to the MongoDB shell.</span><br><span class="line">For interactive <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">For more comprehensive documentation, see</span><br><span class="line">	http://docs.mongodb.org/</span><br><span class="line">Questions? Try the support group</span><br><span class="line">	http://groups.google.com/group/mongodb-user</span><br><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt;  db.createUser(&#123;user:<span class="string">"admin"</span>,<span class="built_in">pwd</span>:<span class="string">"12345"</span>,roles:[<span class="string">"root"</span>]&#125;)</span><br><span class="line">Successfully added user: &#123; <span class="string">"user"</span> : <span class="string">"admin"</span>, <span class="string">"roles"</span> : [ <span class="string">"root"</span> ] &#125;</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt; show collections</span><br><span class="line">Warning: unable to run listCollections, attempting to approximate collection names by parsing connectionStatus</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt; db.auth(<span class="string">"admin"</span>,<span class="string">"12345"</span>)</span><br><span class="line">1</span><br><span class="line">&gt;</span><br><span class="line">&gt; show collections</span><br><span class="line">system.users</span><br><span class="line">system.version</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加数据库用户<br>为数据库添加用户，添加用户前需要切换到该数据库，这里简单设置其角色为dbOwner</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; use bfg</span><br><span class="line">switched to db bfg</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">"bfg"</span>, <span class="built_in">pwd</span>: <span class="string">"bfg100"</span>, roles: [&#123; role: <span class="string">"dbOwner"</span>, db: <span class="string">"bfg"</span> &#125;]&#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">	<span class="string">"user"</span> : <span class="string">"bfg"</span>,</span><br><span class="line">	<span class="string">"roles"</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"role"</span> : <span class="string">"dbOwner"</span>,</span><br><span class="line">			<span class="string">"db"</span> : <span class="string">"bfg"</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="docker安装rabbitmq"><a href="#docker安装rabbitmq" class="headerlink" title="docker安装rabbitmq"></a>docker安装rabbitmq</h3><ol>
<li>简单安装<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull rabbitmq:3.8.9-management</span><br><span class="line">$</span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name rabbitmq-hwt \</span><br><span class="line">    -p 5672:5672 \</span><br><span class="line">    -p 15672:15672 \</span><br><span class="line">    -e RABBITMQ_DEFAULT_USER=admin \</span><br><span class="line">    -e RABBITMQ_DEFAULT_PASS=admin \</span><br><span class="line">    rabbitmq:3.8.9-management</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>访问WEB界面：<br><a href="http://192.168.56.113:15672/" target="_blank" rel="noopener">http://192.168.56.113:15672/</a></p>
<h3 id="docker安装zookeeper"><a href="#docker安装zookeeper" class="headerlink" title="docker安装zookeeper"></a>docker安装zookeeper</h3><ol>
<li>简单安装<br>先建立保存数据的目录和设置好配置文件：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/db/zookeeper</span><br><span class="line">$ mkdir data datalog logs</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>开始安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull zookeeper:3.6.2</span><br><span class="line">$</span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name zookeeper-hwt \</span><br><span class="line">    -p 2181:2181 \</span><br><span class="line">    -e ZOO_TICK_TIME=2000 \</span><br><span class="line">    -e ZOO_INIT_LIMIT=10 \</span><br><span class="line">    -e ZOO_SYNC_LIMIT=5 \</span><br><span class="line">    -v /root/db/zookeeper/data:/data \</span><br><span class="line">    -v /root/db/zookeeper/datalog:/datalog \</span><br><span class="line">    -v /root/db/zookeeper/logs:/logs \</span><br><span class="line">    zookeeper:3.6.2</span><br></pre></td></tr></table></figure></p>
<p>客户端登录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker <span class="built_in">exec</span> -it zookeeper-hwt zkCli.sh</span><br><span class="line">Connecting to localhost:2181</span><br></pre></td></tr></table></figure></p>
<h3 id="docker安装kafka"><a href="#docker安装kafka" class="headerlink" title="docker安装kafka"></a>docker安装kafka</h3><ol>
<li>简单安装<br>先建立保存数据的目录和设置好配置文件：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /root/db/kafka</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>开始安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull wurstmeister/kafka:2.13-2.7.0</span><br><span class="line">$</span><br><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name kafka-hwt \</span><br><span class="line">    -p 9092:9092 \</span><br><span class="line">    -e KAFKA_BROKER_ID=0 \</span><br><span class="line">    -e KAFKA_ZOOKEEPER_CONNECT=192.168.56.113:2181/kafka \</span><br><span class="line">    -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.56.113:9092 \</span><br><span class="line">    -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \</span><br><span class="line">    -v /root/db/kafka:/kafka \</span><br><span class="line">    wurstmeister/kafka:2.13-2.7.0</span><br></pre></td></tr></table></figure></p>
<p>验证kafka是否可以使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker <span class="built_in">exec</span> -it kafka-hwt bash</span><br><span class="line">$ <span class="built_in">cd</span> /opt/kafka/bin/</span><br><span class="line">$</span><br><span class="line">$ 发送消息</span><br><span class="line">$ ./kafka-console-producer.sh --broker-list localhost:9092 --topic redsuns</span><br><span class="line">&gt; hello word</span><br><span class="line">$</span><br><span class="line">$ 接收消息</span><br><span class="line">$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic redsuns --from-beginning</span><br></pre></td></tr></table></figure></p>
<p><strong>注意</strong>：因为上面的<code>KAFKA_ZOOKEEPER_CONNECT</code>将kafka的数据保存到了<code>/kafka</code>目录下，所以，当我们使用<code>Kafka Tool</code>工具连接kafka的时候要记得配置<code>chroot path: /kafka</code>，否则连不上。</p>
<h3 id="docker安装zipkin"><a href="#docker安装zipkin" class="headerlink" title="docker安装zipkin"></a>docker安装zipkin</h3><p>拉取镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull openzipkin/zipkin</span><br></pre></td></tr></table></figure></p>
<ol>
<li>简单安装（数据保存到内存中）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name zipkin-hwt \</span><br><span class="line">    -p 9411:9411 \</span><br><span class="line">    openzipkin/zipkin</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>访问WEB界面：<br><a href="http://192.168.56.113:9411/zipkin/" target="_blank" rel="noopener">http://192.168.56.113:9411/zipkin/</a></p>
<ol>
<li>详细安装（数据保存到mysql中，并且从消息队列中读取数据）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run \</span><br><span class="line">    -itd --name zipkin-hwt \</span><br><span class="line">    -p 9411:9411 \</span><br><span class="line">    -e STORAGE_TYPE=mysql \</span><br><span class="line">    -e MYSQL_HOST=192.168.56.113 \</span><br><span class="line">    -e MYSQL_TCP_PORT=3306 \</span><br><span class="line">    -e MYSQL_DB=zipkin \</span><br><span class="line">    -e MYSQL_USER=zipkin \</span><br><span class="line">    -e MYSQL_PASS=HFWM8DBv6nfPXKg2 \</span><br><span class="line">    -e RABBIT_ADDRESSES=192.168.56.113:5672 \</span><br><span class="line">    -e RABBIT_USER=admin \</span><br><span class="line">    -e RABBIT_PASSWORD=admin \</span><br><span class="line">    openzipkin/zipkin</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="进入指定的容器"><a href="#进入指定的容器" class="headerlink" title="进入指定的容器"></a>进入指定的容器</h3><p>若启动容器的时候不是以交互模式，之后又想进入容器，则可以使用如下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">先启动一个之前停止了的容器</span><br><span class="line">$ sudo docker start 3063341debf2</span><br><span class="line">3063341debf2</span><br><span class="line"></span><br><span class="line">直接运行容器内的脚本</span><br><span class="line">$ sudo docker <span class="built_in">exec</span> -it 3063341debf2 /bin/bash /a.sh</span><br><span class="line">Wed Jul 31 01:40:20 UTC 2019</span><br><span class="line"></span><br><span class="line">以交互模式进入容器</span><br><span class="line">$ sudo docker <span class="built_in">exec</span> -it 3063341debf2 /bin/bash</span><br><span class="line">root@3063341debf2:/<span class="comment"># ls</span></span><br><span class="line">a.sh  bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">root@3063341debf2:/<span class="comment"># sh a.sh </span></span><br><span class="line">Wed Jul 31 01:44:34 UTC 2019</span><br><span class="line">root@3063341debf2:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">退出后，容器并不会停止</span><br><span class="line">$ sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">3063341debf2        ubuntu:18.04        <span class="string">"/bin/bash"</span>         41 hours ago        Up 18 seconds                           friendly_poitras</span><br></pre></td></tr></table></figure></p>
<p>另外，使用<code>attach</code>命令也能进入容器，但是当退出后，容器会停止<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">3063341debf2        ubuntu:18.04        <span class="string">"/bin/bash"</span>         41 hours ago        Up 18 seconds                           friendly_poitras</span><br><span class="line"></span><br><span class="line">$ sudo docker attach --sig-proxy=<span class="literal">false</span> 3063341debf2</span><br><span class="line">root@3063341debf2:/<span class="comment"># ls</span></span><br><span class="line">a.sh  bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">root@3063341debf2:/<span class="comment"># sh a.sh </span></span><br><span class="line">Wed Jul 31 02:02:50 UTC 2019</span><br><span class="line">root@3063341debf2:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">$ sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br></pre></td></tr></table></figure></p>
<h3 id="将镜像导出-导入"><a href="#将镜像导出-导入" class="headerlink" title="将镜像导出/导入"></a>将镜像导出/导入</h3><p>导出镜像语法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker save --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Usage:	docker save [OPTIONS] IMAGE [IMAGE...]</span><br><span class="line"></span><br><span class="line">Save one or more images to a tar archive (streamed to STDOUT by default)</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -o, --output string   Write to a file, instead of STDOUT</span><br></pre></td></tr></table></figure></p>
<p>导入镜像语法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker load --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Usage:	docker load [OPTIONS]</span><br><span class="line"></span><br><span class="line">Load an image from a tar archive or STDIN</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -i, --input string   Read from tar archive file, instead of STDIN</span><br><span class="line">  -q, --quiet          Suppress the load output</span><br></pre></td></tr></table></figure></p>
<p>示例：先将镜像导出，然后删除镜像，最后再将导出的镜像重新导入：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">&lt;none&gt;              &lt;none&gt;              c6cd98aa1461        27 hours ago        64.2MB</span><br><span class="line">hewentian/ubuntu    v2                  2bdf86d10fbc        45 hours ago        91MB</span><br><span class="line">nginx               latest              e445ab08b2be        7 days ago          126MB</span><br><span class="line">ubuntu              18.04               3556258649b2        7 days ago          64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br><span class="line"></span><br><span class="line">$ sudo docker save -o hu.tar hewentian/ubuntu:v2</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">hu.tar</span><br><span class="line"></span><br><span class="line">$ sudo docker rmi 2bdf86d10fbc</span><br><span class="line">Untagged: hewentian/ubuntu:v2</span><br><span class="line">Deleted: sha256:2bdf86d10fbc18204e04fe5a30dee06dfeb30683247c41e85e8cfe6d66d5d9d6</span><br><span class="line">Deleted: sha256:c4a9226f13fa8f48ef07e27e0954c43f38275b6aa1d24e361ed016dfff056069</span><br><span class="line"></span><br><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">&lt;none&gt;              &lt;none&gt;              c6cd98aa1461        27 hours ago        64.2MB</span><br><span class="line">nginx               latest              e445ab08b2be        7 days ago          126MB</span><br><span class="line">ubuntu              18.04               3556258649b2        7 days ago          64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br><span class="line"></span><br><span class="line">$ sudo docker load -i hu.tar </span><br><span class="line">ed4797628ae8: Loading layer [==================================================&gt;]  26.85MB/26.85MB</span><br><span class="line">Loaded image: hewentian/ubuntu:v2</span><br><span class="line"></span><br><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">&lt;none&gt;              &lt;none&gt;              c6cd98aa1461        27 hours ago        64.2MB</span><br><span class="line">hewentian/ubuntu    v2                  2bdf86d10fbc        45 hours ago        91MB</span><br><span class="line">nginx               latest              e445ab08b2be        7 days ago          126MB</span><br><span class="line">ubuntu              18.04               3556258649b2        7 days ago          64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure></p>
<p>或者使用压缩方式导出导入</p>
<pre><code>$ sudo docker save mysql:5.6.42 | gzip &gt; mysql-5.6.42.tar.gz
$ sudo docker load &lt; mysql-5.6.42.tar.gz
</code></pre><p><strong>注意：导出镜像的时候，要使用<code>REPOSITORY:TAG</code>，而不是<code>IMAGE ID</code>，否则在重新导入的时候会没有<code>REPOSITORY:TAG</code>，显示为none</strong></p>
<h3 id="使用import创建镜像"><a href="#使用import创建镜像" class="headerlink" title="使用import创建镜像"></a>使用import创建镜像</h3><p>也可以从导出的tar文件中创建一个新的镜像，语法如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker import --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Usage:	docker import [OPTIONS] file|URL|- [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line">Import the contents from a tarball to create a filesystem image</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -c, --change list      Apply Dockerfile instruction to the created image</span><br><span class="line">  -m, --message string   Set commit message <span class="keyword">for</span> imported image</span><br></pre></td></tr></table></figure></p>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker import hu.tar hewentian/ubuntu:v2.1</span><br><span class="line">sha256:c389673d68c576b08ad8e3c2337de4ee3b4ed7e622fa986771323797edd2d595</span><br><span class="line"></span><br><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hewentian/ubuntu    v2.1                c389673d68c5        5 seconds ago       66.6MB</span><br><span class="line">hewentian/ubuntu    v2                  2bdf86d10fbc        45 hours ago        91MB</span><br><span class="line">nginx               latest              e445ab08b2be        7 days ago          126MB</span><br><span class="line">ubuntu              18.04               3556258649b2        7 days ago          64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure></p>
<p><strong>我试过使用import进去的镜像来创建容器，但是失败了，留待以后再解决</strong></p>
<h3 id="登录-登出镜像仓库"><a href="#登录-登出镜像仓库" class="headerlink" title="登录/登出镜像仓库"></a>登录/登出镜像仓库</h3><p>默认登录/登出官方仓库 <a href="https://hub.docker.com/" target="_blank" rel="noopener">https://hub.docker.com/</a> ，不过，也可以登录到指定的私有仓库。</p>
<p>登录语法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker login --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Usage:	docker login [OPTIONS] [SERVER]</span><br><span class="line"></span><br><span class="line">Log <span class="keyword">in</span> to a Docker registry.</span><br><span class="line">If no server is specified, the default is defined by the daemon.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -p, --password string   Password</span><br><span class="line">      --password-stdin    Take the password from stdin</span><br><span class="line">  -u, --username string   Username</span><br></pre></td></tr></table></figure></p>
<p>登出语法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker <span class="built_in">logout</span> --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Usage:	docker <span class="built_in">logout</span> [SERVER]</span><br><span class="line"></span><br><span class="line">Log out from a Docker registry.</span><br><span class="line">If no server is specified, the default is defined by the daemon.</span><br></pre></td></tr></table></figure></p>
<p>登录/登出示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker login -u hewentian</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /home/hewentian/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ sudo docker <span class="built_in">logout</span> </span><br><span class="line">Removing login credentials <span class="keyword">for</span> https://index.docker.io/v1/</span><br></pre></td></tr></table></figure></p>
<h3 id="将本地镜像上传到镜像仓库"><a href="#将本地镜像上传到镜像仓库" class="headerlink" title="将本地镜像上传到镜像仓库"></a>将本地镜像上传到镜像仓库</h3><p>默认上传到docker官方仓库docker.io，上传到私有仓库的例子，后面会介绍。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker push hewentian/ubuntu:v2.1</span><br><span class="line">The push refers to repository [docker.io/hewentian/ubuntu]</span><br><span class="line">8c29bfccf50c: Pushed </span><br><span class="line">v2.1: digest: sha256:992cc4e008449d8285387fe80aff3c9b0574360fc3ad21b04bccc5b6a4229923 size: 528</span><br></pre></td></tr></table></figure></p>
<h3 id="harbor的安装"><a href="#harbor的安装" class="headerlink" title="harbor的安装"></a>harbor的安装</h3><p>我们将在机器<code>192.168.56.113</code>上面安装harbor，安装过程参考这里：<br><a href="https://github.com/goharbor/harbor">https://github.com/goharbor/harbor</a></p>
<p>harbor依赖<code>docker 17.06.0-ce+</code>、<code>docker-compose 1.18.0+</code>，其中<code>dock-ce</code>的安装参照上文。</p>
<p>安装<code>docker-compose</code>，参考： <a href="https://docs.docker.com/compose/install/#install-compose" target="_blank" rel="noopener">https://docs.docker.com/compose/install/#install-compose</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L <span class="string">"https://github.com/docker/compose/releases/download/1.24.1/docker-compose-<span class="variable">$(uname -s)</span>-<span class="variable">$(uname -m)</span>"</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line">$ sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"></span><br><span class="line">$ docker-compose -version</span><br><span class="line">docker-compose version 1.24.1, build 4667896b</span><br></pre></td></tr></table></figure></p>
<p>开始安装harbor，安装之前需要启动docker，参考： <a href="https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md">https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md</a><br>下载离线安装包，在 <a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a> 下载最新版本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop</span><br><span class="line">$ wget https://storage.googleapis.com/harbor-releases/release-1.8.0/harbor-offline-installer-v1.8.2-rc1.tgz</span><br><span class="line">$ tar xf harbor-offline-installer-v1.8.2-rc1.tgz</span><br><span class="line">$ <span class="built_in">cd</span> harbor</span><br><span class="line">$ ls </span><br><span class="line">harbor.v1.8.2.tar.gz  harbor.yml  install.sh  LICENSE  prepare</span><br></pre></td></tr></table></figure></p>
<p>安装前的配置，配置文件<code>harbor.yml</code>中<code>hostname</code>可以配置成IP地址或域名，主要是用于给客户端登录使用：<br>首先查看本机的<code>hostname</code>和IP地址<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ hostname</span><br><span class="line">hadoop-host-slave-3</span><br><span class="line"></span><br><span class="line">$ ifconfig</span><br><span class="line">enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.56.113  netmask 255.255.255.0  broadcast 192.168.56.255</span><br><span class="line">        inet6 fe80::90f2:2a79:288c:984e  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 08:00:27:9f:8e:7e  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 4726  bytes 448939 (448.9 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 7637  bytes 9739346 (9.7 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure></p>
<p>可以看到<code>hostname</code>是<code>hadoop-host-slave-3</code>，而IP地址是<code>192.168.56.113</code>。这里我们将<code>hostname</code>配置成<code>hadoop-host-slave-3</code>，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/harbor</span><br><span class="line">$ vi harbor.yml</span><br><span class="line"></span><br><span class="line">hostname: hadoop-host-slave-3</span><br></pre></td></tr></table></figure></p>
<p>开始安装，执行一个安装脚本即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hadoop/harbor</span><br><span class="line">$ sudo ./install.sh</span><br></pre></td></tr></table></figure></p>
<p>如无意外，你会看到如下的安装日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">[sudo] password <span class="keyword">for</span> hadoop: </span><br><span class="line"></span><br><span class="line">[Step 0]: checking installation environment ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 19.03.1</span><br><span class="line"></span><br><span class="line">Note: docker-compose version: 1.24.1</span><br><span class="line"></span><br><span class="line">[Step 1]: loading Harbor images ...</span><br><span class="line">39b2d676308e: Loading layer [==================================================&gt;]  33.47MB/33.47MB</span><br><span class="line">f3583ea30104: Loading layer [==================================================&gt;]  3.552MB/3.552MB</span><br><span class="line">8290f582ffa5: Loading layer [==================================================&gt;]   6.59MB/6.59MB</span><br><span class="line">19913bc5e52b: Loading layer [==================================================&gt;]  161.3kB/161.3kB</span><br><span class="line">ae8b73743d1b: Loading layer [==================================================&gt;]    215kB/215kB</span><br><span class="line">5c811d1fe61a: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">Loaded image: goharbor/harbor-portal:v1.8.2</span><br><span class="line">f27812f7a2da: Loading layer [==================================================&gt;]  8.971MB/8.971MB</span><br><span class="line">c74d2b18a2d1: Loading layer [==================================================&gt;]  38.82MB/38.82MB</span><br><span class="line">c416e128ff4c: Loading layer [==================================================&gt;]  38.82MB/38.82MB</span><br><span class="line">Loaded image: goharbor/harbor-jobservice:v1.8.2</span><br><span class="line">e97909585a09: Loading layer [==================================================&gt;]  8.972MB/8.972MB</span><br><span class="line">23b18d08698d: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">9c1d8c03df3e: Loading layer [==================================================&gt;]   20.1MB/20.1MB</span><br><span class="line">9666a22cf141: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">95783fa51b82: Loading layer [==================================================&gt;]  7.465MB/7.465MB</span><br><span class="line">285e05bca91e: Loading layer [==================================================&gt;]  27.56MB/27.56MB</span><br><span class="line">Loaded image: goharbor/harbor-registryctl:v1.8.2</span><br><span class="line">6543a3ba9bd9: Loading layer [==================================================&gt;]    338MB/338MB</span><br><span class="line">43f486f0ed18: Loading layer [==================================================&gt;]    107kB/107kB</span><br><span class="line">Loaded image: goharbor/harbor-migrator:v1.8.2</span><br><span class="line">6710d86773e1: Loading layer [==================================================&gt;]  50.51MB/50.51MB</span><br><span class="line">dba91d68db46: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">4b6a61fc3477: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">efd64eeb5c31: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">25d50c6108dd: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">6c22404ddaf0: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">135fef0d64a7: Loading layer [==================================================&gt;]  12.29kB/12.29kB</span><br><span class="line">Loaded image: goharbor/harbor-log:v1.8.2</span><br><span class="line">f080cac48a5f: Loading layer [==================================================&gt;]  3.552MB/3.552MB</span><br><span class="line">Loaded image: goharbor/nginx-photon:v1.8.2</span><br><span class="line">9562b05e7bd1: Loading layer [==================================================&gt;]  8.971MB/8.971MB</span><br><span class="line">2ff1ba9952dc: Loading layer [==================================================&gt;]  5.143MB/5.143MB</span><br><span class="line">463651a0baca: Loading layer [==================================================&gt;]  15.13MB/15.13MB</span><br><span class="line">feceecff30a6: Loading layer [==================================================&gt;]  26.47MB/26.47MB</span><br><span class="line">a2d1a1b1eaaa: Loading layer [==================================================&gt;]  22.02kB/22.02kB</span><br><span class="line">2c8463eca215: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">7e91f466c852: Loading layer [==================================================&gt;]  46.74MB/46.74MB</span><br><span class="line">Loaded image: goharbor/notary-server-photon:v0.6.1-v1.8.2</span><br><span class="line">628aac791456: Loading layer [==================================================&gt;]    113MB/113MB</span><br><span class="line">32e13bd19d15: Loading layer [==================================================&gt;]  10.94MB/10.94MB</span><br><span class="line">17d6a3366a31: Loading layer [==================================================&gt;]  2.048kB/2.048kB</span><br><span class="line">9c3d274d3072: Loading layer [==================================================&gt;]  48.13kB/48.13kB</span><br><span class="line">a3e8bc524efe: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">6edf120ab0a5: Loading layer [==================================================&gt;]  10.99MB/10.99MB</span><br><span class="line">Loaded image: goharbor/clair-photon:v2.0.8-v1.8.2</span><br><span class="line">fa7f8bd666e1: Loading layer [==================================================&gt;]  8.972MB/8.972MB</span><br><span class="line">d23a3ac1da5c: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">25ece37b9b62: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">ceff80c4799d: Loading layer [==================================================&gt;]   20.1MB/20.1MB</span><br><span class="line">4ddaf99a2326: Loading layer [==================================================&gt;]   20.1MB/20.1MB</span><br><span class="line">Loaded image: goharbor/registry-photon:v2.7.1-patch-2819-v1.8.2</span><br><span class="line">86ef8960f9fa: Loading layer [==================================================&gt;]  13.72MB/13.72MB</span><br><span class="line">4be07cab0847: Loading layer [==================================================&gt;]  26.47MB/26.47MB</span><br><span class="line">b3f2bb8db417: Loading layer [==================================================&gt;]  22.02kB/22.02kB</span><br><span class="line">4c68837d983b: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">f2526a5c0965: Loading layer [==================================================&gt;]  45.33MB/45.33MB</span><br><span class="line">Loaded image: goharbor/notary-signer-photon:v0.6.1-v1.8.2</span><br><span class="line">9c6a2b28994d: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">49bb4e719955: Loading layer [==================================================&gt;]  1.536kB/1.536kB</span><br><span class="line">47d1a63f5482: Loading layer [==================================================&gt;]  69.81MB/69.81MB</span><br><span class="line">db449d60801c: Loading layer [==================================================&gt;]  39.75MB/39.75MB</span><br><span class="line">f01c7fa07db7: Loading layer [==================================================&gt;]  144.4kB/144.4kB</span><br><span class="line">5ff7a32e9f2c: Loading layer [==================================================&gt;]  3.005MB/3.005MB</span><br><span class="line">Loaded image: goharbor/prepare:v1.8.2</span><br><span class="line">6602e119ecab: Loading layer [==================================================&gt;]  8.971MB/8.971MB</span><br><span class="line">6b45eae45c58: Loading layer [==================================================&gt;]  46.86MB/46.86MB</span><br><span class="line">e3d9614f88b3: Loading layer [==================================================&gt;]  5.632kB/5.632kB</span><br><span class="line">f0b457c2a1b1: Loading layer [==================================================&gt;]  28.67kB/28.67kB</span><br><span class="line">f4e712369f36: Loading layer [==================================================&gt;]  46.86MB/46.86MB</span><br><span class="line">Loaded image: goharbor/harbor-core:v1.8.2</span><br><span class="line">c39fa71cb1b3: Loading layer [==================================================&gt;]   63.4MB/63.4MB</span><br><span class="line">245ad05b59aa: Loading layer [==================================================&gt;]  50.88MB/50.88MB</span><br><span class="line">6fc4b5ec5705: Loading layer [==================================================&gt;]  6.656kB/6.656kB</span><br><span class="line">8a003956ed73: Loading layer [==================================================&gt;]  2.048kB/2.048kB</span><br><span class="line">0b4d3b06d5d5: Loading layer [==================================================&gt;]   7.68kB/7.68kB</span><br><span class="line">c045e2109691: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">eef5f9c09eb0: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">75776554d401: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">Loaded image: goharbor/harbor-db:v1.8.2</span><br><span class="line">0130cb61aaba: Loading layer [==================================================&gt;]  74.58MB/74.58MB</span><br><span class="line">9f0973beb46c: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">74bd291b6f8b: Loading layer [==================================================&gt;]   59.9kB/59.9kB</span><br><span class="line">3b11caba8d3e: Loading layer [==================================================&gt;]  61.95kB/61.95kB</span><br><span class="line">Loaded image: goharbor/redis-photon:v1.8.2</span><br><span class="line">5b00b48e6ec3: Loading layer [==================================================&gt;]  8.976MB/8.976MB</span><br><span class="line">7f5008b71ec6: Loading layer [==================================================&gt;]  44.39MB/44.39MB</span><br><span class="line">02f96d3b6e35: Loading layer [==================================================&gt;]  2.048kB/2.048kB</span><br><span class="line">da8354357ee3: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">1819913851a3: Loading layer [==================================================&gt;]   44.4MB/44.4MB</span><br><span class="line">Loaded image: goharbor/chartmuseum-photon:v0.9.0-v1.8.2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 2]: preparing environment ...</span><br><span class="line">prepare base dir is <span class="built_in">set</span> to /home/hadoop/harbor</span><br><span class="line">Generated configuration file: /config/<span class="built_in">log</span>/logrotate.conf</span><br><span class="line">Generated configuration file: /config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: /config/core/env</span><br><span class="line">Generated configuration file: /config/core/app.conf</span><br><span class="line">Generated configuration file: /config/registry/config.yml</span><br><span class="line">Generated configuration file: /config/registryctl/env</span><br><span class="line">Generated configuration file: /config/db/env</span><br><span class="line">Generated configuration file: /config/jobservice/env</span><br><span class="line">Generated configuration file: /config/jobservice/config.yml</span><br><span class="line">Generated and saved secret to file: /secret/keys/secretkey</span><br><span class="line">Generated certificate, key file: /secret/core/private_key.pem, cert file: /secret/registry/root.crt</span><br><span class="line">Generated configuration file: /compose_location/docker-compose.yml</span><br><span class="line">Clean up the input dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 3]: starting Harbor ...</span><br><span class="line">Creating network <span class="string">"harbor_harbor"</span> with the default driver</span><br><span class="line">Creating harbor-log ... <span class="keyword">done</span></span><br><span class="line">Creating redis       ... <span class="keyword">done</span></span><br><span class="line">Creating registryctl ... <span class="keyword">done</span></span><br><span class="line">Creating registry    ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-db   ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-core ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-portal     ... <span class="keyword">done</span></span><br><span class="line">Creating harbor-jobservice ... <span class="keyword">done</span></span><br><span class="line">Creating nginx             ... <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">✔ ----Harbor has been installed and started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able to visit the admin portal at http://hadoop-host-slave-3. </span><br><span class="line">For more details, please visit https://github.com/goharbor/harbor .</span><br></pre></td></tr></table></figure></p>
<p>按照上面的提示，我们在浏览器中访问<br><a href="http://hadoop-host-slave-3" target="_blank" rel="noopener">http://hadoop-host-slave-3</a><br><a href="http://harbor.hewentian.com" target="_blank" rel="noopener">http://harbor.hewentian.com</a></p>
<p>在访问之前，我们需要在本地机器中配置一下hosts，添加如下两行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ more /etc/hosts</span><br><span class="line"></span><br><span class="line">192.168.56.113	hadoop-host-slave-3</span><br><span class="line">192.168.56.113	harbor.hewentian.com</span><br></pre></td></tr></table></figure></p>
<p>为方便docker将镜像上传到私有harbor，这里多配置一个域名。所以访问上面所列的两个站点，结果是一样的。后面的操作，我们使用<code>harbor.hewentian.com</code>这个域名。</p>
<p><img src="/img/harbor-admin-login.png" alt="" title="harbor 管理员登录"></p>
<p>输入管理员的初始用户名/密码：<code>admin/Harbor12345</code>，登录之后，在页面上可以修改密码。登录之后，如下图：</p>
<p><img src="/img/harbor-logined.png" alt="" title="harbor logined"></p>
<p>我们创建一个用户，用户名/密码：<code>hewentian/Harbor12345</code>，用于上传下载镜像：</p>
<p><img src="/img/harbor-new-user.png" alt="" title="harbor 创建用户"></p>
<p>然后我们退出管理员帐号，用新创建的用户登录：</p>
<p><img src="/img/harbor-user-login.png" alt="" title="harbor 普通用户登录"></p>
<p>创建一个project，名为hp，可见性为public：</p>
<p><img src="/img/harbor-create-project.png" alt="" title="harbor 普通用户登录"></p>
<p>docker登录到harbor<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker login harbor.hewentian.com -u hewentian</span><br><span class="line">Password: </span><br><span class="line">Error response from daemon: Get https://harbor.hewentian.com/v2/: dial tcp 192.168.56.113:443: connect: connection refused</span><br></pre></td></tr></table></figure></p>
<p>有可能会报上面的错误，原因是docker与registry交互默认使用的是HTTPS，但是我们搭建的harbor默认使用的是HTTP服务。解决方法：<br>在要登录到harbor的机器（本地机器）作如下配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"insecure-registries"</span>: [<span class="string">"harbor.hewentian.com"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>文件<code>/etc/docker/daemon.json</code>原先可能并不存在，它所有可能的配置，可以参考这里：<br><a href="https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file" target="_blank" rel="noopener">https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file</a></p>
<p>重启（本地机器）的docker，并重新尝试登录到harbor<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service docker restart</span><br><span class="line"></span><br><span class="line">$ sudo docker login harbor.hewentian.com -u hewentian</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /home/hewentian/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure></p>
<h3 id="将本地镜像上传到私有镜像仓库harbor"><a href="#将本地镜像上传到私有镜像仓库harbor" class="headerlink" title="将本地镜像上传到私有镜像仓库harbor"></a>将本地镜像上传到私有镜像仓库harbor</h3><p>上传到私库的命令，和上传到官方仓库的命令差不多，命令如下：</p>
<pre><code>docker push reg.yourdomain.com/myproject/myrepo:mytag
</code></pre><p>先查看本地的所有镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hewentian/ubuntu    v2.1                3712fd008024        8 days ago          64.2MB</span><br><span class="line">hewentian/ubuntu    v2                  2bdf86d10fbc        10 days ago         91MB</span><br><span class="line">nginx               latest              e445ab08b2be        2 weeks ago         126MB</span><br><span class="line">ubuntu              18.04               3556258649b2        2 weeks ago         64.2MB</span><br><span class="line">hello-world         latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure></p>
<p>例如我们要将<code>ubuntu:18.04</code>上传到harbor<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker push harbor.hewentian.com/hp/ubuntu:18.04</span><br><span class="line">[sudo] password <span class="keyword">for</span> hewentian: </span><br><span class="line">The push refers to repository [harbor.hewentian.com/hp/ubuntu]</span><br><span class="line">An image does not exist locally with the tag: harbor.hewentian.com/hp/ubuntu</span><br></pre></td></tr></table></figure></p>
<p>可以看到，不能直接上传，要先为待上传的镜像打tag<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker tag ubuntu:18.04 harbor.hewentian.com/hp/ubuntu:18.04</span><br><span class="line"></span><br><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hewentian/ubuntu                 v2.1                3712fd008024        8 days ago          64.2MB</span><br><span class="line">hewentian/ubuntu                 v2                  2bdf86d10fbc        10 days ago         91MB</span><br><span class="line">nginx                            latest              e445ab08b2be        2 weeks ago         126MB</span><br><span class="line">harbor.hewentian.com/hp/ubuntu   18.04               3556258649b2        2 weeks ago         64.2MB</span><br><span class="line">ubuntu                           18.04               3556258649b2        2 weeks ago         64.2MB</span><br><span class="line">hello-world                      latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp                  latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure></p>
<p>从上面可以看到，打tag后的镜像只是原镜像的一个引用，它们的<code>IMAGE ID</code>是一样的。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker push harbor.hewentian.com/hp/ubuntu:18.04</span><br><span class="line">The push refers to repository [harbor.hewentian.com/hp/ubuntu]</span><br><span class="line">b079b3fa8d1b: Pushed </span><br><span class="line">a31dbd3063d7: Pushed </span><br><span class="line">c56e09e1bd18: Pushed </span><br><span class="line">543791078bdb: Pushed </span><br><span class="line">18.04: digest: sha256:d91842ef309155b85a9e5c59566719308fab816b40d376809c39cf1cf4de3c6a size: 1152</span><br></pre></td></tr></table></figure></p>
<p>上传成功。同样在浏览器上面，也可以看到，已经成功上传了。</p>
<p><img src="/img/harbor-push-image-1.png" alt="" title="harbor 查看镜像"></p>
<p><img src="/img/harbor-push-image-2.png" alt="" title="harbor 查看镜像"></p>
<h3 id="从harbor下载镜像"><a href="#从harbor下载镜像" class="headerlink" title="从harbor下载镜像"></a>从harbor下载镜像</h3><p>先将本地的镜像删掉<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker rmi harbor.hewentian.com/hp/ubuntu:18.04</span><br><span class="line">Untagged: harbor.hewentian.com/hp/ubuntu:18.04</span><br><span class="line">Untagged: harbor.hewentian.com/hp/ubuntu@sha256:d91842ef309155b85a9e5c59566719308fab816b40d376809c39cf1cf4de3c6a</span><br><span class="line"></span><br><span class="line">$ sudo docker rmi ubuntu:18.04</span><br><span class="line"></span><br><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hewentian/ubuntu    v2.1                3712fd008024        8 days ago          64.2MB</span><br><span class="line">hewentian/ubuntu    v2                  2bdf86d10fbc        10 days ago         91MB</span><br><span class="line">nginx               latest              e445ab08b2be        2 weeks ago         126MB</span><br><span class="line">hello-world         latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp     latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure></p>
<p>然后从harbor下载<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull harbor.hewentian.com/hp/ubuntu:18.04</span><br><span class="line">18.04: Pulling from hp/ubuntu</span><br><span class="line">7413c47ba209: Pull complete </span><br><span class="line">0fe7e7cbb2e8: Pull complete </span><br><span class="line">1d425c982345: Pull complete </span><br><span class="line">344da5c95cec: Pull complete </span><br><span class="line">Digest: sha256:d91842ef309155b85a9e5c59566719308fab816b40d376809c39cf1cf4de3c6a</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> harbor.hewentian.com/hp/ubuntu:18.04</span><br><span class="line">harbor.hewentian.com/hp/ubuntu:18.04</span><br><span class="line"></span><br><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hewentian/ubuntu                 v2.1                3712fd008024        8 days ago          64.2MB</span><br><span class="line">hewentian/ubuntu                 v2                  2bdf86d10fbc        10 days ago         91MB</span><br><span class="line">nginx                            latest              e445ab08b2be        2 weeks ago         126MB</span><br><span class="line">harbor.hewentian.com/hp/ubuntu   18.04               3556258649b2        2 weeks ago         64.2MB</span><br><span class="line">hello-world                      latest              fce289e99eb9        7 months ago        1.84kB</span><br><span class="line">training/webapp                  latest              6fae60ef3446        4 years ago         349MB</span><br></pre></td></tr></table></figure></p>
<h3 id="查看harbor进程状态"><a href="#查看harbor进程状态" class="headerlink" title="查看harbor进程状态"></a>查看harbor进程状态</h3><p>harbor的日志默认存放在<code>/var/log/harbor</code>，如果有下列哪个服务不是<code>Up</code>状态，可以查看相关日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker-compose ps</span><br><span class="line">[sudo] password <span class="keyword">for</span> hadoop: </span><br><span class="line">      Name                     Command                  State                 Ports          </span><br><span class="line">---------------------------------------------------------------------------------------------</span><br><span class="line">harbor-core         /harbor/start.sh                 Up (healthy)                            </span><br><span class="line">harbor-db           /entrypoint.sh postgres          Up (healthy)   5432/tcp                 </span><br><span class="line">harbor-jobservice   /harbor/start.sh                 Up                                      </span><br><span class="line">harbor-log          /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up (healthy)   127.0.0.1:1514-&gt;10514/tcp</span><br><span class="line">harbor-portal       nginx -g daemon off;             Up (healthy)   80/tcp                   </span><br><span class="line">nginx               nginx -g daemon off;             Up (healthy)   0.0.0.0:80-&gt;80/tcp       </span><br><span class="line">redis               docker-entrypoint.sh redis ...   Up             6379/tcp                 </span><br><span class="line">registry            /entrypoint.sh /etc/regist ...   Up (healthy)   5000/tcp                 </span><br><span class="line">registryctl         /harbor/start.sh                 Up (healthy)</span><br></pre></td></tr></table></figure></p>
<h3 id="harbor生命周期管理"><a href="#harbor生命周期管理" class="headerlink" title="harbor生命周期管理"></a>harbor生命周期管理</h3><p>可以使用<code>docker-compose</code>命令来启动、停止harbor<br>停止harbor：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker-compose stop</span><br><span class="line"></span><br><span class="line">Stopping nginx             ... <span class="keyword">done</span></span><br><span class="line">Stopping harbor-jobservice ... <span class="keyword">done</span></span><br><span class="line">Stopping harbor-portal     ... <span class="keyword">done</span></span><br><span class="line">Stopping harbor-core       ... <span class="keyword">done</span></span><br><span class="line">Stopping registry          ... <span class="keyword">done</span></span><br><span class="line">Stopping harbor-db         ... <span class="keyword">done</span></span><br><span class="line">Stopping registryctl       ... <span class="keyword">done</span></span><br><span class="line">Stopping redis             ... <span class="keyword">done</span></span><br><span class="line">Stopping harbor-log        ... <span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>启动harbor：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker-compose start</span><br><span class="line"></span><br><span class="line">Starting <span class="built_in">log</span>         ... <span class="keyword">done</span></span><br><span class="line">Starting registry    ... <span class="keyword">done</span></span><br><span class="line">Starting registryctl ... <span class="keyword">done</span></span><br><span class="line">Starting postgresql  ... <span class="keyword">done</span></span><br><span class="line">Starting core        ... <span class="keyword">done</span></span><br><span class="line">Starting portal      ... <span class="keyword">done</span></span><br><span class="line">Starting redis       ... <span class="keyword">done</span></span><br><span class="line">Starting jobservice  ... <span class="keyword">done</span></span><br><span class="line">Starting proxy       ... <span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>参考文献：<br><a href="https://docs.docker.com/" target="_blank" rel="noopener">https://docs.docker.com/</a><br><a href="https://blog.docker.com/" target="_blank" rel="noopener">https://blog.docker.com/</a><br><a href="https://github.com/goharbor/harbor">https://github.com/goharbor/harbor</a></p>
<h3 id="将宿主机的文件复制到容器里面"><a href="#将宿主机的文件复制到容器里面" class="headerlink" title="将宿主机的文件复制到容器里面"></a>将宿主机的文件复制到容器里面</h3><pre><code>sudo docker cp /data.txt containerID:/
</code></pre><p>注意：一定要指定复制到的目录位置</p>
<p>未完待续……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2019/07/26/docker-note/" data-id="clf9thvks000d6h3kt7mrczdd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/10/nginx-note/" class="article-date">
  <time datetime="2019-06-10T11:20:16.000Z" itemprop="datePublished">2019-06-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web-server/">web server</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/10/nginx-note/">nginx 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天一看，天哪，原来已经有4个月没有更新博客了，我在想，这4个月我都干嘛去了，内心立马慌起来了（你知道的，程序员是不能停止学习的）。但是细想，虽然没更新博客，但还是看了几本书：《从0到1》、《毛泽东选集》卷一、《MongoDB in Action》、《SpringBoot in Action》、《白帽子讲Web安全》，内心立马淡定了不少。好了，题外话不多说了，马上进入主题。</p>
<p><code>nginx</code>是一个<code>HTTP</code>和反向代理服务器、邮件代理服务器和通用的<code>TCP/UDP</code>代理服务器，最初由俄罗斯程序员<code>Igor Sysoev</code>所开发。</p>
<p>详细介绍可以参见：<br><a href="http://nginx.org/en/" target="_blank" rel="noopener">http://nginx.org/en/</a><br><a href="http://nginx.org/en/docs/" target="_blank" rel="noopener">http://nginx.org/en/docs/</a></p>
<p>本文将说下<code>nginx</code>的简单安装使用，因为在项目中要使用到的。我在虚拟机VirtualBox中的机器中安装，系统为<code>Ubuntu Linux</code>，机器节点相关配置如下（之前安装过Hadoop集群的机器）：</p>
<pre><code>master：
    ip: 192.168.56.110
    hostname: hadoop-host-master
</code></pre><p>首先，我们要将<code>nginx</code>的安装包下载回来，截止本文写时，它的最新稳定版本为<code>1.16.0</code>，可以在它的<a href="http://nginx.org/download/nginx-1.16.0.tar.gz" target="_blank" rel="noopener">官网</a>下载。我先在我的物理机器下载回来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/Downloads/</span><br><span class="line">$ wget http://nginx.org/download/nginx-1.16.0.tar.gz</span><br><span class="line">$ wget http://nginx.org/download/nginx-1.16.0.tar.gz.asc</span><br><span class="line"></span><br><span class="line">验证下载文件的完整性，这里略</span><br></pre></td></tr></table></figure>
<p>在物理机上将它传到要安装的机器<code>hadoop-host-master</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ scp nginx-1.16.0.tar.gz hadoop@hadoop-host-master:~/</span><br></pre></td></tr></table></figure></p>
<p>接下来，我们进入<code>hadoop-host-master</code>中操作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ ssh hadoop@hadoop-host-master</span><br><span class="line"></span><br><span class="line">$ tar xf nginx-1.16.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> nginx-1.16.0/</span><br><span class="line">$ ls</span><br><span class="line">auto  CHANGES  CHANGES.ru  conf  configure  contrib  html  LICENSE  man  README  src</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ sudo ./configure --with-http_stub_status_module --with-http_ssl_module --with-http_realip_module</span><br><span class="line">checking <span class="keyword">for</span> OS</span><br><span class="line"> + Linux 4.15.0-39-generic x86_64</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">中间省略部分</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Configuration summary</span><br><span class="line">  + using system PCRE library</span><br><span class="line">  + OpenSSL library is not used</span><br><span class="line">  + using system zlib library</span><br><span class="line"></span><br><span class="line">  nginx path prefix: <span class="string">"/usr/local/nginx"</span></span><br><span class="line">  nginx binary file: <span class="string">"/usr/local/nginx/sbin/nginx"</span></span><br><span class="line">  nginx modules path: <span class="string">"/usr/local/nginx/modules"</span></span><br><span class="line">  nginx configuration prefix: <span class="string">"/usr/local/nginx/conf"</span></span><br><span class="line">  nginx configuration file: <span class="string">"/usr/local/nginx/conf/nginx.conf"</span></span><br><span class="line">  nginx pid file: <span class="string">"/usr/local/nginx/logs/nginx.pid"</span></span><br><span class="line">  nginx error <span class="built_in">log</span> file: <span class="string">"/usr/local/nginx/logs/error.log"</span></span><br><span class="line">  nginx http access <span class="built_in">log</span> file: <span class="string">"/usr/local/nginx/logs/access.log"</span></span><br><span class="line">  nginx http client request body temporary files: <span class="string">"client_body_temp"</span></span><br><span class="line">  nginx http proxy temporary files: <span class="string">"proxy_temp"</span></span><br><span class="line">  nginx http fastcgi temporary files: <span class="string">"fastcgi_temp"</span></span><br><span class="line">  nginx http uwsgi temporary files: <span class="string">"uwsgi_temp"</span></span><br><span class="line">  nginx http scgi temporary files: <span class="string">"scgi_temp"</span></span><br></pre></td></tr></table></figure></p>
<p>在<code>./configure</code>过程中会检查依赖的缺失情况，如果有缺失，则会在这里提示。我们根据提示安装即可。</p>
<p>一般来说，nginx编译会依赖：zlib、zlib-devel、openssl、openssl-devel、pcre、pcre-devel、gcc、g++</p>
<p>在CentOS上可以通过以下方式进行安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install zlib zlib-devel openssl openssl-devel pcre pcre-devel</span><br></pre></td></tr></table></figure></p>
<p>而在Ubuntu上面则可以通过下面的方式进行安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install build-essential    这会同时安装 gcc、g++</span><br><span class="line">$ sudo apt-get install zlib1g</span><br><span class="line">$ sudo apt-get install openssl libssl-dev</span><br><span class="line">$ sudo apt-get install libpcre3 libpcre3-dev</span><br><span class="line">$ sudo apt-get install zlib1g-dev</span><br></pre></td></tr></table></figure></p>
<p>接下来进行编译安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">objs/ngx_modules.o \</span><br><span class="line">-ldl -lpthread -lcrypt -lpcre -lz \</span><br><span class="line">-Wl,-E</span><br><span class="line">sed -e <span class="string">"s|%%PREFIX%%|/usr/local/nginx|"</span> \</span><br><span class="line">	-e <span class="string">"s|%%PID_PATH%%|/usr/local/nginx/logs/nginx.pid|"</span> \</span><br><span class="line">	-e <span class="string">"s|%%CONF_PATH%%|/usr/local/nginx/conf/nginx.conf|"</span> \</span><br><span class="line">	-e <span class="string">"s|%%ERROR_LOG_PATH%%|/usr/local/nginx/logs/error.log|"</span> \</span><br><span class="line">	&lt; man/nginx.8 &gt; objs/nginx.8</span><br><span class="line">make[1]: Leaving directory <span class="string">'/home/hadoop/nginx-1.16.0'</span></span><br></pre></td></tr></table></figure></p>
<p>它默认会安装到<code>/usr/local/nginx/</code>目录下。</p>
<p>启动命令如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /usr/<span class="built_in">local</span>/nginx/sbin/nginx -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure></p>
<p><strong>注意：使用<code>-c</code>参数指定配置文件一定要使用绝对路径，否则可能会报错。</strong></p>
<p>修改配置文件后，检查配置文件是否正确的命令如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">nginx: the configuration file /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br></pre></td></tr></table></figure></p>
<p>可以打开 <a href="http://192.168.56.110/" target="_blank" rel="noopener">http://192.168.56.110/</a> 来看看是否已启动。</p>
<p><img src="/img/nginx-1.png" alt="" title="nginx 初始启动界面"></p>
<p>另外，使用 <a href="http://hadoop-host-master/" target="_blank" rel="noopener">http://hadoop-host-master/</a> 也是一样的。</p>
<p><img src="/img/nginx-2.png" alt="" title="nginx 初始启动界面"></p>
<p>当你看到上面的界面后，nginx的安装到这里就成功了。</p>
<h3 id="一些常用操作命令"><a href="#一些常用操作命令" class="headerlink" title="一些常用操作命令"></a>一些常用操作命令</h3><p>进入nginx的安装目录，这里进入默认安装目录，然后查看帮助信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nginx/sbin</span><br><span class="line">$ ./nginx -h</span><br><span class="line"></span><br><span class="line">nginx version: nginx/1.16.0</span><br><span class="line">Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -?,-h         : this <span class="built_in">help</span></span><br><span class="line">  -v            : show version and <span class="built_in">exit</span></span><br><span class="line">  -V            : show version and configure options <span class="keyword">then</span> <span class="built_in">exit</span></span><br><span class="line">  -t            : <span class="built_in">test</span> configuration and <span class="built_in">exit</span></span><br><span class="line">  -T            : <span class="built_in">test</span> configuration, dump it and <span class="built_in">exit</span></span><br><span class="line">  -q            : suppress non-error messages during configuration testing</span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class="line">  -p prefix     : <span class="built_in">set</span> prefix path (default: /usr/<span class="built_in">local</span>/nginx/)</span><br><span class="line">  -c filename   : <span class="built_in">set</span> configuration file (default: conf/nginx.conf)</span><br><span class="line">  -g directives : <span class="built_in">set</span> global directives out of configuration file</span><br></pre></td></tr></table></figure></p>
<p>说明如下：</p>
<ol>
<li>启动命令： <code>./nginx</code>；</li>
<li>关闭命令： <code>./nginx -s stop</code>，快速停止nginx，可能并不保存相关信息；</li>
<li>退出命令： <code>./nginx -s quit</code>，完整有序的停止nginx，会保存相关信息，建议使用此命令；</li>
<li>动态加载配置文件： <code>./nginx -s reload</code>可以不关闭nginx的情况下更新配置文件；</li>
<li>重新打开日志文件：<code>./nginx -s reopen</code>；</li>
<li>查看Nginx版本： <code>./nginx -v</code>；</li>
<li>检查配置文件是否正确： <code>./nginx -t</code>或者检查指定配置文件<code>./nginx -t -c /usr/local/nginx/conf/nginx.conf</code>。</li>
</ol>
<p>接下来，我们作一些简单的配置示例。但是在开始之前，在执行访问的机器上面（在这里是我的物理机器），配置一下HOST，<strong>增加</strong>下面这3行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/hosts</span><br><span class="line"></span><br><span class="line">192.168.56.110 www.hewentian.com</span><br><span class="line">192.168.56.110 admin.hewentian.com</span><br><span class="line">192.168.56.110 img.hewentian.com</span><br><span class="line">192.168.56.110 api.hewentian.com</span><br><span class="line">192.168.56.110 so.hewentian.com</span><br></pre></td></tr></table></figure></p>
<h3 id="示例一：将某目录下的图片，让其他机器可以通过WEB访问"><a href="#示例一：将某目录下的图片，让其他机器可以通过WEB访问" class="headerlink" title="示例一：将某目录下的图片，让其他机器可以通过WEB访问"></a>示例一：将某目录下的图片，让其他机器可以通过WEB访问</h3><p>在安装了nginx的机器<code>hadoop-host-master</code>上有个目录<code>/home/hadoop/Pictures</code>，这个目录下放有图片（我的机器里有一张：my_computer.png）。现在想通过web，让其他机器的用户访问这个目录下的图片。</p>
<p>修改<code>nginx.conf</code>配置，添加如下代码即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  img.hewentian.com;                 <span class="comment"># 修改 1/3： WEB访问的位置</span></span><br><span class="line">        access_log  logs/img.access.log  main;          <span class="comment"># 修改 2/3： 日志存放位置。记得将此配置文件中的 log_format  main 前面的注释打开</span></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /home/hadoop/Pictures/;              <span class="comment"># 修改 3/3： 图片存放位置</span></span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>保存文件后，退出。<br>检查配置文件是否正确：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure></p>
<p>然后重启nginx，首先找出nginx进程号：</p>
<pre><code>ps -ef | grep nginx
</code></pre><p>然后杀死nginx的主进程：</p>
<pre><code>sudo kill -9 [nginx进程号]
</code></pre><p>重启nginx</p>
<pre><code>sudo /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
</code></pre><p>在物理机器上面打开浏览器，试着访问： <a href="http://img.hewentian.com/my_computer.png" target="_blank" rel="noopener">http://img.hewentian.com/my_computer.png</a></p>
<p><img src="/img/nginx-3.png" alt="" title="nginx 作为图片服务器"></p>
<p>查看nginx访问日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ tail /usr/<span class="built_in">local</span>/nginx/logs/img.access.log</span><br><span class="line"></span><br><span class="line">192.168.56.1 - - [11/Jun/2019:22:46:33 +0800] <span class="string">"GET / HTTP/1.1"</span> 403 555 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [11/Jun/2019:22:46:50 +0800] <span class="string">"GET /my_computer.png HTTP/1.1"</span> 200 59332 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [11/Jun/2019:22:47:21 +0800] <span class="string">"GET /my_computer.png HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:00:51:04 +0800] <span class="string">"GET /my_computer.png HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:00:51:04 +0800] <span class="string">"GET /my_computer.png HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:00:51:04 +0800] <span class="string">"GET /my_computer.png HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:00:51:05 +0800] <span class="string">"GET /my_computer.png HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:01:02:06 +0800] <span class="string">"GET /my_computer.png HTTP/1.1"</span> 304 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="示例二：实现简单的负载匀衡"><a href="#示例二：实现简单的负载匀衡" class="headerlink" title="示例二：实现简单的负载匀衡"></a>示例二：实现简单的负载匀衡</h3><p>有个应用，它有个接口<code>/hello</code>，是返回当前服务器的IP地址。我是使用SpringBoot来简单开发的，代码只有几行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hewentian.web.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;HelloController&lt;/b&gt; 是 返回当前服务器IP地址的Controller</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href="mailto:wentian.he@qq.com"&gt;hewentian&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-06-12 14:52:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> JDK 1.8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> Logger log = Logger.getLogger(HelloController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String address = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InetAddress inetAddress = InetAddress.getLocalHost();</span><br><span class="line">            address = inetAddress.getHostAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> address + <span class="string">" is serving for you: Hello World"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>部署在下面的2台服务器上，都是监听8080端口。</p>
<pre><code>slave1:
    ip: 192.168.56.111
    hostname: hadoop-host-slave-1
slave2:
    ip: 192.168.56.112
    hostname: hadoop-host-slave-2
</code></pre><p>现在想在网页上访问：<a href="http://192.168.56.110" target="_blank" rel="noopener">http://192.168.56.110</a> 或 <a href="http://api.hewentian.com" target="_blank" rel="noopener">http://api.hewentian.com</a> 的时候，就会访问到上面这2台机器，实现负载均衡。</p>
<p>修改<code>nginx.conf</code>配置，添加如下代码即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">upstream api_worker &#123;</span><br><span class="line">    server 192.168.56.111:8080 weight=3000;</span><br><span class="line">    server 192.168.56.112:8080 weight=3000;</span><br><span class="line">    keepalive 2000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name 192.168.56.110  api.hewentian.com;</span><br><span class="line">    access_log  logs/api.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://api_worker/;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重启nginx。正常情况下，流量会匀衡地分到2台服务器，如下图所示。<br><img src="/img/nginx-4.png" alt="" title="nginx 作为负载匀衡服务器"><br><img src="/img/nginx-5.png" alt="" title="nginx 作为负载匀衡服务器"></p>
<p>如果两台机器中的某一台挂掉了，流量会自动分到另外一台，这样也实现了简单的高可用。</p>
<p>查看nginx访问日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ tail /usr/<span class="built_in">local</span>/nginx/logs/api.access.log </span><br><span class="line"></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /hello HTTP/1.1"</span> 200 46 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /favicon.ico HTTP/1.1"</span> 200 946 <span class="string">"http://api.hewentian.com/hello"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /hello HTTP/1.1"</span> 200 46 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /favicon.ico HTTP/1.1"</span> 200 946 <span class="string">"http://api.hewentian.com/hello"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /hello HTTP/1.1"</span> 200 46 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /favicon.ico HTTP/1.1"</span> 200 946 <span class="string">"http://api.hewentian.com/hello"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /hello HTTP/1.1"</span> 200 46 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /favicon.ico HTTP/1.1"</span> 200 946 <span class="string">"http://api.hewentian.com/hello"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /hello HTTP/1.1"</span> 200 46 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line">192.168.56.1 - - [12/Jun/2019:02:46:52 +0800] <span class="string">"GET /favicon.ico HTTP/1.1"</span> 200 946 <span class="string">"http://api.hewentian.com/hello"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="示例三：实现同一个域名下的两个服务"><a href="#示例三：实现同一个域名下的两个服务" class="headerlink" title="示例三：实现同一个域名下的两个服务"></a>示例三：实现同一个域名下的两个服务</h3><p>有两个服务：<br>一个是一个WEB服务，是指向另一台机器的，其中<code>/hello</code>是一个接口：<br><a href="http://www.hewentian.com/api/hello" target="_blank" rel="noopener">http://www.hewentian.com/api/hello</a></p>
<p>另一个是用来看某个目录下的图片的：<br><a href="http://www.hewentian.com/img/my_computer.png" target="_blank" rel="noopener">http://www.hewentian.com/img/my_computer.png</a></p>
<p>修改<code>nginx.conf</code>配置，添加如下代码即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">upstream api_worker &#123;</span><br><span class="line">    server 192.168.56.111:8080 weight=3000;</span><br><span class="line">    keepalive 2000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name www.hewentian.com;</span><br><span class="line">  </span><br><span class="line">    location / &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    location /api/ &#123;</span><br><span class="line">        proxy_pass http://api_worker/;</span><br><span class="line">        <span class="comment">#proxy_redirect off;</span></span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="comment">#proxy_http_version 1.1;</span></span><br><span class="line">        <span class="comment">#proxy_set_header Connection "";</span></span><br><span class="line">        access_log  logs/api.access.log  main;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /img/ &#123;</span><br><span class="line">        <span class="built_in">alias</span> /home/hadoop/Pictures/;</span><br><span class="line">        access_log  logs/img.access.log  main;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重启nginx。访问上述地址，将得到如下图效果：</p>
<p><img src="/img/nginx-6.png" alt="" title="nginx 实现同一个域名下的两个服务"></p>
<p><img src="/img/nginx-7.png" alt="" title="nginx 实现同一个域名下的两个服务"></p>
<p>查看nginx访问日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tail -n1 /usr/<span class="built_in">local</span>/nginx/logs/api.access.log /usr/<span class="built_in">local</span>/nginx/logs/img.access.log </span><br><span class="line"></span><br><span class="line">==&gt; /usr/<span class="built_in">local</span>/nginx/logs/api.access.log &lt;==</span><br><span class="line">192.168.56.1 - - [12/Jun/2019:04:09:55 +0800] <span class="string">"GET /api/hello HTTP/1.1"</span> 200 46 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br><span class="line"></span><br><span class="line">==&gt; /usr/<span class="built_in">local</span>/nginx/logs/img.access.log &lt;==</span><br><span class="line">192.168.56.1 - - [12/Jun/2019:04:08:04 +0800] <span class="string">"GET /img/my_computer.png HTTP/1.1"</span> 200 59332 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.75 Safari/537.36"</span> <span class="string">"-"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="示例四：静态HTML项目、WEB接口项目并存和Tomcat项目"><a href="#示例四：静态HTML项目、WEB接口项目并存和Tomcat项目" class="headerlink" title="示例四：静态HTML项目、WEB接口项目并存和Tomcat项目"></a>示例四：静态HTML项目、WEB接口项目并存和Tomcat项目</h3><p>有三个服务：</p>
<ol>
<li><p>第一个是一个WEB服务，是指向另一台机器的，其中<code>/hello</code>是一个接口，另外此WEB项目包含静态HTML代码：<br><a href="http://www.hewentian.com/index.html" target="_blank" rel="noopener">http://www.hewentian.com/index.html</a>  <strong>最后的 /index.html不能少</strong><br><a href="http://www.hewentian.com/hello" target="_blank" rel="noopener">http://www.hewentian.com/hello</a></p>
</li>
<li><p>第二个也是一个WEB服务，是指向另一台机器的，其中<code>/hello</code>是一个接口，另外此WEB项目包含静态HTML代码：<br><a href="http://admin.hewentian.com/index.html" target="_blank" rel="noopener">http://admin.hewentian.com/index.html</a>  <strong>最后的 /index.html不能少</strong><br><a href="http://admin.hewentian.com/hello" target="_blank" rel="noopener">http://admin.hewentian.com/hello</a></p>
</li>
<li><p>第三个是Tomcat中的一个WEB项目：<br><a href="http://so.hewentian.com" target="_blank" rel="noopener">http://so.hewentian.com</a></p>
</li>
</ol>
<p>修改<code>nginx.conf</code>配置，添加如下代码即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  www.hewentian.com;</span><br><span class="line">    access_log  logs/www.access.log  main;</span><br><span class="line"></span><br><span class="line">    location ~* (.html|.js|.css|.png|.jpg|.gif|.ico|.woff|.ttf|.woff2)$ &#123;</span><br><span class="line">        root	/home/hadoop/www-hewentian;</span><br><span class="line">        index	main.html index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass   http://192.168.56.111:8080;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  admin.hewentian.com;</span><br><span class="line">    access_log  logs/admin.access.log  main;</span><br><span class="line"></span><br><span class="line">    location ~* (.html|.js|.css|.png|.jpg|.gif|.ico|.woff|.ttf|.woff2)$ &#123;</span><br><span class="line">        root 	/home/hadoop/admin-hewentian;</span><br><span class="line">        index  	main.html index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass   http://192.168.56.112:8080;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  so.hewentian.com;</span><br><span class="line">    access_log  logs/so.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass   http://192.168.56.111:8082/so/; <span class="comment"># 注意：最后的/不能少，具体位置： /home/hadoop/apache-tomcat-8.0.47/webapps/so</span></span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="示例五：同一个Tomcat下的两个项目"><a href="#示例五：同一个Tomcat下的两个项目" class="headerlink" title="示例五：同一个Tomcat下的两个项目"></a>示例五：同一个Tomcat下的两个项目</h3><p>有三个服务：</p>
<ol>
<li><p>第一个是一个WEB服务：<br><a href="http://www.hewentian.com/so/" target="_blank" rel="noopener">http://www.hewentian.com/so/</a></p>
</li>
<li><p>第二个也是一个WEB服务，和第一个项目在同一个Tomcat中：<br><a href="http://www.hewentian.com/smswzl/" target="_blank" rel="noopener">http://www.hewentian.com/smswzl/</a></p>
</li>
<li><p>第三个是统计nginx状态的功能，需要安装<code>./configure --with-http_stub_status_module</code>模块，并重新编译安装nginx：<br><a href="http://www.hewentian.com/nginxstatus" target="_blank" rel="noopener">http://www.hewentian.com/nginxstatus</a></p>
</li>
</ol>
<p>修改<code>nginx.conf</code>配置，添加如下代码即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">gzip  on;</span><br><span class="line">gzip_min_length  1k;</span><br><span class="line">gzip_buffers     4 16k;</span><br><span class="line">gzip_http_version 1.0;</span><br><span class="line">gzip_comp_level 2;</span><br><span class="line">gzip_types       text/plain application/x-javascript text/css application/xml;</span><br><span class="line">gzip_vary on;</span><br><span class="line"></span><br><span class="line">upstream tomcatServer &#123;</span><br><span class="line">    server 192.168.56.111:8082;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.hewentian.com;</span><br><span class="line">    charset utf-8;</span><br><span class="line"></span><br><span class="line">    root	/home/hadoop/www-hewentian;</span><br><span class="line">    index	main.html index.html index.htm;</span><br><span class="line"></span><br><span class="line">    access_log logs/www.access.log  combined;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#expires</span></span><br><span class="line">    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$ &#123;</span><br><span class="line">        expires 30d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ .*\.(js|css)?$ &#123;</span><br><span class="line">        expires 24h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /nginxstatus &#123;</span><br><span class="line">        stub_status on;</span><br><span class="line">        access_log off;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /so &#123;</span><br><span class="line">        index index.html;</span><br><span class="line">        proxy_pass http://tomcatServer/so;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /smswzl &#123;</span><br><span class="line">        index index.html;</span><br><span class="line">        proxy_pass http://tomcatServer/smswzl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="示例六：服务器使用nginx做代理，通过HttpServletRequest获取请求用户的真实IP地址"><a href="#示例六：服务器使用nginx做代理，通过HttpServletRequest获取请求用户的真实IP地址" class="headerlink" title="示例六：服务器使用nginx做代理，通过HttpServletRequest获取请求用户的真实IP地址"></a>示例六：服务器使用nginx做代理，通过HttpServletRequest获取请求用户的真实IP地址</h3><pre><code>在使用nginx做代理时，服务端如果直接从`X-Forwarded-For`头部获取来源IP，将获取到nginx所在的ip
</code></pre><p>地址，而不是请求的真实ip地址。那么，如何获取请求的真实IP地址？</p>
<pre><code>首先，在nginx执行`./configure`的时候一定要加上`--with-http_realip_module`模块，然后在nginx
</code></pre><p>的配置中添加如下配置。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /api/userinfo &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:8081/api/userinfo;</span><br><span class="line">    proxy_set_header Host      <span class="variable">$host</span>;</span><br><span class="line">    proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在nginx中将请求来源IP添加到代理请求头部，然后使用命令重新加载配置</p>
<pre><code>nginx -s reload
</code></pre><p>服务端使用以下代码即可获取请求主机真实IP地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getRealIP</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (String head : Arrays.asList(<span class="string">"X-Forwarded-For"</span>, <span class="string">"X-Real-IP"</span>)) &#123;</span><br><span class="line">        String ip = request.getHeader(head);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(ip)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"&#123;&#125; : &#123;&#125;"</span>, head, ip);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> index = ip.indexOf(<span class="string">','</span>);</span><br><span class="line">        <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</span><br><span class="line">            ip = ip.substring(<span class="number">0</span>, index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ip.trim();  <span class="comment">// 一般从 X-Forwarded-For 中即可获取并返回</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2019/06/10/nginx-note/" data-id="clf9thvmo002i6h3kg4zpodrw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">bigdata</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/container/">container</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-server/">web server</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/03/07/xxl-job-note/">xxl-job 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/11/28/seata-note/">seata 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/09/25/spring-note/">spring 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/04/01/mybatis-note/">mybatis 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/01/22/canal-note/">canal 学习笔记</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">link</h3>
    <div class="widget">
      <li><a href="https://github.com/hewentian" title="Tim Ho's Blog">我的github</a></li>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 Tim Ho<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/categories/" class="mobile-nav-link">Categories</a>
  
    <a href="/tags/" class="mobile-nav-link">Tags</a>
  
    <a href="/about/" class="mobile-nav-link">About</a>
  
</nav>
    

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<!-- <script src="//code.jquery.com/jquery-2.2.4.min.js"></script> -->
<script src="/js/jquery-3.5.1.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>