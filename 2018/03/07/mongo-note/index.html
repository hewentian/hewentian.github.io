<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>mongo 学习笔记 | Tim Ho&#39;s Technology Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="安装mongodb数据库首先，我们必须安装mongodb，这样才能使用。我们下载相应版本的mongodb，因为我的笔记本电脑是ubuntu，所以我下载mongodb的tgz版本，下载地址如下： https://www.mongodb.com/download-center/community 下载之后，得到如下两个文件：mongodb-linux-x86_64-ubuntu1804-4.0.6.t">
<meta name="keywords" content="mongo">
<meta property="og:type" content="article">
<meta property="og:title" content="mongo 学习笔记">
<meta property="og:url" content="https://github.com/hewentian/2018/03/07/mongo-note/index.html">
<meta property="og:site_name" content="Tim Ho&#39;s Technology Blog">
<meta property="og:description" content="安装mongodb数据库首先，我们必须安装mongodb，这样才能使用。我们下载相应版本的mongodb，因为我的笔记本电脑是ubuntu，所以我下载mongodb的tgz版本，下载地址如下： https://www.mongodb.com/download-center/community 下载之后，得到如下两个文件：mongodb-linux-x86_64-ubuntu1804-4.0.6.t">
<meta property="og:locale" content="en-US">
<meta property="og:updated_time" content="2020-03-16T01:55:41.621Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mongo 学习笔记">
<meta name="twitter:description" content="安装mongodb数据库首先，我们必须安装mongodb，这样才能使用。我们下载相应版本的mongodb，因为我的笔记本电脑是ubuntu，所以我下载mongodb的tgz版本，下载地址如下： https://www.mongodb.com/download-center/community 下载之后，得到如下两个文件：mongodb-linux-x86_64-ubuntu1804-4.0.6.t">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tim Ho&#39;s Technology Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心如止水</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/categories/">Categories</a>
        
          <a class="main-nav-link" href="/tags/">Tags</a>
        
          <a class="main-nav-link" href="/about/">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/hewentian"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-mongo-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/07/mongo-note/" class="article-date">
  <time datetime="2018-03-07T06:39:42.000Z" itemprop="datePublished">2018-03-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/db/">db</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      mongo 学习笔记
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安装mongodb数据库"><a href="#安装mongodb数据库" class="headerlink" title="安装mongodb数据库"></a>安装mongodb数据库</h3><p>首先，我们必须安装mongodb，这样才能使用。我们下载相应版本的mongodb，因为我的笔记本电脑是ubuntu，所以我下载mongodb的tgz版本，下载地址如下：</p>
<pre><code>https://www.mongodb.com/download-center/community
</code></pre><p>下载之后，得到如下两个文件：<br>mongodb-linux-x86_64-ubuntu1804-4.0.6.tgz<br>mongodb-linux-x86_64-ubuntu1804-4.0.6.tgz.md5</p>
<p>mongodb依赖libcurl4、openssl，我们必须先安装这两个依赖包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">如已安装，则可跳过，验证命令如下</span><br><span class="line">$ dpkg -s libcurl4</span><br><span class="line">$ dpkg -s openssl</span><br><span class="line"></span><br><span class="line">安装命令</span><br><span class="line">$ sudo apt-get install libcurl4 openssl</span><br></pre></td></tr></table></figure></p>
<p>我们将压缩包下载到<code>/home/hewentian/ProjectD</code>目录，然后解压：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD</span><br><span class="line">$ tar xf mongodb-linux-x86_64-ubuntu1804-4.0.6.tgz</span><br><span class="line">$</span><br><span class="line">$ ls mongodb-linux-x86_64-ubuntu1804-4.0.6/</span><br><span class="line">bin  LICENSE-Community.txt  MPL-2  README  THIRD-PARTY-NOTICES</span><br></pre></td></tr></table></figure></p>
<p>创建data目录和log目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD</span><br><span class="line">$ mkdir -p db/mongodb/data</span><br><span class="line">$ mkdir -p db/mongodb/<span class="built_in">log</span></span><br></pre></td></tr></table></figure></p>
<p>创建mongod.conf配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/</span><br><span class="line">$ vi mongod.conf</span><br></pre></td></tr></table></figure></p>
<p>并在其中输入如下内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line">storage:</span><br><span class="line">  dbPath: /home/hewentian/ProjectD/db/mongodb/data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /home/hewentian/ProjectD/db/mongodb/<span class="built_in">log</span>/mongod.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 127.0.0.1</span><br><span class="line"><span class="comment">#  bindIp: 0.0.0.0  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line">  pidFilePath: /home/hewentian/ProjectD/db/mongodb/mongod.pid  <span class="comment"># location of pidfile</span></span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line"></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#  authorization: enabled</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Enterprise-Only Options:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure></p>
<h3 id="启动mongodb"><a href="#启动mongodb" class="headerlink" title="启动mongodb"></a>启动mongodb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/bin</span><br><span class="line">$ ./mongod -f ../mongod.conf</span><br><span class="line"></span><br><span class="line">about to fork child process, waiting until server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 24049</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>
<h3 id="停止mongodb"><a href="#停止mongodb" class="headerlink" title="停止mongodb"></a>停止mongodb</h3><p>不要直接通过kill命令杀掉mongodb的进程，而应通过它官方提供的关闭脚本，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/bin</span><br><span class="line">$ ./mongod -f ../mongod.conf --shutdown</span><br><span class="line"></span><br><span class="line">killing process with pid: 24049</span><br></pre></td></tr></table></figure></p>
<h3 id="配置登录用户名和密码"><a href="#配置登录用户名和密码" class="headerlink" title="配置登录用户名和密码"></a>配置登录用户名和密码</h3><p>要开启密码登录，首先要将mongod.conf中的以下选项打开：</p>
<pre><code>security:
  authorization: enabled
</code></pre><p>然后重启mongodb服务。</p>
<ol>
<li><p>添加管理员<br>使用mongo命令进入命令行交互模式，创建第一个用户admin，该用户需要有用户管理权限，其角色为root。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/bin</span><br><span class="line">$ ./bin/mongo --host 127.0.0.1</span><br><span class="line">MongoDB shell version v4.0.6</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">"id"</span> : UUID(<span class="string">"cbd0445f-667b-4d2a-92a8-66f8ad1d07ef"</span>) &#125;</span><br><span class="line">MongoDB server version: 4.0.6</span><br><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">&gt; db.createUser(&#123;user:<span class="string">"admin"</span>,<span class="built_in">pwd</span>:<span class="string">"12345"</span>,roles:[<span class="string">"root"</span>]&#125;)</span><br><span class="line">Successfully added user: &#123; <span class="string">"user"</span> : <span class="string">"admin"</span>, <span class="string">"roles"</span> : [ <span class="string">"root"</span> ] &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; show collections</span><br><span class="line">Warning: unable to run listCollections, attempting to approximate collection names by parsing connectionStatus</span><br><span class="line">&gt; db.auth(<span class="string">"admin"</span>,<span class="string">"12345"</span>)</span><br><span class="line">1</span><br><span class="line">&gt; show collections</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加数据库用户<br>为数据库添加用户，添加用户前需要切换到该数据库，这里简单设置其角色为dbOwner</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; use bfg</span><br><span class="line">switched to db bfg</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">"bfg"</span>, <span class="built_in">pwd</span>: <span class="string">"bfg100"</span>, roles: [&#123; role: <span class="string">"dbOwner"</span>, db: <span class="string">"bfg"</span> &#125;]&#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">	<span class="string">"user"</span> : <span class="string">"bfg"</span>,</span><br><span class="line">	<span class="string">"roles"</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"role"</span> : <span class="string">"dbOwner"</span>,</span><br><span class="line">			<span class="string">"db"</span> : <span class="string">"bfg"</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这样，bfg的用户就只能访问bfg这个库了，登录方式如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/mongo --host 127.0.0.1</span><br><span class="line">MongoDB shell version v4.0.6</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">"id"</span> : UUID(<span class="string">"873114cf-fb7e-436a-b939-7e765dbecee9"</span>) &#125;</span><br><span class="line">MongoDB server version: 4.0.6</span><br><span class="line">&gt; use bfg</span><br><span class="line">switched to db bfg</span><br><span class="line">&gt; db.auth(<span class="string">"bfg"</span>,<span class="string">"bfg100"</span>)</span><br><span class="line">1</span><br><span class="line">&gt; show dbs</span><br><span class="line">bfg  0.000GB</span><br></pre></td></tr></table></figure></p>
<p>至此，数据库安装完毕（此安装过程2019年初才补上）。</p>
<h3 id="shell命令行方式连接到mongodb"><a href="#shell命令行方式连接到mongodb" class="headerlink" title="shell命令行方式连接到mongodb"></a>shell命令行方式连接到mongodb</h3><p>连接到单机：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo --host 192.168.1.111:27017 --authenticationDatabase user_database -u user_name -p user_password</span><br></pre></td></tr></table></figure></p>
<p>连接到单机中的指定数据库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017/user_database"</span> --authenticationDatabase user_database -u user_name -p user_password</span><br></pre></td></tr></table></figure></p>
<p>连接到副本集：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017,192.168.1.112:27017/user_database?replicaSet=mgset-9527&amp;readPreference=secondaryPreferred"</span> --authenticationDatabase user_database -u user_name -p user_password</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb查询数组大小"><a href="#mongodb查询数组大小" class="headerlink" title="mongodb查询数组大小"></a>mongodb查询数组大小</h3><p>mongodb查询数组大小使用<code>$size</code>，例如：我们有一个名为<code>person</code>的集合，其中有个字段为<code>childrenNames</code>，是数组类型，如果我们要查询<code>childrenNames</code>长度为2的数据，则查询语句为：</p>
<pre><code>db.getCollection(&apos;person&apos;).find({&apos;childrenNames&apos;:{&apos;$size&apos;:2}})
</code></pre><p>但是它不能限定数组的大小范围，只能查询指定的长度。要查询数组范围，我们使用<code>$exists</code>，例如：查询数组长度大于等于3的语句如下（检查数组第3个元素是否存了）</p>
<pre><code>db.getCollection(&apos;person&apos;).find({&apos;childrenNames.2&apos;:{&apos;$exists&apos;:1}})
</code></pre><h3 id="mongodb分组查询"><a href="#mongodb分组查询" class="headerlink" title="mongodb分组查询"></a>mongodb分组查询</h3><p>如果我们要对集合<code>person</code>中的地区字段<code>area</code>来分组统计，语法如下：</p>
<pre><code>db.getCollection(&apos;person&apos;).aggregate({&apos;$group&apos;:{&apos;_id&apos;:&apos;$area&apos;,&apos;count&apos;:{&apos;$sum&apos;:1}}})
</code></pre><p>如果我们还想将分组统计结果，按数量倒序输出显示：</p>
<pre><code>db.getCollection(&apos;person&apos;).aggregate([{&apos;$group&apos;:{&apos;_id&apos;:&apos;$area&apos;,&apos;count&apos;:{&apos;$sum&apos;:1}}},{&apos;$sort&apos;:{&apos;count&apos;:-1}}])
</code></pre><p>对应的JAVA代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MongoDatabase mongoDatabase = MongoUtil.getMongoDatabase(); <span class="comment">// 这个是我自已写的工具类</span></span><br><span class="line">MongoCollection&lt;Document&gt; personCollection = mongoDatabase.getCollection(<span class="string">"person"</span>);</span><br><span class="line"></span><br><span class="line">List&lt;BasicDBObject&gt; pipeline = <span class="keyword">new</span> ArrayList&lt;BasicDBObject&gt;();</span><br><span class="line">pipeline.add(<span class="keyword">new</span> BasicDBObject(<span class="string">"$group"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="string">"$area"</span>).append(<span class="string">"count"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"$sum"</span>, <span class="number">1</span>))));</span><br><span class="line">pipeline.add(<span class="keyword">new</span> BasicDBObject(<span class="string">"$sort"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"count"</span>, -<span class="number">1</span>))); <span class="comment">// 如果不要排序，则注释这一行</span></span><br><span class="line"></span><br><span class="line">AggregateIterable&lt;Document&gt; aggregate = personCollection.aggregate(pipeline);</span><br><span class="line">MongoCursor&lt;Document&gt; iterator = aggregate.iterator();</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb更新部分字段"><a href="#mongodb更新部分字段" class="headerlink" title="mongodb更新部分字段"></a>mongodb更新部分字段</h3><p>例如我们要将<code>person</code>中<code>_id</code>为<code>123</code>的数据的<code>address</code>修改为：广东，语句如下：</p>
<pre><code>db.getCollection(&apos;person&apos;).update({&apos;_id&apos;:&apos;123&apos;},{$set:{&apos;address&apos;:&apos;广东&apos;}})
</code></pre><h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><p>删除数据的时候，要注意条件为null的情况，这在组成json条件的时候，会变成{}，这会将整个库的数据都删掉，这个要避免。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MongoCollection&lt;Document&gt; mongoCollection = <span class="keyword">null</span>; <span class="comment">// 这里不建连接，仅演示</span></span><br><span class="line">JSONArray userNames = <span class="keyword">new</span> JSONArray();</span><br><span class="line"><span class="keyword">for</span> (String userName : Arrays.asList(<span class="string">""</span>, <span class="keyword">null</span>, <span class="string">"xiao ming"</span>)) &#123;</span><br><span class="line">    JSONObject obj = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    obj.put(<span class="string">"userName"</span>, userName);</span><br><span class="line">    userNames.add(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JSONObject condition = <span class="keyword">new</span> JSONObject();</span><br><span class="line">condition.put(<span class="string">"$or"</span>, userNames);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除原有的数据</span></span><br><span class="line">log.info(<span class="string">"删除的语句为："</span> + condition); <span class="comment">// &#123;"$or":[&#123;"userName":""&#125;,&#123;&#125;,&#123;"userName":"xiao ming"&#125;]&#125;</span></span><br><span class="line">DeleteResult deleteResult = mongoCollection.deleteMany(BsonDocument.parse(condition.toJSONString()));</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">"======mongo删除原有的数据条数：======"</span> + deleteResult.getDeletedCount());</span><br></pre></td></tr></table></figure></p>
<h3 id="导出、导入数据库"><a href="#导出、导入数据库" class="headerlink" title="导出、导入数据库"></a>导出、导入数据库</h3><h4 id="我们使用mongoexport来导出指定的collection"><a href="#我们使用mongoexport来导出指定的collection" class="headerlink" title="我们使用mongoexport来导出指定的collection"></a>我们使用<code>mongoexport</code>来导出指定的<code>collection</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把一个<code>collection</code>导出成JSON或CSV格式的文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongoexport -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; -c &#123;COLLECTION_NAME&#125; -o &#123;EXPORT_FILE_PATH&#125; --<span class="built_in">type</span> json/csv -f fields</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	-c: collection名</span><br><span class="line">	-o: 输出的文件名</span><br><span class="line">	--<span class="built_in">type</span>: 输出的格式，默认为json</span><br><span class="line">	-f: 输出的字段，如果-<span class="built_in">type</span>为csv，则需要加上-f <span class="string">"字段名"</span></span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">$ mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.json</span><br><span class="line">$ mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.json --<span class="built_in">type</span> json -f  <span class="string">"_id,name"</span></span><br><span class="line">$ mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.csv --<span class="built_in">type</span> csv -f  <span class="string">"_id,name"</span></span><br></pre></td></tr></table></figure></p>
<h4 id="我们使用mongoimport来导入指定的collection"><a href="#我们使用mongoimport来导入指定的collection" class="headerlink" title="我们使用mongoimport来导入指定的collection"></a>我们使用<code>mongoimport</code>来导入指定的<code>collection</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把一个json/csv文件导入到指定的<code>collection</code>中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongoimport -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; -c &#123;COLLECTION_NAME&#125; --file &#123;IMPORT_FILE_PATH&#125; --headerline --<span class="built_in">type</span> json/csv -f fields</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	-c: collection名</span><br><span class="line">	--file: 要导入的文件</span><br><span class="line">	--<span class="built_in">type</span>: input format to import: json, csv, or tsv (defaults to <span class="string">'json'</span>) (default: json)</span><br><span class="line">	--headerline: use first line <span class="keyword">in</span> input <span class="built_in">source</span> as the field list (CSV and TSV only)</span><br><span class="line">	-f: 导入的字段名，CSV或TSV的时候可用</span><br><span class="line"> </span><br><span class="line">示例：</span><br><span class="line">$ mongoimport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user --file /home/hewentian/ProjectD/db/user.json</span><br><span class="line"></span><br><span class="line">注意：--headerline 和 -f 不能同时使用</span><br><span class="line"></span><br><span class="line">	--headerline: 使用CSV文件中首列指定的列名作为导入的name</span><br><span class="line">	-f: 会将CSV文件的所有列，作为数据进行导入，包括第一列的列名（如果文件中有指定列名）</span><br><span class="line"></span><br><span class="line">$ mongoimport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user --file /home/hewentian/ProjectD/db/user.csv --<span class="built_in">type</span> csv --headerline</span><br><span class="line">$ mongoimport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user --file /home/hewentian/ProjectD/db/user.csv --<span class="built_in">type</span> csv -f <span class="string">"_id,name,age"</span></span><br></pre></td></tr></table></figure></p>
<h4 id="我们使用mongodump来导出指定的database"><a href="#我们使用mongodump来导出指定的database" class="headerlink" title="我们使用mongodump来导出指定的database"></a>我们使用<code>mongodump</code>来导出指定的<code>database</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把一个<code>database</code>导出成指定目录下的JSON、BSON的文件集<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongodump -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; -o &#123;DUMP_FILE_PATH&#125;</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	-o: 输出的文件路径，要事先创建该目录，在该目录下会自动创建要导出的数据库作为子目录</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">$ mongodump -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -o /home/hewentian/ProjectD/db/</span><br></pre></td></tr></table></figure></p>
<h4 id="我们使用mongorestore来恢复指定的database"><a href="#我们使用mongorestore来恢复指定的database" class="headerlink" title="我们使用mongorestore来恢复指定的database"></a>我们使用<code>mongorestore</code>来恢复指定的<code>database</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把指定目录下的JSON、BSON的文件集恢复成<code>database</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongorestore -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; --dir &#123;RESTORE_FILE_PATH&#125;</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	--dir: 要恢复的数据库的位置，注意与上面备份的 -o 不同，这里要指定到数据库的目录</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">$ mongorestore -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg --dir /home/hewentian/ProjectD/db/bfg/</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb类型转换"><a href="#mongodb类型转换" class="headerlink" title="mongodb类型转换"></a>mongodb类型转换</h3><p>如下所示，将字符串类型的数据转换为int, double, date类型：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">先插入一条数据，都是字符串类型：</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="string">"20"</span>, <span class="string">"salary"</span>:<span class="string">"30"</span>, <span class="string">"birthday"</span>:<span class="string">"2018-12-21"</span>&#125;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5c45b7099a14ab9807edaa75"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="string">"20"</span>,</span><br><span class="line">    <span class="string">"salary"</span> : <span class="string">"30"</span>,</span><br><span class="line">    <span class="string">"birthday"</span> : <span class="string">"2018-12-21"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">改变字段类型：</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;&#125;).forEach(function(doc) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).updateOne(&#123;_id: doc._id&#125;, &#123;$set: &#123;<span class="string">"age"</span>: NumberInt(doc.age), <span class="string">"salary"</span>: parseInt(doc.salary), <span class="string">"birthday"</span>: <span class="keyword">new</span> ISODate(doc.birthday)&#125;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5c45b7099a14ab9807edaa75"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="number">20</span>,</span><br><span class="line">    <span class="string">"salary"</span> : <span class="number">30.0</span>,</span><br><span class="line">    <span class="string">"birthday"</span> : ISODate(<span class="string">"2018-12-21T00:00:00.000Z"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果要将集合中已有文档的<code>ISODate</code>类型转换成<code>String</code>类型的日期，例如：将<code>updateTime</code>由<code>ISODate(&quot;2019-04-04T07:12:37.295Z&quot;)</code>转换为<code>2019-04-04 07:12:37</code>类型：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"updateTime"</span>:&#123;<span class="string">"$type"</span>:<span class="number">9</span>&#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> mydate = doc.updateTime;</span><br><span class="line">    <span class="keyword">if</span> (mydate) &#123;</span><br><span class="line">        mydate = mydate.toJSON();</span><br><span class="line">        <span class="keyword">if</span> (mydate.length &gt; <span class="number">19</span>) &#123;</span><br><span class="line">            mydate = mydate.substr(<span class="number">0</span>, <span class="number">19</span>)</span><br><span class="line">            mydate = mydate.replace(<span class="string">'T'</span>,<span class="string">' '</span>);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   db.getCollection(<span class="string">'userInfo'</span>).update(&#123;<span class="string">"_id"</span>:doc._id&#125;, &#123;<span class="string">"$set"</span>:&#123;<span class="string">"updateTime"</span>:mydate&#125;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">验证结果：</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>:ObjectId(<span class="string">"5abc7ffc00a32c2b045e598c"</span>)&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="MongoDB的主键类型修改"><a href="#MongoDB的主键类型修改" class="headerlink" title="MongoDB的主键类型修改"></a>MongoDB的主键类型修改</h3><p><strong>主键类型的修改不能像其他字段一样直接修改</strong></p>
<p>将String类型的主键修改为ObjectId类型，在Mongodb中String类型对应的int值为2，<br>我们先增加一条主键为ObjectId记录，然后删除主键为String的记录。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">2</span>&#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    doc._id = ObjectId(doc._id);</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).save(doc);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).remove(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">2</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<p>反之，将ObjectId类型的主键修改为String类型，在Mongodb中ObjectId类型对应的int值为7。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">7</span>&#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    doc._id = doc._id.toJSON().$oid;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).save(doc);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).remove(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">7</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb默认插入类型"><a href="#mongodb默认插入类型" class="headerlink" title="mongodb默认插入类型"></a>mongodb默认插入类型</h3><p>插入的int32整数会默认转为Double类型，若需插入为整数，需指定NumberInt：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="number">20</span>, <span class="string">"salary"</span>:NumberInt(<span class="number">30</span>), <span class="string">"birthday"</span>:<span class="string">"2018-12-21"</span>&#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;&#125;)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5d3815a2a7de52e9fed7bbcf"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="number">20.0</span>,</span><br><span class="line">    <span class="string">"salary"</span> : <span class="number">30</span>,</span><br><span class="line">    <span class="string">"birthday"</span> : <span class="string">"2018-12-21"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb日期查询"><a href="#mongodb日期查询" class="headerlink" title="mongodb日期查询"></a>mongodb日期查询</h3><p>日期的类型不同，查询的方式也不同：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">如果日期的类型为String：</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"insertTime"</span>:&#123;$regex:<span class="string">"2019-01-07 *"</span>&#125;&#125;) <span class="comment">// *号前有个空格</span></span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"insertTime"</span>:&#123;$gte:<span class="string">"2019-02-01 00:00:00"</span>,$lte:<span class="string">"2019-02-11 23:59:59"</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">如果日期的类型为ISODate：</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"insertTime"</span>:&#123;$gte:ISODate(<span class="string">"2019-01-01T00:00:00Z"</span>),$lte:ISODate(<span class="string">"2019-02-11T23:59:59Z"</span>)&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="复制集合"><a href="#复制集合" class="headerlink" title="复制集合"></a>复制集合</h3><p>在复制集合的时候，修改某些值，可以使用javascript实现（建议在mongo shell下执行，这样不容易超时），示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var count=<span class="number">0</span>;</span><br><span class="line">var totalCount = db.getCollection(<span class="string">'user'</span>).count(&#123;&#125;);</span><br><span class="line">var lastId=<span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(count &lt; totalCount) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'user'</span>).find(&#123;<span class="string">"_id"</span>:&#123;<span class="string">"$gt"</span>:lastId&#125;&#125;).sort(&#123;<span class="string">"_id"</span>:<span class="number">1</span>&#125;).limit(<span class="number">100</span>).forEach((doc)=&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (++count % <span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            print(<span class="string">'handling: '</span> + count + <span class="string">' / '</span> + totalCount)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        lastId = doc._id;</span><br><span class="line">        doc._id=doc.regId;</span><br><span class="line">       db.getCollection(<span class="string">'user_new'</span>).save(doc);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="正则表达式的使用"><a href="#正则表达式的使用" class="headerlink" title="正则表达式的使用"></a>正则表达式的使用</h3><p>查询用户名<code>name</code>前后有空格的记录：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"name"</span>:/^\s+|\s+$/&#125;)</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"$or"</span>:[&#123;<span class="string">"name"</span>:/^\s+|\s+$/&#125;, &#123;<span class="string">"postCode"</span>:/^\s+|\s+$/&#125;]&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><p>The following update() operation uses the <code>$unset</code> operator to remove the fields <code>quantity</code> and <code>instock</code> from the first document in the <code>products</code> collection where the field <code>sku</code> has a value of <code>unknown</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.products.update(</span><br><span class="line">   &#123; sku: <span class="string">"unknown"</span> &#125;,</span><br><span class="line">   &#123; <span class="variable">$unset</span>: &#123; quantity: <span class="string">""</span>, instock: <span class="string">""</span> &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>if you want to update all matched, use <code>updateMany</code> instead.</p>
<h3 id="mongo执行一个js脚本文件"><a href="#mongo执行一个js脚本文件" class="headerlink" title="mongo执行一个js脚本文件"></a>mongo执行一个js脚本文件</h3><p>例如有一个js脚本文件，位于<code>/home/hewentian/Documents/updateMongo.js</code>，内容如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 处理字段中数据重复的方法：将字符串一分为二，如果前后两部分相同，则更新成其中一部分</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handleCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> updateCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> totalCount = db.getCollection(<span class="string">'userInfo'</span>).count(&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> lastId = ObjectId(<span class="string">'000000000000000000000000'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (handleCount &lt; totalCount) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$gt"</span>: lastId&#125;&#125;).sort(&#123;<span class="string">"_id"</span>: <span class="number">1</span>&#125;).limit(<span class="number">5</span>).forEach(<span class="function">(<span class="params">doc</span>) =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (++handleCount % <span class="number">10</span> == <span class="number">0</span> || handleCount == totalCount) &#123;</span><br><span class="line">            print(<span class="string">'handling: '</span> + handleCount + <span class="string">' / '</span> + totalCount + <span class="string">", updateCount = "</span> + updateCount + <span class="string">", lastId = "</span> + lastId.toJSON().$oid + (handleCount == totalCount ? <span class="string">" end"</span> : <span class="string">""</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastId = doc._id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> userName = doc.userName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (userName) &#123; <span class="comment">// 这个字段必须要存在</span></span><br><span class="line">            <span class="keyword">var</span> len = userName.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (len % <span class="number">2</span> == <span class="number">0</span>) &#123; <span class="comment">// 字符数必须为偶数倍</span></span><br><span class="line">                <span class="keyword">var</span> middleIndex = len / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">var</span> substrA = userName.substr(<span class="number">0</span>, middleIndex);</span><br><span class="line">                <span class="keyword">var</span> substrB = userName.substr(middleIndex);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (substrA == substrB) &#123; <span class="comment">// 前后两半字符串相同时，才更新</span></span><br><span class="line">                    db.getCollection(<span class="string">'userInfo'</span>).update(&#123;<span class="string">"_id"</span>: doc._id&#125;, &#123;<span class="string">"$set"</span>: &#123;<span class="string">"userName"</span>: substrA&#125;&#125;)</span><br><span class="line">                    updateCount++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们这样执行这个脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017/user_database"</span> --authenticationDatabase user_database -u user_name -p user_password /home/hewentian/Documents/updateMongo.js</span><br></pre></td></tr></table></figure></p>
<h3 id="使用typeof操作符"><a href="#使用typeof操作符" class="headerlink" title="使用typeof操作符"></a>使用typeof操作符</h3><p>有时候，我们在使用javascript操作Mongodb的过程中，可能要根据数据类型进行相关操作：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 对集合进行清洗，保证字段 telephone 是字符串格式</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handleCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> updateCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> totalCount = db.getCollection(<span class="string">'userInfo'</span>).count(&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> lastId = <span class="string">"000000000000000000000000"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (handleCount &lt; totalCount) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$gt"</span>: lastId&#125;&#125;).sort(&#123;<span class="string">"_id"</span>: <span class="number">1</span>&#125;).limit(<span class="number">100</span>).forEach(<span class="function">(<span class="params">doc</span>) =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (++handleCount % <span class="number">1000</span> == <span class="number">0</span> || handleCount == totalCount) &#123;</span><br><span class="line">            print(<span class="string">'handling: '</span> + handleCount + <span class="string">' / '</span> + totalCount + <span class="string">", updateCount = "</span> + updateCount + <span class="string">", lastId = "</span> + lastId + (handleCount == totalCount ? <span class="string">" end"</span> : <span class="string">""</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastId = doc._id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> telephone = doc.telephone;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (telephone &amp;&amp; <span class="keyword">typeof</span>(telephone) == <span class="string">'object'</span>) &#123; <span class="comment">// 这个字段必须要存在，并且是内嵌类型文档</span></span><br><span class="line">            <span class="keyword">var</span> fixTelephone = telephone.phoneNumber;</span><br><span class="line">            <span class="keyword">if</span> (fixTelephone &amp;&amp; <span class="keyword">typeof</span>(fixTelephone) == <span class="string">'string'</span>) &#123;</span><br><span class="line">                db.getCollection(<span class="string">'userInfo'</span>).updateOne(&#123;<span class="string">"_id"</span>: doc._id&#125;, &#123;<span class="string">"$set"</span>: &#123;<span class="string">"telephone"</span>: fixTelephone&#125;&#125;);</span><br><span class="line">                updateCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/03/07/mongo-note/" data-id="ck7ttggrc0021cq3klkzuq1ow" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/04/06/jvm-note/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Récent</strong>
      <div class="article-nav-title">
        
          jvm 学习笔记
        
      </div>
    </a>
  
  
    <a href="/2018/03/03/solr-cloud/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">solr 集群的创建</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Catégories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">bigdata</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/container/">container</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-server/">web server</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/01/14/spark-note/">spark 学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/12/30/scala-note/">scala 学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/07/26/docker-note/">docker 学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/06/10/nginx-note/">nginx 学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/01/20/hbase-cluster/">hbase 集群的搭建</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">link</h3>
    <div class="widget">
      <li><a href="https://github.com/hewentian" title="Tim Ho's Blog">我的github</a></li>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Tim Ho<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/categories/" class="mobile-nav-link">Categories</a>
  
    <a href="/tags/" class="mobile-nav-link">Tags</a>
  
    <a href="/about/" class="mobile-nav-link">About</a>
  
</nav>
    

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<script src="//code.jquery.com/jquery-2.2.4.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>