<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>mongo 学习笔记 | Tim Ho&#39;s Technology Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="安装mongodb数据库首先，我们必须安装mongodb，这样才能使用。我们下载相应版本的mongodb，因为我的笔记本电脑是ubuntu，所以我下载mongodb的tgz版本，下载地址如下： https://www.mongodb.com/download-center/community 下载之后，得到如下两个文件：mongodb-linux-x86_64-ubuntu1804-4.0.6.t">
<meta name="keywords" content="mongo">
<meta property="og:type" content="article">
<meta property="og:title" content="mongo 学习笔记">
<meta property="og:url" content="https://github.com/hewentian/2018/03/07/mongo-note/index.html">
<meta property="og:site_name" content="Tim Ho&#39;s Technology Blog">
<meta property="og:description" content="安装mongodb数据库首先，我们必须安装mongodb，这样才能使用。我们下载相应版本的mongodb，因为我的笔记本电脑是ubuntu，所以我下载mongodb的tgz版本，下载地址如下： https://www.mongodb.com/download-center/community 下载之后，得到如下两个文件：mongodb-linux-x86_64-ubuntu1804-4.0.6.t">
<meta property="og:locale" content="en-US">
<meta property="og:updated_time" content="2022-08-22T04:05:28.805Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mongo 学习笔记">
<meta name="twitter:description" content="安装mongodb数据库首先，我们必须安装mongodb，这样才能使用。我们下载相应版本的mongodb，因为我的笔记本电脑是ubuntu，所以我下载mongodb的tgz版本，下载地址如下： https://www.mongodb.com/download-center/community 下载之后，得到如下两个文件：mongodb-linux-x86_64-ubuntu1804-4.0.6.t">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tim Ho&#39;s Technology Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心如止水</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/categories/">Categories</a>
        
          <a class="main-nav-link" href="/tags/">Tags</a>
        
          <a class="main-nav-link" href="/about/">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/hewentian"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-mongo-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/07/mongo-note/" class="article-date">
  <time datetime="2018-03-07T06:39:42.000Z" itemprop="datePublished">2018-03-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/db/">db</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      mongo 学习笔记
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="安装mongodb数据库"><a href="#安装mongodb数据库" class="headerlink" title="安装mongodb数据库"></a>安装mongodb数据库</h3><p>首先，我们必须安装mongodb，这样才能使用。我们下载相应版本的mongodb，因为我的笔记本电脑是ubuntu，所以我下载mongodb的tgz版本，下载地址如下：</p>
<pre><code>https://www.mongodb.com/download-center/community
</code></pre><p>下载之后，得到如下两个文件：<br>mongodb-linux-x86_64-ubuntu1804-4.0.6.tgz<br>mongodb-linux-x86_64-ubuntu1804-4.0.6.tgz.md5</p>
<p>mongodb依赖libcurl4、openssl，我们必须先安装这两个依赖包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">如已安装，则可跳过，验证命令如下</span><br><span class="line">$ dpkg -s libcurl4</span><br><span class="line">$ dpkg -s openssl</span><br><span class="line"></span><br><span class="line">安装命令</span><br><span class="line">$ sudo apt-get install libcurl4 openssl</span><br></pre></td></tr></table></figure></p>
<p>我们将压缩包下载到<code>/home/hewentian/ProjectD</code>目录，然后解压：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD</span><br><span class="line">$ tar xf mongodb-linux-x86_64-ubuntu1804-4.0.6.tgz</span><br><span class="line">$</span><br><span class="line">$ ls mongodb-linux-x86_64-ubuntu1804-4.0.6/</span><br><span class="line">bin  LICENSE-Community.txt  MPL-2  README  THIRD-PARTY-NOTICES</span><br></pre></td></tr></table></figure></p>
<p>创建data目录和log目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD</span><br><span class="line">$ mkdir -p db/mongodb/data</span><br><span class="line">$ mkdir -p db/mongodb/<span class="built_in">log</span></span><br></pre></td></tr></table></figure></p>
<p>创建mongod.conf配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/</span><br><span class="line">$ vi mongod.conf</span><br></pre></td></tr></table></figure></p>
<p>并在其中输入如下内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line">storage:</span><br><span class="line">  dbPath: /home/hewentian/ProjectD/db/mongodb/data</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /home/hewentian/ProjectD/db/mongodb/<span class="built_in">log</span>/mongod.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 127.0.0.1,192.168.56.110 <span class="comment"># 127.0.0.1只能从本机访问，将本机的IP配置到这里，这样其他机器才能通过该IP访问</span></span><br><span class="line"><span class="comment">#  bindIp: 0.0.0.0  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line">  pidFilePath: /home/hewentian/ProjectD/db/mongodb/mongod.pid  <span class="comment"># location of pidfile</span></span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line"></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#  authorization: enabled</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Enterprise-Only Options:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure></p>
<h3 id="启动mongodb"><a href="#启动mongodb" class="headerlink" title="启动mongodb"></a>启动mongodb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/bin</span><br><span class="line">$ ./mongod -f ../mongod.conf</span><br><span class="line"></span><br><span class="line">about to fork child process, waiting until server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 24049</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>
<h3 id="停止mongodb"><a href="#停止mongodb" class="headerlink" title="停止mongodb"></a>停止mongodb</h3><p>不要直接通过kill命令杀掉mongodb的进程，而应通过它官方提供的关闭脚本，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/bin</span><br><span class="line">$ ./mongod -f ../mongod.conf --shutdown</span><br><span class="line"></span><br><span class="line">killing process with pid: 24049</span><br></pre></td></tr></table></figure></p>
<h3 id="配置登录用户名和密码"><a href="#配置登录用户名和密码" class="headerlink" title="配置登录用户名和密码"></a>配置登录用户名和密码</h3><p>要开启密码登录，首先要将mongod.conf中的以下选项打开：</p>
<pre><code>security:
  authorization: enabled
</code></pre><p>然后重启mongodb服务。</p>
<ol>
<li><p>添加管理员<br>使用mongo命令进入命令行交互模式，创建第一个用户admin，该用户需要有用户管理权限，其角色为root。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/mongodb-linux-x86_64-ubuntu1804-4.0.6/bin</span><br><span class="line">$ ./bin/mongo --host 127.0.0.1</span><br><span class="line">MongoDB shell version v4.0.6</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">"id"</span> : UUID(<span class="string">"cbd0445f-667b-4d2a-92a8-66f8ad1d07ef"</span>) &#125;</span><br><span class="line">MongoDB server version: 4.0.6</span><br><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">&gt; db.createUser(&#123;user:<span class="string">"admin"</span>,<span class="built_in">pwd</span>:<span class="string">"admin"</span>,roles:[<span class="string">"root"</span>]&#125;)</span><br><span class="line">Successfully added user: &#123; <span class="string">"user"</span> : <span class="string">"admin"</span>, <span class="string">"roles"</span> : [ <span class="string">"root"</span> ] &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; show collections</span><br><span class="line">Warning: unable to run listCollections, attempting to approximate collection names by parsing connectionStatus</span><br><span class="line">&gt; db.auth(<span class="string">"admin"</span>,<span class="string">"admin"</span>)</span><br><span class="line">1</span><br><span class="line">&gt; show collections</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加数据库用户<br>为数据库添加用户，添加用户前需要切换到该数据库，这里简单设置其角色为dbOwner</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; use bfg</span><br><span class="line">switched to db bfg</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">"bfg"</span>, <span class="built_in">pwd</span>: <span class="string">"bfg100"</span>, roles: [&#123; role: <span class="string">"dbOwner"</span>, db: <span class="string">"bfg"</span> &#125;]&#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">	<span class="string">"user"</span> : <span class="string">"bfg"</span>,</span><br><span class="line">	<span class="string">"roles"</span> : [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"role"</span> : <span class="string">"dbOwner"</span>,</span><br><span class="line">			<span class="string">"db"</span> : <span class="string">"bfg"</span></span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这样，bfg的用户就只能访问bfg这个库了，登录方式如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/mongo --host 127.0.0.1</span><br><span class="line">MongoDB shell version v4.0.6</span><br><span class="line">connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; <span class="string">"id"</span> : UUID(<span class="string">"873114cf-fb7e-436a-b939-7e765dbecee9"</span>) &#125;</span><br><span class="line">MongoDB server version: 4.0.6</span><br><span class="line">&gt; use bfg</span><br><span class="line">switched to db bfg</span><br><span class="line">&gt; db.auth(<span class="string">"bfg"</span>,<span class="string">"bfg100"</span>)</span><br><span class="line">1</span><br><span class="line">&gt; show dbs</span><br><span class="line">bfg  0.000GB</span><br></pre></td></tr></table></figure></p>
<p>至此，数据库安装完毕（此安装过程2019年初才补上）。</p>
<h3 id="修改用户密码"><a href="#修改用户密码" class="headerlink" title="修改用户密码"></a>修改用户密码</h3><p>修改用户密码使用<code>db.changeUserPassword(username, password)</code>，Updates a user’s password. Run the method in the database where the user is defined, i.e. the database you created the user.</p>
<h3 id="shell命令行方式连接到mongodb"><a href="#shell命令行方式连接到mongodb" class="headerlink" title="shell命令行方式连接到mongodb"></a>shell命令行方式连接到mongodb</h3><p>连接到单机：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo --host 192.168.1.111:27017 --authenticationDatabase user_database -u user_name -p user_password</span><br></pre></td></tr></table></figure></p>
<p>连接到单机中的指定数据库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017/user_database"</span> --authenticationDatabase user_database -u user_name -p user_password</span><br></pre></td></tr></table></figure></p>
<p>连接到副本集：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017,192.168.1.112:27017/user_database?replicaSet=mgset-9527&amp;readPreference=secondaryPreferred"</span> --authenticationDatabase user_database -u user_name -p user_password</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb查询数组大小"><a href="#mongodb查询数组大小" class="headerlink" title="mongodb查询数组大小"></a>mongodb查询数组大小</h3><p>mongodb查询数组大小使用<code>$size</code>，例如：我们有一个名为<code>person</code>的集合，其中有个字段为<code>childrenNames</code>，是数组类型，如果我们要查询<code>childrenNames</code>长度为2的数据，则查询语句为：</p>
<pre><code>db.getCollection(&apos;person&apos;).find({&apos;childrenNames&apos;:{&apos;$size&apos;:2}})
</code></pre><p>但是它不能限定数组的大小范围，只能查询指定的长度。要查询数组范围，我们使用<code>$exists</code>，例如：查询数组长度大于等于3的语句如下（检查数组第3个元素是否存了）</p>
<pre><code>db.getCollection(&apos;person&apos;).find({&apos;childrenNames.2&apos;:{&apos;$exists&apos;:1}})
</code></pre><h3 id="数组查询"><a href="#数组查询" class="headerlink" title="数组查询"></a>数组查询</h3><p>有如下数组，它的查询方式为：<br>        db.getCollection(‘userInfo’).find({“sons”: {$elemMatch: {“birthday”: {$gte:1594252800000, $lte:1594339200000}}}})</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5f0e26bcf0a06369a460b4c8"</span>),</span><br><span class="line">    <span class="string">"name"</span> : <span class="string">"tony"</span>,</span><br><span class="line">    <span class="string">"sons"</span> : [ </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"h"</span>,</span><br><span class="line">            <span class="string">"birthday"</span> : NumberLong(<span class="number">1594762936000</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">		  &#123;</span><br><span class="line">            <span class="string">"name"</span> : <span class="string">"w"</span>,</span><br><span class="line">            <span class="string">"birthday"</span> : NumberLong(<span class="number">1594762936000</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mongodb分组查询"><a href="#mongodb分组查询" class="headerlink" title="mongodb分组查询"></a>mongodb分组查询</h3><p>如果我们要对集合<code>person</code>中的地区字段<code>area</code>来分组统计，语法如下：</p>
<pre><code>db.getCollection(&apos;person&apos;).aggregate([{&apos;$group&apos;:{&apos;_id&apos;:&apos;$area&apos;,&apos;count&apos;:{&apos;$sum&apos;:1}}}])
</code></pre><p>如果我们还想将分组统计结果，按数量倒序输出显示：</p>
<pre><code>db.getCollection(&apos;person&apos;).aggregate([{&apos;$group&apos;:{&apos;_id&apos;:&apos;$area&apos;,&apos;count&apos;:{&apos;$sum&apos;:1}}},{&apos;$sort&apos;:{&apos;count&apos;:-1}}])
</code></pre><p>对应的JAVA代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MongoDatabase mongoDatabase = MongoUtil.getMongoDatabase(); <span class="comment">// 这个是我自已写的工具类</span></span><br><span class="line">MongoCollection&lt;Document&gt; personCollection = mongoDatabase.getCollection(<span class="string">"person"</span>);</span><br><span class="line"></span><br><span class="line">List&lt;BasicDBObject&gt; pipeline = <span class="keyword">new</span> ArrayList&lt;BasicDBObject&gt;();</span><br><span class="line">pipeline.add(<span class="keyword">new</span> BasicDBObject(<span class="string">"$group"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="string">"$area"</span>).append(<span class="string">"count"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"$sum"</span>, <span class="number">1</span>))));</span><br><span class="line">pipeline.add(<span class="keyword">new</span> BasicDBObject(<span class="string">"$sort"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"count"</span>, -<span class="number">1</span>))); <span class="comment">// 如果不要排序，则注释这一行</span></span><br><span class="line"></span><br><span class="line">AggregateIterable&lt;Document&gt; aggregate = personCollection.aggregate(pipeline);</span><br><span class="line">MongoCursor&lt;Document&gt; iterator = aggregate.iterator();</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb更新部分字段"><a href="#mongodb更新部分字段" class="headerlink" title="mongodb更新部分字段"></a>mongodb更新部分字段</h3><p>例如我们要将<code>person</code>中<code>_id</code>为<code>123</code>的数据的<code>address</code>修改为：广东，语句如下：</p>
<pre><code>db.getCollection(&apos;person&apos;).update({&apos;_id&apos;:&apos;123&apos;},{$set:{&apos;address&apos;:&apos;广东&apos;}})
</code></pre><h3 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; show dbs</span><br><span class="line">&gt; use monitor</span><br><span class="line">&gt; db.dropDatabase()</span><br></pre></td></tr></table></figure>
<h3 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; show collections</span><br><span class="line">&gt; db.collection_name.drop()</span><br></pre></td></tr></table></figure>
<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><p>删除数据的时候，要注意条件为null的情况，这在组成json条件的时候，会变成{}，这会将整个库的数据都删掉，这个要避免。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MongoCollection&lt;Document&gt; mongoCollection = <span class="keyword">null</span>; <span class="comment">// 这里不建连接，仅演示</span></span><br><span class="line">JSONArray userNames = <span class="keyword">new</span> JSONArray();</span><br><span class="line"><span class="keyword">for</span> (String userName : Arrays.asList(<span class="string">""</span>, <span class="keyword">null</span>, <span class="string">"xiao ming"</span>)) &#123;</span><br><span class="line">    JSONObject obj = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    obj.put(<span class="string">"userName"</span>, userName);</span><br><span class="line">    userNames.add(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JSONObject condition = <span class="keyword">new</span> JSONObject();</span><br><span class="line">condition.put(<span class="string">"$or"</span>, userNames);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除原有的数据</span></span><br><span class="line">log.info(<span class="string">"删除的语句为："</span> + condition); <span class="comment">// &#123;"$or":[&#123;"userName":""&#125;,&#123;&#125;,&#123;"userName":"xiao ming"&#125;]&#125;</span></span><br><span class="line">DeleteResult deleteResult = mongoCollection.deleteMany(BsonDocument.parse(condition.toJSONString()));</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">"======mongo删除原有的数据条数：======"</span> + deleteResult.getDeletedCount());</span><br></pre></td></tr></table></figure></p>
<h3 id="导出、导入数据库"><a href="#导出、导入数据库" class="headerlink" title="导出、导入数据库"></a>导出、导入数据库</h3><h4 id="我们使用mongoexport来导出指定的collection"><a href="#我们使用mongoexport来导出指定的collection" class="headerlink" title="我们使用mongoexport来导出指定的collection"></a>我们使用<code>mongoexport</code>来导出指定的<code>collection</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把一个<code>collection</code>导出成JSON或CSV格式的文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongoexport -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; -c &#123;COLLECTION_NAME&#125; -o &#123;EXPORT_FILE_PATH&#125; --<span class="built_in">type</span> json/csv -f fields</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	-c: collection名</span><br><span class="line">	-o: 输出的文件名</span><br><span class="line">	--<span class="built_in">type</span>: 输出的格式，默认为json</span><br><span class="line">	-f: 输出的字段，如果-<span class="built_in">type</span>为csv，则需要加上-f <span class="string">"字段名"</span></span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">$ mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.json</span><br><span class="line">$ mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.json --<span class="built_in">type</span> json -f  <span class="string">"_id,name"</span></span><br><span class="line">$ mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.csv --<span class="built_in">type</span> csv -f  <span class="string">"_id,name"</span></span><br></pre></td></tr></table></figure></p>
<p>如果导出的数据中包含查询条件，则要用下面这种方式导出：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017/user_database"</span> --authenticationDatabase user_database -u user_name -p user_password --quiet --<span class="built_in">eval</span> <span class="string">'db.user.find(&#123; _id: &#123;$gt: ObjectId("5ee08d67e144cb56edf945da")&#125;&#125;).forEach(printjson);'</span> &gt; a.json</span><br></pre></td></tr></table></figure></p>
<p>如果导出的查询条件中包含ObjectId，则要用<code>$oid</code>来代替它：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoexport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user -o /home/hewentian/ProjectD/db/user.json -q <span class="string">'&#123;"_id":&#123;"$oid":"5ece9b4d8008d750e611010c"&#125;&#125;'</span></span><br></pre></td></tr></table></figure></p>
<h4 id="我们使用mongoimport来导入指定的collection"><a href="#我们使用mongoimport来导入指定的collection" class="headerlink" title="我们使用mongoimport来导入指定的collection"></a>我们使用<code>mongoimport</code>来导入指定的<code>collection</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把一个json/csv文件导入到指定的<code>collection</code>中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongoimport -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; -c &#123;COLLECTION_NAME&#125; --file &#123;IMPORT_FILE_PATH&#125; --headerline --<span class="built_in">type</span> json/csv -f fields</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	-c: collection名</span><br><span class="line">	--file: 要导入的文件</span><br><span class="line">	--<span class="built_in">type</span>: input format to import: json, csv, or tsv (defaults to <span class="string">'json'</span>) (default: json)</span><br><span class="line">	--headerline: use first line <span class="keyword">in</span> input <span class="built_in">source</span> as the field list (CSV and TSV only)</span><br><span class="line">	-f: 导入的字段名，CSV或TSV的时候可用</span><br><span class="line"> </span><br><span class="line">示例：</span><br><span class="line">$ mongoimport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user --file /home/hewentian/ProjectD/db/user.json</span><br><span class="line"></span><br><span class="line">注意：--headerline 和 -f 不能同时使用</span><br><span class="line"></span><br><span class="line">	--headerline: 使用CSV文件中首列指定的列名作为导入的name</span><br><span class="line">	-f: 会将CSV文件的所有列，作为数据进行导入，包括第一列的列名（如果文件中有指定列名）</span><br><span class="line"></span><br><span class="line">$ mongoimport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user --file /home/hewentian/ProjectD/db/user.csv --<span class="built_in">type</span> csv --headerline</span><br><span class="line">$ mongoimport -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -c user --file /home/hewentian/ProjectD/db/user.csv --<span class="built_in">type</span> csv -f <span class="string">"_id,name,age"</span></span><br></pre></td></tr></table></figure></p>
<h4 id="我们使用mongodump来导出指定的database"><a href="#我们使用mongodump来导出指定的database" class="headerlink" title="我们使用mongodump来导出指定的database"></a>我们使用<code>mongodump</code>来导出指定的<code>database</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把一个<code>database</code>导出成指定目录下的JSON、BSON的文件集<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongodump -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; -o &#123;DUMP_FILE_PATH&#125;</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	-o: 输出的文件路径，要事先创建该目录，在该目录下会自动创建要导出的数据库作为子目录</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">$ mongodump -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg -o /home/hewentian/ProjectD/db/</span><br></pre></td></tr></table></figure></p>
<h4 id="我们使用mongorestore来恢复指定的database"><a href="#我们使用mongorestore来恢复指定的database" class="headerlink" title="我们使用mongorestore来恢复指定的database"></a>我们使用<code>mongorestore</code>来恢复指定的<code>database</code></h4><p>该命令位于<code>{MONGO_HOME}/bin/</code>目录下，可以把指定目录下的JSON、BSON的文件集恢复成<code>database</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">$ mongorestore -h &#123;SERVER_ADDRESS&#125; --port &#123;SERVER_PORT&#125; -u &#123;USER_NAME&#125; -p &#123;PASSWORD&#125; --authenticationDatabase &#123;AUTH_DB&#125; -d &#123;DB_NAME&#125; --dir &#123;RESTORE_FILE_PATH&#125;</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">	-h: MONGODB服务器的地址</span><br><span class="line">	--port: MONGODB服务器的端口</span><br><span class="line">	-u: 用户名</span><br><span class="line">	-p: 密码</span><br><span class="line">	--authenticationDatabase: 验证数据库</span><br><span class="line">	-d: 数据库名</span><br><span class="line">	--dir: 要恢复的数据库的位置，注意与上面备份的 -o 不同，这里要指定到数据库的目录</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">$ mongorestore -h 127.0.0.1 --port 27017 -u bfg_user -p a12345678 --authenticationDatabase admin -d bfg --dir /home/hewentian/ProjectD/db/bfg/</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb类型转换"><a href="#mongodb类型转换" class="headerlink" title="mongodb类型转换"></a>mongodb类型转换</h3><p>如下所示，将字符串类型的数据转换为int, double, date类型：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">先插入一条数据，都是字符串类型：</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="string">"20"</span>, <span class="string">"salary"</span>:<span class="string">"30"</span>, <span class="string">"birthday"</span>:<span class="string">"2018-12-21"</span>&#125;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5c45b7099a14ab9807edaa75"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="string">"20"</span>,</span><br><span class="line">    <span class="string">"salary"</span> : <span class="string">"30"</span>,</span><br><span class="line">    <span class="string">"birthday"</span> : <span class="string">"2018-12-21"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">改变字段类型：</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;&#125;).forEach(function(doc) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).updateOne(&#123;_id: doc._id&#125;, &#123;$set: &#123;<span class="string">"age"</span>: NumberInt(doc.age), <span class="string">"salary"</span>: parseInt(doc.salary), <span class="string">"birthday"</span>: <span class="keyword">new</span> ISODate(doc.birthday)&#125;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5c45b7099a14ab9807edaa75"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="number">20</span>,</span><br><span class="line">    <span class="string">"salary"</span> : <span class="number">30.0</span>,</span><br><span class="line">    <span class="string">"birthday"</span> : ISODate(<span class="string">"2018-12-21T00:00:00.000Z"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果要将集合中已有文档的<code>ISODate</code>类型转换成<code>String</code>类型的日期，例如：将<code>updateTime</code>由<code>ISODate(&quot;2019-04-04T07:12:37.295Z&quot;)</code>转换为<code>2019-04-04 07:12:37</code>类型：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"updateTime"</span>:&#123;<span class="string">"$type"</span>:<span class="number">9</span>&#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> mydate = doc.updateTime;</span><br><span class="line">    <span class="keyword">if</span> (mydate) &#123;</span><br><span class="line">        mydate = mydate.toJSON();</span><br><span class="line">        <span class="keyword">if</span> (mydate.length &gt; <span class="number">19</span>) &#123;</span><br><span class="line">            mydate = mydate.substr(<span class="number">0</span>, <span class="number">19</span>)</span><br><span class="line">            mydate = mydate.replace(<span class="string">'T'</span>,<span class="string">' '</span>);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   db.getCollection(<span class="string">'userInfo'</span>).update(&#123;<span class="string">"_id"</span>:doc._id&#125;, &#123;<span class="string">"$set"</span>:&#123;<span class="string">"updateTime"</span>:mydate&#125;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">验证结果：</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>:ObjectId(<span class="string">"5abc7ffc00a32c2b045e598c"</span>)&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="MongoDB的主键类型修改"><a href="#MongoDB的主键类型修改" class="headerlink" title="MongoDB的主键类型修改"></a>MongoDB的主键类型修改</h3><p><strong>主键类型的修改不能像其他字段一样直接修改</strong></p>
<p>将String类型的主键修改为ObjectId类型，在Mongodb中String类型对应的int值为2，<br>我们先增加一条主键为ObjectId记录，然后删除主键为String的记录。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">2</span>&#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    doc._id = ObjectId(doc._id);</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).save(doc);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).remove(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">2</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<p>反之，将ObjectId类型的主键修改为String类型，在Mongodb中ObjectId类型对应的int值为7。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">7</span>&#125;&#125;).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    doc._id = doc._id.toJSON().$oid;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).save(doc);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).remove(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$type"</span>: <span class="number">7</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb默认插入类型"><a href="#mongodb默认插入类型" class="headerlink" title="mongodb默认插入类型"></a>mongodb默认插入类型</h3><p>插入的int32整数会默认转为Double类型，若需插入为整数，需指定NumberInt：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="number">20</span>, <span class="string">"salary"</span>:NumberInt(<span class="number">30</span>), <span class="string">"birthday"</span>:<span class="string">"2018-12-21"</span>&#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;&#125;)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5d3815a2a7de52e9fed7bbcf"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="number">20.0</span>,</span><br><span class="line">    <span class="string">"salary"</span> : <span class="number">30</span>,</span><br><span class="line">    <span class="string">"birthday"</span> : <span class="string">"2018-12-21"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="mongodb模糊查询"><a href="#mongodb模糊查询" class="headerlink" title="mongodb模糊查询"></a>mongodb模糊查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"name"</span>:&#123;<span class="string">"$regex"</span>:<span class="string">"t"</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>这样名字中包含”tom”和”scott”的记录都会查询出来。</p>
<h3 id="mongodb日期查询"><a href="#mongodb日期查询" class="headerlink" title="mongodb日期查询"></a>mongodb日期查询</h3><p>日期的类型不同，查询的方式也不同：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">如果日期的类型为String：</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"insertTime"</span>:&#123;$regex:<span class="string">"2019-01-07 *"</span>&#125;&#125;) <span class="comment">// *号前有个空格</span></span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"insertTime"</span>:&#123;$gte:<span class="string">"2019-02-01 00:00:00"</span>,$lte:<span class="string">"2019-02-11 23:59:59"</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">如果日期的类型为ISODate：</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"insertTime"</span>:&#123;$gte:ISODate(<span class="string">"2019-01-01T00:00:00Z"</span>),$lte:ISODate(<span class="string">"2019-02-11T23:59:59Z"</span>)&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="复制集合"><a href="#复制集合" class="headerlink" title="复制集合"></a>复制集合</h3><p>在复制集合的时候，修改某些值，可以使用javascript实现（建议在mongo shell下执行，这样不容易超时），示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var count = <span class="number">0</span>;</span><br><span class="line">var totalCount = db.getCollection(<span class="string">'user'</span>).count(&#123;&#125;);</span><br><span class="line">var lastId = <span class="string">"000000000000000000000000"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(count &lt; totalCount) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'user'</span>).find(&#123;<span class="string">"_id"</span>:&#123;<span class="string">"$gt"</span>:lastId&#125;&#125;).sort(&#123;<span class="string">"_id"</span>:<span class="number">1</span>&#125;).limit(<span class="number">100</span>).forEach((doc)=&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (++count % <span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            print(<span class="string">'handling: '</span> + count + <span class="string">' / '</span> + totalCount)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        lastId = doc._id;</span><br><span class="line">        doc._id=doc.regId;</span><br><span class="line">       db.getCollection(<span class="string">'user_new'</span>).save(doc);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="正则表达式的使用"><a href="#正则表达式的使用" class="headerlink" title="正则表达式的使用"></a>正则表达式的使用</h3><p>查询用户名<code>name</code>前后有空格的记录：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"name"</span>:/^\s+|\s+$/&#125;)</span><br><span class="line">db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"$or"</span>:[&#123;<span class="string">"name"</span>:/^\s+|\s+$/&#125;, &#123;<span class="string">"postCode"</span>:/^\s+|\s+$/&#125;]&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><p>The following update() operation uses the <code>$unset</code> operator to remove the fields <code>quantity</code> and <code>instock</code> from the first document in the <code>products</code> collection where the field <code>sku</code> has a value of <code>unknown</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.products.update(</span><br><span class="line">   &#123; sku: <span class="string">"unknown"</span> &#125;,</span><br><span class="line">   &#123; <span class="variable">$unset</span>: &#123; quantity: <span class="string">""</span>, instock: <span class="string">""</span> &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>if you want to update all matched, use <code>updateMany</code> instead.</p>
<h3 id="mongo执行一个js脚本文件"><a href="#mongo执行一个js脚本文件" class="headerlink" title="mongo执行一个js脚本文件"></a>mongo执行一个js脚本文件</h3><p>例如有一个js脚本文件，位于<code>/home/hewentian/Documents/updateMongo.js</code>，内容如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 处理字段中数据重复的方法：将字符串一分为二，如果前后两部分相同，则更新成其中一部分</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handleCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> updateCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> totalCount = db.getCollection(<span class="string">'userInfo'</span>).count(&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> lastId = ObjectId(<span class="string">'000000000000000000000000'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (handleCount &lt; totalCount) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$gt"</span>: lastId&#125;&#125;).sort(&#123;<span class="string">"_id"</span>: <span class="number">1</span>&#125;).limit(<span class="number">5</span>).forEach(<span class="function">(<span class="params">doc</span>) =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (++handleCount % <span class="number">10</span> == <span class="number">0</span> || handleCount == totalCount) &#123;</span><br><span class="line">            print(<span class="string">'handling: '</span> + handleCount + <span class="string">' / '</span> + totalCount + <span class="string">", updateCount = "</span> + updateCount + <span class="string">", lastId = "</span> + lastId.toJSON().$oid + (handleCount == totalCount ? <span class="string">" end"</span> : <span class="string">""</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastId = doc._id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> userName = doc.userName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (userName) &#123; <span class="comment">// 这个字段必须要存在</span></span><br><span class="line">            <span class="keyword">var</span> len = userName.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (len % <span class="number">2</span> == <span class="number">0</span>) &#123; <span class="comment">// 字符数必须为偶数倍</span></span><br><span class="line">                <span class="keyword">var</span> middleIndex = len / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">var</span> substrA = userName.substr(<span class="number">0</span>, middleIndex);</span><br><span class="line">                <span class="keyword">var</span> substrB = userName.substr(middleIndex);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (substrA == substrB) &#123; <span class="comment">// 前后两半字符串相同时，才更新</span></span><br><span class="line">                    db.getCollection(<span class="string">'userInfo'</span>).update(&#123;<span class="string">"_id"</span>: doc._id&#125;, &#123;<span class="string">"$set"</span>: &#123;<span class="string">"userName"</span>: substrA&#125;&#125;)</span><br><span class="line">                    updateCount++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们这样执行这个脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo <span class="string">"192.168.1.111:27017/user_database"</span> --authenticationDatabase user_database -u user_name -p user_password /home/hewentian/Documents/updateMongo.js</span><br></pre></td></tr></table></figure></p>
<h3 id="使用typeof操作符"><a href="#使用typeof操作符" class="headerlink" title="使用typeof操作符"></a>使用typeof操作符</h3><p>有时候，我们在使用javascript操作Mongodb的过程中，可能要根据数据类型进行相关操作：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 对集合进行清洗，保证字段 telephone 是字符串格式</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handleCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> updateCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> totalCount = db.getCollection(<span class="string">'userInfo'</span>).count(&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> lastId = <span class="string">"000000000000000000000000"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (handleCount &lt; totalCount) &#123;</span><br><span class="line">    db.getCollection(<span class="string">'userInfo'</span>).find(&#123;<span class="string">"_id"</span>: &#123;<span class="string">"$gt"</span>: lastId&#125;&#125;).sort(&#123;<span class="string">"_id"</span>: <span class="number">1</span>&#125;).limit(<span class="number">100</span>).forEach(<span class="function">(<span class="params">doc</span>) =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (++handleCount % <span class="number">1000</span> == <span class="number">0</span> || handleCount == totalCount) &#123;</span><br><span class="line">            print(<span class="string">'handling: '</span> + handleCount + <span class="string">' / '</span> + totalCount + <span class="string">", updateCount = "</span> + updateCount + <span class="string">", lastId = "</span> + lastId + (handleCount == totalCount ? <span class="string">" end"</span> : <span class="string">""</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastId = doc._id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> telephone = doc.telephone;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (telephone &amp;&amp; <span class="keyword">typeof</span>(telephone) == <span class="string">'object'</span>) &#123; <span class="comment">// 这个字段必须要存在，并且是内嵌类型文档</span></span><br><span class="line">            <span class="keyword">var</span> fixTelephone = telephone.phoneNumber;</span><br><span class="line">            <span class="keyword">if</span> (fixTelephone &amp;&amp; <span class="keyword">typeof</span>(fixTelephone) == <span class="string">'string'</span>) &#123;</span><br><span class="line">                db.getCollection(<span class="string">'userInfo'</span>).updateOne(&#123;<span class="string">"_id"</span>: doc._id&#125;, &#123;<span class="string">"$set"</span>: &#123;<span class="string">"telephone"</span>: fixTelephone&#125;&#125;);</span><br><span class="line">                updateCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MongoDB-去重-distinct-查询后求总数-count"><a href="#MongoDB-去重-distinct-查询后求总数-count" class="headerlink" title="MongoDB 去重(distinct)查询后求总数(count)"></a>MongoDB 去重(distinct)查询后求总数(count)</h3><ol>
<li>直接使用distinct语句查询，这种查询会将所有查询出来的数据返回给用户，然后对查询出来的结果集求总数（耗内存，耗时一些）<pre><code>db.student.distinct(&quot;name&quot;, {&quot;age&quot; : 18}).length
</code></pre></li>
</ol>
<p>使用这种方法查询时，查询的结果集大于16M时会查询失败：<br>        {“message” : “distinct failed: MongoError: distinct too big, 16mb cap”,”stack” : “script:1:20”}</p>
<ol>
<li>使用聚合函数，多次分组统计结果，最终将聚合的结果数返回给用户<pre><code>db.student.aggregate([
    {$match:{&quot;age&quot; : 18}},
    {$project:{&quot;name&quot;:1}},
    {$group:{&quot;_id&quot;:&quot;$name&quot;,&quot;count&quot;:{$sum:1}}},
    {$sort:{&quot;count&quot;:-1}}
])
</code></pre></li>
</ol>
<p>这种查询数据量大时就不会出现如上查询失败的情况，而且这种查询不管是内存消耗还是时间消耗都优于上面一种查询。</p>
<h3 id="BSON-ObjectID-Specification"><a href="#BSON-ObjectID-Specification" class="headerlink" title="BSON ObjectID Specification"></a>BSON ObjectID Specification</h3><p>A BSON ObjectID is a 12-byte value consisting of a 4-byte timestamp (seconds since epoch), a 3-byte machine id,<br>a 2-byte process id, and a 3-byte counter. Note that the timestamp and counter fields must be stored big endian<br>unlike the rest of BSON. This is because they are compared byte-by-byte and we want to ensure a mostly increasing<br>order. The format:</p>
<pre><code>0 1 2 3    4 5 6    7 8    9 10 11
time       machine    pid       inc
</code></pre><ul>
<li>TimeStamp: This is a unix style timestamp. It is a signed int representing the number of seconds before or after January 1st 1970 (UTC).</li>
<li>Machine: This is the first three bytes of the (md5) hash of the machine host name, or of the mac/network address, or the virtual machine id.</li>
<li>Pid: This is 2 bytes of the process id (or thread id) of the process generating the object id.</li>
<li>Increment: This is an ever incrementing value, or a random number if a counter can’t be used in the language/runtime.</li>
</ul>
<p>BSON ObjectIds can be any 12 byte binary string that is unique; however, the server itself and almost all drivers use the format above.</p>
<p>ObjectId占用12字节的存储空间，由“时间戳” 、“机器名”、“PID号”和“计数器”组成。使用机器名的好处是在分布式环境中能够避免<br>单点计数的性能瓶颈。使用PID号的好处是支持同一机器内运行多个mongod实例。最终采用时间戳和计数器的组合来保证唯一性。</p>
<p>自动生成的主键objectId是一个24位的字符串，它是由一组十六进制的字符构成，每个字节两位的十六进制数字，总共用了12字节的存储空间。</p>
<ul>
<li><p>时间戳<br>确保ObjectId唯一性依赖的是时间的顺序，不依赖时间的取值，因此集群节点的时间不必完全同步。既然ObjectId已经有了时间戳，<br>那么在文档中就可以省掉一个时间戳了。在使用ObjectID提取时间时，应注意到MongoDB允许各节点时间不一致这一细节。</p>
</li>
<li><p>机器名<br>机器名通过Md5加密后取前三个字节，应该还是有重复概率的，配置生产集群时检查一下总不会错。另外，我也注意到重启MongoDB后<br>MD5加密结果会发生变化，在利用ObjectID提取机器名信息时需格外注意。</p>
</li>
<li><p>PID号<br>注意到每次重启mongod进程后PID号通常会发生变化就可以了。</p>
</li>
<li><p>计数器<br>计数器占3个字节，表示的取值范围就是<code>256*256*256-1=16777215</code>。不妨认为MongDB性能的极限是单台设备一秒钟插入一千万条记录。<br>以目前的水平看，单台设备一秒钟插入一万条就很不错了，因此ObjectID计数器的设计是够用的。</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.user.findOne()._id</span><br><span class="line">ObjectId(<span class="string">"5eda936e8008d750e63ee723"</span>)</span><br><span class="line"></span><br><span class="line">&gt; db.user.findOne()._id.toString()</span><br><span class="line">ObjectId(<span class="string">"5eda936e8008d750e63ee723"</span>)</span><br><span class="line"></span><br><span class="line">&gt; db.user.findOne()._id.toJSON()</span><br><span class="line">&#123; <span class="string">"$oid"</span> : <span class="string">"5eda936e8008d750e63ee723"</span> &#125;</span><br><span class="line"></span><br><span class="line">&gt; db.user.findOne()._id.toJSON().$oid.substring(<span class="number">0</span>, <span class="number">8</span>)</span><br><span class="line"><span class="number">5</span>eda936e</span><br><span class="line"></span><br><span class="line">&gt; db.user.findOne()._id.getTimestamp()</span><br><span class="line">ISODate(<span class="string">"2020-06-06T02:48:14Z"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>从mongoDB的ObjectId中提取时间信息<br>取8个字符，得到的是这条数据创建时的时间戳（不带毫秒位数），在后面补上毫秒位数”000”。</li>
</ul>
<p>java代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectId("5eda936e8008d750e63ee723")</span></span><br><span class="line">String id = <span class="string">"5eda936e8008d750e63ee723"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取前8位</span></span><br><span class="line"><span class="keyword">long</span> timestamp = Long.parseLong(Integer.parseInt(id.substring(<span class="number">0</span>, <span class="number">8</span>), <span class="number">16</span>) + <span class="string">"000"</span>);</span><br><span class="line"></span><br><span class="line">Date date = <span class="keyword">new</span> Date(timestamp);</span><br><span class="line">System.out.println(date); <span class="comment">// Sat Jun 06 02:48:14 CST 2020</span></span><br></pre></td></tr></table></figure></p>
<p>javascript代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectId("5eda936e8008d750e63ee723")</span></span><br><span class="line"><span class="keyword">var</span> id = <span class="string">"5eda936e8008d750e63ee723"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取前8位</span></span><br><span class="line"><span class="keyword">var</span> timestamp = <span class="built_in">Number</span>(<span class="built_in">parseInt</span>(id.substring(<span class="number">0</span>, <span class="number">8</span>), <span class="number">16</span>).toString() + <span class="string">"000"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>(timestamp);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(date); <span class="comment">// Sat Jun 06 2020 02:48:14 GMT+0800 (China Standard Time)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="explain查询执行情况"><a href="#explain查询执行情况" class="headerlink" title="explain查询执行情况"></a>explain查询执行情况</h3><p>explain的目的是将mongo的黑盒操作白盒化。比如查询很慢的时候想知道原因。explain有三种模式：</p>
<ol>
<li>queryPlanner: 不会真正的执行查询，只是分析查询，选出winningPlan。</li>
<li>executionStats: 返回winningPlan的关键数据。</li>
<li>allPlansExecution: 执行所有的plans。</li>
</ol>
<p>通过explain(“executionStats”)来选择模式，默认是第一种模式。一些返回字段的说明：<br>namespace: 本次所查询的集合<br>indexFilterSet: 是否使用partial index，比如只对某个集合中的部分文档进行index<br>parsedQuery: 本次执行的查询<br>executionTimeMillis: 该query查询的总体时间<br>indexName: 所使用的索引的名字<br>indexBounds: 索引查找时使用的范围<br>stage:<br>  COLLSCAN: 全表扫描<br>  IXSCAN: 索引扫描<br>  FETCH: 根据索引去检索指定document<br>  SHARD_MERGE: 将各个分片返回数据进行merge<br>  SORT: 表明在内存中进行了排序<br>  LIMIT: 使用limit限制返回数<br>  SKIP: 使用skip进行跳过<br>  IDHACK: 针对_id进行查询</p>
<p>通过这些信息就能判断查询时如何执行的了。示例如下，先插入3个文档：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="string">"20"</span>, <span class="string">"name"</span>:<span class="string">"scott"</span>, <span class="string">"birthday"</span>:<span class="string">"2018-12-21"</span>&#125;)</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="string">"21"</span>, <span class="string">"name"</span>:<span class="string">"tiger"</span>, <span class="string">"birthday"</span>:<span class="string">"2019-12-21"</span>&#125;)</span><br><span class="line">db.getCollection(<span class="string">"userInfo"</span>).insert(&#123;<span class="string">"age"</span>:<span class="string">"23"</span>, <span class="string">"name"</span>:<span class="string">"tom"</span>, <span class="string">"birthday"</span>:<span class="string">"1919-11-21"</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>没有建立索引的时候查询：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;<span class="string">"name"</span>:<span class="string">"tom"</span>&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"queryPlanner"</span> : &#123;</span><br><span class="line">		<span class="string">"plannerVersion"</span> : <span class="number">1</span>,</span><br><span class="line">		<span class="string">"namespace"</span> : <span class="string">"bfg.userInfo"</span>,</span><br><span class="line">		<span class="string">"indexFilterSet"</span> : <span class="literal">false</span>,</span><br><span class="line">		<span class="string">"parsedQuery"</span> : &#123;</span><br><span class="line">			<span class="string">"name"</span> : &#123;</span><br><span class="line">				<span class="string">"$eq"</span> : <span class="string">"tom"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"queryHash"</span> : <span class="string">"01AEE5EC"</span>,</span><br><span class="line">		<span class="string">"planCacheKey"</span> : <span class="string">"01AEE5EC"</span>,</span><br><span class="line">		<span class="string">"winningPlan"</span> : &#123;</span><br><span class="line">			<span class="string">"stage"</span> : <span class="string">"COLLSCAN"</span>,</span><br><span class="line">			<span class="string">"filter"</span> : &#123;</span><br><span class="line">				<span class="string">"name"</span> : &#123;</span><br><span class="line">					<span class="string">"$eq"</span> : <span class="string">"tom"</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">"direction"</span> : <span class="string">"forward"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"rejectedPlans"</span> : [ ]</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"serverInfo"</span> : &#123;</span><br><span class="line">		<span class="string">"host"</span> : <span class="string">"0d550468977f"</span>,</span><br><span class="line">		<span class="string">"port"</span> : <span class="number">27017</span>,</span><br><span class="line">		<span class="string">"version"</span> : <span class="string">"4.4.0"</span>,</span><br><span class="line">		<span class="string">"gitVersion"</span> : <span class="string">"563487e100c4215e2dce98d0af2a6a5a2d67c5cf"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从<code>&quot;stage&quot; : &quot;COLLSCAN&quot;</code>可知，没有使用到索引，是全表扫描的。我们建个索引，再查询。</p>
<pre><code>db.getCollection(&apos;userInfo&apos;).ensureIndex({&quot;name&quot;:1}, {background:true})
</code></pre><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">"userInfo"</span>).find(&#123;<span class="string">"name"</span>:<span class="string">"tom"</span>&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"queryPlanner"</span> : &#123;</span><br><span class="line">		<span class="string">"plannerVersion"</span> : <span class="number">1</span>,</span><br><span class="line">		<span class="string">"namespace"</span> : <span class="string">"bfg.userInfo"</span>,</span><br><span class="line">		<span class="string">"indexFilterSet"</span> : <span class="literal">false</span>,</span><br><span class="line">		<span class="string">"parsedQuery"</span> : &#123;</span><br><span class="line">			<span class="string">"name"</span> : &#123;</span><br><span class="line">				<span class="string">"$eq"</span> : <span class="string">"tom"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"queryHash"</span> : <span class="string">"01AEE5EC"</span>,</span><br><span class="line">		<span class="string">"planCacheKey"</span> : <span class="string">"4C5AEA2C"</span>,</span><br><span class="line">		<span class="string">"winningPlan"</span> : &#123;</span><br><span class="line">			<span class="string">"stage"</span> : <span class="string">"FETCH"</span>,</span><br><span class="line">			<span class="string">"inputStage"</span> : &#123;</span><br><span class="line">				<span class="string">"stage"</span> : <span class="string">"IXSCAN"</span>,</span><br><span class="line">				<span class="string">"keyPattern"</span> : &#123;</span><br><span class="line">					<span class="string">"name"</span> : <span class="number">1</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">"indexName"</span> : <span class="string">"name_1"</span>,</span><br><span class="line">				<span class="string">"isMultiKey"</span> : <span class="literal">false</span>,</span><br><span class="line">				<span class="string">"multiKeyPaths"</span> : &#123;</span><br><span class="line">					<span class="string">"name"</span> : [ ]</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">"isUnique"</span> : <span class="literal">false</span>,</span><br><span class="line">				<span class="string">"isSparse"</span> : <span class="literal">false</span>,</span><br><span class="line">				<span class="string">"isPartial"</span> : <span class="literal">false</span>,</span><br><span class="line">				<span class="string">"indexVersion"</span> : <span class="number">2</span>,</span><br><span class="line">				<span class="string">"direction"</span> : <span class="string">"forward"</span>,</span><br><span class="line">				<span class="string">"indexBounds"</span> : &#123;</span><br><span class="line">					<span class="string">"name"</span> : [</span><br><span class="line">						<span class="string">"[\"tom\", \"tom\"]"</span></span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"rejectedPlans"</span> : [ ]</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"serverInfo"</span> : &#123;</span><br><span class="line">		<span class="string">"host"</span> : <span class="string">"0d550468977f"</span>,</span><br><span class="line">		<span class="string">"port"</span> : <span class="number">27017</span>,</span><br><span class="line">		<span class="string">"version"</span> : <span class="string">"4.4.0"</span>,</span><br><span class="line">		<span class="string">"gitVersion"</span> : <span class="string">"563487e100c4215e2dce98d0af2a6a5a2d67c5cf"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次可以看到，它使用了索引。</p>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><pre><code>mongodb可以通过profile来监控数据，进行优化。查看当前是否开启profile功能用命令：`db.getProfilingLevel()`
</code></pre><p>返回level等级，值为<code>0|1|2</code>，分别代表意思：0代表关闭，1代表记录慢命令，2代表全部。开启profile功能为<br><code>db.setProfilingLevel(level)</code>，level为1的时候，慢命令默认值为100ms，更改为<code>db.setProfilingLevel(level, slowms)</code><br>如<code>db.setProfilingLevel(1,50)</code>这样就更改为50毫秒。通过<code>db.system.profile.find()</code>查看当前的监控日志。通过执行<br><code>db.system.profile.find({millis:{$gt:500}})</code>能够返回查询时间在500毫秒以上的查询命令。</p>
<p>这里值的含义<br>op: query，代表查询<br>ns: 代表查询的库与集合<br>command: 命令的内容<br>responseLength: 返回的结果集大小，byte数<br>nscanned: 扫描记录数量<br>filter: 后面是查询条件<br>nreturned: 返回记录数<br>ts: 命令执行的时刻<br>millis: 所花时间</p>
<p>如果发现时间比较长，那么就需要作优化。比如nscanned数很大，或者接近记录总数，那么可能没有用到索引查询。<br>responseLength很大，有可能返回没必要的字段。<br>nreturned很大，那么有可能查询的时候没有加限制。</p>
<p>mongo可以通过<code>db.serverStatus()</code>查看mongod的运行状态<br>mongo可以通过<code>db.currentOp()</code>可以查看当前正在执行的操作。这两个命令，必须用<code>admin</code>帐号才能操作。</p>
<p>如果出现如下错误提示，则是由于auth太多了，退出，并且以admin帐号登录admin库来执行<br>        mongo –host 192.168.1.100 –port 27017 –authenticationDatabase admin -u admin -p admin</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.currentOp()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"ok"</span> : <span class="number">0</span>,</span><br><span class="line">	<span class="string">"errmsg"</span> : <span class="string">"too many users are authenticated"</span>,</span><br><span class="line">	<span class="string">"code"</span> : <span class="number">13</span>,</span><br><span class="line">	<span class="string">"codeName"</span> : <span class="string">"Unauthorized"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/03/07/mongo-note/" data-id="clf9thvmj002a6h3k30ht37a1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongo/">mongo</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/04/06/jvm-note/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          jvm 学习笔记
        
      </div>
    </a>
  
  
    <a href="/2018/03/03/solr-cloud/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">solr 集群的创建</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">bigdata</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/container/">container</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-server/">web server</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/03/07/xxl-job-note/">xxl-job 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/11/28/seata-note/">seata 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/09/25/spring-note/">spring 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/04/01/mybatis-note/">mybatis 学习笔记</a>
          </li>
        
          <li>
            <a href="/2021/01/22/canal-note/">canal 学习笔记</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">link</h3>
    <div class="widget">
      <li><a href="https://github.com/hewentian" title="Tim Ho's Blog">我的github</a></li>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 Tim Ho<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/categories/" class="mobile-nav-link">Categories</a>
  
    <a href="/tags/" class="mobile-nav-link">Tags</a>
  
    <a href="/about/" class="mobile-nav-link">About</a>
  
</nav>
    

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<!-- <script src="//code.jquery.com/jquery-2.2.4.min.js"></script> -->
<script src="/js/jquery-3.5.1.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>